(this["webpackJsonpmatx-react-pro"]=this["webpackJsonpmatx-react-pro"]||[]).push([[95],{1064:function(e,t,r){"use strict";r.r(t),r.d(t,"default",(function(){return st}));var n=r(155),a=r(5),i=r(142),s=r(143),o=r(164),l=r(163),c=r(144),u=r(145),f=r(154),h=r.n(f),d=r(148),p=r(282),m=r(743),b=r(159),v=r(146),y=r(272),x=r(162),g=r(175),O=r(151),j=(r(152),r(147)),k=r(150),w=r(196),I=r(189),S=r(149),_=r(286),T=r(336),R=r(480),C=r(14),M=(r(177),r(186)),P=r(156),F=r(363),B=r(182),D=r(372),z=r(259),A=r(748),E=r(1030),L=r(296),N=r(880),H=r(468),J=r(1031),W=r(916),q=r(552),G=r(176),U=r(185),V=P.a.getLogger("esri.layers.mixins.ImageryTileMixin"),Y=r(304),X=r(306),K=r(398),Z=r(307),$=r(494),Q=r(356),ee=r(749),te=r(487),re=r(551),ne=r(16),ae=r(160),ie=r(283),se=r(920),oe=r(763),le=r(299),ce=r(501),ue=r(197),fe=function(e){Object(c.a)(r,e);var t=Object(u.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments)).rasterJobHandler=null,e.datasetName=null,e.datasetFormat=null,e.rasterInfo=null,e.ioConfig={sampling:"closest"},e}return Object(s.a)(r,[{key:"init",value:function(){var e=Object(n.a)(h.a.mark((function e(){var t;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object(ce.g)(),this.addResolvingPromise(t),e.next=4,this.when();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"normalizeCtorArgs",value:function(e){return e&&e.ioConfig&&(e=Object(a.a)(Object(a.a)({},e),{},{ioConfig:Object(a.a)({resolution:null,bandIds:null,sampling:"closest",tileInfo:L.a.create()},e.ioConfig)})),e}},{key:"_isGlobalWrappableSource",get:function(){var e=this.rasterInfo,t=Object(ce.e)(e.spatialReference);return Object(v.k)(t)&&e.extent.width>=t/2}},{key:"url",set:function(e){this._set("url",Object(D.h)(e,P.a.getLogger(this.declaredClass)))}},{key:"open",value:function(){var e=Object(n.a)(h.a.mark((function e(t){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new b.a("BaseRaster:open-not-implemented","open() is not implemented");case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchTile",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r,n){var a,i,s,o=arguments;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=o.length>3&&void 0!==o[3]?o[3]:{},i=a.tileInfo||this.rasterInfo.storageInfo.tileInfo,s=this.getTileExtentFromTileInfo(t,r,n,i),e.abrupt("return",this.fetchPixels(s,i.size[0],i.size[1],a));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"identify",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r,n,i,s,o,l,c,u,f,d,p,m,b,y,x,g,O,j,k,w,I,S,_,T,R,C,M,P,F,B,D,z=arguments;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=z.length>1&&void 0!==z[1]?z[1]:{},o=(s=i).multidimensionalDefinition,l=s.timeExtent,c=this.rasterInfo,u=c.hasMultidimensionalTranspose,f=c.multidimensionalInfo,d=i.transposedVariableName,(p=Object(v.k)(f)&&u&&(null!=l||Object(N.e)(o)))&&!d&&(d=Object(v.k)(o)&&o.length>0?o[0].variableName:f.variables[0].name,i=Object(a.a)(Object(a.a)({},i),{},{transposedVariableName:d})),i=this._getRequestOptionsWithSliceId(i),m=this.rasterInfo,b=m.spatialReference,y=m.extent,x=i.datumTransformation,g=Object(ce.i)(t,b,x),y.intersects(g)){e.next=10;break}return e.abrupt("return",{location:g,value:null});case 10:if(!Object(v.k)(this.rasterInfo.transform)){e.next=15;break}if(O=this.rasterInfo.transform.inverseTransform(g),this.rasterInfo.nativeExtent.intersects(O)){e.next=14;break}return e.abrupt("return",{location:O,value:null});case 14:g=O;case 15:if(j=0,k=d&&Object(v.k)(f)&&this.rasterInfo.hasMultidimensionalTranspose){e.next=27;break}if(!i.srcResolution){e.next=22;break}j=Object(ce.m)(i.srcResolution,this.rasterInfo,this.ioConfig.sampling).pyramidLevel,e.next=27;break;case 22:return e.next=24,this.computeBestPyramidLevelForLocation(t,i);case 24:if(null!=(j=e.sent)){e.next=27;break}return e.abrupt("return",{location:g,value:null});case 27:if(null!==(w=this.identifyPixelLocation(g,j,null,k))){e.next=30;break}return e.abrupt("return",{location:g,value:null});case 30:return I=w.row,S=w.col,_=w.rowOffset,T=w.colOffset,R=w.blockWidth,C=null!==(r=d)&&void 0!==r?r:Object(v.q)(i.sliceId),M=Object(se.d)(this.url,C),P="".concat(j,"/").concat(I,"/").concat(S),F=Object(se.c)(M,null,P),Object(v.j)(F)&&(F=this.fetchRawTile(j,I,S,i),Object(se.e)(M,null,P,F)),e.next=35,F;case 35:if(B=e.sent,!Object(v.j)(B)&&null!==(n=B.pixels)&&void 0!==n&&n.length){e.next=38;break}return e.abrupt("return",{location:g,value:null});case 38:return D=_*R+T,e.abrupt("return",this._processIdentifyResult(B,{srcLocation:g,position:D,pyramidLevel:j,useTransposedTile:k,requestSomeSlices:p,identifyOptions:i}));case 40:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchPixels",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r,n){var a,i,s,o,l,c,u,f,d,p,m,b,y,x,g,O,j,k,w=arguments;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=w.length>3&&void 0!==w[3]?w[3]:{},t=Object(ce.l)(t),!(a=this._getRequestOptionsWithSliceId(a)).requestRawData){e.next=3;break}return e.abrupt("return",this._fetchPixels(t,r,n,a));case 3:if(i=Object(ce.e)(t.spatialReference),s=Object(ce.f)(t),!(Object(v.j)(i)||0===s||1===s&&this._isGlobalWrappableSource)){e.next=6;break}return e.abrupt("return",this._fetchPixels(t,r,n,a));case 6:if(!(s>=3)){e.next=8;break}return e.abrupt("return",{extent:t,pixelBlock:null});case 8:for(o=[],c=(l=t).xmin,u=l.xmax,f=Math.round(i/(u-c)*r),d=f-Math.round((i/2-c)/(u-c)*r),p=0,m=[],b=0;b<=s;b++)y=new G.a({xmin:0===b?c:-i/2,xmax:b===s?u-i*b:i/2,ymin:t.ymin,ymax:t.ymax,spatialReference:t.spatialReference}),p+=x=0===b?f-d:b===s?r-p:f,m.push(x),g=a.disableWrapAround&&b>0?null:this._fetchPixels(y,x,n,a),o.push(g);return e.next=14,Promise.all(o);case 14:if(O=e.sent.map((function(e){return null===e||void 0===e?void 0:e.pixelBlock})),j=null,k={width:r,height:n},!this.rasterJobHandler){e.next=23;break}return e.next=20,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:O,srcMosaicSize:k,destDimension:null,coefs:null,sampleSpacing:null,interpolation:"nearest",alignmentInfo:null,blockWidths:m},a);case 20:j=e.sent.pixelBlock,e.next=24;break;case 23:j=Object(le.h)(O,k,{blockWidths:m});case 24:return e.abrupt("return",{extent:t,srcExtent:Object(ce.h)(t,this.rasterInfo.spatialReference,a.datumTransformation),pixelBlock:j});case 25:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"fetchRawPixels",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r,n){var a,i,s,o,l,c,u,f,d,p,m,b,y,x,g,O,j=arguments;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=j.length>3&&void 0!==j[3]?j[3]:{},r={x:Math.floor(r.x),y:Math.floor(r.y)},e.next=4,this._fetchRawTiles(t,r,n,a);case 4:if(i=e.sent,s=this.rasterInfo,o=s.nativeExtent,l=s.nativePixelSize,c=s.storageInfo,u=Math.pow(2,t),f=l.x*u,d=l.y*u,p=new G.a({xmin:o.xmin+f*r.x,xmax:o.xmin+f*(r.x+n.width-1),ymin:o.ymax-d*(r.y+n.height-1),ymax:o.ymax-d*r.y,spatialReference:o.spatialReference}),i){e.next=15;break}return e.abrupt("return",{extent:p,srcExtent:p,pixelBlock:null});case 15:if(m=i.pixelBlocks,b=i.mosaicSize,1!==m.length||!Object(v.k)(m[0])||m[0].width!==n.width||m[0].height!==n.height){e.next=18;break}return e.abrupt("return",{extent:p,srcExtent:p,pixelBlock:i.pixelBlocks[0]});case 18:if(y=t>0?c.pyramidBlockWidth:c.blockWidth,x=t>0?c.pyramidBlockHeight:c.blockHeight,g={x:r.x%y,y:r.y%x},!this.rasterJobHandler){e.next=25;break}return e.next=22,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:m,srcMosaicSize:b,destDimension:n,clipOffset:g,clipSize:n,coefs:null,sampleSpacing:null,interpolation:a.interpolation,alignmentInfo:null,blockWidths:null},a);case 22:O=e.sent.pixelBlock,e.next=26;break;case 25:O=Object(le.h)(m,b,{clipOffset:g,clipSize:n});case 26:return e.abrupt("return",{extent:p,srcExtent:p,pixelBlock:O});case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r,n){throw new b.a("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")}},{key:"computeExtent",value:function(e){return Object(ce.h)(this.rasterInfo.extent,e)}},{key:"decodePixelBlock",value:function(e,t){return!this.rasterJobHandler||t.useCanvas?Object(oe.a)(e,t):this.rasterJobHandler.decode({data:e,options:t})}},{key:"request",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r,n){var i,s,o,l,c,u,f;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=this.ioConfig.customFetchParameters,l=r.range,c=r.query,u=r.headers,n=null!==(i=null!==(s=n)&&void 0!==s?s:r.retryCount)&&void 0!==i?i:this.ioConfig.retryCount,f=l?{Range:"bytes=".concat(l.from,"-").concat(l.to)}:null,e.prev=3,e.next=6,Object(M.default)(t,Object(a.a)(Object(a.a)({},r),{},{query:Object(a.a)(Object(a.a)({},c),o),headers:Object(a.a)(Object(a.a)({},u),f)}));case 6:return e.abrupt("return",e.sent);case 9:if(e.prev=9,e.t0=e.catch(3),!(n>0)){e.next=13;break}return e.abrupt("return",(n--,this.request(t,r,n)));case 13:throw e.t0;case 14:case"end":return e.stop()}}),e,this,[[3,9]])})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"getSliceIndex",value:function(e){var t=this.rasterInfo.multidimensionalInfo;return Object(v.j)(t)||Object(v.j)(e)||0===e.length?null:Object(N.d)(e,t)}},{key:"getTileExtentFromTileInfo",value:function(e,t,r,n){var a=n.lodAt(e);return this.getTileExtent({x:a.resolution,y:a.resolution},t,r,n.origin,n.spatialReference,n.size)}},{key:"updateTileInfo",value:function(){var e=this.rasterInfo,t=e.storageInfo,r=e.spatialReference,n=e.extent,a=e.pixelSize;if(!t.tileInfo){for(var i=[],s=t.maximumPyramidLevel||0,o=Math.max(a.x,a.y),l=1/.0254*96*o,c=0;c<=s;c++)i.push({level:s-c,resolution:o,scale:l}),o*=2,l*=2;var u=new ue.a({x:n.xmin,y:n.ymax,spatialReference:r});t.tileInfo=new L.a({origin:u,size:[t.blockWidth,t.blockHeight],spatialReference:r,lods:i}),t.isVirtualTileInfo=!0}}},{key:"createRemoteDatasetStorageInfo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:512,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:512,n=arguments.length>3?arguments[3]:void 0,a=e.width,i=e.height,s=e.nativeExtent,o=e.pixelSize,l=e.spatialReference,c=new ue.a({x:s.xmin,y:s.ymax,spatialReference:l});null==n&&(n=Math.max(0,Math.round(Math.log(Math.max(a,i))/Math.LN2-8)));var u=this.computeBlockBoundary(s,512,512,{x:s.xmin,y:s.ymax},[o],n);e.storageInfo=new re.a({blockWidth:t,blockHeight:r,pyramidBlockWidth:t,pyramidBlockHeight:r,origin:c,firstPyramidLevel:1,maximumPyramidLevel:n,blockBoundary:u})}},{key:"computeBestPyramidLevelForLocation",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r=arguments;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.length>1&&void 0!==r[1]?r[1]:{},e.abrupt("return",0);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"computeBlockBoundary",value:function(e,t,r,n,a){var i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:2;if(1===a.length&&i>0)for(var o=(a=Object(ne.a)(a))[0],l=o.x,c=o.y,u=0;u<i;u++)l*=s,c*=s,a.push({x:l,y:c});for(var f=[],h=n.x,d=n.y,p=0;p<a.length;p++){var m=a[p],b=m.x,v=m.y;f.push({minCol:Math.floor((e.xmin-h+.1*b)/t/b),maxCol:Math.floor((e.xmax-h-.1*b)/t/b),minRow:Math.floor((d-e.ymax+.1*v)/r/v),maxRow:Math.floor((d-e.ymin-.1*v)/r/v)})}return f}},{key:"getPyramidPixelSize",value:function(e){var t=this.rasterInfo.nativePixelSize,r=this.rasterInfo.storageInfo,n=r.pyramidResolutions,a=r.pyramidScalingFactor;if(0===e)return t;if(Object(v.k)(n)&&n.length)return n[e-1];var i=Math.pow(a,e);return{x:t.x*i,y:t.y*i}}},{key:"identifyPixelLocation",value:function(e,t,r,n){var a=this.rasterInfo,i=a.spatialReference,s=a.nativeExtent,o=a.storageInfo,l=o.maximumPyramidLevel,c=o.origin,u=o.transposeInfo,f=n&&Object(v.k)(u)?u.tileSize[0]:o.blockWidth,h=n&&Object(v.k)(u)?u.tileSize[1]:o.blockHeight,d=Object(ce.i)(e,i,r);if(!s.intersects(d))return null;if(t<0||t>l)return null;var p=this.getPyramidPixelSize(t),m=p.x,b=p.y,y=(c.y-d.y)/b/h,x=(d.x-c.x)/m/f,g=Math.min(h-1,Math.floor((y-Math.floor(y))*h)),O=Math.min(f-1,Math.floor((x-Math.floor(x))*f));return{pyramidLevel:t,row:Math.floor(y),col:Math.floor(x),rowOffset:g,colOffset:O,blockWidth:f,srcLocation:d}}},{key:"getTileExtent",value:function(e,t,r,n,a,i){var s=Object(C.a)(i,2),o=s[0],l=s[1],c=n.x+r*o*e.x,u=c+o*e.x,f=n.y-t*l*e.y,h=f-l*e.y;return new G.a({xmin:c,xmax:u,ymin:h,ymax:f,spatialReference:a})}},{key:"getBlockWidthHeight",value:function(e){return{blockWidth:e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}}},{key:"isBlockOutside",value:function(e,t,r){var n=this.rasterInfo.storageInfo.blockBoundary[e];return!n||n.maxRow<t||n.maxCol<r||n.minRow>t||n.minCol>r}},{key:"_fetchPixels",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r,n){var a,i,s,o,l,c,u,f,d,p,m,b,y,x,g,O,j,k,w,I,S,_,T,R,C,M,P,F,B,D,z,A,E,L,N=arguments;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=N.length>3&&void 0!==N[3]?N[3]:{},!((i=Object(ce.f)(t))>=2)){e.next=4;break}return e.abrupt("return",{extent:t,pixelBlock:null});case 4:if(s=this._getSourceDataInfo(t,r,n,a),o=s.pyramidLevel,l=s.pyramidResolution,c=s.srcResolution,u=s.srcExtent,f=s.srcWidth,d=s.srcHeight,0!==f&&0!==d){e.next=7;break}return e.abrupt("return",{extent:t,srcExtent:u,pixelBlock:null});case 7:return p=Object(v.q)(this.rasterInfo.transform),m="gcs-shift"===(null===p||void 0===p?void 0:p.type),b=Object(v.k)(Object(ce.e)(t.spatialReference)),!m&&b||(i=Object(ce.f)(s.srcExtent,m)),y=this.rasterInfo.storageInfo,x={x:Math.floor((u.xmin-y.origin.x)/l.x+.1),y:Math.floor((y.origin.y-u.ymax)/l.y+.1)},e.next=13,this._fetchRawTiles(o,x,{width:f,height:d,wrapCount:i},a);case 13:if(g=e.sent){e.next=16;break}return e.abrupt("return",{extent:t,srcExtent:u,pixelBlock:null});case 16:if(O=o>0?y.pyramidBlockWidth:y.blockWidth,j=o>0?y.pyramidBlockHeight:y.blockHeight,k=O===f&&j===d&&x.x%O==0&&x.y%j==0,w=new ue.a({x:(t.xmax-t.xmin)/r,y:(t.ymax-t.ymin)/n,spatialReference:t.spatialReference}),I=!t.spatialReference.equals(this.rasterInfo.spatialReference),S=a.datumTransformation,I||!k||1!==g.pixelBlocks.length||O!==r||j!==n||c.x!==w.x||c.y!==w.y){e.next=19;break}return e.abrupt("return",{extent:t,srcExtent:u,pixelBlock:g.pixelBlocks[0]});case 19:if(_=b&&Object(v.k)(Object(ce.e)(u.spatialReference)),T=a.requestProjectedLocalDirections&&this.rasterInfo.dataType.startsWith("vector"),e.t0=T&&!this.rasterJobHandler,!e.t0){e.next=24;break}return e.next=24,Object(ce.g)();case 24:if(!this.rasterJobHandler){e.next=30;break}return e.next=27,this.rasterJobHandler.getProjectionOffsetGrid({projectedExtent:t,srcBufferExtent:g.extent,pixelSize:w.toJSON(),datumTransformation:S,rasterTransform:p,hasWrapAround:i>0||_,isAdaptive:!1!==this.ioConfig.optimizeProjectionAccuracy,includeGCSGrid:T},a);case 27:e.t1=e.sent,e.next=31;break;case 30:e.t1=Object(ce.c)({projectedExtent:t,srcBufferExtent:g.extent,pixelSize:w,datumTransformation:S,rasterTransform:p,hasWrapAround:i>0||_,isAdaptive:!1,includeGCSGrid:T});case 31:if(R=e.t1,M=!a.requestRawData,P={rows:R.spacing[0],cols:R.spacing[1]},F=Object(v.q)(this._getRasterTileAlignmentInfo(o,g.extent.xmin)),B=g.pixelBlocks,D=g.mosaicSize,z=g.isPartiallyFilled,A=null,!this.rasterJobHandler){e.next=42;break}return e.next=37,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:B,srcMosaicSize:D,destDimension:M?{width:r,height:n}:null,coefs:M?R.coefficients:null,sampleSpacing:M?P:null,projectDirections:T,gcsGrid:T?R.gcsGrid:null,isUV:"vector-uv"===this.rasterInfo.dataType,interpolation:a.interpolation,alignmentInfo:F,blockWidths:null},a);case 37:E=e.sent,C=E.pixelBlock,A=E.localNorthDirections,e.next=44;break;case 42:L=Object(le.h)(B,D,{alignmentInfo:F}),C=M?Object(le.a)(L,{width:r,height:n},R.coefficients,P,a.interpolation):L,T&&R.gcsGrid&&(A=Object(le.e)({width:r,height:n},R.gcsGrid),C=Object(H.a)(C,this.rasterInfo.dataType,A));case 44:return e.abrupt("return",a.requestRawData||T?{srcExtent:u,pixelBlock:C,transformGrid:R,localNorthDirections:A,extent:t,isPartiallyFilled:z}:{srcExtent:u,extent:t,pixelBlock:C});case 45:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_fetchRawTiles",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r,n,a){var i,s,o,l,c,u,f,d,p,m,b,y,x,g,O,j,k,w,I,S,_,T,R,C,M,P,F,B,D,z,A,E,L,N,H,J,W=this;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.rasterInfo.storageInfo,s=i.origin,o=i.blockBoundary,l=this.getBlockWidthHeight(t),c=l.blockWidth,u=l.blockHeight,f=r.x,d=r.y,p=n.width,m=n.height,b=n.wrapCount,y=this._getRasterTileAlignmentInfo(t,0),a.buffer&&(f-=a.buffer.cols,d-=a.buffer.rows,p+=2*a.buffer.cols,m+=2*a.buffer.rows),x=0,g=0,O=0,b&&Object(v.k)(y)&&(g=y.worldColumnCountFromOrigin,O=y.originColumnOffset,x=y.rightPadding,g*y.blockWidth-x>=f+p&&(x=0)),j=Math.floor(f/c),k=Math.floor(d/u),w=Math.floor((f+p+x-1)/c),I=Math.floor((d+m+x-1)/u),S=o[t]){e.next=9;break}return e.abrupt("return",null);case 9:if(_=S.minRow,T=S.minCol,R=S.maxCol,C=S.maxRow,0!==b||!(I<_||w<T||k>C||j>R)){e.next=12;break}return e.abrupt("return",null);case 12:for(M=new Array,P=!1,F=null==this.ioConfig.allowPartialFill?a.allowPartialFill:this.ioConfig.allowPartialFill,B=k;B<=I;B++)for(D=j;D<=w;D++)z=D,!a.disableWrapAround&&b&&Object(v.k)(y)&&g<=D&&(z=D-g-O),B>=_&&z>=T&&C>=B&&R>=z?function(){var e=W._fetchRawTile(t,B,z,a);F?M.push(new Promise((function(t){e.then((function(e){return t(e)})).catch((function(){P=!0,t(null)}))}))):M.push(e)}():M.push(null);if(0!==M.length){e.next=18;break}return e.abrupt("return",null);case 18:return e.next=20,Promise.all(M);case 20:return A=e.sent,E={height:(I-k+1)*u,width:(w-j+1)*c},L=this.rasterInfo.spatialReference,N=this.getPyramidPixelSize(t),H=N.x,J=N.y,e.abrupt("return",{extent:new G.a({xmin:s.x+j*c*H,xmax:s.x+(w+1)*c*H,ymin:s.y-(I+1)*u*J,ymax:s.y-k*u*J,spatialReference:L}),pixelBlocks:A,mosaicSize:E,isPartiallyFilled:P});case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"_fetchRawTile",value:function(e,t,r,n){var i=this.rasterInfo.storageInfo.blockBoundary[e];if(!i)return Promise.resolve(null);var s=i.minRow,o=i.minCol,l=i.maxCol,c=i.maxRow;if(t<s||r<o||t>c||r>l)return Promise.resolve(null);var u=Object(se.d)(this.url,n.sliceId),f="".concat(e,"/").concat(t,"/").concat(r),h=Object(se.c)(u,n.registryId,f);if(Object(v.j)(h)){var d=new AbortController;h=this.fetchRawTile(e,t,r,Object(a.a)(Object(a.a)({},n),{},{signal:d.signal})),Object(se.e)(u,n.registryId,f,h,d),h.catch((function(){return Object(se.b)(u,n.registryId,f)}))}return n.signal&&Object(x.m)(n,(function(){Object(se.a)(u,n.registryId,f)})),h}},{key:"_computeMagDirValues",value:function(e){var t,r=this.rasterInfo,n=r.bandCount,a=r.dataType;if((2!==n||"vector-magdir"!==a)&&"vector-uv"!==a||2!==(null===e||void 0===e?void 0:e.length)||null===(t=e[0])||void 0===t||!t.length)return null;var i=e[0].length;if("vector-magdir"===a){var s=e[1].map((function(e){return(e+360)%360}));return[e[0],s]}for(var o=Object(C.a)(e,2),l=o[0],c=o[1],u=[],f=[],h=0;h<i;h++){var d=Object(H.j)([l[h],c[h]]),p=Object(C.a)(d,2),m=p[0],b=p[1];u.push(m),f.push(b)}return[u,f]}},{key:"_getRasterTileAlignmentInfo",value:function(e,t){return null==this._rasterTileAlighmentInfo&&(this._rasterTileAlighmentInfo=Object(ce.d)(this.rasterInfo)),Object(v.j)(this._rasterTileAlighmentInfo.pyramidsInfo)?null:Object(a.a)({startX:t,halfWorldWidth:this._rasterTileAlighmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlighmentInfo.hasGCSSShiftTransform},this._rasterTileAlighmentInfo.pyramidsInfo[e])}},{key:"_getSourceDataInfo",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a={datumTransformation:n.datumTransformation,pyramidLevel:0,pyramidResolution:null,srcExtent:null,srcHeight:0,srcResolution:null,srcWidth:0};n.srcResolution&&(a.srcResolution=n.srcResolution,this._updateSourceDataInfo(e,a));var i=this.rasterInfo.storageInfo.maximumPyramidLevel||0,s=a.srcWidth,o=a.srcHeight,l=a.pyramidLevel,c=s/t,u=o/r,f=l<i&&c*u>=16;if(f||l===i&&(c>8||u>8)||0===s||0===o){var h=new ue.a({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/r,spatialReference:e.spatialReference}),d=Object(ce.j)(h,this.rasterInfo.spatialReference,e,a.datumTransformation),p=!d||n.srcResolution&&d.x+d.y<n.srcResolution.x+n.srcResolution.y;if(f&&n.srcResolution&&p){var m=Math.round(Math.log(Math.max(c,u))/Math.LN2)-1;if(i-l+3>=m){var b=Math.pow(2,m);d={x:n.srcResolution.x*b,y:n.srcResolution.y*b}}}d&&(a.srcResolution=d,this._updateSourceDataInfo(e,a))}return(a.srcWidth/t>8||a.srcHeight/r>8)&&(a.srcWidth=0,a.srcHeight=0),a}},{key:"_updateSourceDataInfo",value:function(e,t){t.srcWidth=0,t.srcHeight=0;var r=this.rasterInfo.spatialReference,n=t.srcResolution,a=t.datumTransformation,i=Object(ce.m)(n,this.rasterInfo,this.ioConfig.sampling),s=i.pyramidLevel,o=i.pyramidResolution;if(!i.excessiveReading){var l=t.srcExtent||Object(ce.h)(e,r,a);if(null!=l){var c=Object(v.q)(this.rasterInfo.transform);c&&(l=c.inverseTransform(l)),t.srcExtent=l;var u=Math.ceil((l.xmax-l.xmin)/o.x-.1),f=Math.ceil((l.ymax-l.ymin)/o.y-.1);t.pyramidLevel=s,t.pyramidResolution=o,t.srcWidth=u,t.srcHeight=f}}}},{key:"_getRequestOptionsWithSliceId",value:function(e){return Object(v.k)(this.rasterInfo.multidimensionalInfo)&&null==e.sliceId&&(e=Object(a.a)(Object(a.a)({},e),{},{sliceId:this.getSliceIndex(e.multidimensionalDefinition)})),e}},{key:"_processIdentifyResult",value:function(e,t){var r=t.srcLocation,n=t.position,a=t.pyramidLevel,i=t.useTransposedTile,s=e.pixels[0].length/e.width/e.height;if(e.mask&&!e.mask[n])return{location:r,value:null};var o=this.rasterInfo.multidimensionalInfo;if(Object(v.j)(o)||!i){var l=e.pixels.map((function(e){return e[n]})),c={location:r,value:l,pyramidLevel:a},u=this._computeMagDirValues(l.map((function(e){return[e]})));return null!==u&&void 0!==u&&u.length&&(c.magdirValue=u.map((function(e){return e[0]}))),c}var f=e.pixels.map((function(e){return Array.prototype.slice.call(e,n*s,n*s+s)})),h=this._computeMagDirValues(f),d=t.requestSomeSlices,p=t.identifyOptions,m=Object(N.a)(o,p.transposedVariableName);if(d){var b,y=Object(N.c)(m,Object(v.q)(p.multidimensionalDefinition),Object(v.q)(p.timeExtent));f=f.map((function(e){return y.map((function(t){return e[t]}))})),h=null===(b=h)||void 0===b?void 0:b.map((function(e){return y.map((function(t){return e[t]}))})),m=y.map((function(e){return m[e]}))}return{location:r,value:null,dataSeries:m.map((function(e,t){var r,n={value:f.map((function(e){return e[t]})),multidimensionalDefinition:e.multidimensionalDefinition,variableName:e.multidimensionalDefinition[0].variableName,dimensionValues:{}};return null!==(r=h)&&void 0!==r&&r.length&&(n.magdirValue=[h[0][t],h[1][t]]),e.multidimensionalDefinition.forEach((function(e){return n.dimensionValues[e.dimensionName]=e.values[0]})),n})),pyramidLevel:a}}}]),r}(Object(ie.b)(ae.a));Object(d.a)([Object(O.b)()],fe.prototype,"_rasterTileAlighmentInfo",void 0),Object(d.a)([Object(O.b)({readOnly:!0})],fe.prototype,"_isGlobalWrappableSource",null),Object(d.a)([Object(O.b)(z.o)],fe.prototype,"url",null),Object(d.a)([Object(O.b)({type:String,json:{write:!0}})],fe.prototype,"datasetName",void 0),Object(d.a)([Object(O.b)({type:String,json:{write:!0}})],fe.prototype,"datasetFormat",void 0),Object(d.a)([Object(O.b)()],fe.prototype,"rasterInfo",void 0),Object(d.a)([Object(O.b)()],fe.prototype,"ioConfig",void 0),Object(d.a)([Object(O.b)()],fe.prototype,"sourceJSON",void 0);var he=fe=Object(d.a)([Object(S.a)("esri.layers.support.rasterDatasets.BaseRaster")],fe),de=r(1023);function pe(e){var t=e.fields,r=e.records,n=t.some((function(e){return"oid"===e.name.toLowerCase()}))?"OBJECTID":"OID",a=[{name:n,type:"esriFieldTypeOID",alias:"OID"}].concat(t.map((function(e){return{name:e.name,type:"esriFieldType"+e.typeName,alias:e.name}}))),i=a.map((function(e){return e.name})),s=[],o=0,l=0;return r.forEach((function(e){var t={};for(t[n]=o++,l=1;l<i.length;l++)t[i[l]]=e[l-1];s.push({attributes:t})})),{displayFieldName:"",fields:a,features:s}}var me=function(){function e(){Object(i.a)(this,e)}return Object(s.a)(e,null,[{key:"supportedVersions",get:function(){return[5]}},{key:"parse",value:function(e){var t=new DataView(e),r=3&t.getUint8(0);if(3!==r)return{header:{version:r},recordSet:null};var n,a=t.getUint32(4,!0),i=t.getUint16(8,!0),s=t.getUint16(10,!0),o={version:r,recordCount:a,headerByteCount:i,recordByteCount:s},l=32,c=[],u=[];if(3===r){for(;13!==t.getUint8(l);)n=String.fromCharCode(t.getUint8(l+11)).trim(),c.push({name:Object(de.a)(new Uint8Array(e,l,11)),type:n,typeName:["String","Date","Double","Boolean","String","Integer"][["C","D","F","L","M","N"].indexOf(n)],length:t.getUint8(l+16)}),l+=32;if(l+=1,c.length>0)for(var f=function(){var r=[];32===t.getUint8(l)?(l+=1,c.forEach((function(t){if("C"===t.type)r.push(Object(de.a)(new Uint8Array(e,l,t.length)).trim());else if("N"===t.type)r.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim(),10));else if("F"===t.type)r.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim()));else if("D"===t.type){var n=String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim();r.push(new Date(parseInt(n.substring(0,4),10),parseInt(n.substring(4,6),10)-1,parseInt(n.substring(6,8),10)))}l+=t.length})),u.push(r)):l+=s};u.length<a&&e.byteLength-l>s;)f()}return{header:o,fields:c,records:u,recordSet:pe({fields:c,records:u})}}}]),e}(),be=r(1093),ve=r(288),ye=new Map;ye.set("int16","esriFieldTypeSmallInteger"),ye.set("int32","esriFieldTypeInteger"),ye.set("int64","esriFieldTypeInteger"),ye.set("float32","esriFieldTypeSingle"),ye.set("float64","esriFieldTypeDouble"),ye.set("text","esriFieldTypeString");var xe=function(e){Object(c.a)(r,e);var t=Object(u.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments)).storageInfo=null,e.datasetFormat="CRF",e}return Object(s.a)(r,[{key:"open",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r,n,a,i,s,o;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return e.next=4,this.request(this.url+"/conf.json",{signal:null===t||void 0===t?void 0:t.signal});case 4:if(r=e.sent,n=r.data,this._validateHeader(n)){e.next=8;break}throw new b.a("cloudraster:open","Invalid or unsupported conf.json.");case 8:if(this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),a=this._parseHeader(n),i=a.storageInfo,"thematic"!==(s=a.rasterInfo).dataType){e.next=15;break}return e.next=13,this._fetchAuxiliaryInformation();case 13:o=e.sent,s.attributeTable=o;case 15:this._set("storageInfo",i),this._set("rasterInfo",s),this.ioConfig.retryCount=this.ioConfig.retryCount||0;case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r,n){var a,i,s,o,l,c,u,f,d,p,m,b,v,y,x,g=arguments;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=g.length>3&&void 0!==g[3]?g[3]:{},i=this.rasterInfo.storageInfo.transposeInfo,s=a.transposedVariableName,!((l=(o=!(!i||!s))?0:this.rasterInfo.storageInfo.maximumPyramidLevel-t)<0)){e.next=4;break}return e.abrupt("return",null);case 4:return c=this._buildCacheFilePath(l,r,n,a.multidimensionalDefinition,s),u=this._getIndexRecordFromBundle(r,n,o),e.next=8,this.request(c,{range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer",signal:a.signal});case 8:if(f=e.sent){e.next=11;break}return e.abrupt("return",null);case 11:if(d=new Uint8Array(f.data),0!==(p=this._getTileEndAndContentType(d,u)).recordSize){e.next=14;break}return e.abrupt("return",null);case 14:return e.next=16,this.request(c,{range:{from:p.position,to:p.position+p.recordSize},responseType:"array-buffer",signal:a.signal});case 16:if(m=e.sent){e.next=19;break}return e.abrupt("return",null);case 19:return b=this._getTileSize(o),v=Object(C.a)(b,2),y=v[0],x=v[1],e.abrupt("return",this.decodePixelBlock(m.data,{width:y,height:x,planes:null,pixelType:null,returnPixelInterleavedDims:o}));case 21:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_validateHeader",value:function(e){return e&&"RasterInfo"===e.type&&!["origin","extent","geodataXform","LODInfos","blockWidth","blockHeight","bandCount","pixelType","pixelSizeX","pixelSizeY","format","packetSize"].some((function(t){return!e[t]}))}},{key:"_parseHeader",value:function(e){var t,r,n=["u1","u2","u4","u8","s8","u16","s16","u32","s32","f32","f64"][e.pixelType],a=e.bandCount,i=e.histograms,s=e.colormap,o=e.blockWidth,l=e.blockHeight,c=e.firstPyramidLevel,u=e.maximumPyramidLevel,f=e.statistics&&e.statistics.map((function(e){return{min:e.min,max:e.max,avg:e.mean,stddev:e.standardDeviation,median:e.median,mode:e.mode}})),h=e.extent.spatialReference,d=null===(t=e.geodataXform)||void 0===t?void 0:t.spatialReference,p=new U.a(null!==h&&void 0!==h&&h.wkid||null!==h&&void 0!==h&&h.wkt?h:d),m=new G.a({xmin:e.extent.xmin,ymin:e.extent.ymin,xmax:e.extent.xmax,ymax:e.extent.ymax,spatialReference:p}),b=new ue.a({x:e.pixelSizeX,y:e.pixelSizeY,spatialReference:p}),v=Math.round((m.xmax-m.xmin)/b.x),y=Math.round((m.ymax-m.ymin)/b.y),x=this._parseTransform(e.geodataXform),g=x?m:null;x&&(m=x.forwardTransform(m),b.x=(m.xmax-m.xmin)/v,b.y=(m.ymax-m.ymin)/y);var O,j,k,w,I=null!==(r=e.properties)&&void 0!==r?r:{},S=e.format.toLowerCase().replace("cache/",""),_=new ue.a(e.origin.x,e.origin.y,p);if(s&&s.colors)for(O=[],j=0;j<s.colors.length;j++)k=s.colors[j],w=s.values?s.values[j]:j,O.push([w,255&k,k<<16>>>24,k<<8>>>24,k>>>24]);var T=e.LODInfos,R=[];for(j=0;j<T.levels.length;j++)R.push({level:T.levels[j],resolution:T.resolutions[j],scale:96/.0254*T.resolutions[j]});var C=new L.a({dpi:96,lods:R,format:S,origin:_,size:[o,l],spatialReference:p}),M={recordSize:8,packetSize:e.packetSize,headerSize:e.packetSize*e.packetSize*8+64},P=[{maxCol:Math.ceil(v/o)-1,maxRow:Math.ceil(y/l)-1,minCol:0,minRow:0}],F=2;if(u>0)for(j=0;j<u;j++)P.push({maxCol:Math.ceil(v/F/o)-1,maxRow:Math.ceil(y/F/l)-1,minCol:0,minRow:0}),F*=2;var B=e.mdInfo,D=null;if(B&&I._yxs){var z=I._yxs;D={packetSize:z.PacketSize,tileSize:[z.TileXSize,z.TileYSize]}}return{storageInfo:M,rasterInfo:new te.a({width:v,height:y,pixelType:n,bandCount:a,extent:m,nativeExtent:g,transform:x,spatialReference:p,pixelSize:b,keyProperties:I,statistics:f,histograms:i,multidimensionalInfo:B,colormap:O,storageInfo:new re.a({blockWidth:o,blockHeight:l,pyramidBlockWidth:o,pyramidBlockHeight:l,origin:_,tileInfo:C,transposeInfo:D,firstPyramidLevel:c,maximumPyramidLevel:u,blockBoundary:P})})}}},{key:"_parseTransform",value:function(e){var t,r;if(!Object(be.a)(e))throw new b.a("cloudraster:open","the data contains unsupported geodata transform types");var n=Object(be.b)(e);if("identity"===n.type)return null;if("polynomial"!==n.type||null===(t=n.forwardCoefficients)||void 0===t||!t.length||null===(r=n.inverseCoefficients)||void 0===r||!r.length)throw new b.a("cloudraster:open","the data contains unsupported geodata transforms - both forward and inverse coefficients are required currently");return n}},{key:"_fetchAuxiliaryInformation",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r,n,a,i,s,o,l;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.request(this.url+"/conf.vat.json",{signal:t}).then((function(e){return e.data})).catch((function(){return null})),n=this.request(this.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:t}).then((function(e){return e.data})).catch((function(){return null})),e.next=4,Promise.all([r,n]);case 4:return(a=e.sent)[0]&&(s=a[0].fields,o=a[0].values,s&&o&&(s=s.map((function(e){return{type:"OID"===e.name?"esriFieldTypeOID":ye.get(e.type),name:e.name,alias:e.alias||e.name}})),l=o.map((function(e){return{attributes:e}})),s&&o&&(i={fields:s,features:l}))),!i&&a[1]&&(i=me.parse(a[1]).recordSet),e.abrupt("return",ve.default.fromJSON(i));case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_buildCacheFilePath",value:function(e,t,r,n,a){var i=this._getPackageSize(!!a),s=Math.floor(t/i)*i,o=Math.floor(r/i)*i,l="R"+this._toHexString4(s)+"C"+this._toHexString4(o),c="L";c+=e>=10?e.toString():"0"+e.toString();var u=this.rasterInfo.multidimensionalInfo,f=null===n||void 0===n?void 0:n[0];if(Object(v.j)(u)||!f)return"".concat(this.url,"/_alllayers/").concat(c,"/").concat(l,".bundle");var h="_yxs";if(!a){h=u.variables.find((function(e){return e.name===f.variableName})).dimensions[0].values.indexOf(f.values[0]).toString(16);for(var d=4-h.length,p=0;p<d;p++)h="0"+h;h="S"+h}var m=this._getVariableFolderName(a||f.variableName);return"".concat(this.url,"/_alllayers/").concat(m,"/").concat(h,"/").concat(c,"/").concat(l,".bundle")}},{key:"_getPackageSize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.rasterInfo.storageInfo.transposeInfo;return e&&Object(v.k)(t)?t.packetSize:this.storageInfo.packetSize}},{key:"_getTileSize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.rasterInfo.storageInfo,r=t.transposeInfo;return e&&Object(v.k)(r)?r.tileSize:t.tileInfo.size}},{key:"_getVariableFolderName",value:function(e){return""===(e=e.trim())?"_v":e.replace(/[\{|\}\-]/g,"_").replace("\\*","_v")}},{key:"_getIndexRecordFromBundle",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this._getPackageSize(r),a=n*(e%n)+t%n;if(a<0)throw"Invalid level / row / col";return 20+a*this.storageInfo.recordSize+44}},{key:"_getTileEndAndContentType",value:function(e,t){var r,n=e.subarray(t,t+8),a=0;for(r=0;r<5;r++)a|=(255&n[r])<<8*r;var i=0xffffffffff&a;for(a=0,r=5;r<8;r++)a|=(255&n[r])<<8*(r-5);return{position:i,recordSize:0xffffffffff&a}}},{key:"_toHexString4",value:function(e){var t=e.toString(16);if(4!==t.length)for(var r=4-t.length;r-- >0;)t="0"+t;return t}}]),r}(he);Object(d.a)([Object(O.b)({readOnly:!0})],xe.prototype,"storageInfo",void 0),Object(d.a)([Object(O.b)({type:String,json:{write:!0}})],xe.prototype,"datasetFormat",void 0);var ge=xe=Object(d.a)([Object(S.a)("esri.layers.support.rasterDatasets.CloudRaster")],xe),Oe=r(585),je=function(e){Object(c.a)(r,e);var t=Object(u.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments)).datasetFormat="MEMORY",e}return Object(s.a)(r,[{key:"open",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r,n,a,i,s,o,l,c,u,f,d,p,m,b,v,y;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return n=this.data,a=n.pixelBlock,i=n.statistics,s=n.histograms,o=n.name,l=n.keyProperties,c=n.nativeExtent,u=n.transform,f=a.width,d=a.height,p=a.pixelType,m=this.data.extent||new G.a({xmin:-.5,ymin:.5,xmax:f-.5,ymax:d-.5,spatialReference:new U.a({wkid:3857})}),b=null!==(r=this.data.isPseudoSpatialReference)&&void 0!==r?r:!this.data.extent,v={x:m.width/f,y:m.height/d},y=new te.a({width:f,height:d,pixelType:p,extent:m,nativeExtent:c,transform:u,pixelSize:v,spatialReference:m.spatialReference,bandCount:3,keyProperties:l||{},statistics:i,isPseudoSpatialReference:b,histograms:s}),this.createRemoteDatasetStorageInfo(y,512,512),this._set("rasterInfo",y),this.updateTileInfo(),e.next=8,this._buildInMemoryRaster(a,{width:512,height:512},t);case 8:this.datasetName=o,this.url="/InMemory/"+o;case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r){var n=this._pixelBlockTiles.get("".concat(e,"/").concat(t,"/").concat(r));return Promise.resolve(n)}},{key:"_buildInMemoryRaster",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r,n){var a,i,s,o,l,c,u,f;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=this.rasterInfo.storageInfo.maximumPyramidLevel,o=this.rasterJobHandler?this.rasterJobHandler.split({pixelBlock:t,tileSize:r,maximumPyramidLevel:s},n):Promise.resolve(Object(le.l)(t,r,s)),l=Object(v.k)(this.rasterInfo.statistics),c=Object(v.k)(this.rasterInfo.histograms),u=l?Promise.resolve({statistics:null,histograms:null}):this.rasterJobHandler?this.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:t},n):Promise.resolve(Object(Oe.e)(t)),e.next=7,Object(x.g)([o,u]);case 7:if((f=e.sent)[0].value||!f[1].value){e.next=10;break}throw new b.a("inmemory-raster:open","failed to build in memory raster");case 10:this._pixelBlockTiles=f[0].value,l||(this.rasterInfo.statistics=null===(a=f[1].value)||void 0===a?void 0:a.statistics),c||(this.rasterInfo.histograms=null===(i=f[1].value)||void 0===i?void 0:i.histograms);case 11:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()}]),r}(he);Object(d.a)([Object(O.b)({type:String,json:{write:!0}})],je.prototype,"datasetFormat",void 0),Object(d.a)([Object(O.b)()],je.prototype,"data",void 0);var ke=je=Object(d.a)([Object(S.a)("esri.layers.support.rasterDatasets.InMemoryRaster")],je);function we(e,t){if(!e||!t)return[];var r=t;t.includes("/")?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";var n=[];if(t){for(var a=we(e,r),i=0;i<a.length;i++)we(a[i],t).forEach((function(e){return n.push(e)}));return n}var s=e.getElementsByTagNameNS("*",r);if(!s||0===s.length)return[];for(var o=0;o<s.length;o++)n.push(s[o]||s.item[o]);return n}function Ie(e,t){if(!e||!t)return null;var r=t;t.includes("/")?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";var n=we(e,r);return n.length>0?t?Ie(n[0],t):n[0]:null}function Se(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=r?Ie(e,r):e;return n?(t=n.textContent||n.nodeValue)?t.trim():null:null}function _e(e,t){return function(e,t){for(var r,n=we(e,t),a=[],i=0;i<n.length;i++)(r=n[i].textContent||n[i].nodeValue)&&""!==(r=r.trim())&&a.push(r);return a}(e,t).map((function(e){return Number(e)}))}function Te(e,t){var r=Se(e,t);return Number(r)}function Re(e,t){var r,n=null===e||void 0===e||null===(r=e.nodeName)||void 0===r?void 0:r.toLowerCase(),a=t.toLowerCase();return n.slice(n.lastIndexOf(":")+1)===a}var Ce=r(734);function Me(e,t){if(!e||!t)return null;for(var r=[],n=0;n<e.length;n++)r.push(e[n]),r.push(t[n]);return r}function Pe(e){if(!e)return null;var t=Number(e);if(!isNaN(t)&&0!==t)return new U.a({wkid:t});if((e=String(e)).startsWith("COMPD_CS")){if(!e.includes("VERTCS")||!e.includes("GEOGCS")&&!e.startsWith("PROJCS"))return null;var r=e.indexOf("VERTCS"),n=e.indexOf("PROJCS"),a=n>-1?n:e.indexOf("GEOGCS");if(-1===a)return null;var i=e.slice(a,e.lastIndexOf("]",r)+1).trim(),s=e.slice(r,e.lastIndexOf("]")).trim();t=Fe(i);var o=new U.a(t?{wkid:t}:{wkt:i}),l=Fe(s);return l&&(o.vcsWkid=l),o}return e.startsWith("GEOGCS")||e.startsWith("PROJCS")?(t=Fe(e),new U.a(0!==t?{wkid:t}:{wkt:e})):null}function Fe(e){var t,r=e.replace(/\]/g,"[").replace(/\"/g,"").split("[").map((function(e){return e.trim()})).filter((function(e){return""!==e})),n=r[r.length-1].split(","),a=null===(t=n[0])||void 0===t?void 0:t.toLowerCase();if(("epsg"===a||"esri"===a)&&e.endsWith('"]]')){var i=Number(n[1]);if(!isNaN(i)&&0!==i)return i}return 0}function Be(e){var t;if("pamdataset"!==(null===e||void 0===e||null===(t=e.documentElement.tagName)||void 0===t?void 0:t.toLowerCase()))return{};var r={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach((function(e){if(1===e.nodeType)if(Re(e,"SRS")){if(!r.spatialReference){var t=Se(e);r.spatialReference=Pe(t)}}else if(Re(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){var n=function(e){var t,r=Ie(e,"GeodataXform"),n=Pe(Te(r,"SpatialReference/WKID")||Se(r,"SpatialReference/WKT"));if("typens:PolynomialXform"!==r.getAttribute("xsi:type"))return{spatialReference:n,transform:null};var a=null!==(t=Te(r,"PolynomialOrder"))&&void 0!==t?t:1,i=_e(r,"CoeffX/Double"),s=_e(r,"CoeffY/Double"),o=_e(r,"InverseCoeffX/Double"),l=_e(r,"InverseCoeffY/Double"),c=Me(i,s),u=Me(o,l);return{spatialReference:n,transform:new Ce.a({spatialReference:n,polynomialOrder:a,forwardCoefficients:c,inverseCoefficients:u})}}(e),a=n.spatialReference,i=n.transform;r.transform=i,r.spatialReference||(r.spatialReference=a)}else we(e,"MDI").forEach((function(e){return r.metadata[e.getAttribute("key")]=Se(e)}));else if(Re(e,"PAMRasterBand")){var s=function(e){var t,r,n,a,i,s=Te(e,"NoDataValue"),o=Ie(e,"Histograms/HistItem"),l=Te(o,"HistMin"),c=Te(o,"HistMax"),u=Te(o,"BucketCount"),f=null===(t=Se(o,"HistCounts"))||void 0===t?void 0:t.split("|").map((function(e){return Number(e)}));we(e,"Metadata/MDI").forEach((function(e){var t,s=Number(null!==(t=e.textContent)&&void 0!==t?t:e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":r=s;break;case"STATISTICS_MAXIMUM":n=s;break;case"STATISTICS_MEAN":a=s;break;case"STATISTICS_STDDEV":i=s}}));var h=Te(e,"Metadata/SourceBandIndex");return{noDataValue:s,histogram:null!==f&&void 0!==f&&f.length&&null!=r&&null!=n?{min:l,max:c,size:u||f.length,counts:f}:null,sourceBandIndex:h,statistics:null!=r&&null!=n?{min:r,max:n,avg:a,stddev:i}:null}}(e);null!=s.sourceBandIndex&&null==r.rasterBands[s.sourceBandIndex]?r.rasterBands[s.sourceBandIndex]=s:r.rasterBands.push(s)}}));var n=r.rasterBands;if(n){var a=!!n[0].statistics;r.statistics=a?n.map((function(e){return e.statistics})):null;var i=!!n[0].histogram;r.histograms=i?n.map((function(e){return e.histogram})):null}return r}var De=function(e){Object(c.a)(r,e);var t=Object(u.a)(r);function r(){return Object(i.a)(this,r),t.apply(this,arguments)}return Object(s.a)(r,[{key:"open",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r,n,a,i,s,o,l,c,u,f,d,p,m;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return e.next=4,this._fetchData(t);case 4:return r=e.sent,e.next=7,this._fetchAuxiliaryData(t);case 7:return n=e.sent,a=n.spatialReference,i=n.statistics,s=n.histograms,o=n.transform,(l=!a)&&(a=new U.a({wkid:3857})),(null===s||void 0===s?void 0:s.length)&&null==i&&(i=Object(Oe.d)(s)),c=r.width,u=r.height,f=new G.a({xmin:-.5,ymin:.5-u,xmax:c-.5,ymax:.5,spatialReference:a}),d=o?o.forwardTransform(f):f,!0,o&&(p=o.forwardCoefficients,p&&0===p[1]&&0===p[2]&&(o=null,f=d)),m=new ke({data:{extent:d,nativeExtent:f,transform:o,pixelBlock:r,statistics:i,histograms:s,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:l}}),e.next=22,m.open();case 22:m.data=null,this._set("rasterInfo",m.rasterInfo),this._inMemoryRaster=m;case 25:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this._inMemoryRaster.fetchRawTile(e,t,r,n)}},{key:"_fetchData",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r,n,a,i,s;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.request(this.url,{responseType:"array-buffer",signal:null===t||void 0===t?void 0:t.signal});case 2:if(r=e.sent,n=r.data,"JPG"===(a=Object(oe.b)(n).toUpperCase())||"PNG"===a||"GIF"===a||"BMP"===a){e.next=7;break}throw new b.a("image-aux-raster:open","the data is not a supported format");case 7:return this._set("datasetFormat",a),i=a.toLowerCase(),s="gif"===i||"bmp"===i||!Object(j.a)("ios"),e.next=11,this.decodePixelBlock(n,{format:i,useCanvas:s,hasNoZlibMask:!0});case 11:return e.abrupt("return",e.sent);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchAuxiliaryData",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r,n,a,i,s,o,l,c,u,f,d;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=Object(v.q)(null===t||void 0===t?void 0:t.signal),i=null!==(r=this.ioConfig.skipExtensions)&&void 0!==r?r:[],s=i.includes("aux.xml")?null:this.request(this.url+".aux.xml",{responseType:"xml",signal:a}),o=this.datasetFormat,l="JPG"===o?"jgw":"PNG"===o?"pgw":"BMP"===o?"bpw":null,c=i.includes(l)?null:this.request(this.url.slice(0,this.url.lastIndexOf("."))+"."+l,{responseType:"text",signal:a}),e.next=8,Object(x.g)([s,c]);case 8:if(u=e.sent,null===a||void 0===a||!a.aborted){e.next=11;break}throw Object(x.b)();case 11:return(f=Be(null===(n=u[0].value)||void 0===n?void 0:n.data)).transform||(d=u[1].value?u[1].value.data.split("\n").slice(0,6).map((function(e){return Number(e)})):null,f.transform=6===(null===d||void 0===d?void 0:d.length)?new Ce.a({forwardCoefficients:[d[4],d[5],d[0],-d[1],d[2],-d[3]]}):null),e.abrupt("return",f);case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),r}(he);Object(d.a)([Object(O.b)({type:String,json:{write:!0}})],De.prototype,"datasetFormat",void 0);var ze=De=Object(d.a)([Object(S.a)("esri.layers.support.rasterDatasets.ImageAuxRaster")],De),Ae=r(183),Ee=r(520),Le=r(532),Ne=r(1025),He=r(1032),Je=function(e){Object(c.a)(r,e);var t=Object(u.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments))._levelOffset=0,e._tilemapCache=null,e._slices=null,e.datasetFormat="RasterTileServer",e}return Object(s.a)(r,[{key:"open",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r,n,a,i,s,o,l,c,u,f,d,p,m,y,x,g,O,j,k,w,I,S,_,T,R;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:if(r=t&&t.signal,!this.sourceJSON){e.next=7;break}e.t0={data:this.sourceJSON},e.next=10;break;case 7:return e.next=9,this.request(this.url,{query:{f:"json"},signal:r});case 9:e.t0=e.sent;case 10:if((n=e.t0).ssl&&(this.url=this.url.replace(/^http:/i,"https:")),a=n.data,this.sourceJSON=a,a){e.next=15;break}throw new b.a("imageserverraster:open","cannot initialize tiled image service, missing service info");case 15:if(a.tileInfo){e.next=17;break}throw new b.a("imageserverraster:open","use ImageryLayer to open non-tiled image services");case 17:return this._fixScaleInServiceInfo(),i=["jpg","jpeg","png","png8","png24","png32","mixed"],this.tileType=a.cacheType,null==this.tileType&&(i.includes(a.tileInfo.format.toLowerCase())?this.tileType="Map":"lerc"===a.tileInfo.format.toLowerCase()?this.tileType="Elevation":this.tileType="Raster"),this.datasetName=a.name.slice(a.name.indexOf("/")+1),e.next=22,this._fetchRasterInfo({signal:r});case 22:if(s=e.sent,Object(v.k)(s)){e.next=25;break}throw new b.a("image-server-raster:open","cannot initialize image service");case 25:c="Map"===this.tileType?Object(Ee.a)(a.tileInfo,a):L.a.fromJSON(a.tileInfo),u=s.extent,f=s.pixelSize,d=.5/s.width*f.x,y=c.lodAt(Math.max.apply(null,c.lods.map((function(e){return e.level})))),"Map"!==this.tileType&&0!==a.maxScale&&("Raster"===this.tileType?(p=c.lods.find((function(e){return e.resolution===f.x})),p||(p=c.lods[c.lods.length-1])):(p=c.lods.find((function(e){return Math.abs(e.scale-a.maxScale)<d})),p||(p=c.lods.filter((function(e){return e.scale>a.maxScale})).sort((function(e,t){return e.scale>t.scale?1:-1}))[0])),f.x=f.y=p.resolution,s.width=Math.ceil((u.xmax-u.xmin)/f.x-.1),s.height=Math.ceil((u.ymax-u.ymin)/f.y-.1)),p||(p=y),x=c.lodAt(Math.min.apply(null,c.lods.map((function(e){return e.level})))),"Map"===this.tileType?this._levelOffset=c.lods[0].level:0!==a.minScale&&"Elevation"===this.tileType&&(m=c.lods.find((function(e){return Math.abs(e.scale-a.minScale)<d})),this._levelOffset=m.level-x.level),m||(m=x),g=Math.max(f.x,f.y),(Math.abs(f.x-f.y)>d||!c.lods.some((function(e){return Math.abs(e.resolution-g)<d})))&&(f.x=f.y=p.resolution,s.width=Math.ceil((u.xmax-u.xmin)/f.x-.1),s.height=Math.ceil((u.ymax-u.ymin)/f.y-.1)),O=p.level-m.level,j=Object(C.a)(c.size,2),k=j[0],w=j[1],I=[],c.lods.forEach((function(e){e.level>=m.level&&e.level<=p.level&&I.push({x:e.resolution,y:e.resolution})})),I.sort((function(e,t){return e.x-t.x})),S=this.computeBlockBoundary(u,k,w,c.origin,I,O),_=I.length>1?I.slice(1):null,a.transposeInfo&&(T={tileSize:[a.transposeInfo.rows,a.transposeInfo.cols],packetSize:null!==(o=null===(l=s.keyProperties)||void 0===l?void 0:l._yxs.PacketSize)&&void 0!==o?o:0}),s.storageInfo=new re.a({blockWidth:c.size[0],blockHeight:c.size[1],pyramidBlockWidth:c.size[0],pyramidBlockHeight:c.size[1],pyramidResolutions:_,compression:c.format,origin:c.origin,firstPyramidLevel:1,maximumPyramidLevel:O,tileInfo:c,transposeInfo:T,blockBoundary:S}),this._fixGCSShift(s),this._set("rasterInfo",s),a.capabilities.toLowerCase().includes("tilemap")&&(R={tileInfo:s.storageInfo.tileInfo,parsedUrl:Object(Ae.M)(this.url),url:this.url,tileServers:[],type:"tile"},this._tilemapCache=new Le.a({layer:R}));case 37:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r,n){var a,i,s,o,l,c,u,f,d,p,m,b,y,x,g,O,j,k,w,I,S,_,T,R,C,M,P,F,B=arguments;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=B.length>3&&void 0!==B[3]?B[3]:{},i=this.rasterInfo,s=i.storageInfo,o=i.extent,l=s.transposeInfo,c=Object(v.k)(l)&&!!a.transposedVariableName,!this._slices||c||null!=a.sliceId){e.next=4;break}return e.abrupt("return",null);case 4:return u=c?0:s.maximumPyramidLevel-t+this._levelOffset,f="".concat(this.url,"/tile/").concat(u,"/").concat(r,"/").concat(n),d=this._slices?c?{variable:a.transposedVariableName}:{sliceId:a.sliceId||0}:null,e.next=9,this.request(f,{query:d,responseType:"array-buffer",signal:a.signal});case 9:if(p=e.sent,m=p.data){e.next=13;break}return e.abrupt("return",null);case 13:return b=c?l.tileSize:s.tileInfo.size,e.next=16,this.decodePixelBlock(m,{width:b[0],height:b[1],planes:null,pixelType:null,isPoint:"Elevation"===this.tileType,returnPixelInterleavedDims:c});case 16:if(y=e.sent,x=s.blockBoundary[t],!("jpg"!==s.compression||n>x.minCol&&n<x.maxCol&&r>x.minRow&&r<x.maxRow)){e.next=20;break}return e.abrupt("return",y);case 20:return g=s.origin,O=s.blockWidth,j=s.blockHeight,k=this.getPyramidPixelSize(t),w=k.x,I=k.y,S=Math.round((o.xmin-g.x)/w)%O,_=Math.round((o.xmax-g.x)/w)%O||O,T=Math.round((g.y-o.ymax)/I)%j,R=Math.round((g.y-o.ymin)/I)%j||j,C=n===x.minCol?S:0,M=r===x.minRow?T:0,P=n===x.maxCol?_:O,F=r===x.maxRow?R:j,e.abrupt("return",(Object(le.k)(y,{x:C,y:M},{width:P-C,height:F-M}),y));case 22:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"getSliceIndex",value:function(e){if(!this._slices||Object(v.j)(e)||0===e.length)return null;for(var t=e,r=0;r<this._slices.length;r++){var n=this._slices[r].multidimensionalDefinition;if(n.length===t.length&&!n.some((function(e){var r=t.find((function(t){return e.variableName===t.variableName&&t.dimensionName===e.dimensionName}));return!r||(Array.isArray(e.values[0])?"".concat(e.values[0][0],"-").concat(e.values[0][1]):e.values[0])!==(Array.isArray(r.values[0])?"".concat(r.values[0][0],"-").concat(r.values[0][1]):r.values[0])})))return r}return null}},{key:"fetchVariableStatisticsHistograms",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r){var n,a,i;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.request(this.url+"/statistics",{query:{variable:t,f:"json"},signal:r}).then((function(e){var t;return null===(t=e.data)||void 0===t?void 0:t.statistics})),a=this.request(this.url+"/histograms",{query:{variable:t,f:"json"},signal:r}).then((function(e){var t;return null===(t=e.data)||void 0===t?void 0:t.histograms})),e.next=4,Promise.all([n,a]);case 4:return i=e.sent,e.abrupt("return",(i[0]&&i[0].forEach((function(e){e.avg=e.mean,e.stddev=e.standardDeviation})),{statistics:i[0]||null,histograms:i[1]||null}));case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"computeBestPyramidLevelForLocation",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r,n,a,i,s,o,l=arguments;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=l.length>1&&void 0!==l[1]?l[1]:{},this._tilemapCache){e.next=3;break}return e.abrupt("return",0);case 3:if(null!==(n=this.identifyPixelLocation(t,0,Object(v.q)(r.datumTransformation)))){e.next=6;break}return e.abrupt("return",null);case 6:a=0,i=this.rasterInfo.storageInfo.maximumPyramidLevel,s=i-a+this._levelOffset,o=n.srcLocation;case 10:if(!(s>=0)){e.next=25;break}return e.prev=11,e.next=14,this._tilemapCache.fetchAvailability(s,n.row,n.col,r);case 14:if(e.t0=e.sent,"available"!==e.t0){e.next=17;break}return e.abrupt("break",25);case 17:e.next=21;break;case 19:e.prev=19,e.t1=e.catch(11);case 21:if(s--,a++,null!==(n=this.identifyPixelLocation(o,a,Object(v.q)(r.datumTransformation)))){e.next=23;break}return e.abrupt("return",null);case 23:e.next=10;break;case 25:return e.abrupt("return",-1===s||null==n?null:a);case 26:case"end":return e.stop()}}),e,this,[[11,19]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchRasterInfo",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r,n,a,i,s,o,l,c,u;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.sourceJSON,"Map"!==this.tileType){e.next=4;break}return n=Math.ceil((r.extent.xmax-r.extent.xmin)/r.pixelSizeX-.1),a=Math.ceil((r.extent.ymax-r.extent.ymin)/r.pixelSizeY-.1),i=U.a.fromJSON(r.spatialReference||r.extent.spatialReference),s=new ue.a({x:r.pixelSizeX,y:r.pixelSizeY,spatialReference:i}),e.abrupt("return",new te.a({width:n,height:a,bandCount:3,extent:G.a.fromJSON(r.extent),spatialReference:i,pixelSize:s,pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}}));case 4:return o=t.signal,l=Object(He.a)(this.url,this.sourceJSON,{signal:o,query:this.ioConfig.customFetchParameters}),c=r.hasMultidimensions?this.request("".concat(this.url,"/slices"),{query:{f:"json"},signal:o}).then((function(e){return e.data&&e.data.slices})).catch((function(){return null})):null,e.next=9,Promise.all([l,c]);case 9:return u=e.sent,e.abrupt("return",(this._slices=u[1],u[0]));case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fixScaleInServiceInfo",value:function(){var e=this.sourceJSON;e.minScale&&e.minScale<0&&(e.minScale=0),e.maxScale&&e.maxScale<0&&(e.maxScale=0)}},{key:"_fixGCSShift",value:function(e){var t=e.extent,r=e.spatialReference;0===t.xmin&&360===t.xmax&&r.wkid&&r.isGeographic&&(e.nativeExtent=e.extent,e.transform=new Ne.a,e.extent=e.transform.forwardTransform(t))}}]),r}(he);Object(d.a)([Object(O.b)({type:String,json:{write:!0}})],Je.prototype,"datasetFormat",void 0),Object(d.a)([Object(O.b)()],Je.prototype,"tileType",void 0);var We=Je=Object(d.a)([Object(S.a)("esri.layers.support.rasterDatasets.ImageServerRaster")],Je),qe=r(467),Ge=r(856),Ue=new Map;Ue.set("Int8","s8"),Ue.set("UInt8","u8"),Ue.set("Int16","s16"),Ue.set("UInt16","u16"),Ue.set("Int32","s32"),Ue.set("UInt32","u32"),Ue.set("Float32","f32"),Ue.set("Float64","f32"),Ue.set("Double64","f32");var Ve=new Map;Ve.set("none",{blobExtension:".til",isOneSegment:!0,decoderFormat:"bip"}),Ve.set("lerc",{blobExtension:".lrc",isOneSegment:!1,decoderFormat:"lerc"}),Ve.set("deflate",{blobExtension:".pzp",isOneSegment:!0,decoderFormat:"deflate"}),Ve.set("jpeg",{blobExtension:".pjg",isOneSegment:!0,decoderFormat:"jpg"});var Ye=function(e){Object(c.a)(r,e);var t=Object(u.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments))._files=null,e._storageIndex=null,e.datasetFormat="MRF",e}return Object(s.a)(r,[{key:"open",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r,n,a,i,s,o,l,c,u,f,d,p,m,b,y,x,g,O,j,k,w,I;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),n=t?Object(v.q)(t.signal):null,e.next=6,this.request(this.url,{responseType:"xml",signal:n});case 6:if(a=e.sent,i=this._parseHeader(a.data),s=i.rasterInfo,o=i.files,-1!==(null===(r=this.ioConfig.skipExtensions)||void 0===r?void 0:r.indexOf("aux.xml"))){e.next=15;break}return e.next=13,this._fetchAuxiliaryData(t);case 13:null!=(c=e.sent)&&(s.statistics=null!==(l=c.statistics)&&void 0!==l?l:s.statistics,s.histograms=c.histograms,c.histograms&&Object(v.j)(s.statistics)&&(s.statistics=Object(Oe.d)(c.histograms)));case 15:return this._set("rasterInfo",s),this._files=o,e.next=18,this.request(o.index,{responseType:"array-buffer",signal:n});case 18:for(u=e.sent,this._storageIndex=this._parseIndex(u.data),f=this.rasterInfo.storageInfo,d=f.blockWidth,p=f.blockHeight,m=this.rasterInfo.storageInfo.pyramidScalingFactor,b=this.rasterInfo,y=b.width,x=b.height,g=[],O=this._getBandSegmentCount(),j=0,k=-1;j<this._storageIndex.length;)k++,w=Math.ceil(y/d/Math.pow(m,k))-1,I=Math.ceil(x/p/Math.pow(m,k))-1,j+=(w+1)*(I+1)*O*4,g.push({maxRow:I,maxCol:w,minCol:0,minRow:0});this.rasterInfo.storageInfo.blockBoundary=g,k>0&&(this.rasterInfo.storageInfo.firstPyramidLevel=1,this.rasterInfo.storageInfo.maximumPyramidLevel=k),this.updateTileInfo();case 24:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r,n){var a,i,s,o,l,c,u,f,d,p,m,b,y,x,g,O,j,k,w,I,S,_,T,R,C,M,P,F,B,D,z=arguments;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=z.length>3&&void 0!==z[3]?z[3]:{},i=this.rasterInfo.storageInfo,s=i.blockWidth,o=i.blockHeight,l=i.blockBoundary,!(!(c=l[t])||c.maxRow<r||c.maxCol<n||c.minRow>r||c.minCol>n)){e.next=4;break}return e.abrupt("return",null);case 4:if(u=this.rasterInfo,f=u.bandCount,d=u.pixelType,p=this._getTileLocation(t,r,n),m=p.ranges,b=p.actualTileWidth,y=p.actualTileHeight,m&&0!==m.length){e.next=7;break}return e.abrupt("return",null);case 7:if(0!==m[0].from||0!==m[0].to){e.next=10;break}return x=new Uint8Array(s*o),e.abrupt("return",new qe.a({width:s,height:o,pixels:null,mask:x,validPixelCount:0}));case 10:for(g=this.ioConfig.bandIds,O=this._getBandSegmentCount(),j=[],k=0,k=0;k<O;k++)(!g||g.indexOf[k]>-1)&&j.push(this.request(this._files.data,{range:{from:m[k].from,to:m[k].to},responseType:"array-buffer",signal:a.signal}));return e.next=15,Promise.all(j);case 15:for(w=e.sent,I=w.map((function(e){return e.data.byteLength})).reduce((function(e,t){return e+t})),S=new Uint8Array(I),_=0,k=0;k<O;k++)S.set(new Uint8Array(w[k].data),_),_+=w[k].data.byteLength;return T=Ve.get(this.rasterInfo.storageInfo.compression).decoderFormat,e.next=23,this.decodePixelBlock(S.buffer,{width:s,height:o,format:T,planes:(null===g||void 0===g?void 0:g.length)||f,pixelType:d});case 23:if(R=e.sent,Object(v.k)(this.rasterInfo.noDataValue)&&"lerc"!==T&&!R.mask&&null!=(C=this.rasterInfo.noDataValue[0])){if(M=R.width*R.height,P=new Uint8Array(M),Math.abs(C)>1e24)for(k=0;k<M;k++)Math.abs((R.pixels[0][k]-C)/C)>1e-6&&(P[k]=1);else for(k=0;k<M;k++)R.pixels[0][k]!==C&&(P[k]=1);R.mask=P}if(F=0,B=0,b!==s||y!==o)if(D=R.mask)for(k=0;k<o;k++)if(B=k*s,k<y)for(F=b;F<s;F++)D[B+F]=0;else for(F=0;F<s;F++)D[B+F]=0;else for(D=new Uint8Array(s*o),R.mask=D,k=0;k<y;k++)for(B=k*s,F=0;F<b;F++)D[B+F]=1;return e.abrupt("return",R);case 28:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_parseIndex",value:function(e){if(e.byteLength%16>0)throw"invalid array buffer must be multiples of 16";var t,r,n,a,i,s;if(Ge.a){for(r=new Uint8Array(e),a=new ArrayBuffer(e.byteLength),n=new Uint8Array(a),i=0;i<e.byteLength/4;i++)for(s=0;s<4;s++)n[4*i+s]=r[4*i+3-s];t=new Uint32Array(a)}else t=new Uint32Array(e);return t}},{key:"_getBandSegmentCount",value:function(){return Ve.get(this.rasterInfo.storageInfo.compression).isOneSegment?1:this.rasterInfo.bandCount}},{key:"_getTileLocation",value:function(e,t,r){var n,a,i,s=this.rasterInfo.storageInfo,o=s.blockWidth,l=s.blockHeight,c=s.pyramidScalingFactor,u=this.rasterInfo,f=u.width,h=u.height,d=this._getBandSegmentCount(),p=0,m=0;for(i=0;i<e;i++)m=Math.pow(c,i),p+=(n=Math.ceil(f/o/m))*(a=Math.ceil(h/l/m));m=Math.pow(c,e),n=Math.ceil(f/o/m),a=Math.ceil(h/l/m),p+=t*n+r,p*=4*d;for(var b=this._storageIndex.subarray(p,p+4*d),v=0,y=0,x=[],g=0;g<d;g++)y=(v=b[4*g+0]*Math.pow(2,32)+b[4*g+1])+b[4*g+2]*Math.pow(2,32)+b[4*g+3],x.push({from:v,to:y});return{ranges:x,actualTileWidth:r<n-1?o:Math.ceil(f/m)-o*(n-1),actualTileHeight:t<a-1?l:Math.ceil(h/m)-l*(a-1)}}},{key:"_parseHeader",value:function(e){var t=Ie(e,"MRF_META/Raster");if(!t)throw new b.a("mrf:open","not a valid MRF format");var r=Ie(t,"Size"),n=parseInt(r.getAttribute("x"),10),a=parseInt(r.getAttribute("y"),10),i=parseInt(r.getAttribute("c"),10),s=(Se(t,"Compression")||"none").toLowerCase();if(!Ve.has(s))throw new b.a("mrf:open","currently does not support compression "+s);var o=Se(t,"DataType")||"UInt8",l=Ue.get(o);if(null==l)throw new b.a("mrf:open","currently does not support pixel type "+o);var c,u,f=Ie(t,"PageSize"),h=parseInt(f.getAttribute("x"),10),d=parseInt(f.getAttribute("y"),10),p=Ie(t,"DataValues");if(p&&(null!=(u=p.getAttribute("NoData"))&&(c=u.trim().split(" ").map((function(e){return parseFloat(e)})))),Ie(e,"MRF_META/CachedSource"))throw new b.a("mrf:open","currently does not support MRF referencing other data files");var m,v=Ie(e,"MRF_META/GeoTags"),y=Ie(v,"BoundingBox"),x=!1;if(null!=y){var g,O=parseFloat(y.getAttribute("minx")),j=parseFloat(y.getAttribute("miny")),k=parseFloat(y.getAttribute("maxx")),w=parseFloat(y.getAttribute("maxy")),I=Se(v,"Projection")||"";if("LOCAL_CS[]"!==I)if(I.toLowerCase().startsWith("epsg:")){var S=Number(I.slice(5));isNaN(S)||0===S||(g=new U.a({wkid:S}))}else g=Pe(I);else x=!0,g=new U.a({wkid:3857});(m=new G.a(O,j,k,w)).spatialReference=g}else x=!0,m=new G.a({xmin:-.5,ymin:.5-a,xmax:n-.5,ymax:.5,spatialReference:new U.a({wkid:3857})});var _=Ie(e,"MRF_META/Rsets"),T=parseInt(_&&_.getAttribute("scale")||"2",10),R=m.spatialReference,C=new re.a({origin:new ue.a({x:m.xmin,y:m.ymax,spatialReference:R}),blockWidth:h,blockHeight:d,pyramidBlockWidth:h,pyramidBlockHeight:d,compression:s,pyramidScalingFactor:T}),M=new ue.a({x:m.width/n,y:m.height/a,spatialReference:R}),P=new te.a({width:n,height:a,extent:m,isPseudoSpatialReference:x,spatialReference:R,bandCount:i,pixelType:l,pixelSize:M,noDataValue:c,storageInfo:C}),F=Se(e,"datafile"),B=Se(e,"IndexFile");return{rasterInfo:P,files:{mrf:this.url,index:B||this.url.replace(".mrf",".idx"),data:F||this.url.replace(".mrf",Ve.get(s).blobExtension)}}}},{key:"_fetchAuxiliaryData",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r,n;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".aux.xml",{responseType:"xml",signal:null===t||void 0===t?void 0:t.signal});case 3:return r=e.sent,n=r.data,e.abrupt("return",Be(n));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(t){return e.apply(this,arguments)}}()}]),r}(he);Object(d.a)([Object(O.b)()],Ye.prototype,"_files",void 0),Object(d.a)([Object(O.b)()],Ye.prototype,"_storageIndex",void 0),Object(d.a)([Object(O.b)({type:String,json:{write:!0}})],Ye.prototype,"datasetFormat",void 0);var Xe=Ye=Object(d.a)([Object(S.a)("esri.layers.support.rasterIO.MRFRaster")],Ye),Ke=r(1022),Ze=r(1024),$e=function(e,t){var r=e.get(t);return r&&r.values},Qe=function(e,t){var r=e.get(t);return r&&r.values[0]},et=function(e){Object(c.a)(r,e);var t=Object(u.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments))._files=null,e._headerInfo=null,e._bufferSize=1048576,e.datasetFormat="TIFF",e}return Object(s.a)(r,[{key:"open",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r,n,i,s,o,l,c,u,f,d,p,m,y,x,g,O,j,k,w,I,S,_,T,R,C,M,P,F,B,D,z,A,E,L,N,H,J,W;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return s=t?Object(v.q)(t.signal):null,e.next=5,this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:s});case 5:if(o=e.sent,l=o.data){e.next=9;break}throw new b.a("tiffraster:open","failed to open url "+this.url);case 9:return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),c=Object(Ke.g)(l),u=c.littleEndian,f=c.firstIFD,d=c.isBigTiff,p=[],e.next=13,this._readIFDs(p,l,u,f,0,d?8:4,s);case 13:if(m=Object(Ke.c)(p),y=m.width,x=m.height,g=m.tileWidth,O=m.tileHeight,j=m.planes,k=m.pixelType,w=m.compression,I=m.firstPyramidLevel,S=m.maximumPyramidLevel,_=m.pyramidBlockWidth,T=m.pyramidBlockHeight,R=m.tileBoundary,C=m.affine,M=m.metadata,P=(null===(r=m.extent.spatialReference)||void 0===r?void 0:r.wkt)||(null===(n=m.extent.spatialReference)||void 0===n?void 0:n.wkid),F=Pe(P),B=!1,null==F&&(B=!0,F=new U.a({wkid:3857})),D=new G.a(Object(a.a)(Object(a.a)({},m.extent),{},{spatialReference:F})),z=new ue.a(D?{x:D.xmin,y:D.ymax,spatialReference:F}:{x:0,y:0}),A=new re.a({blockWidth:g,blockHeight:O,pyramidBlockWidth:_,pyramidBlockHeight:T,compression:w,origin:z,firstPyramidLevel:I,maximumPyramidLevel:S,blockBoundary:R}),E=new ue.a({x:(D.xmax-D.xmin)/y,y:(D.ymax-D.ymin)/x,spatialReference:F}),L=M?{BandProperties:M.bandProperties,DataType:M.dataType}:{},N=new te.a({width:y,height:x,bandCount:j,pixelType:k,compression:w,pixelSize:E,storageInfo:A,spatialReference:F,isPseudoSpatialReference:B,keyProperties:L,extent:D,statistics:M?M.statistics:null}),null!==C&&void 0!==C&&C.length&&(N.nativeExtent=new G.a({xmin:-.5,ymin:.5-x,xmax:y-.5,ymax:.5,spatialReference:F}),N.transform=new Ce.a({polynomialOrder:1,forwardCoefficients:[C[2]+C[0]/2,C[5]-C[3]/2,C[0],C[3],-C[1],-C[4]]}),N.extent=N.transform.forwardTransform(N.nativeExtent),N.pixelSize=new ue.a({x:(D.xmax-D.xmin)/y,y:(D.ymax-D.ymin)/x,spatialReference:F}),A.origin.x=-.5,A.origin.y=.5),null!==(i=this.ioConfig.skipExtensions)&&void 0!==i&&i.includes("aux.xml")){e.next=22;break}return e.next=20,this._fetchAuxiliaryData(t);case 20:null!=(H=e.sent)&&(N.statistics=null!==(J=H.statistics)&&void 0!==J?J:N.statistics,N.histograms=H.histograms,H.histograms&&Object(v.j)(N.statistics)&&(N.statistics=Object(Oe.d)(H.histograms)),H.transform&&!C&&(N.transform=H.transform,N.nativeExtent=N.extent,W=N.transform.forwardTransform(N.nativeExtent),N.pixelSize=new ue.a({x:(W.xmax-W.xmin)/y,y:(W.ymax-W.ymin)/x,spatialReference:F}),N.extent=W),N.spatialReference||(N.spatialReference=H.spatialReference));case 22:if(this._set("rasterInfo",N),this._headerInfo=Object(a.a)({littleEndian:u,isBigTiff:d,ifds:p},m),this._headerInfo.isSupported){e.next=24;break}throw new b.a("tiffraster:open","this tiff is not supported: "+this._headerInfo.message);case 24:this.updateTileInfo();case 25:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r,n){var a,i,s,o,l,c,u,f,d,p,m,b,v,y,x,g,O,j,k,w,I,S,_,T,R,C=this,M=arguments;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=M.length>3&&void 0!==M[3]?M[3]:{},null!==(a=this._headerInfo)&&void 0!==a&&a.isSupported&&!this.isBlockOutside(t,r,n)){e.next=3;break}return e.abrupt("return",null);case 3:if(s=this._getTileLocation(t,r,n)){e.next=6;break}return e.abrupt("return",null);case 6:return o=s.ranges,l=s.actualTileWidth,c=s.actualTileHeight,u=s.ifd,f=o.map((function(e){return C.request(C.url,{range:e,responseType:"array-buffer",signal:i.signal})})),e.next=13,Promise.all(f);case 13:if(d=e.sent,p=d.map((function(e){return e.data.byteLength})).reduce((function(e,t){return e+t})),m=1===d.length?d[0].data:new ArrayBuffer(p),b=[0],v=[0],d.length>1)for(y=new Uint8Array(m),x=0,g=0;x<d.length;x++)O=d[x].data,y.set(new Uint8Array(O),g),b[x]=g,g+=O.byteLength,v[x]=O.byteLength;return j=this.getBlockWidthHeight(t),k=j.blockWidth,w=j.blockHeight,e.next=24,this.decodePixelBlock(m,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:u,offsets:b,sizes:v},width:k,height:w,planes:null,pixelType:null});case 24:if(I=e.sent,l!==k||c!==w)if(R=I.mask)for(S=0;S<w;S++)if(T=S*k,S<c)for(_=l;_<k;_++)R[T+_]=0;else for(_=0;_<k;_++)R[T+_]=0;else for(R=new Uint8Array(k*w),I.mask=R,S=0;S<c;S++)for(T=S*k,_=0;_<l;_++)R[T+_]=1;return e.abrupt("return",I);case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_readIFDs",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r,n,a,i){var s,o,l,c=arguments;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=c.length>5&&void 0!==c[5]?c[5]:4,o=c.length>6?c[6]:void 0,a){e.next=4;break}return e.abrupt("return",null);case 4:if(!(a>=r.byteLength||a<0)){e.next=10;break}return e.next=7,this.request(this.url,{range:{from:a+i,to:a+i+this._bufferSize},responseType:"array-buffer",signal:o});case 7:r=e.sent.data,i=a+i,a=0;case 10:return e.next=12,this._readIFD(r,n,a,i,Ze.a.TIFF_TAGS,s,o);case 12:if(l=e.sent,t.push(l.ifd),l.nextIFD){e.next=15;break}return e.abrupt("return",null);case 15:return e.next=17,this._readIFDs(t,r,n,l.nextIFD-i,i,s,o);case 17:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a,i){return e.apply(this,arguments)}}()},{key:"_readIFD",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r,n,a){var i,s,o,l,c,u,f,d,p,m,b,v,y,x,g=arguments;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=g.length>4&&void 0!==g[4]?g[4]:Ze.a.TIFF_TAGS,s=g.length>5&&void 0!==g[5]?g[5]:4,o=g.length>6?g[6]:void 0,t){e.next=5;break}return e.abrupt("return",null);case 5:if(!(l=Object(Ke.f)(t,r,n,a,i,s)).success){e.next=25;break}if(c=[],l.ifd.forEach((function(e){e.values||c.push(e)})),!(c.length>0)){e.next=16;break}if(u=c.map((function(e){return e.offlineOffsetSize})),f=Math.min.apply(null,u.map((function(e){return e[0]}))),!(Math.min.apply(null,u.map((function(e){return e[0]+e[1]})))-f<=this._bufferSize)){e.next=16;break}return e.next=13,this.request(this.url,{range:{from:f,to:f+this._bufferSize},responseType:"array-buffer",signal:o});case 13:d=e.sent,p=d.data,t=p,a=f,c.forEach((function(e){return Object(Ke.e)(t,r,e,a)}));case 16:if(!l.ifd.has("GEOKEYDIRECTORY")){e.next=24;break}if(m=l.ifd.get("GEOKEYDIRECTORY"),!((b=m.values)&&b.length>4)){e.next=24;break}return v=b[0]+"."+b[1]+"."+b[2],e.next=22,this._readIFD(t,r,m.valueOffset+6-a,a,Ze.a.GEO_KEYS,2,o);case 22:y=e.sent,m.data=y.ifd,m.data&&m.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[v]});case 24:return e.abrupt("return",l);case 25:if(!l.requiredBufferSize||l.requiredBufferSize===t.byteLength){e.next=30;break}return e.next=28,this.request(this.url,{range:{from:a,to:a+l.requiredBufferSize+4},responseType:"array-buffer",signal:o});case 28:return x=e.sent,e.abrupt("return",(t=x.data).byteLength<l.requiredBufferSize?null:this._readIFD(t,r,0,a,Ze.a.TIFF_TAGS,4,o));case 30:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"_getTileLocation",value:function(e,t,r){var n=this.rasterInfo.storageInfo,a=n.firstPyramidLevel,i=n.blockBoundary,s=0===e?0:e-(a-1),o=this._headerInfo.ifds[s];if(!o)return null;var l=Object(Ke.d)(o,this._headerInfo),c=$e(o,"TILEOFFSETS");if(void 0===c)return null;var u=$e(o,"TILEBYTECOUNTS"),f=i[s],h=f.minRow,d=f.minCol,p=f.maxRow,m=f.maxCol;if(t>p||r>m||t<h||r<d)return null;var b=Qe(o,"IMAGEWIDTH"),v=Qe(o,"IMAGELENGTH"),y=Qe(o,"TILEWIDTH"),x=Qe(o,"TILELENGTH"),g=l?this.rasterInfo.bandCount:1,O=g*t*(m+1)+r,j=[{from:c[O],to:c[O+g-1]+u[O+g-1]-1}];if(l){for(var k=!0,w=0;w<g;w++)if(c[O+w]+u[O+w]!==c[O+w+1]){k=!1;break}if(!k)for(var I=0;I<g;I++)j[I]={from:c[O+I],to:c[O+I]+u[O+I]-1}}var S=c[O],_=u[O];return null==S||null==_?null:{ranges:j,ifd:o,actualTileWidth:r===m?b%y:y,actualTileHeight:t===p?v%x:x}}},{key:"_fetchAuxiliaryData",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r,n;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".aux.xml",{responseType:"xml",signal:null===t||void 0===t?void 0:t.signal});case 3:return r=e.sent,n=r.data,e.abrupt("return",Be(n));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(t){return e.apply(this,arguments)}}()}]),r}(he);Object(d.a)([Object(O.b)()],et.prototype,"_files",void 0),Object(d.a)([Object(O.b)()],et.prototype,"_headerInfo",void 0),Object(d.a)([Object(O.b)()],et.prototype,"_bufferSize",void 0),Object(d.a)([Object(O.b)({type:String,json:{write:!0}})],et.prototype,"datasetFormat",void 0);var tt=et=Object(d.a)([Object(S.a)("esri.layers.support.rasterDatasets.TIFFRaster")],et),rt=new Map;rt.set("CRF",{desc:"Cloud Raster Format",constructor:ge}),rt.set("MRF",{desc:"Meta Raster Format",constructor:Xe}),rt.set("TIFF",{desc:"GeoTIFF",constructor:tt}),rt.set("RasterTileServer",{desc:"Raster Tile Server",constructor:We}),rt.set("JPG",{desc:"JPG Raster Format",constructor:ze}),rt.set("PNG",{desc:"PNG Raster Format",constructor:ze}),rt.set("GIF",{desc:"GIF Raster Format",constructor:ze}),rt.set("BMP",{desc:"BMP Raster Format",constructor:ze});var nt=function(){function e(){Object(i.a)(this,e)}return Object(s.a)(e,null,[{key:"supportedFormats",get:function(){var e=new Set;return rt.forEach((function(t,r){return e.add(r)})),e}},{key:"open",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r,n,a,i,s,o,l,c,u,f;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.url,n=t.ioConfig,a=t.sourceJSON,null==(i=t.datasetFormat)&&r.lastIndexOf(".")&&(i=r.slice(r.lastIndexOf(".")+1).toUpperCase()),"OVR"===i||"TIF"===i?i="TIFF":"JPG"!==i&&"JPEG"!==i&&"JFIF"!==i||(i="JPG"),r.toLowerCase().includes("/imageserver")&&!r.toLowerCase().includes("/wcsserver")&&(i="RasterTileServer"),s={url:r,sourceJSON:a,datasetFormat:i,ioConfig:n||{bandIds:null,sampling:null}},!this.supportedFormats.has(i)){e.next=12;break}if("CRF"!==i||n.enableCRF){e.next=7;break}throw new b.a("rasterfactory:open","cannot open raster: ".concat(r));case 7:return o=rt.get(i).constructor,l=new o(s),e.next=11,l.open({signal:t.signal});case 11:return e.abrupt("return",l);case 12:if(!i){e.next=14;break}throw new b.a("rasterfactory:open","not a supported format "+i);case 14:return c=Array.from(rt.keys()),u=0,f=function e(){return(i=c[u++])&&("CRF"!==i||n.enableCRF)?(o=rt.get(i).constructor,(l=new o(s)).open({signal:t.signal}).then((function(){return l})).catch((function(){return e()}))):null},e.abrupt("return",f());case 18:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"register",value:function(e,t,r){rt.has(e.toUpperCase())||rt.set(e.toUpperCase(),{desc:t,constructor:r})}}]),e}(),at=r(464),it=function(e){Object(c.a)(r,e);var t=Object(u.a)(r);function r(){var e;Object(i.a)(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return(e=t.call.apply(t,[this].concat(a))).bandIds=null,e.interpolation=null,e.legendEnabled=!0,e.isReference=null,e.listMode="show",e.sourceJSON=null,e.version=null,e.title=null,e.type="imagery-tile",e.operationalLayerType="ArcGISTiledImageServiceLayer",e.popupEnabled=!0,e.popupTemplate=null,e.fields=null,e}return Object(s.a)(r,[{key:"normalizeCtorArgs",value:function(e,t){return"string"==typeof e?Object(a.a)({url:e},t):e}},{key:"load",value:function(e){var t=this,r=Object(v.k)(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},e).catch(x.o).then((function(){return t._openRaster(r)}))),Promise.resolve(this)}},{key:"defaultPopupTemplate",get:function(){return this.createPopupTemplate()}},{key:"rasterFields",get:function(){var e,t,r=[new Q.a({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"})],n=null===(e=this.rasterInfo)||void 0===e||null===(t=e.attributeTable)||void 0===t?void 0:t.fields;if(n){var a=n.filter((function(e){return"oid"!==e.type&&"value"!==e.name.toLowerCase()})).map((function(e){var t=e.clone();return t.name="Raster."+e.name,t}));r=r.concat(a)}var i=this.rasterInfo.dataType;if(("vector-magdir"===i||"vector-uv"===i)&&Object(v.k)(this.rasterInfo.multidimensionalInfo)){var s,o=null===(s=this.rasterInfo.multidimensionalInfo.variables[0].unit)||void 0===s?void 0:s.trim(),l="Magnitude"+(o?" (".concat(o,")"):"");r.push(new Q.a({name:"Raster.Magnitude",alias:l,domain:null,editable:!1,type:"double"})),r.push(new Q.a({name:"Raster.Direction",alias:"Direction (\xb0)",domain:null,editable:!1,type:"double"}))}return r}},{key:"renderer",set:function(e){this._set("renderer",e),this.updateRenderer()}},{key:"readRenderer",value:function(e,t,r){var n=t&&t.layerDefinition&&t.layerDefinition.drawingInfo&&t.layerDefinition.drawingInfo.renderer,a=Object(m.b)(n,r)||void 0;if(null!=a)return a}},{key:"createPopupTemplate",value:function(e){return Object(at.a)({fields:this.rasterFields,title:this.title},e)}},{key:"write",value:function(e,t){var n=this.raster;if(this.loaded?"RasterTileServer"===n.datasetFormat&&("Raster"===n.tileType||"Map"===n.tileType):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))return Object(o.a)(Object(l.a)(r.prototype),"write",this).call(this,e,t);if(t&&t.messages){var a="".concat(t.origin,"/").concat(t.layerContainerType||"operational-layers");t.messages.push(new b.a("layer:unsupported","Layers (".concat(this.title,", ").concat(this.id,") of type '").concat(this.declaredClass,"' are not supported in the context of '").concat(a,"'"),{layer:this}))}return null}},{key:"_openRaster",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r,n=this;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.raster){e.next=8;break}if(e.t0=this.raster.rasterInfo,e.t0){e.next=5;break}return e.next=5,this.raster.open();case 5:this.url=this.raster.url,e.next=11;break;case 8:return e.next=10,nt.open({url:this.url,sourceJSON:this.sourceJSON,ioConfig:Object(a.a)(Object(a.a)({sampling:"closest"},this.ioConfig),{},{customFetchParameters:this.customParameters}),signal:t});case 10:this.raster=e.sent;case 11:if(this.raster.rasterInfo){e.next=14;break}throw new b.a("imagery-tile-layer:load","cannot load resources on "+this.url);case 14:this.sourceJSON=this.sourceJSON||this.raster.sourceJSON,null!=this.sourceJSON&&(r="Map"===this.raster.tileType&&null!=this.sourceJSON.minLOD&&null!=this.sourceJSON.maxLOD?this.sourceJSON:Object(a.a)(Object(a.a)({},this.sourceJSON),{},{minScale:0,maxScale:0}),this.read(r,{origin:"service"})),null==this.title&&(this.title=this.raster.datasetName),"Map"===this.raster.tileType&&(this.popupEnabled=!1),this._configDefaultSettings(),this.own(Object(g.e)((function(){return n.customParameters}),(function(e){n.raster.ioConfig.customFetchParameters=e})));case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),r}(Object(T.a)(Object(Z.a)(Object(Y.a)(Object(X.a)(Object(R.a)(function(e){var t=function(e){Object(c.a)(r,e);var t=Object(u.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments))._rasterJobHandler={instance:null,refCount:0,connectionPromise:null},e.bandIds=null,e.copyright=null,e.fullExtent=null,e.interpolation="nearest",e.multidimensionalDefinition=null,e.raster=null,e.rasterInfo=null,e.sourceJSON=null,e.spatialReference=null,e.tileInfo=null,e.symbolizer=null,e}return Object(s.a)(r,[{key:"url",set:function(e){this._set("url",Object(D.h)(e,V))}},{key:"renderer",set:function(e){this._set("renderer",e),this.updateRenderer()}},{key:"convertVectorFieldData",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r){var n,a;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(v.j)(t)){e.next=2;break}return e.abrupt("return",null);case 2:return n=this._rasterJobHandler.instance,a=this.rasterInfo.dataType,e.abrupt("return",n?n.convertVectorFieldData({pixelBlock:t,dataType:a},r):Object(H.b)(t,a));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"createFlowMesh",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r){var n;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._rasterJobHandler.instance,e.abrupt("return",n?n.createFlowMesh(t,r):Object(q.a)(t.meshType,t.simulationSettings,t.flowData,Object(v.k)(r.signal)?r.signal:(new AbortController).signal));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"normalizeRasterFetchOptions",value:function(e){var t=this.rasterInfo.multidimensionalInfo;if(Object(v.j)(t))return e;var r=e.multidimensionalDefinition||this.multidimensionalDefinition;!Object(v.j)(r)&&r.length||(r=Object(N.b)(this.raster.rasterInfo));var n=e.timeExtent||this.timeExtent;if(Object(v.k)(r)&&Object(v.k)(n)&&(Object(v.k)(n.start)||Object(v.k)(n.end))){var i,s;r=r.map((function(e){return e.clone()}));var o=null===(i=t.variables.find((function(e){return e.name===r[0].variableName})))||void 0===i||null===(s=i.dimensions)||void 0===s?void 0:s.find((function(e){return"StdTime"===e.name})),l=r.find((function(e){return"StdTime"===e.dimensionName}));if(!o||!l)return Object(a.a)(Object(a.a)({},e),{},{multidimensionalDefinition:null});var c=n.start,u=n.end,f=Object(v.j)(c)?null:c.getTime(),h=Object(v.j)(u)?null:u.getTime(),d=null!==f&&void 0!==f?f:h,p=null!==h&&void 0!==h?h:f;if(Object(v.k)(o.values)){var m=o.values.filter((function(e){if(Array.isArray(e)){if(d===p)return e[0]<=d&&e[1]>=d;var t=e[0]<=d&&e[1]>d||e[0]<p&&e[1]>=p,r=e[0]>=d&&e[1]<=p||e[0]<d&&e[1]>p;return t||r}return d===p?e===d:e>=d&&e<=p}));if(m.length){var b=m.sort((function(e,t){var r,n,a,i;return d===p?(null!==(r=e[0])&&void 0!==r?r:e)-(null!==(n=t[0])&&void 0!==n?n:t):Math.abs((null!==(a=e[1])&&void 0!==a?a:e)-p)-Math.abs((null!==(i=t[1])&&void 0!==i?i:t)-p)}))[0];l.values=[b]}else r=null}else if(o.hasRegularIntervals&&o.extent){var y=Object(C.a)(o.extent,2),x=y[0],g=y[1];d>g||p<x?r=null:l.values=d===p?[d]:[Math.max(x,d),Math.min(g,p)]}}return Object(a.a)(Object(a.a)({},e),{},{multidimensionalDefinition:r})}},{key:"updateRenderer",value:function(){var e=Object(n.a)(h.a.mark((function e(){var t;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.loaded){e.next=2;break}return e.abrupt("return");case 2:if(JSON.stringify(this._cachedRendererJson)!==JSON.stringify(this.renderer)){e.next=4;break}return e.abrupt("return");case 4:if(t=this._rasterJobHandler.instance,e.t0=t,!e.t0){e.next=12;break}return this.symbolizer.rendererJSON=Object(J.e)(this.renderer.toJSON()),this.symbolizer.bind(),e.next=11,t.updateSymbolizer(this.symbolizer);case 11:this._cachedRendererJson=this.renderer.toJSON();case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"applyRenderer",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r){var n,i,s,o;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t&&t.pixelBlock,Object(v.k)(n)&&n.pixels&&n.pixels.length>0){e.next=3;break}return e.abrupt("return",null);case 3:return e.next=5,this.updateRenderer();case 5:if(s=this._rasterJobHandler.instance,o=this.bandIds,!s){e.next=12;break}return e.next=9,s.symbolize(Object(a.a)(Object(a.a)({},t),{},{simpleStretchParams:r,bandIds:o}));case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0=this.symbolizer.symbolize(Object(a.a)(Object(a.a)({},t),{},{simpleStretchParams:r,bandIds:o}));case 13:return i=e.t0,e.abrupt("return",i);case 15:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getTileUrl",value:function(e,t,r){return"RasterTileServer"===this.raster.datasetFormat?"".concat(this.url,"/tile/").concat(e,"/").concat(t,"/").concat(r):""}},{key:"getCompatibleTileInfo",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.loaded||Object(v.j)(t))return null;if(r&&e.equals(this.spatialReference))return this.tileInfo;var n=Object(B.e)(e);return L.a.create({size:256,spatialReference:e,origin:n?{x:n.origin[0],y:n.origin[1]}:{x:t.xmin,y:t.ymax}})}},{key:"getCompatibleFullExtent",value:function(e){return this.loaded?(this._compatibleFullExtent&&this._compatibleFullExtent.spatialReference.equals(e)||(this._compatibleFullExtent=this.raster.computeExtent(e)),this._compatibleFullExtent):null}},{key:"fetchTile",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r,n){var i,s,o,l=arguments;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(i=l.length>3&&void 0!==l[3]?l[3]:{}).requestAsImageElement){e.next=4;break}return s=this.getTileUrl(t,r,n),e.abrupt("return",Object(M.default)(s,{responseType:"image",query:Object(a.a)(Object(a.a)({},this.refreshParameters),this.raster.ioConfig.customFetchParameters),signal:i.signal}).then((function(e){return e.data})));case 4:if(!Object(v.k)(this.rasterInfo.multidimensionalInfo)||(i=this.normalizeRasterFetchOptions(i),!Object(v.j)(i.multidimensionalDefinition))){e.next=7;break}return o=i.tileInfo||this.rasterInfo.storageInfo.tileInfo,e.abrupt("return",{extent:this.raster.getTileExtentFromTileInfo(t,r,n,o),pixelBlock:null});case 7:return e.next=9,this._initJobHandler();case 9:return"raster-shaded-relief"===this.renderer.type&&(i=Object(a.a)(Object(a.a)({},i),{},{buffer:{cols:1,rows:1}})),e.abrupt("return",this.raster.fetchTile(t,r,n,i));case 11:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"fetchPixels",value:function(){var e=Object(n.a)(h.a.mark((function e(t,r,n){var a,i=arguments;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=i.length>3&&void 0!==i[3]?i[3]:{},!Object(v.k)(this.rasterInfo.multidimensionalInfo)||(a=this.normalizeRasterFetchOptions(a),!Object(v.j)(a.multidimensionalDefinition))){e.next=5;break}e.t0={extent:t,pixelBlock:null},e.next=8;break;case 5:return e.next=7,this._initJobHandler();case 7:e.t0=this.raster.fetchPixels(t,r,n,a);case 8:return e.abrupt("return",e.t0);case 9:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"identify",value:function(){var e=Object(n.a)(h.a.mark((function e(t){var r,n=arguments;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n.length>1&&void 0!==n[1]?n[1]:{},!Object(v.k)(this.rasterInfo.multidimensionalInfo)){e.next=4;break}if(this.rasterInfo.hasMultidimensionalTranspose&&(Object(N.e)(r.multidimensionalDefinition)||r.transposedVariableName||r.timeExtent)||(r=this.normalizeRasterFetchOptions(r),!Object(v.j)(r.multidimensionalDefinition))){e.next=4;break}return e.abrupt("return",{location:t,value:null});case 4:return e.abrupt("return",this.raster.identify(t,r));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"increaseRasterJobHandlerUsage",value:function(){this._rasterJobHandler.refCount++}},{key:"decreaseRasterJobHandlerUsage",value:function(){this._rasterJobHandler.refCount--,this._rasterJobHandler.refCount<=0&&this._shutdownJobHandler()}},{key:"hasStandardTime",value:function(){var e,t=this.rasterInfo.multidimensionalInfo;if(Object(v.j)(t)||"standard-time"!==this.rasterInfo.dataType)return!1;var r=null===(e=this.multidimensionalDefinition[0])||void 0===e?void 0:e.variableName;return t.variables.some((function(e){return e.name===r&&e.dimensions.some((function(e){return"StdTime"===e.name}))}))}},{key:"getStandardTimeValue",value:function(e){return new Date(24*(e-25569)*3600*1e3).toString()}},{key:"_configDefaultSettings",value:function(){this._configDefaultInterpolation(),this.multidimensionalDefinition||(this.multidimensionalDefinition=Object(N.b)(this.raster.rasterInfo)),this._configDefaultRenderer()}},{key:"_initJobHandler",value:function(){var e=this;if(null!=this._rasterJobHandler.connectionPromise)return this._rasterJobHandler.connectionPromise;var t=new E.a;return this._rasterJobHandler.connectionPromise=t.initialize().then((function(){e._rasterJobHandler.instance=t,e.raster.rasterJobHandler=t,e.renderer&&e.updateRenderer()})).catch((function(){return null})),this._rasterJobHandler.connectionPromise}},{key:"_shutdownJobHandler",value:function(){this._rasterJobHandler.instance&&this._rasterJobHandler.instance.destroy(),this._rasterJobHandler.instance=null,this._rasterJobHandler.connectionPromise=null,this._rasterJobHandler.refCount=0,this.raster.rasterJobHandler=null,this._cachedRendererJson=null}},{key:"_configDefaultInterpolation",value:function(){if(null==this.interpolation){var e,t=Object(J.c)(this.rasterInfo,this.raster.tileType,null===(e=this.sourceJSON)||void 0===e?void 0:e.defaultResamplingMethod);this._set("interpolation",t)}}},{key:"_configDefaultRenderer",value:function(){var e=this.raster.rasterInfo;if(this.bandIds||(this.bandIds=Object(J.b)(e)),!this.renderer){var t,r,n,a=Object(J.a)(e,{bandIds:this.bandIds,variableName:Object(v.k)(this.multidimensionalDefinition)?null===(t=this.multidimensionalDefinition[0])||void 0===t?void 0:t.variableName:null});"WCSServer"===this.raster.datasetFormat&&"raster-stretch"===a.type&&((null===(r=e.statistics)||void 0===r?void 0:r[0].max)>1e24||(null===(n=e.statistics)||void 0===n?void 0:n[0].min)<-1e24)&&(a.dynamicRangeAdjustment=!0,a.statistics=null,"none"===a.stretchType&&(a.stretchType="min-max")),this.renderer=a}this.symbolizer?(this.symbolizer.rendererJSON=Object(J.e)(this.renderer.toJSON()),this.symbolizer.rasterInfo=e):this.symbolizer=new W.a({rendererJSON:this.renderer.toJSON(),rasterInfo:e});var i=this.symbolizer.bind();i.success||V.warn("imagery-tile-mixin",i.error||"The given renderer is not supported by the layer.")}}]),r}(e);return Object(d.a)([Object(O.b)()],t.prototype,"_cachedRendererJson",void 0),Object(d.a)([Object(O.b)()],t.prototype,"_compatibleFullExtent",void 0),Object(d.a)([Object(O.b)()],t.prototype,"_rasterJobHandler",void 0),Object(d.a)([Object(O.b)()],t.prototype,"bandIds",void 0),Object(d.a)([Object(O.b)({json:{origins:{service:{read:{source:"copyrightText"}}}}})],t.prototype,"copyright",void 0),Object(d.a)([Object(O.b)({type:G.a,json:{read:!1}}),Object(F.a)("rasterInfo.extent")],t.prototype,"fullExtent",void 0),Object(d.a)([Object(O.b)()],t.prototype,"interpolation",void 0),Object(d.a)([Object(O.b)()],t.prototype,"ioConfig",void 0),Object(d.a)([Object(O.b)({type:[A.a]})],t.prototype,"multidimensionalDefinition",void 0),Object(d.a)([Object(O.b)()],t.prototype,"raster",void 0),Object(d.a)([Object(O.b)({readOnly:!0}),Object(F.a)("raster.rasterInfo")],t.prototype,"rasterInfo",void 0),Object(d.a)([Object(O.b)()],t.prototype,"sourceJSON",void 0),Object(d.a)([Object(O.b)({type:U.a,json:{read:!1}}),Object(F.a)("rasterInfo.spatialReference")],t.prototype,"spatialReference",void 0),Object(d.a)([Object(O.b)({type:L.a,json:{read:!1}}),Object(F.a)("rasterInfo.storageInfo.tileInfo")],t.prototype,"tileInfo",void 0),Object(d.a)([Object(O.b)(z.o)],t.prototype,"url",null),Object(d.a)([Object(O.b)({types:m.a})],t.prototype,"renderer",null),Object(d.a)([Object(O.b)()],t.prototype,"symbolizer",void 0),t=Object(d.a)([Object(S.a)("esri.layers.ImageryTileMixin")],t),t}(Object($.a)(Object(K.a)(Object(y.a)(_.a))))))))));Object(d.a)([Object(O.b)({type:[k.a],json:{write:{overridePolicy:function(){var e;return{enabled:!this.loaded||"Raster"===this.raster.tileType||"0,1,2"!==(null===(e=this.bandIds)||void 0===e?void 0:e.join(","))}}}}})],it.prototype,"bandIds",void 0),Object(d.a)([Object(O.b)({json:{write:{overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType||"bilinear"!==this.interpolation}}}}}),Object(w.a)(ee.a)],it.prototype,"interpolation",void 0),Object(d.a)([Object(O.b)({json:{write:!0}})],it.prototype,"multidimensionalDefinition",void 0),Object(d.a)([Object(O.b)(z.e)],it.prototype,"legendEnabled",void 0),Object(d.a)([Object(O.b)({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:function(){return{enabled:!1}}}}})],it.prototype,"isReference",void 0),Object(d.a)([Object(O.b)({type:["show","hide"]})],it.prototype,"listMode",void 0),Object(d.a)([Object(O.b)({json:{read:!0,write:!0}})],it.prototype,"blendMode",void 0),Object(d.a)([Object(O.b)()],it.prototype,"sourceJSON",void 0),Object(d.a)([Object(O.b)({readOnly:!0,json:{origins:{service:{read:{source:"currentVersion"}}}}})],it.prototype,"version",void 0),Object(d.a)([Object(O.b)()],it.prototype,"title",void 0),Object(d.a)([Object(O.b)({readOnly:!0,json:{read:!1}})],it.prototype,"type",void 0),Object(d.a)([Object(O.b)({type:["ArcGISTiledImageServiceLayer"]})],it.prototype,"operationalLayerType",void 0),Object(d.a)([Object(O.b)({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:function(e,t){return!t.disablePopup}},write:{target:"disablePopup",overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}},writer:function(e,t,r){t[r]=!e}}}})],it.prototype,"popupEnabled",void 0),Object(d.a)([Object(O.b)({type:p.a,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}}}}})],it.prototype,"popupTemplate",void 0),Object(d.a)([Object(O.b)({readOnly:!0})],it.prototype,"defaultPopupTemplate",null),Object(d.a)([Object(O.b)({readOnly:!0,type:[Q.a]})],it.prototype,"fields",void 0),Object(d.a)([Object(O.b)({readOnly:!0,type:[Q.a]})],it.prototype,"rasterFields",null),Object(d.a)([Object(O.b)({types:m.a,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:function(){var e,t="raster-stretch"===(null===(e=this.renderer)||void 0===e?void 0:e.type)&&"none"===this.renderer.stretchType&&!this.renderer.useGamma;return{enabled:!this.loaded||"Raster"===this.raster.tileType||!t}}},origins:{"web-scene":{types:m.c,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:function(e){return{enabled:e&&"vector-field"!==e.type&&"flow"!==e.type}}}}}}})],it.prototype,"renderer",null),Object(d.a)([Object(I.a)("renderer")],it.prototype,"readRenderer",null);var st=it=Object(d.a)([Object(S.a)("esri.layers.ImageryTileLayer")],it)},520:function(e,t,r){"use strict";r.d(t,"a",(function(){return s})),r.d(t,"b",(function(){return i}));var n=r(5),a=r(296),i={type:a.a,json:{origins:{service:{read:{source:["tileInfo","minScale","maxScale","minLOD","maxLOD"],reader:s}}}}};function s(e,t,r,i){if(!e)return null;var s=t.minScale,o=t.maxScale,l=t.minLOD,c=t.maxLOD;if(null!=l&&null!=c)return i&&i.ignoreMinMaxLOD?a.a.fromJSON(e):a.a.fromJSON(Object(n.a)(Object(n.a)({},e),{},{lods:e.lods.filter((function(e){var t=e.level;return null!=t&&t>=l&&t<=c}))}));if(0!==s&&0!==o){var u=function(e){return Math.round(1e4*e)/1e4},f=s?u(s):1/0,h=o?u(o):-1/0;return a.a.fromJSON(Object(n.a)(Object(n.a)({},e),{},{lods:e.lods.filter((function(e){var t=u(e.scale);return t<=f&&t>=h}))}))}return a.a.fromJSON(e)}},532:function(e,t,r){"use strict";r.d(t,"a",(function(){return F}));var n,a=r(155),i=r(5),s=r(142),o=r(143),l=r(144),c=r(145),u=r(154),f=r.n(u),h=r(148),d=r(186),p=r(181),m=r(482),b=r(159),v=r(215),y=r(156),x=r(408),g=r(456),O=r(162),j=r(175),k=r(371),w=r(183),I=r(151),S=r(152),_=(r(147),r(248)),T=r(149),R=r(161),C=function(){function e(){Object(s.a)(this,e),this.location={left:0,top:0,width:0,height:0},this._allAvailability="unknown",this.byteSize=40}return Object(o.a)(e,[{key:"getAvailability",value:function(e,t){if("unknown"!==this._allAvailability)return this._allAvailability;var r=(e-this.location.top)*this.location.width+(t-this.location.left),n=r%8,a=r>>3,i=this._tileAvailabilityBitSet;return a<0||a>i.length?"unknown":i[a]&1<<n?"available":"unavailable"}},{key:"_updateFromData",value:function(e){for(var t=this.location.width,r=this.location.height,n=!0,a=!0,i=Math.ceil(t*r/8),s=new Uint8Array(i),o=0,l=0;l<e.length;l++){var c=l%8;e[l]?(a=!1,s[o]|=1<<c):n=!1,7===c&&++o}a?this._allAvailability="unavailable":n?this._allAvailability="available":(this._allAvailability="unknown",this._tileAvailabilityBitSet=s,this.byteSize+=s.length)}}],[{key:"fromDefinition",value:function(t,r){var n=t.service.request||d.default,a=t.row,s=t.col,o=t.width,l=t.height,c={query:{f:"json"}};return r=r?Object(i.a)(Object(i.a)({},c),r):c,n(function(e){var t;if("vector-tile"===e.service.type)t="".concat(e.service.url,"/tilemap/").concat(e.level,"/").concat(e.row,"/").concat(e.col,"/").concat(e.width,"/").concat(e.height);else{var r=e.service.tileServers;t="".concat(r&&r.length?r[e.row%r.length]:e.service.url,"/tilemap/").concat(e.level,"/").concat(e.row,"/").concat(e.col,"/").concat(e.width,"/").concat(e.height)}var n=e.service.query;return n&&(t="".concat(t,"?").concat(n)),t}(t),r).then((function(e){return e.data})).catch((function(e){if(e&&e.details&&422===e.details.httpStatus)return{location:{top:a,left:s,width:o,height:l},valid:!0,data:Object(S.b)(o*l,0)};throw e})).then((function(t){if(t.location&&(t.location.top!==a||t.location.left!==s||t.location.width!==o||t.location.height!==l))throw new b.a("tilemap:location-mismatch","Tilemap response for different location than requested",{response:t,definition:{top:a,left:s,width:o,height:l}});return e.fromJSON(t)}))}},{key:"fromJSON",value:function(t){e._validateJSON(t);var r=new e;return r.location=Object.freeze(Object(R.a)(t.location)),r._updateFromData(t.data),Object.freeze(r)}},{key:"_validateJSON",value:function(e){if(!e||!e.location)throw new b.a("tilemap:missing-location","Location missing from tilemap response");if(!1===e.valid)throw new b.a("tilemap:invalid","Tilemap response was marked as invalid");if(!e.data)throw new b.a("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(e.data))throw new b.a("tilemap:data-mismatch","Data must be an array of numbers");if(e.data.length!==e.location.width*e.location.height)throw new b.a("tilemap:data-mismatch","Number of data items does not match width/height of tilemap")}}]),e}();function M(e){return"".concat(e.level,"/").concat(e.row,"/").concat(e.col,"/").concat(e.width,"/").concat(e.height)}var P=y.a.getLogger("esri.layers.support.TilemapCache"),F=n=function(e){Object(l.a)(r,e);var t=Object(c.a)(r);function r(e){var n;return Object(s.a)(this,r),(n=t.call(this,e))._pendingTilemapRequests={},n._availableLevels={},n.levels=5,n.cacheByteSize=2*m.a.MEGABYTES,n.request=d.default,n._prefetchingEnabled=!0,n}return Object(o.a)(r,[{key:"initialize",value:function(){var e=this;this._tilemapCache=new x.a(this.cacheByteSize),this.own([Object(j.e)((function(){var t=e.layer;return[null===t||void 0===t?void 0:t.parsedUrl,null===t||void 0===t?void 0:t.tileServers,null===t||void 0===t?void 0:t.apiKey,null===t||void 0===t?void 0:t.customParameters]}),(function(){return e._initializeTilemapDefinition()})),Object(j.e)((function(){var t,r;return null===(t=e.layer)||void 0===t||null===(r=t.tileInfo)||void 0===r?void 0:r.lods}),(function(t){return e._initializeAvailableLevels(t)}),j.d)]),this._initializeTilemapDefinition()}},{key:"castLevels",value:function(e){return e<=2?(P.error("Minimum levels for Tilemap is 3, but got ",e),3):e}},{key:"size",get:function(){return 1<<this.levels}},{key:"fetchTilemap",value:function(e,t,r,n){var a=this;if(!this._availableLevels[e])return Promise.reject(new b.a("tilemap-cache:level-unavailable","Level ".concat(e," is unavailable in the service")));var s=this._tmpTilemapDefinition,o=this._tilemapFromCache(e,t,r,s);if(o)return Promise.resolve(o);var l=n&&n.signal;return n=Object(i.a)(Object(i.a)({},n),{},{signal:null}),new Promise((function(e,t){Object(O.m)(l,(function(){return t(Object(O.b)())}));var r=M(s),i=a._pendingTilemapRequests[r];if(!i){i=C.fromDefinition(s,n).then((function(e){return a._tilemapCache.put(r,e,e.byteSize),e}));var o=function(){return delete a._pendingTilemapRequests[r]};a._pendingTilemapRequests[r]=i,i.then(o,o)}i.then(e,t)}))}},{key:"getAvailability",value:function(e,t,r){if(!this._availableLevels[e])return"unavailable";var n=this._tilemapFromCache(e,t,r,this._tmpTilemapDefinition);return n?n.getAvailability(t,r):"unknown"}},{key:"fetchAvailability",value:function(e,t,r,n){return this._availableLevels[e]?this.fetchTilemap(e,t,r,n).catch((function(e){return e})).then((function(n){if(n instanceof C){var a=n.getAvailability(t,r);if("unavailable"===a)throw new b.a("tile-map:tile-unavailable","Tile is not available",{level:e,row:t,col:r});return a}if(Object(O.j)(n))throw n;return"unknown"})):Promise.reject(new b.a("tilemap-cache:level-unavailable","Level ".concat(e," is unavailable in the service")))}},{key:"fetchAvailabilityUpsample",value:function(e,t,r,n,a){var i=this;n.level=e,n.row=t,n.col=r;var s=this.layer.tileInfo;s.updateTileInfo(n);var o=this.fetchAvailability(e,t,r,a).catch((function(e){if(Object(O.j)(e))throw e;if(s.upsampleTile(n))return i.fetchAvailabilityUpsample(n.level,n.row,n.col,n);throw e}));return this._fetchAvailabilityUpsamplePrefetch(n.id,e,t,r,a,o),o}},{key:"_fetchAvailabilityUpsamplePrefetch",value:function(){var e=Object(a.a)(f.a.mark((function e(t,r,a,s,o,l){var c,u,h,d,p,m,b,v,y,x=this;return f.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._prefetchingEnabled){e.next=2;break}return e.abrupt("return");case 2:if(c="prefetch-".concat(t),!this.handles.has(c)){e.next=5;break}return e.abrupt("return");case 5:return u=new AbortController,l.then((function(){return u.abort()}),(function(){return u.abort()})),h=!1,d={remove:function(){h||(h=!0,u.abort())}},this.handles.add(d,c),e.next=12,Object(k.c)(10,u.signal).catch((function(){}));case 12:if(h||(h=!0,this.handles.remove(c)),!Object(O.k)(u)){e.next=15;break}return e.abrupt("return");case 15:for(p={id:t,level:r,row:a,col:s},m=Object(i.a)(Object(i.a)({},o),{},{signal:u.signal}),b=this.layer.tileInfo,v=function(e){var t=x.fetchAvailability(p.level,p.row,p.col,m);n._prefetches.push(t);var r=function(){n._prefetches.removeUnordered(t)};t.then(r,r)},y=0;n._prefetches.length<n._maxPrefetch&&b.upsampleTile(p);++y)v();case 18:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a,i,s){return e.apply(this,arguments)}}()},{key:"_initializeTilemapDefinition",value:function(){var e;if(this.layer.parsedUrl){var t=this.layer,r=t.parsedUrl,n=t.apiKey,a=t.customParameters;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:r.path,query:Object(w.G)(Object(i.a)(Object(i.a)(Object(i.a)({},r.query),a),{},{token:null!==n&&void 0!==n?n:null===(e=r.query)||void 0===e?void 0:e.token})),tileServers:this.layer.tileServers,request:this.request,type:this.layer.type},width:this.size,height:this.size,level:0,row:0,col:0}}}},{key:"_tilemapFromCache",value:function(e,t,r,n){n.level=e,n.row=t-t%this.size,n.col=r-r%this.size;var a=M(n);return this._tilemapCache.get(a)}},{key:"_initializeAvailableLevels",value:function(e){var t=this;this._availableLevels={},e&&e.forEach((function(e){return t._availableLevels[e.level]=!0}))}},{key:"test",get:function(){var e=this;return{get prefetchingEnabled(){return e._prefetchingEnabled},set prefetchingEnabled(t){e._prefetchingEnabled=t},hasTilemap:function(t,r,n){return!!e._tilemapFromCache(t,r,n,e._tmpTilemapDefinition)}}}}]),r}(Object(v.b)(p.a));F._maxPrefetch=4,F._prefetches=new g.a({initialSize:n._maxPrefetch}),Object(h.a)([Object(I.b)({constructOnly:!0,type:Number})],F.prototype,"levels",void 0),Object(h.a)([Object(_.a)("levels")],F.prototype,"castLevels",null),Object(h.a)([Object(I.b)({readOnly:!0,type:Number})],F.prototype,"size",null),Object(h.a)([Object(I.b)({constructOnly:!0,type:Number})],F.prototype,"cacheByteSize",void 0),Object(h.a)([Object(I.b)({constructOnly:!0})],F.prototype,"layer",void 0),Object(h.a)([Object(I.b)({constructOnly:!0})],F.prototype,"request",void 0),F=n=Object(h.a)([Object(T.a)("esri.layers.support.TilemapCache")],F)},920:function(e,t,r){"use strict";r.d(t,"a",(function(){return p})),r.d(t,"b",(function(){return v})),r.d(t,"c",(function(){return m})),r.d(t,"d",(function(){return f})),r.d(t,"e",(function(){return b})),r.d(t,"f",(function(){return h})),r.d(t,"g",(function(){return d})),r.d(t,"h",(function(){return x}));r(177);var n=r(146),a=r(142),i=r(143),s=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:15e3,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;Object(a.a)(this,e),this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,r)}return Object(i.a)(e,[{key:"decreaseRefCount",value:function(e,t){var r=e+"/"+t,n=this._cachedBlocks;if(n.has(r)){var a=n.get(r);return a.refCount--,a.refCount<=0&&(n.delete(r),a.controller&&a.controller.abort()),a.refCount}return 0}},{key:"getBlock",value:function(e,t){var r=e+"/"+t,n=this._cachedBlocks;if(n.has(r)){var a=n.get(r);return a.ts=Date.now(),a.refCount++,n.delete(r),n.set(r,a),a.block}return null}},{key:"putBlock",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=this._cachedBlocks,i=e+"/"+t;if(a.has(i)){var s=a.get(i);s.ts=Date.now(),s.refCount++}else a.set(i,{block:r,ts:Date.now(),refCount:1,controller:n});this._trim(),this._updateTimer()}},{key:"deleteBlock",value:function(e,t){var r=this._cachedBlocks,n=e+"/"+t;r.has(n)&&r.delete(n)}},{key:"updateMaxSize",value:function(e){this._size=e,this._trim()}},{key:"empty",value:function(){this._cachedBlocks.clear(),this._clearTimer()}},{key:"getCurrentSize",value:function(){return this._cachedBlocks.size}},{key:"_updateTimer",value:function(){var e=this;if(null==this._timer){var t=this._cachedBlocks;this._timer=setInterval((function(){for(var r=Array.from(t),n=Date.now(),a=0;a<r.length&&r[a][1].ts<=n-e._duration;a++)t.delete(r[a][0]);0===t.size&&e._clearTimer()}),this._interval)}}},{key:"_trim",value:function(){var e=this._cachedBlocks;if(!(-1===this._size||this._size>=e.size))for(var t=Array.from(e),r=0;r<t.length-this._size;r++)e.delete(t[r][0])}},{key:"_clearTimer",value:function(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}]),e}(),o=r(501),l=r(197),c=new Map,u=new s;function f(e,t){return null==t?e:"".concat(e,"?sliceId=").concat(t)}function h(e,t){var r={extent:null,rasterInfo:t,cache:new Map};if(c.has(e)){var n=c.get(e);return n.push(r),n.length-1}return c.set(e,[r]),0}function d(e,t){if(c.has(e)){var r=c.get(e);r[t]=null,r.some((function(e){return null!=e}))||c.delete(e)}}function p(e,t,r){if(!c.has(e))return null==t?u.decreaseRefCount(e,r):0;var n=c.get(e);if(null==n[t])return u.decreaseRefCount(e,r);var a=n[t].cache;if(a.has(r)){var i=a.get(r);if(i.refCount--,0===i.refCount){a.delete(r);for(var s=0;s<n.length;s++)n[s]&&n[s].cache.has(r)&&n[s].cache.delete(r);i.controller&&i.controller.abort()}return i.refCount}return 0}function m(e,t,r){if(!c.has(e))return null==t?u.getBlock(e,r):null;var n=c.get(e);if(null==n[t]){for(var a=0;a<n.length;a++)if(n[a]&&n[a].cache.has(r)){var i=n[a].cache.get(r);return i.refCount++,i.block}return u.getBlock(e,r)}var s=n[t].cache;if(s.has(r)){var o=s.get(r);return o.refCount++,o.block}for(var l=0;l<n.length;l++)if(l!==t&&n[l]&&n[l]&&n[l].cache.has(r)){var f=n[l].cache.get(r);return f.refCount++,s.set(r,f),f.block}return null}function b(e,t,r,n){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(c.has(e)){var i=c.get(e);if(null!=i[t]){var s={refCount:1,block:n,isResolved:!1,isRejected:!1,controller:a};n.then((function(){return s.isResolved=!0})).catch((function(){return s.isRejected=!0})),i[t].cache.set(r,s)}else u.putBlock(e,r,n,a)}else null==t&&u.putBlock(e,r,n,a)}function v(e,t,r){if(c.has(e)){var n=c.get(e);null!=n[t]?n[t].cache.delete(r):u.deleteBlock(e,r)}else null==t&&u.deleteBlock(e,r)}function y(e,t){if(!c.has(e))return null;var r=c.get(e);return null==r[t]?null:r[t]}function x(e,t,r,a,i,s){var c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,u=y(e,t),f=u.extent,h=u.cache,d=u.rasterInfo;if(!f||f.xmin!==r.xmin||f.xmax!==r.xmax||f.ymin!==r.ymin||f.ymax!==r.ymax){for(var p=r.clone().normalize(),m=d.spatialReference,b=d.transform,v=new Set,x=0;x<p.length;x++){var g=p[x];if(!(g.xmax-g.xmin<=a||g.ymax-g.ymin<=a)){var O=Object(o.h)(g,m,c);Object(n.k)(b)&&(O=b.inverseTransform(O));var j=new l.a({x:a,y:a,spatialReference:g.spatialReference});if(null==i&&!(i=Object(o.j)(j,m,g,c)))return;var k=Object(o.m)(i,d,s||"closest"),w=k.pyramidLevel,I=k.pyramidResolution,S=k.excessiveReading;if(S)return;for(var _=d.storageInfo,T=_.origin,R={x:Math.max(0,Math.floor((O.xmin-T.x)/I.x)),y:Math.max(0,Math.floor((T.y-O.ymax)/I.y))},C=Math.ceil((O.xmax-O.xmin)/I.x-.1),M=Math.ceil((O.ymax-O.ymin)/I.y-.1),P=w>0?_.pyramidBlockWidth:_.blockWidth,F=w>0?_.pyramidBlockHeight:_.blockHeight,B=1,D=Math.max(0,Math.floor(R.x/P)-B),z=Math.max(0,Math.floor(R.y/F)-B),A=Math.floor((R.x+C-1)/P)+B,E=Math.floor((R.y+M-1)/F)+B,L=z;L<=E;L++)for(var N=D;N<=A;N++)v.add("".concat(w,"/").concat(L,"/").concat(N))}}h.forEach((function(e,t){if(!v.has(t)){var r=h.get(t);(null==r||r.isResolved||r.isRejected)&&h.delete(t)}})),u.extent={xmin:r.xmin,ymin:r.ymin,xmax:r.xmax,ymax:r.ymax}}}}}]);