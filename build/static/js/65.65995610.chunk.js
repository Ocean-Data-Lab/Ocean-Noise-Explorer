(this["webpackJsonpmatx-react-pro"]=this["webpackJsonpmatx-react-pro"]||[]).push([[65,8],{1216:function(e,t,r){"use strict";r.r(t),r.d(t,"default",(function(){return Rt}));var n=r(155),a=r(142),i=r(143),s=r(144),u=r(145),o=r(154),c=r.n(o),l=r(148),h=r(215),d=r(147),f=r(175),p=r(151),v=(r(152),r(150),r(149)),y=r(182),g=r(296);function b(e){return"heatmap"===e?r.e(113).then(r.bind(null,1332)):Promise.all([r.e(7),r.e(35),r.e(66)]).then(r.bind(null,1387))}var m=r(60),_=r(5),k=r(146),x=r(162),j=r(188),O=r(549),I=r(329),w=r(853),S=r(372),F=r(16),T=r(164),A=r(163),C=r(186),R=r(159),M=r(156),E=r(713),q=r(270),z=r(854),N=r(410),D=r(339),G=r(14),P=r(547),U=r(350),L=r(216),B=r(298),V=r(1010),Q=268435455,Z=function(){function e(){Object(a.a)(this,e),this.fieldMap=new Map,this.fields=[],this.hasFeatures=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}return Object(i.a)(e,[{key:"hasField",value:function(e){return this.fieldMap.has(e)}},{key:"isDateField",value:function(e){var t;return null===(t=this.fieldMap.get(e))||void 0===t?void 0:t.isDate}},{key:"getFieldIndex",value:function(e){var t;return null===(t=this.fieldMap.get(e))||void 0===t?void 0:t.index}}]),e}();function Y(e){for(var t=e.getLength(),r=e.pos()+t,n={name:"",isDate:!1};e.pos()<r&&e.next();)switch(e.tag()){case 1:n.name=e.getString();break;case 2:"esriFieldTypeDate"===Object(V.b)(e.getEnum())&&(n.isDate=!0);break;default:e.skip()}return n}function H(e){return e.toLowerCase().trim()}function X(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=1,a=3,i=9,s=12,u=13,o=15,c=e.pos(),l=new Z,h=0,d=0,f=1,p=2,v=4,y=3,g=null,b=null,m=null,_=!1;e.next();)switch(e.tag()){case n:g=e.getString();break;case a:b=e.getString();break;case s:m=e.processMessage(V.c);break;case i:if(l.exceededTransferLimit=e.getBool(),l.exceededTransferLimit){l.offsets.geometry=r?new Float64Array(8e3):new Int32Array(8e3),l.centroid=r?new Float64Array(16e3):new Int32Array(16e3);for(var k=0;k<l.centroid.length;k++)l.centroid[k]=Q}break;case u:var x=Y(e),j=x.name,O=H(x.name),I={fieldName:j,index:h++,isDate:x.isDate};l.fields.push(I),l.fieldMap.set(x.name,I),l.fieldMap.set(O,I);break;case o:var w=e.getLength(),S=e.pos()+w;if(!l.exceededTransferLimit){var F=l.offsets.geometry,T=l.centroid;F.push(0),T.push(Q),T.push(Q)}!_&&l.exceededTransferLimit&&(_=!0,l.offsets.attributes=r?new Float64Array(8e3*h):new Uint32Array(8e3*h));for(var A=d*h;e.pos()<S&&e.next();)switch(e.tag()){case f:_?l.offsets.attributes[A++]=e.pos():l.offsets.attributes.push(e.pos());var C=e.getLength();e.skipLen(C);break;case p:if(t)for(var M=e.getLength(),E=e.pos()+M;e.pos()<E&&e.next();)if(e.tag()===y){e.getUInt32();var q=e.getSInt64(),z=e.getSInt64();l.centroid[2*d]=q,l.centroid[2*d+1]=z}else e.skip();else{l.offsets.geometry[d]=e.pos();var N=e.getLength();l.vertexCount+=N,e.skipLen(N)}break;case v:for(var D=e.getLength(),G=e.pos()+D;e.pos()<G&&e.next();)if(e.tag()===y){e.getUInt32();var P=e.getSInt64(),U=e.getSInt64();l.centroid[2*d]=P,l.centroid[2*d+1]=U}else e.skip();break;default:e.skip()}d++,l.hasFeatures=!0;break;default:e.skip()}var L=g||b;if(!L)throw new R.a("FeatureSet has no objectId or globalId field name");return l.featureCount=d,l.fieldCount=h,l.objectIdFieldIndex=l.getFieldIndex(L),l.transform=m,l.displayIds=new Uint32Array(l.featureCount),l.groupIds=new Uint16Array(l.featureCount),e.move(c),l}var W=M.a.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF"),J=268435455,$=128e3,K={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array($),decoded:new Int32Array($)}};function ee(e){return e<=K.small.delta.length?K.small:(e<=K.large.delta.length||(K.large.delta=new Int32Array(Math.round(1.25*e)),K.large.decoded=new Int32Array(Math.round(1.25*e))),K.large)}function te(e){return e.toLowerCase().trim()}function re(e){try{for(var t=new P.a(new Uint8Array(e),new DataView(e));t.next();){if(2===t.tag())return ne(t.getMessage());t.skip()}}catch(n){var r=new R.a("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:n});W.error(r)}return null}function ne(e){for(;e.next();){if(1===e.tag())return e.getMessage();e.skip()}return null}function ae(e,t,r,n,a,i){return.5*Math.abs(e*n+r*i+a*t-e*i-r*t-a*n)}function ie(e,t,r,n){return 0===e*n-r*t&&e*r+t*n>0}var se=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(e,n,i,s){var u;return Object(a.a)(this,r),(u=t.call(this,e,s))._hasNext=!1,u._isPoints=!1,u._featureIndex=-1,u._featureOffset=0,u._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},u._geometryType=s.geometryType,u._reader=n,u._header=i,u._hasNext=i.hasFeatures,u._isPoints="esriGeometryPoint"===s.geometryType,u}return Object(i.a)(r,[{key:"geometryType",get:function(){return this._geometryType}},{key:"size",get:function(){return this._header.featureCount}},{key:"hasZ",get:function(){return!1}},{key:"hasM",get:function(){return!1}},{key:"stride",get:function(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}},{key:"hasFeatures",get:function(){return this._header.hasFeatures}},{key:"hasNext",get:function(){return this._hasNext}},{key:"exceededTransferLimit",get:function(){return this._header.exceededTransferLimit}},{key:"hasField",value:function(e){return this._header.hasField(e)||this._header.hasField(te(e))}},{key:"getFieldNames",value:function(){return this._header.fields.map((function(e){return e.fieldName}))}},{key:"getSize",value:function(){return this.size}},{key:"getQuantizationTransform",value:function(){return this._header.transform}},{key:"getCursor",value:function(){return this.copy()}},{key:"getIndex",value:function(){return this._featureIndex}},{key:"setIndex",value:function(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=e}},{key:"getAttributeHash",value:function(){var e=this,t="";return this._header.fields.forEach((function(r){var n=r.index;t+=e._readAttributeAtIndex(n)+"."})),t}},{key:"getObjectId",value:function(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}},{key:"getDisplayId",value:function(){return this._header.displayIds[this._featureIndex]}},{key:"setDisplayId",value:function(e){this._header.displayIds[this._featureIndex]=e}},{key:"getGroupId",value:function(){return this._header.groupIds[this._featureIndex]}},{key:"setGroupId",value:function(e){this._header.groupIds[this._featureIndex]=e}},{key:"readLegacyFeature",value:function(){if(void 0===this._cache.legacyFeature){var e,t=this.readCentroid(),r={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:null!==(e=t&&{x:t.coords[0],y:t.coords[1]})&&void 0!==e?e:null};return this._cache.legacyFeature=r,r}return this._cache.legacyFeature}},{key:"readOptimizedFeature",value:function(){if(void 0===this._cache.optFeature){var e=new U.a(this.readGeometry(),this.readAttributes(),this.readCentroid());return e.objectId=this.getObjectId(),e.displayId=this.getDisplayId(),this._cache.optFeature=e,e}return this._cache.optFeature}},{key:"getXHydrated",value:function(){var e=this._header.centroid[2*this._featureIndex],t=this.getQuantizationTransform();return Object(k.j)(t)?e:e*t.scale[0]+t.translate[0]}},{key:"getYHydrated",value:function(){var e=this._header.centroid[2*this._featureIndex+1],t=this.getQuantizationTransform();return Object(k.j)(t)?e:t.translate[1]-e*t.scale[1]}},{key:"getX",value:function(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx}},{key:"getY",value:function(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty}},{key:"readLegacyPointGeometry",value:function(){return{x:this.getX(),y:this.getY()}}},{key:"readLegacyGeometry",value:function(e){var t=this.readGeometry(e);return Object(j.k)(t,this.geometryType,!1,!1)}},{key:"readLegacyCentroid",value:function(){var e=this.readCentroid();if(!e)return null;var t=Object(G.a)(e.coords,2);return{x:t[0],y:t[1]}}},{key:"readGeometryArea",value:function(){return this._cache.area||this.readGeometry(!0),this._cache.area}},{key:"readUnquantizedGeometry",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(void 0===this._cache.unquantGeometry){var t=this.readGeometry(e);if(!t)return this._cache.unquantGeometry=null,null;var r,n=ee(t.coords.length).decoded,a=t.clone(n),i=a.coords,s=0,u=Object(m.a)(a.lengths);try{for(u.s();!(r=u.n()).done;){for(var o=r.value,c=1;c<o;c++){var l=2*(s+c),h=2*(s+c-1);i[l]+=i[h],i[l+1]+=i[h+1]}s+=o}}catch(d){u.e(d)}finally{u.f()}return this._cache.unquantGeometry=a,a}return this._cache.unquantGeometry}},{key:"readHydratedGeometry",value:function(){if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===J)return null;var e=this.getXHydrated(),t=this.getYHydrated();return new L.a([],[e,t])}var r=this.readGeometry();if(!r)return null;var n=r.clone(),a=this.getQuantizationTransform();return Object(k.k)(a)&&Object(j.z)(n,n,this.hasZ,this.hasM,a),n}},{key:"readGeometry",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(void 0===this._cache.geometry){var t=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===J)return null;var r=this.getX(),n=this.getY();t=new L.a([],[r,n])}else{var a=this._header.offsets.geometry[this._featureIndex],i=this._reader;if(0===a)return null;i.move(a);try{t=e?this._parseGeometryForDisplay(i):this._parseGeometry(i)}catch(s){return console.error("Failed to parse geometry!",s),null}}return this._cache.geometry=t,t}return this._cache.geometry}},{key:"readCentroid",value:function(){if(void 0===this._cache.centroid){var e=null,t=this._header.centroid[2*this._featureIndex]+this._tx,r=this._header.centroid[2*this._featureIndex+1]+this._ty;return t===J?(e=this._computeCentroid())&&(this._header.centroid[2*this._featureIndex]=e.coords[0]-this._tx,this._header.centroid[2*this._featureIndex+1]=e.coords[1]-this._ty):e=new L.a([],[t,r]),this._cache.centroid=e,e}return this._cache.centroid}},{key:"copy",value:function(){var e=this._reader.clone(),t=new r(this.instance,e,this._header,this.fullSchema());return this.copyInto(t),t}},{key:"next",value:function(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this.size&&!this._getExists(););return this._featureIndex<this.size}},{key:"_readAttribute",value:function(e,t){var r=this._header.hasField(e)?e:te(e),n=this._header.getFieldIndex(r);if(null!=n){var a=this._readAttributeAtIndex(n);return t?null==a?a:this._header.isDateField(r)?new Date(a):a:a}}},{key:"_readAttributes",value:function(){var e=this,t={};return this._header.fields.forEach((function(r){var n=r.fieldName,a=r.index;t[n]=e._readAttributeAtIndex(a)})),t}},{key:"copyInto",value:function(e){Object(T.a)(Object(A.a)(r.prototype),"copyInto",this).call(this,e),e._featureIndex=this._featureIndex,e._featureOffset=this._featureOffset,e._hasNext=this._hasNext}},{key:"_readAttributeAtIndex",value:function(e){var t=this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e],r=this._reader;return r.move(t),function(e){for(var t=e.getLength(),r=e.pos()+t;e.pos()<r&&e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}(r)}},{key:"_parseGeometry",value:function(e){for(var t=e.getLength(),r=e.pos()+t,n=[],a=[];e.pos()<r&&e.next();)switch(e.tag()){case 2:for(var i=e.getUInt32(),s=e.pos()+i;e.pos()<s;)a.push(e.getUInt32());break;case 3:var u=e.getUInt32(),o=e.pos()+u;for(n.push(e.getSInt32()+this._tx),n.push(e.getSInt32()+this._ty),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();e.pos()<o;)n.push(e.getSInt32()),n.push(e.getSInt32()),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();break;default:e.skip()}return new L.a(a,n)}},{key:"_parseGeometryForDisplay",value:function(e){for(var t=e.getLength(),r=e.pos()+t,n=[],a=[],i=0,s=0,u=null,o=0,c="esriGeometryPolygon"===this.geometryType;e.pos()<r&&e.next();)switch(e.tag()){case 2:for(var l=e.getUInt32(),h=e.pos()+l;e.pos()<h;){var d=e.getUInt32();n.push(d),i+=d}u=ee(2*i).delta;break;case 3:e.getUInt32();var f,p=2+(this.hasZ?1:0)+(this.hasM?1:0),v=Object(m.a)(n);try{for(v.s();!(f=v.n()).done;){var y=f.value;if(s+p*y>u.length)for(var g=0;g<y;g++)e.getSInt32(),e.getSInt32(),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();else if(c){var b=this.getAreaSimplificationThreshold(y,this._header.vertexCount),_=2,k=1,x=e.getSInt32(),j=e.getSInt32();u[s++]=x,u[s++]=j,this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();var O=e.getSInt32(),I=e.getSInt32();for(this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();_<y;){var w=e.getSInt32(),S=e.getSInt32();this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();var F=x+O,T=j+I;ae(x,j,F,T,F+w,T+S)>=b?(o+=-.5*(F-x)*(T+j),k>1&&ie(u[s-2],u[s-1],O,I)?(u[s-2]+=O,u[s-1]+=I):(u[s++]=O,u[s++]=I,k++),x=F,j=T):(w+=O,S+=I),O=w,I=S,_++}k<3?s-=2*k:(o+=-.5*(x+O-x)*(j+I+j),ie(u[s-2],u[s-1],O,I)?(u[s-2]+=O,u[s-1]+=I,a.push(k)):(u[s++]=O,u[s++]=I,a.push(++k)))}else{var A=0,C=e.getSInt32(),R=e.getSInt32();this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32(),u[s++]=C,u[s++]=R,A+=1;for(var M=1;M<y;M++){var E=e.getSInt32(),q=e.getSInt32(),z=C+E,N=R+q;o+=-.5*(z-C)*(N+R),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32(),M>2&&ie(u[s-2],u[s-1],E,q)?(u[s-2]+=E,u[s-1]+=q):(u[s++]=E,u[s++]=q,A+=1),C=z,R=N}a.push(A)}}}catch(B){v.e(B)}finally{v.f()}break;default:e.skip()}if(this._cache.area=o,!a.length)return null;if(this._tx||this._ty){var D,G=0,P=Object(m.a)(a);try{for(P.s();!(D=P.n()).done;){var U=D.value;u[2*G]+=this._tx,u[2*G+1]+=this._ty,G+=U}}catch(B){P.e(B)}finally{P.f()}}return new L.a(a,u)}}],[{key:"fromBuffer",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=t.geometryType,i=re(e),s=X(i,"esriGeometryPoint"===a,n),u=B.a.createInstance();return new r(u,i,s,t)}}]),r}(B.a),ue=function(){function e(t){Object(a.a)(this,e),this.service=t}return Object(i.a)(e,[{key:"destroy",value:function(){}}]),e}();function oe(e){var t,r=e.capabilities;return(t=e.source)&&t.capabilities&&t.collection&&t.layerDefinition?new fe(e):function(e){return Array.isArray(e.source)}(e)?new le(e):r.query.supportsFormatPBF&&Object(d.a)("featurelayer-pbf")?new he(e):new de(e)}function ce(){return(ce=Object(n.a)(c.a.mark((function e(t){var r;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new E.a,e.next=3,r.open(t,{});case 3:return e.abrupt("return",r);case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var le=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(e){var n;return Object(a.a)(this,r),(n=t.call(this,e))._portsOpen=function(e){return ce.apply(this,arguments)}(e.source).then((function(e){return n.client=e})),n}return Object(i.a)(r,[{key:"destroy",value:function(){this.client.close(),this.client=null}},{key:"executeQuery",value:function(){var e=Object(n.a)(c.a.mark((function e(t,r){var n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._portsOpen;case 2:return e.next=4,this.client.invoke("queryFeatures",t.toJSON(),r);case 4:return n=e.sent,e.abrupt("return",D.a.fromFeatureSet(n,this.service));case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(ue),he=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(){return Object(a.a)(this,r),t.apply(this,arguments)}return Object(i.a)(r,[{key:"executeQuery",value:function(){var e=Object(n.a)(c.a.mark((function e(t,r){var n,a,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(N.executeQueryPBFBuffer)(this.service.source,t,r);case 2:return n=e.sent,a=n.data,i=!t.quantizationParameters,e.abrupt("return",se.fromBuffer(a,this.service,i));case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(ue),de=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(){return Object(a.a)(this,r),t.apply(this,arguments)}return Object(i.a)(r,[{key:"executeQuery",value:function(){var e=Object(n.a)(c.a.mark((function e(t,r){var n,a,i,s,u,o,l,h,d,f,p,v,y,g;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=this.service,i=a.source,s=a.capabilities,u=a.spatialReference,o=a.objectIdField,l=a.geometryType,!Object(k.k)(t.quantizationParameters)||s.query.supportsQuantization){e.next=10;break}return h=t.clone(),d=Object(q.c)(Object(k.q)(h.quantizationParameters)),h.quantizationParameters=null,e.next=6,Object(N.executeQuery)(i,h,u,r);case 6:return f=e.sent,p=f.data,v=Object(j.b)(p,o),e.abrupt("return",(Object(j.t)(d,v),D.a.fromOptimizedFeatureSet(v,this.service)));case 10:return e.next=12,Object(N.executeQuery)(i,t,this.service.spatialReference,r);case 12:return y=e.sent,g=y.data,e.abrupt("return",("esriGeometryPoint"===l&&(g.features=null===(n=g.features)||void 0===n?void 0:n.filter((function(e){if(Object(k.k)(e.geometry)){var t=e.geometry;return Number.isFinite(t.x)&&Number.isFinite(t.y)}return!0}))),D.a.fromFeatureSet(g,this.service)));case 15:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(ue),fe=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(){return Object(a.a)(this,r),t.apply(this,arguments)}return Object(i.a)(r,[{key:"executeQuery",value:function(){var e=Object(n.a)(c.a.mark((function e(t,r){var n,a,i,s,u;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.service.capabilities,!t.quantizationParameters||n.query.supportsQuantization){e.next=8;break}return a=t.clone(),i=Object(q.c)(Object(k.q)(a.quantizationParameters)),a.quantizationParameters=null,e.next=6,Object(z.j)(this.service.source,t,r);case 6:return s=e.sent,e.abrupt("return",(Object(j.t)(i,s),D.a.fromOptimizedFeatureSet(s,this.service)));case 8:return e.next=10,Object(z.j)(this.service.source,t,r);case 10:return u=e.sent,e.abrupt("return",D.a.fromOptimizedFeatureSet(u,this.service));case 12:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(ue),pe=r(364),ve=r(252),ye=r(374),ge=r(254),be=r(486),me=function(){function e(){Object(a.a)(this,e),this.version=0,this.source=!1,this.targets={feature:!1,aggregate:!1},this.storage={filters:!1,data:!1},this.mesh=!1,this.queryFilter=!1,this.why={mesh:[],source:[]}}return Object(i.a)(e,[{key:"unset",value:function(e){this.version=e.version,e.source&&(this.source=!1),e.targets.feature&&(this.targets.feature=!1),e.targets.aggregate&&(this.targets.aggregate=!1),e.storage.filters&&(this.storage.filters=!1),e.storage.data&&(this.storage.data=!1),e.mesh&&(this.mesh=!1),e.queryFilter&&(this.queryFilter=!1)}},{key:"any",value:function(){return this.source||this.mesh||this.storage.filters||this.storage.data||this.targets.feature||this.targets.aggregate||this.queryFilter}},{key:"describe",value:function(){var e=0,t="";if(this.mesh){e+=20,t+="-> (20) Mesh needs update\n";var r,n=Object(m.a)(this.why.mesh);try{for(n.s();!(r=n.n()).done;){var a=r.value;t+="    + ".concat(a,"\n")}}catch(c){n.e(c)}finally{n.f()}}if(this.source){e+=10,t+="-> (10) The source needs update\n";var i,s=Object(m.a)(this.why.source);try{for(s.s();!(i=s.n()).done;){var u=i.value;t+="    + ".concat(u,"\n")}}catch(c){s.e(c)}finally{s.f()}}this.targets.feature&&(e+=5,t+="-> (5) Feature target parameters changed\n"),this.storage.filters&&(e+=5,t+="-> (5) Feature filter parameters changed\n"),this.targets.aggregate&&(e+=4,t+="-> (4) Aggregate target parameters changed\n"),this.storage.data&&(e+=1,t+="-> (1) Texture storage parameters changed");var o=e<5?"Fastest":e<10?"Fast":e<15?"Moderate":e<20?"Slow":"Very Slow";console.debug("Applying ".concat(o," update of cost ").concat(e,"/45 ")),console.debug(t)}},{key:"toJSON",value:function(){return{queryFilter:this.queryFilter,source:this.source,targets:this.targets,storage:this.storage,mesh:this.mesh}}}],[{key:"create",value:function(t){var r=new e;for(var n in t){var a=t[n];if("object"==typeof a)for(var i in a){var s=a[i];r[n][i]=s}r[n]=a}return r}},{key:"empty",value:function(){return e.create({})}},{key:"all",value:function(){return e.create({source:!0,targets:{feature:!0,aggregate:!0},storage:{filters:!0,data:!0},mesh:!0})}}]),e}(),_e=function(){function e(t,r){Object(a.a)(this,e),this.requests={done:new Array,stream:new be.a(10)},this._edits=null,this._abortController=new AbortController,this._version=0,this._done=!1,this.didSend=!1,this.tile=t,this._version=r}return Object(i.a)(e,[{key:"signal",get:function(){return this._abortController.signal}},{key:"options",get:function(){return{signal:this._abortController.signal}}},{key:"empty",get:function(){return!this.requests.done.length}},{key:"edits",get:function(){return this._edits}},{key:"done",get:function(){return this._done}},{key:"end",value:function(){this._done=!0}},{key:"clear",value:function(){this.requests.done=[]}},{key:"applyUpdate",value:function(e){this.requests.done.forEach((function(t){return t.message.status.unset(e)})),this._version=e.version,Object(k.k)(this._edits)&&this._edits.status.unset(e)}},{key:"add",value:function(e){var t;e.message.status=null!==(t=e.message.status)&&void 0!==t?t:me.empty(),e.message.status.version=this._version,Object(d.a)("esri-2d-update-debug")&&console.debug(this.tile.id,"DataTileSubscription:add",this._version),e.message.end&&this.requests.done.forEach((function(e){Object(k.k)(e.message)&&e.message.end&&(e.message.end=!1)})),this.requests.done.push(e)}},{key:"edit",value:function(e,t){var r=e.getQuantizationTransform(),n=e.fullSchema(),a=Array.from(e.features()),i=[].concat(Object(F.a)(t),Object(F.a)(a.map((function(e){return e.objectId}))));this.removeIds(i),this._invalidate(),Object(k.j)(this._edits)?this._edits={type:"append",addOrUpdate:D.a.fromOptimizedFeatures(a,n,Object(k.q)(r)),id:this.tile.id,status:me.empty(),end:!0}:(this.requests.done.forEach((function(e){return e.message.end=!1})),Object(k.q)(this._edits.addOrUpdate).append(e.features()))}},{key:"readers",value:c.a.mark((function e(){var t,r,n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=Object(m.a)(this.requests.done),e.prev=1,t.s();case 3:if((r=t.n()).done){e.next=11;break}if(n=r.value.message,e.t0=Object(k.k)(n.addOrUpdate),!e.t0){e.next=9;break}return e.next=9,n.addOrUpdate;case 9:e.next=3;break;case 11:e.next=16;break;case 13:e.prev=13,e.t1=e.catch(1),t.e(e.t1);case 16:return e.prev=16,t.f(),e.finish(16);case 19:if(e.t2=Object(k.k)(this._edits)&&Object(k.k)(this._edits.addOrUpdate),!e.t2){e.next=23;break}return e.next=23,this._edits.addOrUpdate;case 23:case"end":return e.stop()}}),e,this,[[1,13,16,19]])}))},{key:"_invalidate",value:function(){var e,t=Object(m.a)(this.requests.done);try{for(t.s();!(e=t.n()).done;){e.value.message.status=me.empty()}}catch(r){t.e(r)}finally{t.f()}Object(k.k)(this._edits)&&(this._edits.status=me.empty())}},{key:"removeIds",value:function(e){this._invalidate();var t,r=Object(m.a)(this.requests.done);try{for(r.s();!(t=r.n()).done;){var n=t.value.message,a=n.addOrUpdate;Object(k.k)(a)&&(a.removeIds(e),a.isEmpty&&(n.addOrUpdate=null))}}catch(i){r.e(i)}finally{r.f()}Object(k.k)(this._edits)&&Object(k.k)(this._edits.addOrUpdate)&&this._edits.addOrUpdate.removeIds(e),this.requests.done=this.requests.done.filter((function(e){return e.message.addOrUpdate||e.message.end}))}},{key:"abort",value:function(){this._abortController.abort()}}]),e}();var ke,xe,je=function(){function e(t){Object(a.a)(this,e),this.events=new ve.a,this._resolver=Object(x.d)(),this._didEdit=!1,this._subscriptions=new Map,this._outSR=t.outSR,this._serviceInfo=t.serviceInfo,this._onTileUpdateMessage=t.onMessage}return Object(i.a)(e,[{key:"destroy",value:function(){}},{key:"_onMessage",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n,a,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=this._subscriptions.get(t.id)){e.next=3;break}return e.abrupt("return");case 3:return i=Object(_.a)(Object(_.a)({},t),{},{remove:null!==(r=t.remove)&&void 0!==r?r:[],status:null!==(n=t.status)&&void 0!==n?n:me.empty()}),e.abrupt("return",Object(x.i)(this._onTileUpdateMessage(i,a.options)));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(e,t){var r,n=t.fields.length;t.outFields=function(e,t){var r=new Set;return e&&e.forEach((function(e){return r.add(e)})),t&&t.forEach((function(e){return r.add(e)})),r.has("*")?["*"]:Array.from(r)}(null===(r=this._schema)||void 0===r?void 0:r.outFields,t.outFields),t.outFields=t.outFields.length>=.75*n?["*"]:t.outFields,t.outFields.sort();var a=Object(ye.a)(this._schema,t);if(a){Object(d.a)("esri-2d-update-debug")&&console.debug("Applying Update - Source:",a);var i="orderByFields"in this._serviceInfo&&this._serviceInfo.orderByFields?this._serviceInfo.orderByFields:this._serviceInfo.objectIdField+" ASC",s={returnCentroid:Object(d.a)("esri-2d-query-centroid-enabled")&&"esriGeometryPolygon"===this._serviceInfo.geometryType,returnGeometry:!0,timeReferenceUnknownClient:"stream"!==this._serviceInfo.type&&this._serviceInfo.timeReferenceUnknownClient,outFields:t.outFields,outSpatialReference:this._outSR,orderByFields:[i],where:t.definitionExpression||"1=1",gdbVersion:t.gdbVersion,historicMoment:t.historicMoment,timeExtent:pe.a.fromJSON(t.timeExtent)},u=this._schema&&Object(ye.b)(a,"outFields");this._schema&&Object(ye.c)(a,["timeExtent","definitionExpression","gdbVersion","historicMoment","customParameters"])&&(e.why.mesh.push("Layer filter and/or custom parameters changed"),e.why.source.push("Layer filter and/or custom parameters changed"),e.mesh=!0,e.source=!0,e.queryFilter=!0),u&&(e.why.source.push("Layer required fields changed"),e.source=!0),Object(ye.a)(s,this._queryInfo)&&(this._queryInfo=s),this._schema=t,this._resolver.resolve()}}},{key:"whenInitialized",value:function(){return this._resolver.promise}},{key:"applyUpdate",value:function(){var e=Object(n.a)(c.a.mark((function e(t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t.queryFilter||t.source&&this._didEdit)){e.next=2;break}return e.abrupt("return",(this.refresh(t.version),void(this._didEdit=!1)));case 2:return this._subscriptions.forEach((function(e){return e.applyUpdate(t)})),e.next=5,this.resend();case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"refresh",value:function(e){var t,r=Object(m.a)(this._tiles());try{for(r.s();!(t=r.n()).done;){var n=t.value;this.unsubscribe(n),this.subscribe(n,e)}}catch(a){r.e(a)}finally{r.f()}}},{key:"subscribe",value:function(e,t){var r=new _e(e,t);this._subscriptions.set(e.id,r)}},{key:"unsubscribe",value:function(e){var t=this.get(e.id);Object(k.k)(t)&&t.abort(),this._subscriptions.delete(e.id)}},{key:"createQuery",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null;return new ge.a(Object(_.a)(Object(_.a)({},this._queryInfo),{},{historicMoment:t},e))}},{key:"get",value:function(e){return this._subscriptions.has(e)?this._subscriptions.get(e):null}},{key:"queryLastEditDate",value:function(){var e=Object(n.a)(c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Service does not support query type");case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"query",value:function(){var e=Object(n.a)(c.a.mark((function e(t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Service does not support query");case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"_tiles",value:c.a.mark((function e(){var t,r,n,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=Array.from(this._subscriptions.values()),r=0,n=t;case 2:if(!(r<n.length)){e.next=9;break}return a=n[r],e.next=6,a.tile;case 6:r++,e.next=2;break;case 9:case"end":return e.stop()}}),e,this)}))},{key:"edit",value:function(){var e=Object(n.a)(c.a.mark((function e(t,r){var a,i,s,u,o,l,h=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(a=Array.from(this._subscriptions.values()),i=a.map((function(e){return e.tile})),s=0,u=a;s<u.length;s++)u[s].removeIds(r);if(!t.length){e.next=9;break}return o=i.map((function(e){var r=h.createTileQuery(e);return r.objectIds=t,{tile:e,query:r}})).map(function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.tile,n=t.query,e.t0=r,e.next=4,h.query(n);case 4:return e.t1=e.sent,e.t2=n,e.abrupt("return",{tile:e.t0,result:e.t1,query:e.t2});case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=6,Object(x.h)(o);case 6:return l=e.sent.map(function(){var e=Object(n.a)(c.a.mark((function e(n){var a,i,s;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.tile,(i=n.result).hasFeatures||r.length||t.length){e.next=3;break}return e.abrupt("return");case 3:(s=h._subscriptions.get(a.key.id))&&s.edit(i,t);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=9,Object(x.g)(l);case 9:this._didEdit=!0;case 10:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),e}(),Oe=r(496),Ie=M.a.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource"),we=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(e){var i;return Object(a.a)(this,r),(i=t.call(this,e)).type="feature",i.mode="on-demand",i._adapter=oe(e.serviceInfo),i._queue=new Oe.a({concurrency:8,process:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n,a,s;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Object(x.p)(t),!Object(k.k)(t.tile)){e.next=8;break}return r=t.tile.key.id,n=t.signal,a=Object(d.a)("esri-tiles-debug")?{tile:r.replace(/\//g,"."),depth:t.depth}:void 0,e.next=6,i._adapter.executeQuery(t.query,{signal:n,query:Object(_.a)(Object(_.a)({},a),i._schema.customParameters)});case 6:return s=e.sent,e.abrupt("return",(s.level=t.tile.key.level,s));case 8:return e.abrupt("return",i._adapter.executeQuery(t.query,Object(_.a)(Object(_.a)({},t),{},{query:i._schema.customParameters})));case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}),i._patchQueue=new Oe.a({concurrency:8,process:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n,a,s;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Object(x.p)(t),!Object(k.k)(t.tile)){e.next=8;break}return r=t.tile.key.id,n=t.signal,a=Object(d.a)("esri-tiles-debug")?{tile:r.replace(/\//g,"."),depth:t.depth}:void 0,e.next=6,i._adapter.executeQuery(t.query,{signal:n,query:Object(_.a)(Object(_.a)({},a),i._schema.customParameters)});case 6:return s=e.sent,e.abrupt("return",(s.level=t.tile.key.level,s));case 8:return e.abrupt("return",i._adapter.executeQuery(t.query,Object(_.a)(Object(_.a)({},t),{},{query:i._schema.customParameters})));case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}),i}return Object(i.a)(r,[{key:"destroy",value:function(){Object(T.a)(Object(A.a)(r.prototype),"destroy",this).call(this),this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()}},{key:"updating",get:function(){return!!this._queue.length||Array.from(this._subscriptions.values()).some((function(e){return!e.done}))}},{key:"maxRecordCountFactor",get:function(){return this._serviceInfo.capabilities.query.supportsMaxRecordCountFactor?4:null}},{key:"maxPageSize",get:function(){var e;return(null!==(e=this._serviceInfo.capabilities.query.maxRecordCount)&&void 0!==e?e:8e3)*Object(k.r)(this.maxRecordCountFactor,1)}},{key:"pageSize",get:function(){return Math.min(8e3,this.maxPageSize)}},{key:"enableEvent",value:function(e,t){}},{key:"subscribe",value:function(e,t){Object(T.a)(Object(A.a)(r.prototype),"subscribe",this).call(this,e,t);var n=this._subscriptions.get(e.id);this._fetchDataTile(e).catch((function(t){Object(x.j)(t)||Ie.error(new R.a("mapview-query-error","Encountered error when fetching tile",{tile:e,error:t}))})).then((function(){return n.end()}))}},{key:"unsubscribe",value:function(e){Object(T.a)(Object(A.a)(r.prototype),"unsubscribe",this).call(this,e)}},{key:"readers",value:function(e){return this._subscriptions.get(e).readers()}},{key:"query",value:function(){var e=Object(n.a)(c.a.mark((function e(t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._adapter.executeQuery(t,{query:this._schema.customParameters}));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"queryLastEditDate",value:function(){var e=Object(n.a)(c.a.mark((function e(){var t,r;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._serviceInfo.source,r=Object(_.a)(Object(_.a)({},t.query),{},{f:"json"}),e.next=3,Object(C.default)(t.path,{query:r,responseType:"json"});case 3:return e.abrupt("return",e.sent.data.editingInfo.lastEditDate);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"createTileQuery",value:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this._serviceInfo.geometryType,a=this.createQuery(r);a.quantizationParameters=null!==(t=r.quantizationParameters)&&void 0!==t?t:e.getQuantizationParameters(),a.resultType="tile",a.geometry=e.extent,this._serviceInfo.capabilities.query.supportsQuantization?"esriGeometryPolyline"===n&&(a.maxAllowableOffset=e.resolution*Object(d.a)("feature-polyline-generalization-factor")):"esriGeometryPolyline"!==n&&"esriGeometryPolygon"!==n||(a.maxAllowableOffset=e.resolution,"esriGeometryPolyline"===n&&(a.maxAllowableOffset*=Object(d.a)("feature-polyline-generalization-factor")));var i=this._serviceInfo.capabilities.query;return a.defaultSpatialReferenceEnabled=i.supportsDefaultSpatialReference,a.compactGeometryEnabled=i.supportsCompactGeometry,a}},{key:"_executePatchQuery",value:function(){var e=Object(n.a)(c.a.mark((function e(t,r,n,a){var i,s,u;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(i=r.clone()).outFields=[this._serviceInfo.objectIdField].concat(Object(F.a)(n)),i.returnCentroid=!1,i.returnGeometry=!1,s=Object(k.k)(i.start)?i.start/8e3:0,u=a.signal,e.abrupt("return",this._patchQueue.push({tile:t,query:i,signal:u,depth:s}));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"_resend",value:function(){var e=Object(n.a)(c.a.mark((function e(t,r){var n,a,i,s,u,o,l;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.query,a=t.message,i=Object(k.k)(n.outFields)?n.outFields:[],s=this._queryInfo.outFields,u=s.filter((function(e){return!i.includes(e)})),!Object(k.j)(a.addOrUpdate)){e.next=5;break}this._onMessage(Object(_.a)(Object(_.a)({},a),{},{type:"append"})),e.next=19;break;case 5:if(!u.length){e.next=18;break}return e.prev=6,o=this._subscriptions.get(a.id).tile,e.next=10,this._executePatchQuery(o,n,u,r);case 10:l=e.sent,Object(x.p)(r),n.outFields=s,a.addOrUpdate.joinAttributes(l),this._onMessage(Object(_.a)(Object(_.a)({},a),{},{end:a.end,type:"append"})),e.next=16;break;case 14:e.prev=14,e.t0=e.catch(6);case 16:e.next=19;break;case 18:this._onMessage(Object(_.a)(Object(_.a)({},a),{},{type:"append"}));case 19:case"end":return e.stop()}}),e,this,[[6,14]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_resendSubscription",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n,a,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Object(d.a)("esri-2d-update-debug")&&console.debug(t.tile.id,"Resend Subscription"),!t.empty){e.next=2;break}return e.abrupt("return",this._onMessage({id:t.tile.id,addOrUpdate:null,end:!1,type:"append"}));case 2:r=t.signal,n=Object(m.a)(t.requests.done),e.prev=4,n.s();case 6:if((a=n.n()).done){e.next=12;break}return i=a.value,e.next=10,this._resend(i,{signal:r});case 10:e.next=6;break;case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(4),n.e(e.t0);case 17:return e.prev=17,n.f(),e.finish(17);case 20:return e.abrupt("return",Object(k.k)(t.edits)?this._onMessage(t.edits):void 0);case 21:case"end":return e.stop()}}),e,this,[[4,14,17,20]])})));return function(t){return e.apply(this,arguments)}}()},{key:"resend",value:function(){var e=Object(n.a)(c.a.mark((function e(){var t,r=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Array.from(this._subscriptions.values()),e.next=3,Promise.all(t.map((function(e){return r._resendSubscription(e)})));case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),r}(je),Se=Object(d.a)("esri-mobile"),Fe={maxDrillLevel:Se?1:4,maxRecordCountFactor:Se?1:3},Te=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(e){return Object(a.a)(this,r),t.call(this,e)}return Object(i.a)(r,[{key:"_fetchDataTile",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,a,i,s,u,o,l=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,a=this._subscriptions.get(t.key.id),i=a.signal,s=t.getQuantizationParameters(),u=0,o=function(){var e=Object(n.a)(c.a.mark((function e(n,h){var d,f,p,v,y,g,b;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d=l._queryInfo,f=l.createTileQuery(n,{maxRecordCountFactor:r?Fe.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:s}),u++,e.prev=2,e.next=5,l._queue.push({tile:t,query:f,signal:i,depth:h});case 5:if(p=e.sent,u--,Object(x.p)(i),p){e.next=8;break}return e.abrupt("return");case 8:if(d===l._queryInfo){e.next=10;break}return e.abrupt("return",void o(n,h));case 10:if(!(p.exceededTransferLimit&&h<Fe.maxDrillLevel)){e.next=14;break}v=Object(m.a)(n.createChildTiles());try{for(v.s();!(y=v.n()).done;)g=y.value,o(g,h+1)}catch(c){v.e(c)}finally{v.f()}return e.abrupt("return");case 14:b={id:t.id,addOrUpdate:p,end:0===u,type:"append"},a.add({query:f,message:b}),l._onMessage(b),e.next=21;break;case 18:e.prev=18,e.t0=e.catch(2),Object(x.j)(e.t0)||l._onMessage({id:t.id,addOrUpdate:null,end:!0,type:"append"});case 21:case"end":return e.stop()}}),e,null,[[2,18]])})));return function(t,r){return e.apply(this,arguments)}}(),o(t,0);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),r}(we),Ae=r(209),Ce=r(446),Re=r(190),Me="__esri_stream_id__",Ee=function(){function e(t,r,n,i){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:128;Object(a.a)(this,e),this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=n,this._purgeOptions=i,this.store=t,this.objectIdField=r,this.purgeInterval=s,this._useGeneratedIds=this.objectIdField===Me}return Object(i.a)(e,[{key:"add",value:function(e){if(this._useGeneratedIds){var t=this._nextId();e.attributes[this.objectIdField]=t,e.objectId=t}else e.objectId=e.attributes[this.objectIdField];if(this._addOrUpdated.set(e.objectId,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return Object(k.j)(this._trackIdLessObservations)&&(this._trackIdLessObservations=new be.a(1e5)),void this._trackIdLessObservations.enqueue(e.objectId);var r=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(r)){var n=Object(k.k)(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1e3,a=Object(Re.d)(n,0,1e3);this._trackIdToObservations.set(r,new be.a(a))}var i=this._trackIdToObservations.get(r).enqueue(e.objectId);Object(k.k)(i)&&(this._addOrUpdated.has(i)?this._addOrUpdated.delete(i):this._removed.push(i))}},{key:"checkForUpdates",value:function(){var e=this._getToAdd(),t=this._getToRemove(),r=performance.now();r-this._lastPurge>=this.purgeInterval&&(this._purge(r),this._lastPurge=r);var n=[];if(Object(k.k)(t)){var a,i=Object(m.a)(t);try{for(i.s();!(a=i.n()).done;){var s=a.value,u=this.store.removeById(s);Object(k.k)(u)&&n.push(u)}}catch(h){i.e(h)}finally{i.f()}}if(Object(k.k)(e)){var o,c=Object(m.a)(e);try{for(c.s();!(o=c.n()).done;){var l=o.value;l.attributes.__esri_timestamp__=r,this.store.add(l)}}catch(h){c.e(h)}finally{c.f()}}(e||n)&&this.store.update(e,n)}},{key:"_getToAdd",value:function(){if(!this._addOrUpdated.size)return null;var e=new Array(this._addOrUpdated.size),t=0;return this._addOrUpdated.forEach((function(r){return e[t++]=r})),this._addOrUpdated.clear(),e}},{key:"_getToRemove",value:function(){var e=this._removed;return this._removed.length?(this._removed=[],e):null}},{key:"_nextId",value:function(){var e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}},{key:"_purge",value:function(e){var t=this._purgeOptions;Object(k.k)(t)&&(this._purgeSomeByDisplayCount(t),this._purgeByAge(t),this._purgeByAgeReceived(e,t),this._purgeTracks())}},{key:"_purgeSomeByDisplayCount",value:function(e){if(e.displayCount){var t=this.store.size;if(t>e.displayCount){if(this._timeInfo.trackIdField){var r,n=Object(m.a)(this._trackIdToObservations.values());try{for(n.s();!(r=n.n()).done;){var a=r.value;if(t>e.displayCount&&a.size){var i=Object(k.q)(a.dequeue());this._removed.push(i),t--}}}catch(o){n.e(o)}finally{n.f()}}if(Object(k.k)(this._trackIdLessObservations))for(var s=t-e.displayCount;s-- >0;){var u=this._trackIdLessObservations.dequeue();Object(k.k)(u)&&this._removed.push(u)}}}}},{key:"_purgeByAge",value:function(e){var t,r=this;if(e.age&&null!==(t=this._timeInfo)&&void 0!==t&&t.startTimeField){var n=60*e.age*1e3,a=this._maxAge-n;this.store.forEach((function(e){e.attributes[r._timeInfo.startTimeField]<a&&r._removed.push(e.objectId)}))}}},{key:"_purgeByAgeReceived",value:function(e,t){var r=this;if(t.ageReceived){var n=e-60*t.ageReceived*1e3;this.store.forEach((function(e){e.attributes.__esri_timestamp__<n&&r._removed.push(e.objectId)}))}}},{key:"_purgeTracks",value:function(){var e=this;this._trackIdToObservations.forEach((function(t,r){0===t.size&&e._trackIdToObservations.delete(r)}))}}]),e}(),qe=(r(177),r(183)),ze=(r(234),r(615)),Ne=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(){return Object(a.a)(this,r),t.apply(this,arguments)}return Object(i.a)(r,[{key:"onFeature",value:function(e){this.emit("feature",e)}}]),r}(ve.a.EventedMixin(h.a)),De=Ne=Object(l.a)([Object(v.a)("esri.layers.graphics.sources.connections.StreamConnection")],Ne),Ge=M.a.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");(xe=ke||(ke={}))[xe.CONNECTING=0]="CONNECTING",xe[xe.OPEN=1]="OPEN",xe[xe.CLOSING=2]="CLOSING",xe[xe.CLOSED=3]="CLOSED";var Pe=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(e){var n;Object(a.a)(this,r),(n=t.call(this)).errorString=null;var i=e.geometryType,s=e.spatialReference,u=e.sourceSpatialReference;return n._config=e,n._featureZScaler=Object(ze.a)(i,u,s),n._open(),n}return Object(i.a)(r,[{key:"_open",value:function(){var e=Object(n.a)(c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._tryCreateWebSocket();case 2:if(e.t0=this.destroyed,e.t0){e.next=6;break}return e.next=6,this._handshake();case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){Object(k.k)(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}},{key:"connectionStatus",get:function(){if(Object(k.j)(this._websocket))return"disconnected";switch(this._websocket.readyState){case ke.CONNECTING:case ke.OPEN:return"connected";case ke.CLOSING:case ke.CLOSED:return"disconnected"}}},{key:"_tryCreateWebSocket",value:function(){var e=Object(n.a)(c.a.mark((function e(){var t,r,n,a,i,s=arguments;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=s.length>0&&void 0!==s[0]?s[0]:this._config.source.path,r=s.length>1&&void 0!==s[1]?s[1]:1e3,n=s.length>2&&void 0!==s[2]?s[2]:0,e.prev=3,!this.destroyed){e.next=6;break}return e.abrupt("return");case 6:return a=Object(qe.e)(t,this._config.customParameters),e.next=9,this._createWebSocket(a);case 9:this._websocket=e.sent,this.notifyChange("connectionStatus"),e.next=25;break;case 13:if(e.prev=13,e.t0=e.catch(3),i=r/1e3,!(this._config.maxReconnectionAttempts&&n>=this._config.maxReconnectionAttempts)){e.next=20;break}e.t1=(Ge.error(new R.a("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()),e.next=24;break;case 20:return Ge.error(new R.a("websocket-connection","Failed to connect. Attempting to reconnect in ".concat(i,"s"),e.t0)),e.next=23,Object(x.a)(r);case 23:e.t1=this._tryCreateWebSocket(t,Math.min(1.5*r,1e3*this._config.maxReconnectionInterval),n+1);case 24:return e.abrupt("return",e.t1);case 25:case"end":return e.stop()}}),e,this,[[3,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"_createWebSocket",value:function(e){var t=this;return new Promise((function(r,n){var a=new WebSocket(e);a.onopen=function(){if(a.onopen=null,t.destroyed)return a.onclose=null,void a.close();a.onclose=function(e){return t._onClose(e)},a.onerror=function(e){return t._onError(e)},a.onmessage=function(e){return t._onMessage(e)},r(a)},a.onclose=function(e){a.onopen=a.onclose=null,n(e)}}))}},{key:"_handshake",value:function(){var e=Object(n.a)(c.a.mark((function e(){var t,r,n,a,i,s,u,o,l=this,h=arguments;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=h.length>0&&void 0!==h[0]?h[0]:1e4,r=this._websocket,!Object(k.j)(r)){e.next=4;break}return e.abrupt("return");case 4:return n=Object(x.d)(),a=r.onmessage,i=this._config,s=i.filter,u=i.outFields,o=i.spatialReference,e.abrupt("return",(n.timeout(t),r.onmessage=function(e){var t,i=null;try{i=JSON.parse(e.data)}catch(c){}i&&"object"==typeof i||(Ge.error(new R.a("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),n.reject(),l.destroy()),(null===(t=i.spatialReference)||void 0===t?void 0:t.wkid)!==(null===o||void 0===o?void 0:o.wkid)&&(Ge.error(new R.a("websocket-connection","Protocol violation. Handshake failed - expected wkid of ".concat(o.wkid),e.data)),n.reject(),l.destroy()),"json"!==i.format&&(Ge.error(new R.a("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),n.reject(),l.destroy()),s&&i.filter!==s&&Ge.error(new R.a("websocket-connection","Tried to set filter, but server doesn't support it")),u&&i.outFields!==u&&Ge.error(new R.a("websocket-connection","Tried to set outFields, but server doesn't support it")),r.onmessage=a,n.resolve()},r.send(JSON.stringify({filter:s,outFields:u,format:"json",spatialReference:{wkid:o.wkid}})),n.promise));case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){try{var t=JSON.parse(e.data);if("featureResult"!==t.type)throw new R.a("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",t);var r,n=Object(m.a)(t.features);try{for(n.s();!(r=n.n()).done;){var a=r.value;Object(k.k)(this._featureZScaler)&&this._featureZScaler(a.geometry),this.onFeature(a)}}catch(i){n.e(i)}finally{n.f()}}catch(s){return Ge.error(new R.a("websocket-connection","Failed to parse message",s)),void this.destroy()}}},{key:"_onError",value:function(e){var t="Encountered an error over WebSocket connection";this._set("errorString",t),Ge.error("websocket-connection",t)}},{key:"_onClose",value:function(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&Ge.error("websocket-connection","WebSocket closed unexpectedly with error code ".concat(e.code)),this.destroyed||this._open()}}]),r}(De);Object(l.a)([Object(p.b)()],Pe.prototype,"connectionStatus",null),Object(l.a)([Object(p.b)()],Pe.prototype,"errorString",void 0),Pe=Object(l.a)([Object(v.a)("esri.layers.graphics.sources.connections.WebSocketConnection")],Pe);var Ue=r(168),Le=r(185),Be=M.a.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),Ve={maxQueryDepth:5,maxRecordCountFactor:3},Qe=function(e){Object(s.a)(o,e);var t=Object(u.a)(o);function o(e){return Object(a.a)(this,o),t.call(this,Object(_.a)(Object(_.a)({},Ve),e))}return Object(i.a)(o,[{key:"_open",value:function(){var e=Object(n.a)(c.a.mark((function e(){var t,r,n,a,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._fetchServiceDefinition(this._config.source);case 2:return(t=e.sent).timeInfo.trackIdField||Be.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect."),r=this._fetchWebSocketUrl(t.streamUrls,this._config.spatialReference),this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),e.next=8,this._buddyServicesQuery;case 8:return e.next=10,this._tryCreateWebSocket(r);case 10:n=this._config,a=n.filter,i=n.outFields,this.destroyed||this._setFilter(a,i);case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){var t;try{t=this._enrich(JSON.parse(e.data)),Object(k.k)(this._featureZScaler)&&this._featureZScaler(t.geometry)}catch(r){return void Be.error(new R.a("geoevent-connection","Failed to parse message",r))}this.onFeature(t)}},{key:"_fetchServiceDefinition",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Object(_.a)({f:"json"},this._config.customParameters),n=Object(C.default)(t.path,{query:r,responseType:"json"}),e.next=4,n;case 4:return a=e.sent.data,e.abrupt("return",(this._serviceDefinition=a,a));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchWebSocketUrl",value:function(e,t){var r=e[0],n=r.urls,a=r.token,i=this._inferWebSocketBaseUrl(n);return Object(qe.e)("".concat(i,"/subscribe"),{outSR:""+t.wkid,token:a})}},{key:"_inferWebSocketBaseUrl",value:function(e){if(1===e.length)return e[0];var t,r=Object(m.a)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(n.includes("wss"))return n}}catch(a){r.e(a)}finally{r.f()}return Be.error(new R.a("geoevent-connection","Unable to infer WebSocket url",e)),null}},{key:"_setFilter",value:function(){var e=Object(n.a)(c.a.mark((function e(t,r){var n,a,i,s,u,o,l=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._websocket,!(Object(k.j)(n)||Object(k.j)(t)&&Object(k.j)(r))){e.next=3;break}return e.abrupt("return");case 3:return a=JSON.stringify({filter:this._serializeFilter(t,r)}),i=!1,s=Object(x.d)(),u=function(){i||(l.destroyed||l._websocket!==n||Be.error(new R.a("geoevent-connection","Server timed out when setting filter")),s.reject())},o=function(e){var t=JSON.parse(e.data);t.filter&&(t.error&&(Be.error(new R.a("geoevent-connection","Failed to set service filter",t.error)),l._set("errorString","Could not set service filter - ".concat(t.error)),s.reject(t.error)),n.onmessage=l._onMessage.bind(l),i=!0,s.resolve())},e.abrupt("return",(n.onmessage=o,n.send(a),setTimeout(u,1e4),s.promise));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_serializeFilter",value:function(e,t){var r={};if(Object(k.j)(e)&&Object(k.j)(t))return r;if(Object(k.k)(e)&&e.geometry)try{var n=Object(Ue.a)(e.geometry);if("extent"!==n.type)throw new R.a("Expected extent but found type ".concat(n.type));r.geometry=JSON.stringify(n.shiftCentralMeridian())}catch(a){Be.error(new R.a("geoevent-connection","Encountered an error when setting connection geometryDefinition",a))}return Object(k.k)(e)&&e.where&&"1 = 1"!==e.where&&(r.where=e.where),Object(k.k)(t)&&(r.outFields=t.join(",")),r}},{key:"_enrich",value:function(e){if(!this._relatedFeatures)return e;var t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return Be.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;var n=this._relatedFeatures.get(r),a=n.attributes,i=n.geometry;for(var s in a)e.attributes[s]=a[s];return i&&(e.geometry=i),e.geometry||e.centroid||Be.error(new R.a("geoevent-connection","Found malformed feature - no geometry found",e)),e}},{key:"_queryBuddyServices",value:function(){var e=Object(n.a)(c.a.mark((function e(){var t,r,n,a,i,s,u,o,l;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this._serviceDefinition,r=t.relatedFeatures,n=t.keepLatestArchive,a=this._queryRelatedFeatures(r),i=this._queryArchive(n),e.next=4,a;case 4:return e.next=6,i;case 6:if(s=e.sent){e.next=9;break}return e.abrupt("return");case 9:u=Object(m.a)(s.features);try{for(u.s();!(o=u.n()).done;)l=o.value,this.onFeature(this._enrich(l))}catch(c){u.e(c)}finally{u.f()}e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),Be.error(new R.a("geoevent-connection","Encountered an error when querying buddy services",{error:e.t0}));case 16:case"end":return e.stop()}}),e,this,[[0,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"_queryRelatedFeatures",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this._queryBuddy(t.featuresUrl);case 4:r=e.sent,this._addRelatedFeatures(r);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryArchive",value:function(){var e=Object(n.a)(c.a.mark((function e(t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=2;break}return e.abrupt("return",this._queryBuddy(t.featuresUrl));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryBuddy",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var n,a,i,s,u,o,l,h,d,f,p;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.resolve().then(r.bind(null,404));case 2:return e.t0=e.sent.default,e.t1={url:t},n=new e.t0(e.t1),e.next=7,n.load();case 7:if(a=e.sent,i=a.capabilities,s=i.query.supportsMaxRecordCountFactor,u=i.query.supportsPagination,o=i.query.supportsCentroid,l=this._config.maxRecordCountFactor,h=n.capabilities.query.maxRecordCount,d=s?h*l:h,(f=new ge.a).outFields=Object(k.r)(this._config.outFields,["*"]),f.where=Object(k.r)(Object(k.i)(this._config.filter,"where"),"1=1"),f.returnGeometry=!0,f.returnExceededLimitFeatures=!0,f.outSpatialReference=Le.a.fromJSON(this._config.spatialReference),o&&(f.returnCentroid=!0),s&&(f.maxRecordCountFactor=l),!u){e.next=18;break}return e.abrupt("return",(f.num=d,n.destroy(),this._queryPages(t,f)));case 18:return e.next=20,Object(N.executeQuery)(t,f,this._config.sourceSpatialReference);case 20:return p=e.sent,e.abrupt("return",(n.destroy(),p.data));case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryPages",value:function(){var e=Object(n.a)(c.a.mark((function e(t,r){var n,a,i,s,u=arguments;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=u.length>2&&void 0!==u[2]?u[2]:[],a=u.length>3&&void 0!==u[3]?u[3]:0,r.start=Object(k.k)(r.num)?a*r.num:null,e.next=5,Object(N.executeQuery)(t,r,this._config.sourceSpatialReference);case 5:return i=e.sent,s=i.data,e.abrupt("return",s.exceededTransferLimit&&a<this._config.maxQueryDepth?(s.features.forEach((function(e){return n.push(e)})),this._queryPages(t,r,n,a+1)):(n.forEach((function(e){return s.features.push(e)})),s));case 8:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_addRelatedFeatures",value:function(e){var t,r=new Map,n=e.features,a=this._serviceDefinition.relatedFeatures.joinField,i=Object(m.a)(n);try{for(i.s();!(t=i.n()).done;){var s=t.value,u=s.attributes[a];r.set(u,s)}}catch(o){i.e(o)}finally{i.f()}this._relatedFeatures=r}}]),o}(Pe),Ze=Qe=Object(l.a)([Object(v.a)("esri.layers.graphics.sources.connections.GeoEventConnection")],Qe);function Ye(e,t){var r=e.weakClone();if(Object(k.k)(e.geometry)){var n=Object(j.v)(t,e.geometry.coords[0]),a=Object(j.w)(t,e.geometry.coords[1]);r.geometry=new L.a([],[n,a])}return r}function He(e,t){var r=Object(Ce.a)(9,function(e){return"esriGeometryPoint"===e?function(e){return Object(k.k)(e.geometry)?{minX:e.geometry.coords[0],minY:e.geometry.coords[1],maxX:e.geometry.coords[0],maxY:e.geometry.coords[1]}:{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}:function(e){var t=1/0,r=1/0,n=-1/0,a=-1/0;return Object(k.k)(e.geometry)&&e.geometry.forEachVertex((function(e,i){t=Math.min(t,e),r=Math.min(r,i),n=Math.max(n,e),a=Math.max(a,i)})),{minX:t,minY:r,maxX:n,maxY:a}}}(t));return r.load(e),r}var Xe=function(){function e(t,r){Object(a.a)(this,e),this.onUpdate=t,this._geometryType=r,this._objectIdToFeature=new Map}return Object(i.a)(e,[{key:"_features",get:function(){var e=[];return this._objectIdToFeature.forEach((function(t){return e.push(t)})),e}},{key:"add",value:function(e){this._objectIdToFeature.set(e.objectId,e),this._index=null}},{key:"get",value:function(e){return this._objectIdToFeature.has(e)?this._objectIdToFeature.get(e):null}},{key:"forEach",value:function(e){this._objectIdToFeature.forEach(e)}},{key:"search",value:function(e){return this._index||(this._index=He(this._features,this._geometryType)),function(e,t){return e.search({minX:t.bounds[0],minY:t.bounds[1],maxX:t.bounds[2],maxY:t.bounds[3]})}(this._index,e)}},{key:"removeById",value:function(e){var t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),this._index=null,t):null}},{key:"update",value:function(e,t){this.onUpdate(e,t)}},{key:"size",get:function(){return this._objectIdToFeature.size}}]),e}(),We=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(e){var n;Object(a.a)(this,r),(n=t.call(this,e)).type="geoevent",n._dataReceiveEventEnabled=!1,n._level=0,n._updateInfo={websocket:0,client:0};var i=e.outSR,s=e.serviceInfo,u=s.geometryType,o=s.objectIdField,c=s.timeInfo,l=s.purgeOptions,h=s.source,d=s.spatialReference,p=s.serviceFilter,v=s.maxReconnectionAttempts,y=s.maxReconnectionInterval,g=s.updateInterval,b=s.enableDataReceived,m=s.customParameters,_=new Xe(n._onUpdate.bind(Object(Ae.a)(n)),u),k=new Ee(_,o,c,l),x=function(e,t,r,n,a,i,s,u){var o=0===e.path.indexOf("wss://")||0===e.path.indexOf("ws://"),c={source:e,sourceSpatialReference:t,spatialReference:r,geometryType:n,filter:a,maxReconnectionAttempts:i,maxReconnectionInterval:s,customParameters:u};return o?new Pe(c):new Ze(c)}(h,d,i,u,p,v,y,m);return n._store=_,n._manager=k,n._connection=x,n._quantize=function(e){return"esriGeometryPoint"===e?Ye:function(t,r){var n=t.weakClone(),a=new L.a,i=Object(j.u)(a,t.geometry,!1,!1,e,r,!1,!1);return n.geometry=i,n}}(u),n._dataReceiveEventEnabled=b,n._handles=[n._connection.on("feature",(function(e){return n._onFeature(e)})),Object(f.e)((function(){return x.connectionStatus}),(function(e){return n.events.emit("connectionStatus",e)})),Object(f.e)((function(){return x.errorString}),(function(e){return n.events.emit("errorString",e)}))],n._initUpdateInterval=function(){var t=performance.now();n._updateIntervalId=setInterval((function(){var r=performance.now(),a=r-t;if(a>2500){t=r;var i=Math.round(n._updateInfo.client/(a/1e3)),s=Math.round(n._updateInfo.websocket/(a/1e3));n._updateInfo.client=0,n._updateInfo.websocket=0,n.events.emit("updateRate",{client:i,websocket:s})}e.canAcceptRequest()&&n._manager.checkForUpdates()}),g)},n._initUpdateInterval(),n}return Object(i.a)(r,[{key:"destroy",value:function(){Object(T.a)(Object(A.a)(r.prototype),"destroy",this).call(this),this._clearUpdateInterval(),this._handles.forEach((function(e){return e.remove()})),this._connection.destroy()}},{key:"_fetchDataTile",value:function(){}},{key:"pauseStream",value:function(){this._clearUpdateInterval()}},{key:"resumeStream",value:function(){this._initUpdateInterval()}},{key:"enableEvent",value:function(e,t){"data-received"===e&&(this._dataReceiveEventEnabled=t)}},{key:"updating",get:function(){return!1}},{key:"subscribe",value:function(e,t){Object(T.a)(Object(A.a)(r.prototype),"subscribe",this).call(this,e,t);var n=this._subscriptions.get(e.id);this._level=e.level;var a=this._getTileFeatures(e);this._onMessage({type:"append",id:e.key.id,addOrUpdate:a,end:!0}),n.didSend=!0}},{key:"unsubscribe",value:function(e){Object(T.a)(Object(A.a)(r.prototype),"unsubscribe",this).call(this,e)}},{key:"readers",value:c.a.mark((function e(t){var r,n,a,i,s;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._subscriptions.get(t),n=r.tile,e.next=3,this._getTileFeatures(n);case 3:a=Object(m.a)(r.requests.stream.entries),e.prev=4,a.s();case 6:if((i=a.n()).done){e.next=14;break}if(s=i.value,e.t0=Object(k.k)(s)&&Object(k.k)(s.addOrUpdate),!e.t0){e.next=12;break}return e.next=12,s.addOrUpdate;case 12:e.next=6;break;case 14:e.next=19;break;case 16:e.prev=16,e.t1=e.catch(4),a.e(e.t1);case 19:return e.prev=19,a.f(),e.finish(19);case 22:case"end":return e.stop()}}),e,this,[[4,16,19,22]])}))},{key:"createTileQuery",value:function(e){throw new Error("Service does not support tile  queries")}},{key:"resend",value:function(){var e=Object(n.a)(c.a.mark((function e(){var t=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._subscriptions.forEach((function(e){var r=e.tile,n={type:"append",id:r.id,addOrUpdate:t._getTileFeatures(r),end:!0};t._onMessage(n)}));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_getTileFeatures",value:function(e){var t=this,r=this._store.search(e).map((function(r){return t._quantize(r,e.transform)}));return D.a.fromOptimizedFeatures(r,this._serviceInfo,e.transform)}},{key:"_onFeature",value:function(e){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("feature",e);var t=Object(j.a)(e,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(t)}catch(r){}}},{key:"_clearUpdateInterval",value:function(){clearInterval(this._updateIntervalId),this._updateIntervalId=0}},{key:"_onUpdate",value:function(e,t){var r=this;Object(k.k)(e)&&(this._updateInfo.client+=e.length),this._subscriptions.forEach((function(e,t){e.didSend&&e.tile.level===r._level&&r._onMessage({type:"append",id:t,addOrUpdate:null,clear:!0,end:!1})})),this._subscriptions.forEach((function(e,t){if(e.didSend&&e.tile.level===r._level){var n=e.tile,a={type:"append",id:t,addOrUpdate:r._getTileFeatures(n),remove:[],end:!0,status:me.empty()};e.requests.stream.enqueue(a),r._onMessage(a)}}))}}]),r}(je),Je=M.a.getLogger("esri.views.2d.layers.features.sources.FeatureSource"),$e=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(e){return Object(a.a)(this,r),t.call(this,e)}return Object(i.a)(r,[{key:"_fetchDataTile",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n,a,i,s,u,o,l,h,d,f,p,v=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=6,n=20,a=this._subscriptions.get(t.key.id),i=!1,s=0,u=0,o=function(e,r){u--,Object(x.p)(a);var n=t.id,s=e.reader,o=e.query;if(!s.exceededTransferLimit){if(i=!0,0!==r&&!s.hasFeatures){var c={id:n,addOrUpdate:s,end:0===u,type:"append"};return a.add({message:c,query:o}),void v._onMessage(c)}var l={id:n,addOrUpdate:s,end:0===u,type:"append"};return a.add({message:l,query:o}),void v._onMessage(l)}var h={id:n,addOrUpdate:s,end:i&&0===u,type:"append"};a.add({message:h,query:o}),v._onMessage(h)},l=0,h=0;case 4:if(i||!(h++<n)){e.next=14;break}for(d=void 0,f=function(e){var r=s++;u++,d=v._fetchDataTilePage(t,r,a).then((function(e){return e&&o(e,r)})).catch((function(e){i=!0,Object(x.j)(e)||(Je.error(new R.a("mapview-query-error","Encountered error when fetching tile",{tile:t,error:e})),v._onMessage({id:t.id,addOrUpdate:null,end:i,type:"append"}))}))},p=0;p<l+1;p++)f();return e.next=10,d;case 10:Object(x.p)(a),l=Math.min(l+2,r);case 12:e.next=4;break;case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchDataTilePage",value:function(){var e=Object(n.a)(c.a.mark((function e(t,r,n){var a,i,s,u,o;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Object(x.p)(n),a=this._queryInfo,i={start:this.pageSize*r,num:this.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:t.getQuantizationParameters()},Object(k.k)(this.maxRecordCountFactor)&&(i.maxRecordCountFactor=this.maxRecordCountFactor),s=this.createTileQuery(t,i),e.prev=4,u=n.signal,e.next=8,this._queue.push({tile:t,query:s,signal:u,depth:r});case 8:return o=e.sent,e.abrupt("return",(Object(x.p)(n),o?a!==this._queryInfo?this._fetchDataTilePage(t,r,n):{reader:o,query:s}:null));case 12:return e.prev=12,e.t0=e.catch(4),e.abrupt("return",(Object(x.q)(e.t0),null));case 15:case"end":return e.stop()}}),e,this,[[4,12]])})));return function(t,r,n){return e.apply(this,arguments)}}()}]),r}(we),Ke=r(247),et=r(732),tt=M.a.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource");function rt(e,t,r){var n=e.getXHydrated(),a=e.getYHydrated(),i=t.getColumnForX(n),s=Math.floor(t.normalizeCol(i));return"".concat(r,"/").concat(Math.floor(t.getRowForY(a)),"/").concat(s)}function nt(e,t){if(Object(k.j)(e))return null;var r=t.transform,n=e.getQuantizationTransform();if(Object(k.j)(n)){var a=Object(G.a)(r.scale,2),i=a[0],s=a[1],u=Object(G.a)(r.translate,2),o=-u[0]/i,c=1/i,l=u[1]/s,h=1/-s;return e.transform(o,l,c,h)}var d=Object(G.a)(n.scale,2),f=d[0],p=d[1],v=Object(G.a)(n.translate,2),y=v[0],g=v[1],b=Object(G.a)(r.scale,2),m=b[0],_=b[1],x=Object(G.a)(r.translate,2),j=f/m,O=(y-x[0])/m,I=p/_,w=(-g+x[1])/_;return e.transform(O,w,j,I)}var at=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(e){var n;return Object(a.a)(this,r),(n=t.call(this,e)).mode="snapshot",n._loading=!0,n._controller=new AbortController,n._downloadPromise=null,n._didSendEnd=!1,n._queries=new Array,n._invalidated=!1,n._hasAggregates=!1,n._random=new Ke.a(1e3),n._store=e.store,n._markedIdsBufId=n._store.storage.createBitset(),n}return Object(i.a)(r,[{key:"destroy",value:function(){Object(T.a)(Object(A.a)(r.prototype),"destroy",this).call(this),this._controller.abort()}},{key:"loading",get:function(){return this._loading}},{key:"_signal",get:function(){return this._controller.signal}},{key:"update",value:function(e,t){Object(T.a)(Object(A.a)(r.prototype),"update",this).call(this,e,t),this._hasAggregates=e.targets.aggregate}},{key:"resend",value:function(){var e=Object(n.a)(c.a.mark((function e(){var t,r,n,a=this,i=arguments;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=i.length>0&&void 0!==i[0]&&i[0],e.next=3,this._downloadPromise;case 3:if(!this._invalidated&&!t){e.next=11;break}return r=Object(k.s)(this._schema.featureCount,"Expected featureCount to be defined"),this._invalidated=!1,this._subscriptions.forEach((function(e){return e.clear()})),this._downloadPromise=this._download(r),e.next=10,this._downloadPromise;case 10:return e.abrupt("return",void e.sent);case 11:return n=this._queries.map((function(e){var t=e.query,r=e.reader;return a._sendPatchQuery(t,r)})),e.next=14,Promise.all(n);case 14:this._subscriptions.forEach((function(e){e.requests.done.forEach((function(e){return a._onMessage(e.message)}))}));case 15:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"refresh",value:function(){var e=Object(n.a)(c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.resend(!0);case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_sendPatchQuery",value:function(){var e=Object(n.a)(c.a.mark((function e(t,r){var n,a,i,s,u,o;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=Object(k.k)(t.outFields)?t.outFields:[],a=this._queryInfo.outFields,i=a.filter((function(e){return!n.includes(e)})),i.length){e.next=3;break}return e.abrupt("return");case 3:return s=t.clone(),u=this._signal,s.returnGeometry=!1,s.returnCentroid=!1,s.outFields=i,t.outFields=a,e.next=7,this._queue.push({query:s,depth:0,signal:u});case 7:o=e.sent,Object(x.p)({signal:u}),r.joinAttributes(o);case 9:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_fetchDataTile",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n,a,i,s,u,o,l,h,d;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._downloadPromise||(r=Object(k.s)(this._schema.featureCount,"Expected featureCount to be defined"),this._downloadPromise=this._download(r)),n=this._store.search(t),a=this._subscriptions.get(t.key.id),i=n.length-1,s=0;case 3:if(!(s<i)){e.next=14;break}if(u=nt(n[s],t),o={type:"append",id:t.id,addOrUpdate:u,end:!1,status:me.empty()},a.add({query:null,message:o}),e.t0=this._hasAggregates,e.t0){e.next=10;break}return e.next=10,Object(x.a)(1);case 10:this._onMessage(o);case 11:s++,e.next=3;break;case 14:l=nt(i>=0?n[i]:null,t),h=this._didSendEnd,d={type:"append",id:t.id,addOrUpdate:l,end:h,status:me.empty()},a.add({query:null,message:d}),this._onMessage(d);case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_download",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n,a,i,s=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.whenInitialized();case 3:return r=this._store.storage.getBitset(this._markedIdsBufId),n=new Set,r.clear(),a=Math.ceil(t/this.pageSize),i=Array.from({length:a},(function(e,t){return t})).sort((function(e,t){return s._random.getInt()-s._random.getInt()})).map((function(e){return s._downloadPage(e,r,n)})),e.next=8,Promise.all(i);case 8:this._store.sweepFeatures(r,this._store.storage),this._store.sweepFeatureSets(n),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(0),tt.error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",e.t0);case 15:this._sendEnd(),this._loading=!1;case 16:case"end":return e.stop()}}),e,this,[[0,12]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_downloadPage",value:function(){var e=Object(n.a)(c.a.mark((function e(t,r,n){var a,i,s,u,o,l;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=this.pageSize,i={start:t*a,num:a,cacheHint:!0},Object(k.k)(this.maxRecordCountFactor)&&(i.maxRecordCountFactor=this.maxRecordCountFactor),s=this.createQuery(i),u=this._signal,e.next=6,this._queue.push({query:s,depth:t,signal:u});case 6:for(o=e.sent,Object(x.p)({signal:u}),this._queries.push({query:s,reader:o}),this._store.insert(o),n.add(o.instance),l=o.getCursor();l.next();)r.set(l.getDisplayId());this._send(o);case 11:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_send",value:function(e){var t=this;if(this._subscriptions.size){var r=null,n=new Map,a=new Set,i=new Map;this._subscriptions.forEach((function(e){var t,s=e.tile;n.set(s.key.id,null),r=s.tileInfoView,a.add(s.level);var u=s.key,o=u.row,c=u.col,l="".concat(s.level,"/").concat(o,"/").concat(c),h=null!==(t=i.get(l))&&void 0!==t?t:[];h.push(e),i.set(l,h)}));var s,u=Object(m.a)(a);try{for(u.s();!(s=u.n()).done;)for(var o=s.value,c=r.getLODInfoAt(o),l=e.getCursor();l.next();){var h=rt(l,c,o),d=l.getIndex();if(i.has(h)){var f,p=Object(m.a)(i.get(h));try{for(p.s();!(f=p.n()).done;){var v=f.value.tile.id,y=n.get(v);Object(k.j)(y)&&(y=[],n.set(v,y)),y.push(d)}}catch(g){p.e(g)}finally{p.f()}}}}catch(g){u.e(g)}finally{u.f()}n.forEach((function(r,n){if(Object(k.k)(r)){var a=t._subscriptions.get(n),i={type:"append",id:n,addOrUpdate:nt(et.a.from(e,r),a.tile),end:!1,status:me.empty()};a.add({query:null,message:i}),t._onMessage(i)}}))}}},{key:"_sendEnd",value:function(){var e=this;this._subscriptions.forEach((function(t){var r={type:"append",id:t.tile.id,addOrUpdate:null,end:!0,status:me.empty()};t.add({query:null,message:r}),e._onMessage(r)})),this._didSendEnd=!0}}]),r}(we);function it(e,t,r,n,a,i){var s=function(e,t,r,n,a,i){switch(e.type){case"snapshot":return{type:"feature",origin:"snapshot",featureCount:Object(k.r)(e.featureCount,0),serviceInfo:e,onMessage:n,outSR:t,tileInfoView:r,canAcceptRequest:a,store:i};case"stream":return{type:"geoevent",serviceInfo:e,onMessage:n,outSR:t,canAcceptRequest:a};case"memory":case"on-demand":return{type:"feature",serviceInfo:e,onMessage:n,outSR:t,origin:s(e.source),tileInfoView:r,canAcceptRequest:a}}function s(e){return Array.isArray(e)?"local":"path"in e&&Object(S.c)(e.path)?"hosted":"unknown"}}(e,t,r,n,a,i);switch(s.type){case"feature":switch(s.origin){case"hosted":case"local":return new $e(s);case"snapshot":return new at(s);case"unknown":return new Te(s)}case"geoevent":return new We(s)}}var st=r(388);new Float64Array(2),new Float64Array(2);function ut(e,t,r,n){n%2&&(n+=1);for(var a=0,i=0,s=-90,u=90,o=-180,c=180,l=0;l<n/2;l++){for(var h=0;h<5;h++){var d=(o+c)/2,f=r>d?1:0;a|=f<<29-(h+5*l),o=(1-f)*o+f*d,c=(1-f)*d+f*c}for(var p=0;p<5;p++){var v=(s+u)/2,y=t>v?1:0;i|=y<<29-(p+5*l),s=(1-y)*s+y*v,u=(1-y)*v+y*u}}e.geohashX=a,e.geohashY=i}function ot(e,t,r,n,a){a%2&&(a+=1);for(var i=0,s=0,u=-90,o=90,c=-180,l=180,h=0;h<a/2;h++){for(var d=0;d<5;d++){var f=(c+l)/2,p=n>f?1:0;i|=p<<29-(d+5*h),c=(1-p)*c+p*f,l=(1-p)*f+p*l}for(var v=0;v<5;v++){var y=(u+o)/2,g=r>y?1:0;s|=g<<29-(v+5*h),u=(1-g)*u+g*y,o=(1-g)*y+g*o}}e[2*t]=i,e[2*t+1]=s}var ct=r(278),lt=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=arguments.length>1?arguments[1]:void 0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8096;Object(a.a)(this,e),this.onRelease=function(e){},this._nodes=0,this._root=new ht(this,0,0,0),this._statisticFields=t,this._pool=n?new be.a(8096):null,this._serviceInfo=r}return Object(i.a)(e,[{key:"destroy",value:function(){this.clear()}},{key:"_acquire",value:function(e,t,r){this._nodes++;var n=null;return Object(k.k)(this._pool)&&(n=this._pool.dequeue()),Object(k.k)(n)?n.realloc(e,t,r):n=new ht(this,e,t,r),n}},{key:"_release",value:function(e){this.onRelease(e),this._nodes--,Object(k.k)(this._pool)&&this._pool.enqueue(e)}},{key:"count",get:function(){return this._root.count}},{key:"size",get:function(){return this._nodes}},{key:"poolSize",get:function(){return Object(k.m)(this._pool,0,(function(e){return e.size}))}},{key:"depth",get:function(){var e=0;return this.forEach((function(t){return e=Math.max(e,t.depth)})),e}},{key:"dropLevels",value:function(e){var t=this;this.forEach((function(r){if(r.depth>=e)for(var n=0;n<r.children.length;n++){var a=r.children[n];a&&t._release(a)}})),this.forEach((function(t){if(t.depth>=e)for(var r=0;r<t.children.length;r++)t.children[r]=null}))}},{key:"clear",value:function(){var e=this;this.forEach((function(t){return e._release(t)})),this._root=new ht(this,0,0,0)}},{key:"insert",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=D.a.fromOptimizedFeatures([e],this._serviceInfo).getCursor();n.next();var a=n.readGeometry();if(a){var i=Object(G.a)(a.coords,2),s=i[0],u=i[1],o=e.geohashX,c=e.geohashY;this.insertCursor(n,e.displayId,s,u,o,c,t,r)}}},{key:"insertCursor",value:function(e,t,r,n,a,i,s){for(var u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,o=this._root,c=0,l=0,h=0;null!==o;){if(o.depth>=u&&(o.count+=1,o.xTotal+=r,o.yTotal+=n,o.xGeohashTotal+=a,o.yGeohashTotal+=i,o.referenceId=t,this._updateStatisticsCursor(e,o,1)),c>=s)return void o.add(t);var d=Math.ceil((c+1)/2),f=Math.floor((c+1)/2),p=1-c%2,v=30-(3*d+2*f),y=30-(2*d+3*f),g=(a&7*p+3*(1-p)<<v)>>v,b=(i&3*p+7*(1-p)<<y)>>y,m=g+b*(8*p+4*(1-p));l=l<<3*p+2*(1-p)|g,h=h<<2*p+3*(1-p)|b,null==o.children[m]&&(o.children[m]=this._acquire(l,h,c+1)),c+=1,o=o.children[m]}}},{key:"remove",value:function(e,t){var r=D.a.fromOptimizedFeatures([e],this._serviceInfo).getCursor();r.next();var n=r.readGeometry();if(n){var a=Object(G.a)(n.coords,2),i=a[0],s=a[1],u=e.geohashX,o=e.geohashY;this.removeCursor(r,i,s,u,o,t)}}},{key:"removeCursor",value:function(e,t,r,n,a,i){for(var s=this._root,u=0;null!==s;){if(s.count-=1,s.xTotal-=t,s.yTotal-=r,s.xGeohashTotal-=n,s.yGeohashTotal-=a,this._updateStatisticsCursor(e,s,-1),u>=i)return void s.remove(e.getDisplayId());var o=Math.ceil((u+1)/2),c=Math.floor((u+1)/2),l=1-u%2,h=30-(3*o+2*c),d=30-(2*o+3*c),f=((n&7*l+3*(1-l)<<h)>>h)+((a&3*l+7*(1-l)<<d)>>d)*(8*l+4*(1-l)),p=s.children[f];1===p.count&&(this._release(p),s.children[f]=null),u+=1,s=p}}},{key:"forEach",value:function(e){for(var t=this._root;null!==t;){var r=this._linkChildren(t)||t.next;e(t),t=r}}},{key:"find",value:function(e,t,r){return this._root.find(e,t,r,0,0,0)}},{key:"findIf",value:function(e){var t=null;return this.forEach((function(r){e(r)&&(t=r)})),t}},{key:"findAllIf",value:function(e){var t=[];return this.forEach((function(r){e(r)&&t.push(r)})),t}},{key:"findSingleOccupancyNode",value:function(e,t,r,n,a){for(var i=this._root;null!==i;){var s=i.depth,u=i.xNode,o=i.yNode,c=1-s%2,l=i.xGeohashTotal/i.count,h=i.yGeohashTotal/i.count;if(1===i.count&&e<l&&l<=r&&t<h&&h<=n)return i;if(s>=a)i=i.next;else{for(var d=Math.ceil((s+1)/2),f=Math.floor((s+1)/2),p=30-(3*d+2*f),v=30-(2*d+3*f),y=~((1<<p)-1),g=~((1<<v)-1),b=(e&y)>>p,m=(t&g)>>v,_=(r&y)>>p,k=(n&g)>>v,x=u<<3*c+2*(1-c),j=o<<2*c+3*(1-c),O=x+8*c+4*(1-c),I=j+4*c+8*(1-c),w=Math.max(x,b),S=Math.max(j,m),F=Math.min(O,_),T=Math.min(I,k),A=null,C=null,R=S;R<=T;R++)for(var M=w;M<=F;M++){var E=M-x+(R-j)*(8*c+4*(1-c)),q=i.children[E];q&&(A||((A=q).next=i.next),C&&(C.next=q),C=q,q.next=i.next)}i=A||i.next}}return null}},{key:"getRegionDisplayIds",value:function(e,t,r,n,a){for(var i=this._root,s=[];null!==i;){var u=i.depth,o=i.xNode,c=i.yNode;if(u>=a){var l=i.xGeohashTotal/i.count,h=i.yGeohashTotal/i.count;e<=l&&l<=r&&t<=h&&h<=n&&i.displayIds.forEach((function(e){return s.push(e)})),i=i.next}else{for(var d=Math.ceil((u+1)/2),f=Math.floor((u+1)/2),p=1-u%2,v=30-(3*d+2*f),y=30-(2*d+3*f),g=~((1<<v)-1),b=~((1<<y)-1),m=(e&g)>>v,_=(t&b)>>y,k=(r&g)>>v,x=(n&b)>>y,j=o<<3*p+2*(1-p),O=c<<2*p+3*(1-p),I=j+8*p+4*(1-p),w=O+4*p+8*(1-p),S=Math.max(j,m),F=Math.max(O,_),T=Math.min(I,k),A=Math.min(w,x),C=null,R=null,M=F;M<=A;M++)for(var E=S;E<=T;E++){var q=E-j+(M-O)*(8*p+4*(1-p)),z=i.children[q];z&&(C||((C=z).next=i.next),R&&(R.next=z),R=z,z.next=i.next)}i=C||i.next}}return s}},{key:"getRegionStatistics",value:function(e,t,r,n,a){for(var i=this._root,s=0,u=0,o=0,c={},l=0;null!==i;){var h=i.depth,d=i.xNode,f=i.yNode;if(h>=a){var p=i.xGeohashTotal/i.count,v=i.yGeohashTotal/i.count;e<p&&p<=r&&t<v&&v<=n&&(s+=i.count,u+=i.xTotal,o+=i.yTotal,1===i.count&&(l=i.referenceId),this._aggregateStatistics(c,i.statistics)),i=i.next}else{for(var y=Math.ceil((h+1)/2),g=Math.floor((h+1)/2),b=1-h%2,m=30-(3*y+2*g),_=30-(2*y+3*g),k=~((1<<m)-1),x=~((1<<_)-1),j=(e&k)>>m,O=(t&x)>>_,I=(r&k)>>m,w=(n&x)>>_,S=d<<3*b+2*(1-b),F=f<<2*b+3*(1-b),T=S+8*b+4*(1-b),A=F+4*b+8*(1-b),C=Math.max(S,j),R=Math.max(F,O),M=Math.min(T,I),E=Math.min(A,w),q=null,z=null,N=R;N<=E;N++)for(var D=C;D<=M;D++){var G=D-S+(N-F)*(8*b+4*(1-b)),P=i.children[G];if(P){if(N!==R&&N!==E&&D!==C&&D!==M){var U=P.xGeohashTotal/P.count,L=P.yGeohashTotal/P.count;e<U&&U<=r&&t<L&&L<=n&&(s+=P.count,u+=P.xTotal,o+=P.yTotal,1===i.count&&(l=i.referenceId),this._aggregateStatistics(c,P.statistics));continue}q||((q=P).next=i.next),z&&(z.next=P),z=P,P.next=i.next}}i=q||i.next}}return{count:s,attributes:this.normalizeStatistics(c,s),xTotal:u,yTotal:o,referenceId:l}}},{key:"getBins",value:function(e,t,r,n,a){for(var i=[],s=this._root;null!==s;){var u=s.depth,o=s.xNode,c=s.yNode;if(u>=a)i.push(s),s=s.next;else{for(var l=Math.ceil((u+1)/2),h=Math.floor((u+1)/2),d=1-u%2,f=30-(3*l+2*h),p=30-(2*l+3*h),v=~((1<<f)-1),y=~((1<<p)-1),g=(e&v)>>f,b=(t&y)>>p,m=(r&v)>>f,_=(n&y)>>p,k=o<<3*d+2*(1-d),x=c<<2*d+3*(1-d),j=k+8*d+4*(1-d),O=x+4*d+8*(1-d),I=Math.max(k,g),w=Math.max(x,b),S=Math.min(j,m),F=Math.min(O,_),T=null,A=null,C=w;C<=F;C++)for(var R=I;R<=S;R++){var M=R-k+(C-x)*(8*d+4*(1-d)),E=s.children[M];E&&(T||((T=E).next=s.next),A&&(A.next=E),A=E,E.next=s.next)}s=T||s.next}}return i}},{key:"_linkChildren",value:function(e){for(var t=null,r=null,n=0;n<=e.children.length;n++){var a=e.children[n];a&&(t||((t=a).next=e.next),r&&(r.next=a),r=a,a.next=e.next)}return t}},{key:"_updateStatisticsCursor",value:function(e,t,r){var n,a=Object(m.a)(this._statisticFields);try{for(a.s();!(n=a.n()).done;){var i=n.value,s=i.name,u=i.inField?e.readAttribute(i.inField):e.getComputedNumericAtIndex(i.inFieldIndex);switch(i.statisticType){case"norm":t.statistics[s]||(t.statistics[s]={});var o=i.inNormalizationField,c=e.readAttribute(o),l=t.statistics[s].onStatisticField||0,h=t.statistics[s].onStatisticNormalizationField||0;null==u||isNaN(u)||null==c||0===c||isNaN(c)||(t.statistics[s].onStatisticField=l+r*u,t.statistics[s].onStatisticNormalizationField=h+r*c);break;case"sum":case"avg":t.statistics[s]||(t.statistics[s]={value:0,nanCount:0});var d=t.statistics[s].value,f=t.statistics[s].nanCount;null==u||isNaN(u)?t.statistics[s].nanCount=f+r:t.statistics[s].value=d+r*u;break;case"avg_angle":t.statistics[s]||(t.statistics[s]={x:0,y:0,nanCount:0});var p=t.statistics[s].x,v=t.statistics[s].y,y=t.statistics[s].nanCount,g=Math.PI/180;null==u||isNaN(u)?t.statistics[s].nanCount=y+r:(t.statistics[s].x=p+r*Math.cos(u*g),t.statistics[s].y=v+r*Math.sin(u*g));break;case"mode":t.statistics[s]||(t.statistics[s]={});var b=t.statistics[s][u]||0;t.statistics[s][u]=b+r}}}catch(_){a.e(_)}finally{a.f()}}},{key:"_aggregateStatistics",value:function(e,t){var r,n=Object(m.a)(this._statisticFields);try{for(n.s();!(r=n.n()).done;){var a=r.value,i=a.name;switch(a.statisticType){case"sum":case"avg":case"avg_angle":case"mode":case"norm":for(var s in e[i]||(e[i]={}),t[i]){var u=e[i][s]||0;e[i][s]=u+t[i][s]}}}}catch(o){n.e(o)}finally{n.f()}}},{key:"normalizeStatistics",value:function(e,t){var r,n={},a=Object(m.a)(this._statisticFields);try{for(a.s();!(r=a.n()).done;){var i=r.value,s=i.name;switch(i.statisticType){case"norm":var u=e[s];if(t&&null==u.onStatisticNormalizationField)break;if(t&&u.onStatisticNormalizationField){n[s]=u.onStatisticField/u.onStatisticNormalizationField;break}n[s]=0;break;case"sum":if(!t)break;var o=e[s],c=o.value;if(!(t-o.nanCount))break;n[s]=c;break;case"avg":if(!t)break;var l=e[s],h=l.value,d=l.nanCount;if(!(t-d))break;n[s]=h/(t-d);break;case"avg_angle":if(!t)break;var f=e[s],p=f.x,v=f.y,y=f.nanCount;if(!(t-y))break;var g=p/(t-y),b=v/(t-y),_=180/Math.PI,k=Math.atan2(b,g)*_;n[s]=k;break;case"mode":var x=e[s],j=0,O=null;for(var I in x){var w=x[I];w>j&&(j=w,O=I)}n[s]="null"===O?null:O}}}catch(S){a.e(S)}finally{a.f()}return n}}]),e}(),ht=function(){function e(t,r,n,i){Object(a.a)(this,e),this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.referenceId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this._tree=t,this.children=new Array(32);for(var s=0;s<this.children.length;s++)this.children[s]=null;this.xNode=r,this.yNode=n,this.depth=i}return Object(i.a)(e,[{key:"realloc",value:function(e,t,r){for(var n=0;n<this.children.length;n++)this.children[n]=null;return this.xNode=e,this.yNode=t,this.depth=r,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.displayId=0,this.referenceId=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this}},{key:"id",get:function(){return"".concat(this.xNode,".").concat(this.yNode)}},{key:"add",value:function(e){this.displayIds.add(e)}},{key:"remove",value:function(e){this.displayIds.delete(e)}},{key:"getAttributes",value:function(){var e=this._tree.normalizeStatistics(this.statistics,this.count);return e.aggregateId=this.id,e.aggregateCount=this.count,e}},{key:"getGeometry",value:function(e,t){var r=this.getLngLatBounds(),n=Object(G.a)(r,4),a=n[0],i=n[1],s=n[2],u=n[3],o=Object(ct.b)({rings:[[[a,i],[a,u],[s,u],[s,i],[a,i]]]},Le.a.WGS84,e),c=Object(j.g)(new L.a,o,!1,!1);return Object(k.k)(t)?Object(j.u)(new L.a,c,!1,!1,"esriGeometryPolygon",t,!1,!1):c}},{key:"getLngLatBounds",value:function(){var e=this.depth,t=Math.ceil(e/2),r=Math.floor(e/2),n=30-(3*t+2*r),a=30-(2*t+3*r);return function(e,t){for(var r=-90,n=90,a=-180,i=180,s=0;s<t;s++){for(var u=Math.ceil((s+1)/2),o=Math.floor((s+1)/2),c=1-s%2,l=30-(3*u+2*o),h=30-(2*u+3*o),d=3*c+2*(1-c),f=2*c+3*(1-c),p=3*c+7*(1-c)<<h,v=(7*c+3*(1-c)<<l&e.geohashX)>>l,y=(p&e.geohashY)>>h,g=d-1;g>=0;g--){var b=(a+i)/2,m=v&1<<g?1:0;a=(1-m)*a+m*b,i=(1-m)*b+m*i}for(var _=f-1;_>=0;_--){var k=(r+n)/2,x=y&1<<_?1:0;r=(1-x)*r+x*k,n=(1-x)*k+x*n}}return[a,r,i,n]}({geohashX:this.xNode<<n,geohashY:this.yNode<<a},this.depth)}},{key:"find",value:function(e,t,r,n,a,i){if(n>=r)return this;var s=1-n%2,u=3*s+2*(1-s),o=2*s+3*(1-s),c=30-a-u,l=30-i-o,h=((e&7*s+3*(1-s)<<c)>>c)+((t&3*s+7*(1-s)<<l)>>l)*(8*s+4*(1-s)),d=this.children[h];return null==d?null:d.find(e,t,r,n+1,a+u,i+o)}}]),e}(),dt=r(514),ft=r(212),pt=r(674),vt=r(217),yt=r(176),gt=M.a.getLogger("esri.view.2d.layers.features.support.BinStore");function bt(e){return 57.29577951308232*e}var mt=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(e,n,i,s){var u;return Object(a.a)(this,r),(u=t.call(this,e,i))._geohashLevel=5,u._geohashBuf=[],u._serviceInfo=s,u.geometryInfo=e.geometryInfo,u._spatialReference=n,u._projectionSupportCheck=Object(ct.a)(n,Le.a.WGS84),u._bitsets.geohash=i.getBitset(i.createBitset()),u._bitsets.inserted=i.getBitset(i.createBitset()),u}return Object(i.a)(r,[{key:"destroy",value:function(){this._tree&&this._tree.destroy()}},{key:"updateSchema",value:function(){var e=Object(n.a)(c.a.mark((function e(t,n){var a,i,s=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=this._schema,e.prev=1,e.next=4,Object(T.a)(Object(A.a)(r.prototype),"updateSchema",this).call(this,t,n);case 4:return e.next=6,this._projectionSupportCheck;case 6:e.next=10;break;case 8:e.prev=8,e.t0=e.catch(1);case 10:i=Object(ye.a)(a,n),n&&(!Object(k.j)(i)||t.source||t.storage.filters)?((Object(ye.b)(i,"params.fields")||Object(ye.b)(i,"params")||!this._tree||t.source)&&(this._tree&&this._tree.destroy(),this._tree=new lt(this._statisticFields,this._serviceInfo),this._tree.onRelease=function(e){return e.displayId&&s._storage.releaseDisplayId(e.displayId)},this._geohashLevel=this._schema.params.fixedBinLevel,this._rebuildTree(),Object(d.a)("esri-2d-update-debug")&&gt.info("Aggregate mesh needs update due to tree changing")),Object(d.a)("esri-2d-update-debug")&&gt.info("Aggregate mesh needs update due to tree changing"),t.targets[n.name]=!0,t.mesh=!1):a&&(t.mesh=!0);case 12:case"end":return e.stop()}}),e,this,[[1,8]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"clear",value:function(){this._rebuildTree()}},{key:"sweepFeatures",value:function(e,t){var r=this;this._bitsets.inserted.forEachSet((function(n){if(!e.has(n)){var a=t.lookupByDisplayIdUnsafe(n);r._remove(a)}}))}},{key:"sweepAggregates",value:function(e,t,r){}},{key:"onTileData",value:function(e,t,r,n){var a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(!this._schema||Object(k.j)(t.addOrUpdate))return t;for(var i=this._getTransforms(e,this._spatialReference),s=t.addOrUpdate.getCursor();s.next();)this._update(s,n);if(t.status.mesh||!a)return t;var u=new Array;this._getBinsForTile(u,e,i,r),t.addOrUpdate=D.a.fromOptimizedFeatures(u,Object(_.a)(Object(_.a)({},this._serviceInfo),{},{geometryType:"esriGeometryPolygon"})),t.addOrUpdate.attachStorage(r),t.clear=!0,t.end=!0;for(var o=t.addOrUpdate.getCursor();o.next();){var c=o.getDisplayId();this._bitsets.computed.unset(c),this.setComputedAttributes(r,o,c,e.scale)}return t}},{key:"forEach",value:function(e){this._tree.forEach(e)}},{key:"onTileUpdate",value:function(e){}},{key:"getAggregate",value:function(e){var t=this,r=Object(ft.d)(e,!0),n=this._tree.findIf((function(e){return e.displayId===r}));return Object(k.b)(n,(function(e){return t._toAggregateGraphic(e)}))}},{key:"getAggregates",value:function(){var e=this;return this._tree.findAllIf((function(t){return t.depth===e._geohashLevel})).map(this._toAggregateGraphic.bind(this))}},{key:"getDisplayId",value:function(e){var t=this._tree.findIf((function(t){return t.id===e}));return Object(k.b)(t,(function(e){return e.displayId}))}},{key:"getFeatureDisplayIdsForAggregate",value:function(e){var t=this._tree.findIf((function(t){return t.id===e}));return Object(k.m)(t,[],(function(e){return Array.from(e.displayIds)}))}},{key:"getDisplayIdForReferenceId",value:function(e){var t=this._tree.findIf((function(t){return 1===t.displayIds.size&&t.displayIds.has(e)}));return Object(k.b)(t,(function(e){return e.displayId}))}},{key:"_toAggregateGraphic",value:function(e){var t=this._spatialReference;return{referenceId:null,objectId:e.id,displayId:e.displayId,attributes:e.getAttributes(),geometry:Object(j.k)(e.getGeometry(t),"esriGeometryPolygon",!1,!1),centroid:null}}},{key:"_rebuildTree",value:function(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}},{key:"_remove",value:function(e){var t=e.getDisplayId(),r=e.getXHydrated(),n=e.getYHydrated(),a=this._geohashBuf[2*t],i=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,r,n,a,i,this._geohashLevel))}},{key:"_update",value:function(e,t){var r=e.getDisplayId(),n=this._bitsets.inserted,a=t.isVisible(r);if(a!==n.has(r))if(a){var i=e.getXHydrated(),s=e.getYHydrated();if(this._setGeohash(r,i,s)){var u=this._geohashBuf[2*r],o=this._geohashBuf[2*r+1];this._tree.insertCursor(e,r,i,s,u,o,this._geohashLevel),n.set(r)}}else this._remove(e)}},{key:"_setGeohash",value:function(e,t,r){if(this._bitsets.geohash.has(e))return!0;var n=this._geohashBuf;if(this._spatialReference.isWebMercator){var a=bt(t/dt.a.radius),i=a-360*Math.floor((a+180)/360);ot(n,e,bt(Math.PI/2-2*Math.atan(Math.exp(-r/dt.a.radius))),i,12)}else{var s=Object(ct.b)({x:t,y:r},this._spatialReference,Le.a.WGS84);if(!s)return!1;ot(n,e,s.y,s.x,12)}return this._bitsets.geohash.set(e),!0}},{key:"_getBinsForTile",value:function(e,t,r,n){try{var a,i=this._getGeohashBounds(t),s=i.xLL,u=i.yLL,o=i.xTR,c=i.yTR,l=i.level,h=this._tree.getBins(s,u,o,c,l),d=Object(m.a)(h);try{for(d.s();!(a=d.n()).done;){var f=a.value;f.displayId||(f.displayId=n.createDisplayId(!0));var p=f.getGeometry(this._spatialReference,r.tile),v=new U.a(p,f.getAttributes());v.objectId=f.id,v.displayId=f.displayId,e.push(v)}}catch(y){d.e(y)}finally{d.f()}}catch(g){return void gt.error("Unable to get bins for tile",t.key.id)}}},{key:"_getGeohash",value:function(e,t,r){var n={geohashX:0,geohashY:0};return ut(n,t,e,r),n}},{key:"_getGeohashBounds",value:function(e){var t=this._getGeohashLevel(e.key.level),r=[e.extent.xmin,e.extent.ymin,e.extent.xmax,e.extent.ymax],n=vt.a.fromExtent(yt.a.fromBounds(r,this._spatialReference)),a=Object(ct.b)(n,this._spatialReference,Le.a.WGS84,{densificationStep:64*e.resolution}),i=Object(j.g)(new L.a,a,!1,!1),s=i.coords.filter((function(e,t){return!(t%2)})),u=i.coords.filter((function(e,t){return t%2})),o=Math.min.apply(Math,Object(F.a)(s)),c=Math.min.apply(Math,Object(F.a)(u)),l=Math.max.apply(Math,Object(F.a)(s)),h=Math.max.apply(Math,Object(F.a)(u)),d=this._getGeohash(o,c,t),f=this._getGeohash(l,h,t);return{xLL:d.geohashX,yLL:d.geohashY,xTR:f.geohashX,yTR:f.geohashY,level:t}}},{key:"_getGeohashLevel",value:function(e){return this._schema.params.fixedBinLevel}},{key:"_getTransforms",value:function(e,t){var r={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},n=Object(y.e)(t);if(!n)return{tile:r,left:null,right:null};var a=Object(G.a)(n.valid,2),i=a[0],s=a[1];return{tile:r,left:Object(_.a)(Object(_.a)({},r),{},{translate:[s,e.bounds[3]]}),right:Object(_.a)(Object(_.a)({},r),{},{translate:[i-s+e.bounds[0],e.bounds[3]]})}}}]),r}(pt.a),_t=r(158),kt=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(e,n,i,s,u){var o;return Object(a.a)(this,r),(o=t.call(this,new L.a([],[n,i]),s,null,e)).geohashBoundsInfo=u,o}return Object(i.a)(r,[{key:"count",get:function(){return this.attributes.cluster_count}},{key:"update",value:function(e,t,r,n,a,i){return this.geometry.coords[0]=e,this.geometry.coords[1]=t,this.tileLevel=r,this.attributes=n,this.geohashBoundsInfo=a,this.referenceId=null,this.referenceId=i,this}},{key:"toJSON",value:function(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:Object(_.a)(Object(_.a)({},this.attributes),{},{clusterId:this.objectId}),geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}}}],[{key:"create",value:function(e,t,n,a,i,s,u,o){var c=new r(t,n,a,s,u);return c.displayId=e.createDisplayId(!0),c.referenceId=o,c.tileLevel=i,c}}]),r}(U.b);function xt(e){return 57.29577951308232*e}var jt=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(e,n,i,s){var u;return Object(a.a)(this,r),(u=t.call(this,e,i)).events=new ve.a,u._geohashLevel=0,u._tileLevel=0,u._aggregateValueRanges={},u._aggregateValueRangesChanged=!1,u._geohashBuf=[],u._clusters=new Map,u._tiles=new Map,u._serviceInfo=s,u.geometryInfo=e.geometryInfo,u._spatialReference=n,u._projectionSupportCheck=Object(ct.a)(n,Le.a.WGS84),u._bitsets.geohash=i.getBitset(i.createBitset()),u._bitsets.inserted=i.getBitset(i.createBitset()),u}return Object(i.a)(r,[{key:"destroy",value:function(){this._tree.destroy()}},{key:"updateSchema",value:function(){var e=Object(n.a)(c.a.mark((function e(t,n){var a,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=this._schema,e.prev=1,e.next=4,Object(T.a)(Object(A.a)(r.prototype),"updateSchema",this).call(this,t,n);case 4:return e.next=6,this._projectionSupportCheck;case 6:e.next=10;break;case 8:e.prev=8,e.t0=e.catch(1);case 10:i=Object(ye.a)(a,n),n&&(!Object(k.j)(i)||t.source||t.storage.filters)?((Object(ye.b)(i,"params.fields")||!this._tree||t.source)&&(this._tree&&this._tree.destroy(),this._tree=new lt(this._statisticFields,this._serviceInfo),this._rebuildTree(),Object(d.a)("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),Object(d.a)("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",i),t.targets[n.name]=!0,t.mesh=!1,this._aggregateValueRanges={}):a&&(t.mesh=!0);case 12:case"end":return e.stop()}}),e,this,[[1,8]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"clear",value:function(){this._rebuildTree()}},{key:"sweepFeatures",value:function(e,t){var r=this;this._bitsets.inserted.forEachSet((function(n){if(!e.has(n)){var a=t.lookupByDisplayIdUnsafe(n);r._remove(a)}}))}},{key:"sweepAggregates",value:function(e,t,r){var n=this;this._clusters.forEach((function(a,i){a&&a.tileLevel!==r&&(e.releaseDisplayId(a.displayId),t.unsetAttributeData(a.displayId),n._clusters.delete(i))}))}},{key:"onTileData",value:function(e,t,r,n){var a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(!this._schema||Object(k.j)(t.addOrUpdate))return t;for(var i=this._getTransforms(e,this._spatialReference),s=t.addOrUpdate.getCursor();s.next();)this._update(s,n);if(t.status.mesh||!a)return t;var u=new Array,o=this._schema.params.clusterRadius;this._getClustersForTile(u,e,o,r,i),t.addOrUpdate=D.a.fromOptimizedFeatures(u,this._serviceInfo),t.addOrUpdate.attachStorage(r),t.clear=!0,t.end=!0;for(var c=t.addOrUpdate.getCursor();c.next();){var l=c.getDisplayId();this._bitsets.computed.unset(l),this.setComputedAttributes(r,c,l,e.scale)}return this._aggregateValueRangesChanged&&t.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),t}},{key:"onTileUpdate",value:function(e){var t=this,r=e.added,n=e.removed;if(r.length){var a=r[0].level;this._tileLevel=a,this._setGeohashLevel(a)}if(this._schema){var i=this._schema.params.clusterRadius;n.forEach((function(e){t._tiles.delete(e.key.id),t._markTileClustersForDeletion(e,i)}))}}},{key:"getAggregate",value:function(e){var t,r=Object(m.a)(this._clusters.values());try{for(r.s();!(t=r.n()).done;){var n=t.value;if(((null===n||void 0===n?void 0:n.displayId)&ft.a)==(e&ft.a))return n.toJSON()}}catch(a){r.e(a)}finally{r.f()}return null}},{key:"getAggregates",value:function(){var e,t=[],r=Object(m.a)(this._clusters.values());try{for(r.s();!(e=r.n()).done;){var n=e.value;(null===n||void 0===n?void 0:n.tileLevel)===this._tileLevel&&t.push(n.toJSON())}}catch(a){r.e(a)}finally{r.f()}return t}},{key:"getDisplayId",value:function(e){var t=this._clusters.get(e);return t?t.displayId:null}},{key:"getFeatureDisplayIdsForAggregate",value:function(e){var t=this._clusters.get(e);if(!t)return[];var r=t.geohashBoundsInfo;return this._tree.getRegionDisplayIds(r.xLL,r.yLL,r.xTR,r.yTR,r.level)}},{key:"getDisplayIdForReferenceId",value:function(e){var t,r=Object(m.a)(this._clusters.values());try{for(r.s();!(t=r.n()).done;){var n=t.value;if((null===n||void 0===n?void 0:n.referenceId)===e)return n.displayId}}catch(a){r.e(a)}finally{r.f()}return null}},{key:"getAggregateValueRanges",value:function(){return this._aggregateValueRanges}},{key:"forEach",value:function(e){var t,r=Object(m.a)(this._clusters);try{for(r.s();!(t=r.n()).done;){var n=Object(G.a)(t.value,2),a=n[0],i=n[1];i&&e(i,a)}}catch(s){r.e(s)}finally{r.f()}}},{key:"size",value:function(){var e=0;return this.forEach((function(t){return e++})),e}},{key:"_rebuildTree",value:function(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}},{key:"_remove",value:function(e){var t=e.getDisplayId(),r=e.getXHydrated(),n=e.getYHydrated(),a=this._geohashBuf[2*t],i=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,r,n,a,i,this._geohashLevel))}},{key:"_update",value:function(e,t){var r=e.getDisplayId(),n=this._bitsets.inserted,a=t.isVisible(r);if(a!==n.has(r))if(a){var i=e.getXHydrated(),s=e.getYHydrated();if(this._setGeohash(r,i,s)){var u=this._geohashBuf[2*r],o=this._geohashBuf[2*r+1];this._tree.insertCursor(e,r,i,s,u,o,this._geohashLevel),n.set(r)}}else this._remove(e)}},{key:"_setGeohash",value:function(e,t,r){if(this._bitsets.geohash.has(e))return!0;var n=this._geohashBuf;if(this._spatialReference.isWebMercator){var a=xt(t/dt.a.radius),i=a-360*Math.floor((a+180)/360);ot(n,e,xt(Math.PI/2-2*Math.atan(Math.exp(-r/dt.a.radius))),i,12)}else{var s=Object(ct.b)({x:t,y:r},this._spatialReference,Le.a.WGS84);if(!s)return!1;ot(n,e,s.y,s.x,12)}return this._bitsets.geohash.set(e),!0}},{key:"_getClustersForTile",value:function(e,t,r,n,a){for(var i=this,s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],u=this._schema.params.clusterPixelBuffer,o=2*r,c=this._getGeohashLevel(t.key.level),l=Math.ceil(Math.pow(2,t.key.level)*_t.V/o),h=Math.ceil(u/o)+0,d=Math.ceil(_t.V/o),f=t.key,p=f.row,v=f.col,y=v*_t.V,g=p*_t.V,b=Math.floor(y/o)-h,m=Math.floor(g/o)-h,x=b+d+2*h,O=m+d+2*h,I=t.tileInfoView.getLODInfoAt(t.key.level),w=b;w<=x;w++)for(var S=function(r){var u=w;I.wrap&&(u=w<0?w+l:w%l);var o=I.wrap&&w<0,h=I.wrap&&w%l!==w,d=i._lookupCluster(n,I,t.key.level,u,r,c);if(Object(k.k)(d)){var f=Object(k.b)(a,(function(e){return o?e.left:h?e.right:e.tile}));if(s&&Object(k.j)(f))return"continue";if(!d.count)return"continue";if(Object(k.k)(f)&&s){var p=d.geometry.clone(),v=d.attributes;p.coords[0]=Object(j.v)(f,p.coords[0]),p.coords[1]=Object(j.w)(f,p.coords[1]),1===d.count&&Object(k.k)(d.referenceId)&&(v=Object(_.a)(Object(_.a)({},d.attributes),{},{referenceId:d.referenceId}));var y=new U.a(p,v);y.displayId=d.displayId,e.push(y)}}},F=m;F<=O;F++)S(F)}},{key:"_getGeohashLevel",value:function(e){return Math.min(Math.ceil(e/2+2),12)}},{key:"_setGeohashLevel",value:function(e){var t=this._getGeohashLevel(e),r=1*(Math.floor(t/1)+1)-1;if(this._geohashLevel!==r)return this._geohashLevel=r,this._rebuildTree(),void this._bitsets.geohash.clear()}},{key:"_getTransforms",value:function(e,t){var r={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},n=Object(y.e)(t);if(!n)return{tile:r,left:null,right:null};var a=Object(G.a)(n.valid,2),i=a[0],s=a[1];return{tile:r,left:Object(_.a)(Object(_.a)({},r),{},{translate:[s,e.bounds[3]]}),right:Object(_.a)(Object(_.a)({},r),{},{translate:[i-s+e.bounds[0],e.bounds[3]]})}}},{key:"_getClusterId",value:function(e,t,r){return(15&e)<<28|(16383&t)<<14|16383&r}},{key:"_markForDeletion",value:function(e,t,r){var n=this._getClusterId(e,t,r);this._clusters.delete(n)}},{key:"_getClusterBounds",value:function(e,t,r){var n=this._schema.params.clusterRadius,a=2*n,i=r%2?t*a:t*a-n,s=r*a,u=i+a,o=s-a,c=Math.pow(2,e.level)*_t.V;e.wrap&&i<0&&(i=0),e.wrap&&u>c&&(u=c);var l=i/_t.V,h=s/_t.V,d=u/_t.V,f=o/_t.V;return[e.getXForColumn(l),e.getYForRow(h),e.getXForColumn(d),e.getYForRow(f)]}},{key:"_lookupCluster",value:function(e,t,r,n,a,i){var s=this._getClusterId(r,n,a),u=this._clusters.get(s),o=this._getClusterBounds(t,n,a),c=Object(G.a)(o,4),l=c[0],h=c[1],d=c[2],f=c[3],p={x:l,y:h},v={x:d,y:f},y=0,g=0,b=0,m=0;if(this._spatialReference.isWebMercator){var x=xt(p.x/dt.a.radius);y=x-360*Math.floor((x+180)/360),g=xt(Math.PI/2-2*Math.atan(Math.exp(-p.y/dt.a.radius)));var j=xt(v.x/dt.a.radius);b=j-360*Math.floor((j+180)/360),m=xt(Math.PI/2-2*Math.atan(Math.exp(-v.y/dt.a.radius)))}else{var O=Object(ct.b)(p,this._spatialReference,Le.a.WGS84),I=Object(ct.b)(v,this._spatialReference,Le.a.WGS84);if(!O||!I)return null;y=O.x,g=O.y,b=I.x,m=I.y}var w={geohashX:0,geohashY:0},S={geohashX:0,geohashY:0};ut(w,g,y,i),ut(S,m,b,i);var F=w.geohashX,T=w.geohashY,A=S.geohashX,C=S.geohashY,R={xLL:F,yLL:T,xTR:A,yTR:C,level:i},M=this._tree.getRegionStatistics(F,T,A,C,i),E=M.count,q=M.xTotal,z=M.yTotal,N=M.referenceId,D=E?q/E:0,P=E?z/E:0;if(0===E)return this._clusters.set(s,null),null;var U=Object(_.a)({cluster_count:E},M.attributes),L=Object(k.k)(u)?u.update(D,P,r,U,R,N):kt.create(e,s,D,P,r,U,R,N);return 0===E&&(L.geometry.coords[0]=(l+d)/2,L.geometry.coords[1]=(h+f)/2),this._clusters.set(s,L),this._updateAggregateValueRangeForCluster(L,L.tileLevel),L}},{key:"_updateAggregateValueRangeForCluster",value:function(e,t){var r=this._aggregateValueRanges[t]||{minValue:1/0,maxValue:0},n=r.minValue,a=r.maxValue;r.minValue=Math.min(n,e.count),r.maxValue=Math.max(a,e.count),this._aggregateValueRanges[t]=r,n===r.minValue&&a===r.maxValue||(this._aggregateValueRangesChanged=!0)}},{key:"_markTileClustersForDeletion",value:function(e,t){for(var r=2*t,n=Math.ceil(_t.V/r),a=e.key,i=a.row,s=a.col*_t.V,u=i*_t.V,o=Math.floor(s/r),c=Math.floor(u/r),l=o;l<o+n;l++)for(var h=c;h<c+n;h++)this._markForDeletion(e.key.level,l,h)}}]),r}(pt.a),Ot=r(399);function It(e){if(!Object(x.j)(e)&&!function(e){return"worker:port-closed"===e.name}(e))throw e}function wt(e){return"feature"===e.type&&"snapshot"===e.mode}var St=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(){var e;return Object(a.a)(this,r),(e=t.apply(this,arguments))._storage=new Ot.a,e._markedIdsBufId=e._storage.createBitset(),e._lastCleanup=performance.now(),e._cleanupNeeded=!1,e._invalidated=!1,e._tileToResolver=new Map,e._didEdit=!1,e._updateVersion=1,e.tileStore=null,e.config=null,e.processor=null,e.remoteClient=null,e.service=null,e}return Object(i.a)(r,[{key:"initialize",value:function(){var e=this;this._initStores(),this._initSource(),this._updateQueue=new Oe.a({concurrency:"geoevent"===this._source.type?1:4,process:function(t,r){return e._onTileMessage(t,{signal:r})}}),this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this)),Object(f.f)((function(){return!e.updating}),(function(){return e.onIdle()}))]),this._checkUpdating=setInterval((function(){return e.notifyChange("updating")}),300)}},{key:"_initSource",value:function(){var e=this,t=this.tileStore.tileScheme;this._source=it(this.service,this.spatialReference,t,(function(t,r){return e._invalidated=!0,e._patchTile(t,r)}),(function(){return e._updateQueue.length<50}),this.featureStore),this._proxyEvents()}},{key:"_proxyEvents",value:function(){var e=this;if("geoevent"===this._source.type){var t=this._source.events;this.handles.add([t.on("connectionStatus",(function(t){return e.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:t}).catch(It)})),t.on("errorString",(function(t){return e.remoteClient.invoke("setProperty",{propertyName:"errorString",value:t}).catch(It)})),t.on("feature",(function(t){return e.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:t.attributes,centroid:t.centroid,geometry:t.geometry}}).catch(It)})),t.on("updateRate",(function(t){return e.remoteClient.invoke("emitEvent",{name:"update-rate",event:Object(_.a)({},t)}).catch(It)}))])}}},{key:"_initAttributeStore",value:function(e){var t=this;this.attributeStore?this.attributeStore.invalidateResources():this.attributeStore=new st.a({type:"remote",initialize:function(e,r){return Object(x.i)(t.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",e,{signal:r}).catch(It))},update:function(e,r){return Object(x.i)(t.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",e,{signal:r}).catch(It))},render:function(e){return Object(x.i)(t.remoteClient.invoke("tileRenderer.featuresView.requestRender",void 0,{signal:e}).catch(It))}},e,(function(){return t.notifyChange("updating")}))}},{key:"_initStores",value:function(){var e="snapshot"===this.service.type?"snapshot":"on-demand",t={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields};this.featureStore=new w.a(t,this._storage,e)}},{key:"_initQueryEngine",value:function(e){var t,r=this;null!==(t=this.queryEngine)&&void 0!==t&&t.destroy(),this.queryEngine=new O.a({definitionExpression:e.schema.source.definitionExpression,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds:function(e){return Object(k.j)(r.aggregateStore)?[]:r.aggregateStore.getFeatureDisplayIdsForAggregate(e).map((function(e){return r.getObjectId(e)}))}},timeInfo:this.service.timeInfo})}},{key:"destroy",value:function(){this._updateQueue.destroy(),this._source.destroy(),this.queryEngine.destroy(),this.attributeStore&&this.attributeStore.destroy();var e,t=Object(m.a)(this.tileStore.tiles);try{for(t.s();!(e=t.n()).done;){var r=e.value;this._source.unsubscribe(r)}}catch(n){t.e(n)}finally{t.f()}clearInterval(this._checkUpdating)}},{key:"fieldsIndex",get:function(){return new I.a(this.service.fields)}},{key:"spatialReference",get:function(){return this.tileStore.tileScheme.spatialReference}},{key:"updating",get:function(){return this.isUpdating()}},{key:"isUpdating",value:function(){var e=this._source.updating,t=!!this._updateQueue.length,r=!this.attributeStore||this.attributeStore.isUpdating(),n=e||t||r;return Object(d.a)("esri-2d-log-updating")&&console.log("Updating FeatureController2D: ".concat(n,"\n  -> updatingSource ").concat(e,"\n  -> updateQueue ").concat(t,"\n  -> updatingAttributeStore ").concat(r,"\n")),n}},{key:"enableEvent",value:function(e){this._source.enableEvent(e.name,e.value)}},{key:"pause",value:function(){this._updateQueue.pause(),this._updateQueue.clear()}},{key:"resume",value:function(){this._updateQueue.resume()}},{key:"pauseStream",value:function(){"geoevent"===this._source.type&&this._source.pauseStream()}},{key:"resumeStream",value:function(){"geoevent"===this._source.type&&this._source.resumeStream()}},{key:"_initAggregateStore",value:function(e){var t,r,n=this,a={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},i=null===(t=e.schema.targets)||void 0===t||null===(r=t.aggregate)||void 0===r?void 0:r.type,s=Object(k.b)(this.config,(function(e){var t,r;return null===(t=e.schema.targets)||void 0===t||null===(r=t.aggregate)||void 0===r?void 0:r.type}));if(s!==i&&(Object(k.k)(this.aggregateStore)&&(this.handles.remove("valueRangesChanged"),this.aggregateStore.destroy(),this.aggregateStore=null),i)){switch(i){case"cluster":this.aggregateStore=new jt(a,this.spatialReference,this._storage,this.service),this.handles.add(this.aggregateStore.events.on("valueRangesChanged",(function(e){n.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:e.valueRanges}}).catch(It)})),"valueRangesChanged");break;case"bin":this.aggregateStore=new mt(a,this.spatialReference,this._storage,this.service)}this.aggregateStore.onTileUpdate({added:this.tileStore.tiles,removed:[]})}}},{key:"update",value:function(){var e=Object(n.a)(c.a.mark((function e(t,r){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._updateVersion++,this._initQueryEngine(r),this._initAttributeStore(r),this.pause(),e.next=6,Promise.all([this._source.update(t,r.schema.source),this.featureStore.updateSchema(t,r.schema.targets.feature),this.attributeStore.update(t,r),this.attributeStore.updateFilters(t,r,this)]);case 6:if(this._initAggregateStore(r),e.t0=Object(k.k)(this.aggregateStore),!e.t0){e.next=11;break}return e.next=11,this.aggregateStore.updateSchema(t,r.schema.targets.aggregate);case 11:Object(d.a)("esri-2d-update-debug")&&t.describe(),this._set("config",r);case 13:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"applyUpdate",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.version=this._updateVersion,Object(d.a)("esri-2d-update-debug")&&console.debug("Applying update ".concat(t.version)),t.mesh&&this.clearTiles(),this._updateQueue.resume(),e.next=6,this._source.applyUpdate(t);case 6:return this.notifyChange("updating"),e.next=9,Object(f.g)((function(){return!r.updating}));case 9:if(e.t0=Object(k.k)(this.aggregateStore),!e.t0){e.next=15;break}return e.next=13,Object(x.a)(10);case 13:return e.next=15,Object(f.g)((function(){return!r.updating}));case 15:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"onEdits",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n,a,i=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.edits,Object(d.a)("esri-2d-update-debug")&&console.debug("Applying Edit:",r),this._didEdit=!0,e.prev=2,n=r.removed.map((function(e){return e.objectId&&-1!==e.objectId?e.objectId:i._lookupObjectIdByGlobalId(e.globalId)})),a=r.addOrModified.map((function(e){return e.objectId})),this.featureStore.invalidate(),e.next=7,this._source.edit(a,n);case 7:return this.clearTiles(),this.notifyChange("updating"),Object(k.k)(this.aggregateStore)&&this.aggregateStore.clear(),e.next=12,this._source.resend();case 12:return e.next=14,Object(f.g)((function(){return!i.updating}));case 14:e.next=18;break;case 16:e.prev=16,e.t0=e.catch(2);case 18:case"end":return e.stop()}}),e,this,[[2,16]])})));return function(t){return e.apply(this,arguments)}}()},{key:"refresh",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=3;break}return r=me.empty(),e.abrupt("return",(r.storage.filters=!0,this.applyUpdate(r)));case 3:return this.featureStore.invalidate(),this.clearTiles(),this._source.refresh(this._updateVersion),this._cleanupNeeded=!0,this.notifyChange("updating"),e.next=10,Object(f.g)((function(){return!n.updating}));case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"clearTiles",value:function(){var e,t=Object(m.a)(this.tileStore.tiles);try{for(t.s();!(e=t.n()).done;){var r=e.value;this.processor.onTileClear(r)}}catch(n){t.e(n)}finally{t.f()}}},{key:"onTileUpdate",value:function(e){Object(k.k)(this.aggregateStore)&&this.aggregateStore.onTileUpdate(e);var t,r=Object(m.a)(e.added);try{for(r.s();!(t=r.n()).done;){var n=t.value;this._source.subscribe(n,this._updateVersion),this._level=n.level}}catch(u){r.e(u)}finally{r.f()}var a,i=Object(m.a)(e.removed);try{for(i.s();!(a=i.n()).done;){var s=a.value;this._source.unsubscribe(s),this._cleanupNeeded=!0,this._tileToResolver.has(s.id)&&(this._tileToResolver.get(s.id).resolve(),this._tileToResolver.delete(s.id))}}catch(u){i.e(u)}finally{i.f()}this.notifyChange("updating")}},{key:"onIdle",value:function(){var e=Object(n.a)(c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=this._invalidated,!e.t0){e.next=7;break}if(this._invalidated=!1,e.t1=Object(k.k)(this.aggregateStore)||"heatmap"===this.processor.type,!e.t1){e.next=7;break}return e.next=7,this._repushCurrentLevelTiles();case 7:this._markAndSweep();case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"querySummaryStatistics",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.query,n=t.params,e.abrupt("return",this.queryEngine.executeQueryForSummaryStatistics(r,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"queryUniqueValues",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.query,n=t.params,e.abrupt("return",this.queryEngine.executeQueryForUniqueValues(r,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"queryClassBreaks",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.query,n=t.params,e.abrupt("return",this.queryEngine.executeQueryForClassBreaks(r,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"queryHistogram",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.query,n=t.params,e.abrupt("return",this.queryEngine.executeQueryForHistogram(r,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"queryExtent",value:function(e){return this.queryEngine.executeQueryForExtent(e)}},{key:"queryFeatures",value:function(e){return this.queryEngine.executeQuery(e)}},{key:"queryVisibleFeatures",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n,a=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.queryEngine.executeQuery(t);case 2:return r=e.sent,n=r.objectIdFieldName,e.abrupt("return",(r.features=r.features.filter((function(e){var t=e.attributes[n],r=a.getDisplayId(t);return Object(k.b)(r,(function(e){return a.attributeStore.isVisible(e)}))})),r));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"queryFeatureCount",value:function(e){return this.queryEngine.executeQueryForCount(e)}},{key:"queryLatestObservations",value:function(e){return this.queryEngine.executeQueryForLatestObservations(e)}},{key:"queryObjectIds",value:function(e){return this.queryEngine.executeQueryForIds(e)}},{key:"queryStatistics",value:function(){var e=Object(n.a)(c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.featureStore.storeStatistics);case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getObjectId",value:function(e){return this.featureStore.lookupObjectId(e,this._storage)}},{key:"getDisplayId",value:function(e){if(Object(k.k)(this.aggregateStore)){var t=this.aggregateStore.getDisplayId(e);if(Object(k.j)(t)){var r=this.featureStore.lookupDisplayId(e);return this.aggregateStore.getDisplayIdForReferenceId(r)}return t}return this.featureStore.lookupDisplayId(e)}},{key:"getFeatures",value:function(e){var t,r=[],n=[],a=Object(m.a)(e);try{for(a.s();!(t=a.n()).done;){var i=t.value,s=Object(k.k)(this.aggregateStore)?this.getAggregate(i):null;if(Object(k.k)(s))if(Object(k.k)(s.referenceId)){var u=this.getFeature(s.referenceId);Object(k.k)(u)&&r.push(u)}else n.push(s);else{var o=this.getFeature(i);Object(k.k)(o)&&r.push(o)}}}catch(c){a.e(c)}finally{a.f()}return{features:r,aggregates:n}}},{key:"getFeature",value:function(e){var t=this.featureStore.lookupFeatureByDisplayId(e,this._storage);if(Object(k.j)(t))return null;var r=t.readHydratedGeometry(),n=Object(j.k)(r,t.geometryType,t.hasZ,t.hasM);return{attributes:t.readAttributes(),geometry:n}}},{key:"getAggregate",value:function(e){return Object(k.j)(this.aggregateStore)?null:this.aggregateStore.getAggregate(e)}},{key:"getAggregates",value:function(){return Object(k.j)(this.aggregateStore)?[]:this.aggregateStore.getAggregates()}},{key:"setHighlight",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Object(k.g)(t.map((function(e){return n.getDisplayId(e)}))),e.abrupt("return",this.attributeStore.setHighlight(t,r));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_lookupObjectIdByGlobalId",value:function(e){var t=this.service.globalIdField;if(Object(k.j)(t))throw new Error("Expected globalIdField to be defined");var r=null;if(this.featureStore.forEach((function(n){e===n.readAttribute(t)&&(r=n.getObjectId())})),Object(k.j)(r))throw new Error("Expected to find a feature with globalId ".concat(e));return r}},{key:"_repushCurrentLevelTiles",value:function(){var e=Object(n.a)(c.a.mark((function e(){var t,r=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.tileStore.tiles.filter((function(e){return e.level===r._level})).map(function(){var e=Object(n.a)(c.a.mark((function e(t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r._patchTile({type:"append",id:t.key.id,addOrUpdate:D.a.fromOptimizedFeatures([],r.service),remove:[],end:!0,status:me.empty()}));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=3,Promise.all(t);case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_maybeForceCleanup",value:function(){performance.now()-this._lastCleanup>5e3&&this._markAndSweep()}},{key:"_patchTile",value:function(e,t){var r=this,n=this._updateQueue.push(e,t).then((function(){r.notifyChange("updating")})).catch((function(e){r.notifyChange("updating")}));return this.notifyChange("updating"),n}},{key:"_onTileMessage",value:function(){var e=Object(n.a)(c.a.mark((function e(t,r){var n,a,i,s,u,o,l,h,d;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Object(x.p)(r),n=this.tileStore.get(t.id)){e.next=4;break}return e.abrupt("return");case 4:if(!t.clear){e.next=6;break}return e.abrupt("return",this.processor.onTileClear(n));case 6:a=t.status,this._cleanupNeeded=!0,i=[],s=Object(m.a)(t.remove);try{for(s.s();!(u=s.n()).done;)o=u.value,(l=this.featureStore.lookupDisplayId(o))&&i.push(l)}catch(c){s.e(c)}finally{s.f()}if(t.remove=i,e.prev=12,!Object(k.j)(t.addOrUpdate)){e.next=15;break}return e.abrupt("return",void this.processor.onTileMessage(n,Object(_.a)(Object(_.a)({},t),{},{addOrUpdate:null}),Object(k.k)(this.aggregateStore),r).catch(x.q));case 15:if(t.addOrUpdate.setArcadeSpatialReference(this.spatialReference),this.featureStore.hasInstance(t.addOrUpdate.instance)&&a.targets.feature||(a.targets.feature=!0,this.featureStore.onTileData(n,t)),a.storage.data&&a.storage.filters){e.next=24;break}if(a.storage.data=!0,a.storage.filters=!0,this.attributeStore.onTileData(n,t),"geoevent"!==this._source.type&&!this._didEdit){e.next=23;break}return e.next=20,this.attributeStore.sendUpdates();case 20:Object(x.p)(r),e.next=24;break;case 23:this.attributeStore.sendUpdates();case 24:if(!Object(k.k)(this.aggregateStore)||a.targets.aggregate){e.next=34;break}if(a.targets.aggregate=!0,h=wt(this._source)&&this._source.loading,d=!wt(this._source)||h||t.end,this.aggregateStore.onTileData(n,t,this._storage,this.attributeStore,d),d){e.next=29;break}return e.abrupt("return");case 29:if(e.t0=a.mesh,e.t0){e.next=34;break}return this.attributeStore.onTileData(n,t),e.next=34,this.attributeStore.sendUpdates();case 34:if(e.t1=a.mesh,e.t1){e.next=40;break}return a.mesh=!0,e.next=39,this.processor.onTileMessage(n,t,Object(k.k)(this.aggregateStore),r);case 39:Object(x.p)(r);case 40:this._maybeForceCleanup(),e.next=46;break;case 43:e.prev=43,e.t2=e.catch(12),Object(x.q)(e.t2);case 46:case"end":return e.stop()}}),e,this,[[12,43]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_mark",value:function(e,t,r){var n=(4294901760&this._storage.getInstanceId(e))>>>16;e&&(t.add(n),r.set(e))}},{key:"_markAndSweep",value:function(){var e=this;if(this._lastCleanup=performance.now(),!("feature"===this._source.type&&"snapshot"===this._source.mode||"geoevent"!==this._source.type&&!this._cleanupNeeded)){this._cleanupNeeded=!1;var t=this._storage.getBitset(this._markedIdsBufId),r=new Set;t.clear();var n,a=Object(m.a)(this.tileStore.tiles);try{for(a.s();!(n=a.n()).done;){var i,s=n.value,u=Object(m.a)(this._source.readers(s.id));try{for(u.s();!(i=u.n()).done;)for(var o=i.value.getCursor();o.next();){var c=o.getDisplayId();if(!c){var l=o.getObjectId();c=this.featureStore.lookupDisplayId(l)}this._mark(c,r,t)}}catch(h){u.e(h)}finally{u.f()}}}catch(h){a.e(h)}finally{a.f()}"symbol"===this.processor.type&&this.processor.forEachBufferId((function(n){e._mark(n,r,t)})),this._updateQueue.forEach((function(n){var a,i=Object(m.a)(n.remove);try{for(i.s();!(a=i.n()).done;){var s=a.value,u=e.featureStore.lookupDisplayId(s);e._mark(u,r,t)}}catch(h){i.e(h)}finally{i.f()}})),Object(k.k)(this.aggregateStore)&&(this.aggregateStore.sweepFeatures(t,this.featureStore),"sweepAggregates"in this.aggregateStore&&this.aggregateStore.sweepAggregates(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(t,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(r)}}}]),r}(h.a);Object(l.a)([Object(p.b)({constructOnly:!0})],St.prototype,"tileStore",void 0),Object(l.a)([Object(p.b)()],St.prototype,"config",void 0),Object(l.a)([Object(p.b)({readOnly:!0})],St.prototype,"fieldsIndex",null),Object(l.a)([Object(p.b)()],St.prototype,"processor",void 0),Object(l.a)([Object(p.b)({constructOnly:!0})],St.prototype,"remoteClient",void 0),Object(l.a)([Object(p.b)({constructOnly:!0})],St.prototype,"service",void 0),Object(l.a)([Object(p.b)()],St.prototype,"spatialReference",null),Object(l.a)([Object(p.b)()],St.prototype,"updating",null);var Ft=St=Object(l.a)([Object(v.a)("esri.views.2d.layers.features.controllers.FeatureController2D")],St),Tt=r(1013),At=r(359),Ct=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(){var e;return Object(a.a)(this,r),(e=t.apply(this,arguments)).controller=null,e.processor=null,e.remoteClient=null,e.tileStore=null,e.service=null,e.viewState=null,e._paused=!1,e._pendingTileUpdates=[],e}return Object(i.a)(r,[{key:"initialize",value:function(){var e=this;this.handles.add(Object(f.e)((function(){return e.updating}),(function(t){e.remoteClient.invoke("setUpdating",t).catch((function(e){}))})))}},{key:"destroy",value:function(){var e,t;this.stop(),null!==(e=this.controller)&&void 0!==e&&e.destroy(),null!==(t=this.processor)&&void 0!==t&&t.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null}},{key:"updating",get:function(){return!this.controller||this.controller.updating}},{key:"stop",value:function(){var e,t,r;this._paused=!0,Array.isArray(null===(e=this.service)||void 0===e?void 0:e.source)&&(this.service.source.forEach((function(e){return e.close()})),this.service.source.length=0),null!==(t=this.tileStore)&&void 0!==t&&t.updateTiles({added:[],removed:this.tileStore.tiles.map((function(e){return e.id}))}),null!==(r=this.tileStore)&&void 0!==r&&r.destroy(),this.tileStore=null,this._pendingTileUpdates.length=0}},{key:"startup",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n,a,i,s,u,o,l;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.service,a=t.config,i=t.tileInfo,s=t.tiles,this._paused=!0,Array.isArray(null===(r=this.service)||void 0===r?void 0:r.source)&&(this.service.source.forEach((function(e){return e.close()})),this.service.source.length=0),this.service=n,this.tileStore&&Object(y.d)(this.tileStore.tileScheme.spatialReference,i.spatialReference)||(l=new At.a(g.a.fromJSON(i)),s.added.length=s.removed.length=0,null!==(u=this.tileStore)&&void 0!==u&&u.updateTiles({added:[],removed:this.tileStore.tiles.map((function(e){return e.id}))}),null!==(o=this.tileStore)&&void 0!==o&&o.destroy(),this.tileStore=new Tt.a(l),this._pendingTileUpdates.length=0),e.next=4,this._createProcessorAndController(a);case 4:return e.next=6,this.update({config:a});case 6:this.controller.resume(),this.tileStore.clear(),this.tileStore.updateTiles(s),this._paused=!1;case 10:if(!this._pendingTileUpdates.length){e.next=14;break}this.tileStore.updateTiles(this._pendingTileUpdates.pop());case 12:e.next=10;break;case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateTiles",value:function(){var e=Object(n.a)(c.a.mark((function e(t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._paused?this._pendingTileUpdates.push(t):this.tileStore.updateTiles(t);case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=Object(n.a)(c.a.mark((function e(t){var r,n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.config,n=me.empty(),e.next=4,Promise.all([this.processor.update(n,r),this.controller.update(n,r)]);case 4:return e.abrupt("return",n.toJSON());case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"applyUpdate",value:function(){var e=Object(n.a)(c.a.mark((function e(t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.controller.applyUpdate(me.create(t)));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createProcessorAndController",value:function(){var e=Object(n.a)(c.a.mark((function e(t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([this._handleControllerConfig(t),this._handleProcessorConfig(t)]);case 2:this.controller.processor=this.processor;case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_handleControllerConfig",value:function(){var e=Object(n.a)(c.a.mark((function e(t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._createController(this.service,t));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_handleProcessorConfig",value:function(){var e=Object(n.a)(c.a.mark((function e(t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._createProcessor(this.service,t));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createController",value:function(){var e=Object(n.a)(c.a.mark((function e(t,r){var n,a,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.controller&&this.controller.destroy(),n=this.tileStore,a=this.remoteClient,i=new Ft({service:t,tileStore:n,remoteClient:a}),e.abrupt("return",(this.controller=i,i));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_createProcessor",value:function(){var e=Object(n.a)(c.a.mark((function e(t,r){var n,a,i,s,u;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.schema.processors[0].type,e.next=3,b(n);case 3:return a=e.sent.default,i=this.remoteClient,s=this.tileStore,u=new a({service:t,config:r,tileStore:s,remoteClient:i}),e.abrupt("return",(this.processor&&this.processor.destroy(),this.processor=u,u));case 8:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(h.a);Object(l.a)([Object(p.b)()],Ct.prototype,"controller",void 0),Object(l.a)([Object(p.b)()],Ct.prototype,"processor",void 0),Object(l.a)([Object(p.b)()],Ct.prototype,"updating",null),Object(l.a)([Object(p.b)()],Ct.prototype,"viewState",void 0);var Rt=Ct=Object(l.a)([Object(v.a)("esri.views.2d.layers.features.Pipeline")],Ct)},212:function(e,t,r){"use strict";r.d(t,"a",(function(){return n})),r.d(t,"b",(function(){return s})),r.d(t,"c",(function(){return i})),r.d(t,"d",(function(){return h})),r.d(t,"e",(function(){return c})),r.d(t,"f",(function(){return o})),r.d(t,"g",(function(){return u})),r.d(t,"h",(function(){return l}));var n=8388607,a=8388608,i=0,s=1,u=function(e){return(e&a)>>>23},o=function(e){return e&n},c=function(e){return u(e)===s?254:255};function l(e){return u(e)===s}function h(e,t){return((t?a:0)|e)>>>0}},278:function(e,t,r){"use strict";r.d(t,"a",(function(){return m})),r.d(t,"b",(function(){return j})),r.d(t,"c",(function(){return w}));var n=r(142),a=r(143),i=r(155),s=r(60),u=r(14),o=r(154),c=r.n(o),l=r(146),h=r(266),d=r(308),f=r(182),p=r(318),v=[0,0];function y(e,t){if(!t)return null;if("x"in t){var r,n,a={x:0,y:0};return r=e(t.x,t.y,v),n=Object(u.a)(r,2),a.x=n[0],a.y=n[1],null!=t.z&&(a.z=t.z),null!=t.m&&(a.m=t.m),a}if("xmin"in t){var i,s,o,c,l={xmin:0,ymin:0,xmax:0,ymax:0};return i=e(t.xmin,t.ymin,v),s=Object(u.a)(i,2),l.xmin=s[0],l.ymin=s[1],o=e(t.xmax,t.ymax,v),c=Object(u.a)(o,2),l.xmax=c[0],l.ymax=c[1],t.hasZ&&(l.zmin=t.zmin,l.zmax=t.zmax,l.hasZ=!0),t.hasM&&(l.mmin=t.mmin,l.mmax=t.mmax,l.hasM=!0),l}return"rings"in t?{rings:g(t.rings,e),hasM:t.hasM,hasZ:t.hasZ}:"paths"in t?{paths:g(t.paths,e),hasM:t.hasM,hasZ:t.hasZ}:"points"in t?{points:b(t.points,e),hasM:t.hasM,hasZ:t.hasZ}:void 0}function g(e,t){var r,n=[],a=Object(s.a)(e);try{for(a.s();!(r=a.n()).done;){var i=r.value;n.push(b(i,t))}}catch(u){a.e(u)}finally{a.f()}return n}function b(e,t){var r,n=[],a=Object(s.a)(e);try{for(a.s();!(r=a.n()).done;){var i=r.value,u=t(i[0],i[1],[0,0]);n.push(u),i.length>2&&u.push(i[2]),i.length>3&&u.push(i[3])}}catch(o){a.e(o)}finally{a.f()}return n}function m(e,t){return _.apply(this,arguments)}function _(){return(_=Object(i.a)(c.a.mark((function e(t,r){var n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}return e.abrupt("return");case 2:return n=Array.isArray(t)?t.map((function(e){return Object(l.k)(e.geometry)&&e.geometry.spatialReference})):[t],e.next=5,Object(h.d)(n.map((function(e){return{source:e,dest:r}})));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var k=y.bind(null,p.c),x=y.bind(null,p.f);function j(e,t,r,n){if(!e)return e;if(r||(r=t,t=e.spatialReference),!Object(f.l)(t)||!Object(f.l)(r)||Object(f.d)(t,r))return e;if(Object(p.a)(t,r)){var a=Object(f.p)(r)?k(e):x(e);return a.spatialReference=r,a}return Object(h.i)(d.a,[e],t,r,null,n)[0]}var O=function(){function e(){Object(n.a)(this,e),this._jobs=[],this._timer=null,this._process=this._process.bind(this)}return Object(a.a)(e,[{key:"push",value:function(){var e=Object(i.a)(c.a.mark((function e(t,r,n){var a,i=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&t.length&&r&&n&&!Object(f.d)(r,n)){e.next=2;break}return e.abrupt("return",t);case 2:return a={geometries:t,inSpatialReference:r,outSpatialReference:n,resolve:null},e.abrupt("return",(this._jobs.push(a),new Promise((function(e){a.resolve=e,null===i._timer&&(i._timer=setTimeout(i._process,10))}))));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_process",value:function(){this._timer=null;var e=this._jobs.shift();if(e){var t=e.geometries,r=e.inSpatialReference,n=e.outSpatialReference,a=e.resolve;Object(p.a)(r,n)?Object(f.p)(n)?a(t.map(k)):a(t.map(x)):a(Object(h.i)(d.a,t,r,n,null,null)),this._jobs.length>0&&(this._timer=setTimeout(this._process,10))}}}]),e}(),I=new O;function w(e,t,r){return I.push(e,t,r)}},279:function(e,t,r){"use strict";r.d(t,"a",(function(){return o}));var n=r(159),a=r(156),i=r(157),s=r(165),u=a.a.getLogger("esri.views.2d.engine.webgl");function o(e){return Object(s.v)(e.minDataValue)&&Object(s.v)(e.maxDataValue)&&null!=e.minSize&&null!=e.maxSize?i.f.SIZE_MINMAX_VALUE:(e.expression&&"view.scale"===e.expression||e.valueExpression&&"$view.scale"===e.valueExpression)&&Array.isArray(e.stops)?i.f.SIZE_SCALE_STOPS:(null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&(Array.isArray(e.stops)||"levels"in e&&e.levels)?i.f.SIZE_FIELD_STOPS:(null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&null!=e.valueUnit?i.f.SIZE_UNIT_VALUE:(u.error(new n.a("mapview-bad-type","Found invalid size VisualVariable",e)),i.f.NONE)}},298:function(e,t,r){"use strict";r.d(t,"a",(function(){return A}));var n,a,i,s=r(60),u=r(142),o=r(143),c=r(154),l=r.n(c),h=(r(177),r(147)),d=r(146),f=r(344),p=r(188),v=r(216),y=r(310),g=r(168),b=0,m=null!==(n=Object(h.a)("featurelayer-simplify-thresholds"))&&void 0!==n?n:[.5,.5,.5,.5],_=m[0],k=m[1],x=m[2],j=m[3],O=null!==(a=Object(h.a)("featurelayer-simplify-payload-size-factors"))&&void 0!==a?a:[1,2,4],I=O[0],w=O[1],S=O[2],F=null!==(i=Object(h.a)("featurelayer-simplify-mobile-factor"))&&void 0!==i?i:2,T=Object(h.a)("esri-mobile"),A=function(){function e(t,r){Object(u.a)(this,e),this.type="FeatureSetReader",this.arcadeDeclaredClass="esri.arcade.Feature",this.seen=!1,this.instance=0,this._tx=0,this._ty=0,this._sx=1,this._sy=1,this._deleted=null,this._joined=[],this._objectIdToIndex=null,this._level=0,this.instance=t,this._layerSchema=r}return Object(o.a)(e,[{key:"isEmpty",get:function(){return Object(d.k)(this._deleted)&&this._deleted.countSet()===this.getSize()}},{key:"level",set:function(e){this._level=e}},{key:"getAreaSimplificationThreshold",value:function(e,t){var r=1,n=T?F:1;t>4e6?r=S*n:t>1e6?r=w*n:t>5e5?r=I*n:t>1e5&&(r=n);var a=0;e>4e3?a=j*r:e>2e3?a=x*r:e>100?a=k:e>15&&(a=_);var i=8;return this._level<4?i=1:this._level<5?i=2:this._level<6&&(i=4),a*i}},{key:"setArcadeSpatialReference",value:function(e){this._arcadeSpatialReference=e}},{key:"attachStorage",value:function(e){this._storage=e}},{key:"getQuantizationTransform",value:function(){throw new Error("Unable to find transform for featureSet")}},{key:"getStorage",value:function(){return this._storage}},{key:"getComputedNumeric",value:function(e){return this.getComputedNumericAtIndex(0)}},{key:"setComputedNumeric",value:function(e,t){return this.setComputedNumericAtIndex(t,0)}},{key:"getComputedString",value:function(e){return this.getComputedStringAtIndex(0)}},{key:"setComputedString",value:function(e,t){return this.setComputedStringAtIndex(0,t)}},{key:"getComputedNumericAtIndex",value:function(e){return this._storage.getComputedNumericAtIndex(this.getDisplayId(),e)}},{key:"setComputedNumericAtIndex",value:function(e,t){this._storage.setComputedNumericAtIndex(this.getDisplayId(),e,t)}},{key:"getComputedStringAtIndex",value:function(e){return this._storage.getComputedStringAtIndex(this.getDisplayId(),e)}},{key:"setComputedStringAtIndex",value:function(e,t){return this._storage.setComputedStringAtIndex(this.getDisplayId(),e,t)}},{key:"transform",value:function(e,t,r,n){var a=this.copy();return a._tx+=e,a._ty+=t,a._sx*=r,a._sy*=n,a}},{key:"readAttribute",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this._readAttribute(e,t);if(void 0!==r)return r;var n,a=Object(s.a)(this._joined);try{for(a.s();!(n=a.n()).done;){var i=n.value;i.setIndex(this.getIndex());var u=i._readAttribute(e,t);if(void 0!==u)return u}}catch(o){a.e(o)}finally{a.f()}}},{key:"readAttributes",value:function(){var e,t=this._readAttributes(),r=Object(s.a)(this._joined);try{for(r.s();!(e=r.n()).done;){var n=e.value;n.setIndex(this.getIndex());for(var a=n._readAttributes(),i=0,u=Object.keys(a);i<u.length;i++){var o=u[i];t[o]=a[o]}}}catch(c){r.e(c)}finally{r.f()}return t}},{key:"joinAttributes",value:function(e){this._joined.push(e)}},{key:"readArcadeFeature",value:function(){return this}},{key:"geometry",value:function(){var e=this.readHydratedGeometry(),t=Object(p.k)(e,this.geometryType,this.hasZ,this.hasM),r=Object(g.a)(t);return r&&(r.spatialReference=this._arcadeSpatialReference),r}},{key:"field",value:function(e){if(this.hasField(e))return this.readAttribute(e,!0);var t,r=Object(s.a)(this._joined);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(n.setIndex(this.getIndex()),n.hasField(e))return n._readAttribute(e,!0)}}catch(a){r.e(a)}finally{r.f()}throw new Error("Field ".concat(e," does not exist"))}},{key:"setField",value:function(e,t){throw new Error("Unable to update feature attribute values, feature is readonly")}},{key:"keys",value:function(){return this.getFieldNames()}},{key:"castToText",value:function(){return JSON.stringify(this.readLegacyFeature())}},{key:"gdbVersion",value:function(){return null}},{key:"fullSchema",value:function(){return this._layerSchema}},{key:"castAsJson",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return{attributes:this._readAttributes(),geometry:!0===(null===e||void 0===e?void 0:e.keepGeometryType)?this.geometry():this.geometry().toJSON()}}},{key:"castAsJsonAsync",value:function(){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return Promise.resolve(this.castAsJson(e))}},{key:"removeIds",value:function(e){if(Object(d.j)(this._objectIdToIndex)){for(var t=new Map,r=this.getCursor();r.next();)t.set(r.getObjectId(),r.getIndex());this._objectIdToIndex=t}var n,a=this._objectIdToIndex,i=Object(s.a)(e);try{for(i.s();!(n=i.n()).done;){var u=n.value;a.has(u)&&this.removeAtIndex(a.get(u))}}catch(o){i.e(o)}finally{i.f()}}},{key:"removeAtIndex",value:function(e){Object(d.j)(this._deleted)&&(this._deleted=y.a.create(this.getSize())),this._deleted.set(e)}},{key:"readGeometryForDisplay",value:function(){return this.readUnquantizedGeometry(!0)}},{key:"readLegacyGeometryForDisplay",value:function(){return this.readLegacyGeometry(!0)}},{key:"features",value:l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this.getCursor();case 1:if(!t.next()){e.next=6;break}return e.next=4,t.readOptimizedFeature();case 4:e.next=1;break;case 6:case"end":return e.stop()}}),e,this)}))},{key:"_getExists",value:function(){return Object(d.j)(this._deleted)||!this._deleted.has(this.getIndex())}},{key:"_computeCentroid",value:function(){if("esriGeometryPolygon"!==this.geometryType)return null;var e=this.readUnquantizedGeometry();if(!e||e.hasIndeterminateRingOrder)return null;var t=Object(d.r)(this.getQuantizationTransform(),null);return Object(f.a)(new v.a,e,this.hasM,this.hasZ,t)}},{key:"copyInto",value:function(e){e.seen=this.seen,e._storage=this._storage,e._arcadeSpatialReference=this._arcadeSpatialReference,e._joined=this._joined,e._tx=this._tx,e._ty=this._ty,e._sx=this._sx,e._sy=this._sy,e._deleted=this._deleted,e._objectIdToIndex=this._objectIdToIndex}}],[{key:"createInstance",value:function(){return b=++b>65535?0:b}}]),e}()},308:function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var n=r(143),a=r(142),i={convertToGEGeometry:function(e,t){return null==t?null:e.convertJSONToGeometry(t)},exportPoint:function(e,t,r){var n=new s(e.getPointX(t),e.getPointY(t),r),a=e.hasZ(t),i=e.hasM(t);return a&&(n.z=e.getPointZ(t)),i&&(n.m=e.getPointM(t)),n},exportPolygon:function(e,t,r){return new u(e.exportPaths(t),r,e.hasZ(t),e.hasM(t))},exportPolyline:function(e,t,r){return new o(e.exportPaths(t),r,e.hasZ(t),e.hasM(t))},exportMultipoint:function(e,t,r){return new c(e.exportPoints(t),r,e.hasZ(t),e.hasM(t))},exportExtent:function(e,t,r){var n=e.hasZ(t),a=e.hasM(t),i=new l(e.getXMin(t),e.getYMin(t),e.getXMax(t),e.getYMax(t),r);if(n){var s=e.getZExtent(t);i.zmin=s.vmin,i.zmax=s.vmax}if(a){var u=e.getMExtent(t);i.mmin=u.vmin,i.mmax=u.vmax}return i}};var s=Object(n.a)((function e(t,r,n){Object(a.a)(this,e),this.x=t,this.y=r,this.spatialReference=n,this.z=void 0,this.m=void 0}));var u=Object(n.a)((function e(t,r,n,i){Object(a.a)(this,e),this.rings=t,this.spatialReference=r,this.hasZ=void 0,this.hasM=void 0,n&&(this.hasZ=n),i&&(this.hasM=i)}));var o=Object(n.a)((function e(t,r,n,i){Object(a.a)(this,e),this.paths=t,this.spatialReference=r,this.hasZ=void 0,this.hasM=void 0,n&&(this.hasZ=n),i&&(this.hasM=i)}));var c=Object(n.a)((function e(t,r,n,i){Object(a.a)(this,e),this.points=t,this.spatialReference=r,this.hasZ=void 0,this.hasM=void 0,n&&(this.hasZ=n),i&&(this.hasM=i)}));var l=Object(n.a)((function e(t,r,n,i,s){Object(a.a)(this,e),this.xmin=t,this.ymin=r,this.xmax=n,this.ymax=i,this.spatialReference=s,this.zmin=void 0,this.zmax=void 0,this.mmin=void 0,this.mmax=void 0}))},310:function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var n=r(142),a=r(143),i=function(){function e(t,r){Object(n.a)(this,e),this._mask=0,this._buf=t,this._mask=r}return Object(a.a)(e,[{key:"_getIndex",value:function(e){return Math.floor(e/32)}},{key:"has",value:function(e){var t=this._mask&e;return!!(this._buf[this._getIndex(t)]&1<<t%32)}},{key:"hasRange",value:function(e,t){for(var r=e,n=t;r%32&&r!==n;){if(this.has(r))return!0;r++}for(;n%32&&r!==n;){if(this.has(r))return!0;n--}if(r===n)return!1;for(var a=r/32;a!==n/32;a++)if(this._buf[a])return!0;return!1}},{key:"set",value:function(e){var t=this._mask&e,r=this._getIndex(t),n=1<<t%32;this._buf[r]|=n}},{key:"setRange",value:function(e,t){for(var r=e,n=t;r%32&&r!==n;)this.set(r++);for(;n%32&&r!==n;)this.set(n--);if(r!==n)for(var a=r/32;a!==n/32;a++)this._buf[a]=4294967295}},{key:"unset",value:function(e){var t=this._mask&e,r=this._getIndex(t),n=1<<t%32;this._buf[r]&=4294967295^n}},{key:"resize",value:function(e){var t=this._buf,r=new Uint32Array(Math.ceil(e/32));r.set(t),this._buf=r}},{key:"or",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]|=e._buf[t];return this}},{key:"and",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]&=e._buf[t];return this}},{key:"xor",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]^=e._buf[t];return this}},{key:"ior",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]|=~e._buf[t];return this}},{key:"iand",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]&=~e._buf[t];return this}},{key:"ixor",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]^=~e._buf[t];return this}},{key:"any",value:function(){for(var e=0;e<this._buf.length;e++)if(this._buf[e])return!0;return!1}},{key:"copy",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]=e._buf[t];return this}},{key:"clone",value:function(){return new e(this._buf.slice(),this._mask)}},{key:"clear",value:function(){for(var e=0;e<this._buf.length;e++)this._buf[e]=0}},{key:"forEachSet",value:function(e){for(var t=0;t<this._buf.length;t++){var r=this._buf[t],n=32*t;if(r)for(;r;)1&r&&e(n),r>>>=1,n++}}},{key:"countSet",value:function(){var e=0;return this.forEachSet((function(t){e++})),e}}],[{key:"fromBuffer",value:function(t,r){return new e(t,r)}},{key:"create",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4294967295,n=new Uint32Array(Math.ceil(t/32));return new e(n,r)}}]),e}()},311:function(e,t,r){"use strict";r.d(t,"a",(function(){return a})),r.d(t,"b",(function(){return n}));var n=function(e,t){return e&&function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t.warn.apply(t,["DEBUG:"].concat(r))}||function(){return null}},a=!1},339:function(e,t,r){"use strict";r.d(t,"a",(function(){return p}));var n=r(142),a=r(143),i=r(164),s=r(163),u=r(144),o=r(145),c=r(60),l=r(146),h=r(188),d=r(350),f=r(298);var p=function(e){Object(u.a)(r,e);var t=Object(o.a)(r);function r(e,a,i){var s;return Object(n.a)(this,r),(s=t.call(this,e,i))._featureIndex=-1,s._dateFields=new Set,s._geometryType=null===i||void 0===i?void 0:i.geometryType,s._features=a,s}return Object(a.a)(r,[{key:"_current",get:function(){return this._features[this._featureIndex]}},{key:"geometryType",get:function(){return this._geometryType}},{key:"hasFeatures",get:function(){return!!this._features.length}},{key:"hasNext",get:function(){return this._featureIndex+1<this._features.length}},{key:"exceededTransferLimit",get:function(){return this._exceededTransferLimit}},{key:"hasZ",get:function(){return!1}},{key:"hasM",get:function(){return!1}},{key:"removeIds",value:function(e){var t=new Set(e);this._features=this._features.filter((function(e){return!t.has(e.objectId)}))}},{key:"append",value:function(e){var t,r=Object(c.a)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;this._features.push(n)}}catch(a){r.e(a)}finally{r.f()}}},{key:"getSize",value:function(){return this._features.length}},{key:"getCursor",value:function(){return this.copy()}},{key:"getQuantizationTransform",value:function(){return this._transform}},{key:"getAttributeHash",value:function(){var e="";for(var t in this._current.attributes)e+=this._current.attributes[t];return e}},{key:"getIndex",value:function(){return this._featureIndex}},{key:"setIndex",value:function(e){this._featureIndex=e}},{key:"getObjectId",value:function(){return this._current.objectId}},{key:"getDisplayId",value:function(){return this._current.displayId}},{key:"setDisplayId",value:function(e){this._current.displayId=e}},{key:"getGroupId",value:function(){return this._current.groupId}},{key:"setGroupId",value:function(e){this._current.groupId=e}},{key:"copy",value:function(){var e=new r(this.instance,this._features,this.fullSchema());return this.copyInto(e),e}},{key:"next",value:function(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}},{key:"readLegacyFeature",value:function(){return Object(h.i)(this._current,this.geometryType,this.hasZ,this.hasM)}},{key:"readOptimizedFeature",value:function(){return this._current}},{key:"readLegacyPointGeometry",value:function(){return this.readGeometry()?{x:this.getX(),y:this.getY()}:null}},{key:"readLegacyGeometry",value:function(){var e=this.readGeometry();return Object(h.k)(e,this.geometryType,this.hasZ,this.hasM)}},{key:"readLegacyCentroid",value:function(){var e=this.readCentroid();return Object(l.j)(e)?null:{x:e.coords[0]*this._sx+this._tx,y:e.coords[1]*this._sy+this._ty}}},{key:"readGeometryArea",value:function(){return Object(d.c)(this._current)?Object(h.s)(this._current.geometry,2):0}},{key:"readUnquantizedGeometry",value:function(){var e=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!e)return e;var t=e.clone();return function(e){var t,r=e.coords,n=e.lengths,a=0,i=Object(c.a)(n);try{for(i.s();!(t=i.n()).done;){for(var s=t.value,u=1;u<s;u++)r[2*(a+u)]+=r[2*(a+u)-2],r[2*(a+u)+1]+=r[2*(a+u)-1];a+=s}}catch(o){i.e(o)}finally{i.f()}}(t),t}},{key:"readHydratedGeometry",value:function(){var e=this._current.geometry;if(Object(l.j)(e))return null;var t=e.clone();return Object(l.k)(this._transform)&&Object(h.z)(t,t,this.hasZ,this.hasM,this._transform),t}},{key:"getXHydrated",value:function(){if(!Object(d.c)(this._current))return 0;var e=this._current.geometry.coords[0],t=this.getQuantizationTransform();return Object(l.j)(t)?e:e*t.scale[0]+t.translate[0]}},{key:"getYHydrated",value:function(){if(!Object(d.c)(this._current))return 0;var e=this._current.geometry.coords[1],t=this.getQuantizationTransform();return Object(l.j)(t)?e:t.translate[1]-e*t.scale[1]}},{key:"getX",value:function(){return Object(d.c)(this._current)?this._current.geometry.coords[0]*this._sx+this._tx:0}},{key:"getY",value:function(){return Object(d.c)(this._current)?this._current.geometry.coords[1]*this._sy+this._ty:0}},{key:"readGeometry",value:function(){if(!Object(d.c)(this._current))return null;var e=this._current.geometry.clone();if(e.isPoint)return e.coords[0]=e.coords[0]*this._sx+this._tx,e.coords[1]=e.coords[1]*this._sy+this._ty,e;var t,r=0,n=Object(c.a)(e.lengths);try{for(n.s();!(t=n.n()).done;){var a=t.value;e.coords[2*r]=e.coords[2*r]*this._sx+this._tx,e.coords[2*r+1]=e.coords[2*r+1]*this._sy+this._ty,r+=a}}catch(i){n.e(i)}finally{n.f()}return e}},{key:"readCentroid",value:function(){if(!Object(d.c)(this._current))return null;if(Object(l.j)(this._current.centroid)){var e=this._computeCentroid();if(Object(l.j)(e))return null;e.coords[0]=(e.coords[0]-this._tx)/this._sx,e.coords[1]=(e.coords[1]-this._ty)/this._sy,this._current.centroid=e}var t=this._current.centroid.clone();return t.coords[0]=t.coords[0]*this._sx+this._tx,t.coords[1]=t.coords[1]*this._sx+this._ty,t}},{key:"hasField",value:function(e){return e in this._current.attributes||this.getFieldNames().map((function(e){return e.toLowerCase()})).includes(e.toLowerCase())}},{key:"getFieldNames",value:function(){return Object.keys(this._current.attributes)}},{key:"_readAttribute",value:function(e,t){var r=this._current.attributes[e];if(void 0!==r)return null!=r&&t&&this._dateFields.has(e)?new Date(r):r;var n=this.readAttributes(),a=e.toLocaleLowerCase().trim();for(var i in n)if(i.toLocaleLowerCase().trim()===a){var s=this._current.attributes[i];return null!=s&&t&&this._dateFields.has(i)?new Date(s):s}}},{key:"copyInto",value:function(e){Object(i.a)(Object(s.a)(r.prototype),"copyInto",this).call(this,e),e._featureIndex=this._featureIndex,e._transform=this._transform,e._dateFields=this._dateFields}},{key:"_readAttributes",value:function(){return this._current.attributes}}],[{key:"fromFeatures",value:function(e,t){for(var n=t.objectIdField,a=t.geometryType,i=Object(h.c)([],e,a,!1,!1,n),s=0;s<i.length;s++)i[s].displayId=e[s].displayId;return r.fromOptimizedFeatures(i,t)}},{key:"fromFeatureSet",value:function(e,t){var n=Object(h.b)(e,t.objectIdField);return r.fromOptimizedFeatureSet(n,t)}},{key:"fromOptimizedFeatureSet",value:function(e,t){var n=e.features,a=r.fromOptimizedFeatures(n,t);a._exceededTransferLimit=e.exceededTransferLimit,a._transform=e.transform;var i,s=Object(c.a)(e.fields);try{for(s.s();!(i=s.n()).done;){var u=i.value;"esriFieldTypeDate"===u.type&&a._dateFields.add(u.name)}}catch(o){s.e(o)}finally{s.f()}return a}},{key:"fromOptimizedFeatures",value:function(e,t,n){var a=new r(f.a.createInstance(),e,t);return a._transform=n,a}}]),r}(f.a)},344:function(e,t,r){"use strict";r.d(t,"a",(function(){return s}));var n=r(60),a=r(146);function i(e,t){return e?t?4:3:t?3:2}function s(e,t,r,s,c){if(Object(a.j)(t)||!t.lengths.length)return null;var l="upperLeft"===(null===c||void 0===c?void 0:c.originPosition)?-1:1;e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0);var h,d=e.coords,f=[],p=r?[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]:[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY],v=t.lengths,y=t.coords,g=i(r,s),b=0,m=Object(n.a)(v);try{for(m.s();!(h=m.n()).done;){var _=h.value,k=u(p,y,b,_,r,s,l);k&&f.push(k),b+=_*g}}catch(O){m.e(O)}finally{m.f()}if(f.sort((function(e,t){var n=l*e[2]-l*t[2];return 0===n&&r&&(n=e[4]-t[4]),n})),f.length){var x=6*f[0][2];d[0]=f[0][0]/x,d[1]=f[0][1]/x,r&&(x=6*f[0][4],d[2]=0!==x?f[0][3]/x:0),(d[0]<p[0]||d[0]>p[1]||d[1]<p[2]||d[1]>p[3]||r&&(d[2]<p[4]||d[2]>p[5]))&&(d.length=0)}if(!d.length){var j=t.lengths[0]?o(y,0,v[0],r,s):null;if(!j)return null;d[0]=j[0],d[1]=j[1],r&&j.length>2&&(d[2]=j[2])}return e}function u(e,t,r,n,a,s){for(var u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,o=i(a,s),c=r,l=r+o,h=0,d=0,f=0,p=0,v=0,y=0,g=n-1;y<g;y++,c+=o,l+=o){var b=t[c],m=t[c+1],_=t[c+2],k=t[l],x=t[l+1],j=t[l+2],O=b*x-k*m;p+=O,h+=(b+k)*O,d+=(m+x)*O,a&&(f+=(_+j)*(O=b*j-k*_),v+=O),b<e[0]&&(e[0]=b),b>e[1]&&(e[1]=b),m<e[2]&&(e[2]=m),m>e[3]&&(e[3]=m),a&&(_<e[4]&&(e[4]=_),_>e[5]&&(e[5]=_))}if(p*u>0&&(p*=-1),v*u>0&&(v*=-1),!p)return null;var I=[h,d,.5*p];return a&&(I[3]=f,I[4]=.5*v),I}function o(e,t,r,n,a){for(var s=i(n,a),u=t,o=t+s,f=0,p=0,v=0,y=0,g=0,b=r-1;g<b;g++,u+=s,o+=s){var m=e[u],_=e[u+1],k=e[u+2],x=e[o],j=e[o+1],O=e[o+2],I=n?l(m,_,k,x,j,O):c(m,_,x,j);if(I)if(f+=I,n){var w=d(m,_,k,x,j,O);p+=I*w[0],v+=I*w[1],y+=I*w[2]}else{var S=h(m,_,x,j);p+=I*S[0],v+=I*S[1]}}return f>0?n?[p/f,v/f,y/f]:[p/f,v/f]:r>0?n?[e[t],e[t+1],e[t+2]]:[e[t],e[t+1]]:null}function c(e,t,r,n){var a=r-e,i=n-t;return Math.sqrt(a*a+i*i)}function l(e,t,r,n,a,i){var s=n-e,u=a-t,o=i-r;return Math.sqrt(s*s+u*u+o*o)}function h(e,t,r,n){return[e+.5*(r-e),t+.5*(n-t)]}function d(e,t,r,n,a,i){return[e+.5*(n-e),t+.5*(a-t),r+.5*(i-r)]}},366:function(e,t,r){"use strict";r.d(t,"a",(function(){return v})),r.d(t,"b",(function(){return h}));var n=r(5),a=r(60),i=r(146),s=r(167),u=r(195),o=r(158),c=r(157),l=r(279);function h(e,t){if(!e||!t)return e;switch(t){case"radius":case"distance":return 2*e;case"diameter":case"width":return e;case"area":return Math.sqrt(e)}return e}function d(e){return e.map((function(e){return function(e){return{value:e.value,size:Object(s.e)(e.size)}}(e)}))}function f(e){if("string"==typeof e||"number"==typeof e)return Object(s.e)(e);var t=e;return{type:"size",expression:t.expression,stops:d(t.stops)}}var p=function(e){for(var t=[],r=[],n=d(e),a=n.length,i=0;i<6;i++){var u=n[Math.min(i,a-1)];t.push(u.value),r.push(null==u.size?o.A:Object(s.c)(u.size))}return{values:new Float32Array(t),sizes:new Float32Array(r)}};function v(e){var t=e&&e.length>0?{}:null,r=t?{}:null;if(!t)return{vvFields:t,vvRanges:r};var i,s=Object(a.a)(e);try{for(s.s();!(i=s.n()).done;){var u=i.value;if(u.field&&(t[u.type]=u.field),"size"===u.type){r.size||(r.size={});var o=u;switch(Object(l.a)(o)){case c.f.SIZE_MINMAX_VALUE:r.size.minMaxValue={minDataValue:o.minDataValue,maxDataValue:o.maxDataValue,minSize:f(o.minSize),maxSize:f(o.maxSize)};break;case c.f.SIZE_SCALE_STOPS:r.size.scaleStops={stops:d(o.stops)};break;case c.f.SIZE_FIELD_STOPS:if(o.levels){var h={};for(var v in o.levels)h[v]=p(o.levels[v]);r.size.fieldStops={type:"level-dependent",levels:h}}else r.size.fieldStops=Object(n.a)({type:"static"},p(o.stops));break;case c.f.SIZE_UNIT_VALUE:r.size.unitValue={unit:o.valueUnit,valueRepresentation:o.valueRepresentation}}}else if("color"===u.type)r.color=b(u);else if("opacity"===u.type)r.opacity=y(u);else if("rotation"===u.type){var g=u;r.rotation={type:g.rotationType}}}}catch(m){s.e(m)}finally{s.f()}return{vvFields:t,vvRanges:r}}function y(e){var t={values:[0,0,0,0,0,0,0,0],opacities:[0,0,0,0,0,0,0,0]};if("string"==typeof e.field){if(!e.stops)return null;if(e.stops.length>8)return null;for(var r=e.stops,n=0;n<8;++n){var a=r[Math.min(n,r.length-1)];t.values[n]=a.value,t.opacities[n]=a.opacity}}else{if(!(e.stops&&e.stops.length>=0))return null;for(var i=e.stops&&e.stops.length>=0&&e.stops[0].opacity,s=0;s<8;s++)t.values[s]=1/0,t.opacities[s]=i}return t}function g(e,t,r){e[4*t+0]=r.r/255,e[4*t+1]=r.g/255,e[4*t+2]=r.b/255,e[4*t+3]=r.a}function b(e){if(Object(i.j)(e))return null;if(e.normalizationField)return null;var t={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};if("string"==typeof e.field){if(!e.stops)return null;if(e.stops.length>8)return null;t.field=e.field;for(var r=e.stops,n=0;n<8;++n){var a=r[Math.min(n,r.length-1)];t.values[n]=a.value,g(t.colors,n,a.color)}}else{if(!(e.stops&&e.stops.length>=0))return null;for(var s=e.stops&&e.stops.length>=0&&e.stops[0].color,o=0;o<8;o++)t.values[o]=1/0,g(t.colors,o,s)}for(var c=0;c<32;c+=4)Object(u.b)(t.colors,c,!0);return t}},386:function(e,t,r){"use strict";r.d(t,"a",(function(){return p})),r.d(t,"b",(function(){return d})),r.d(t,"c",(function(){return f})),r.d(t,"d",(function(){return c}));var n=r(7),a=r(5),i=r(147),s=r(161),u=r(387),o=r(365);function c(e){return{renderer:{type:"simple",symbol:"esriGeometryPoint"===e||"esriGeometryMultipoint"===e?o.a:"esriGeometryPolyline"===e?o.c:o.b}}}var l=/^[_$a-zA-Z][_$a-zA-Z0-9]*$/,h=1;function d(e,t){if(Object(i.a)("esri-csp-restrictions"))return function(){return Object(a.a)(Object(n.a)({},t,null),e)};try{var r="this.".concat(t," = null;");for(var s in e)r+="this".concat(l.test(s)?".".concat(s):'["'.concat(s,'"]')," = ").concat(JSON.stringify(e[s]),";");var u=new Function("\n      return class AttributesClass$".concat(h++," {\n        constructor() {\n          ").concat(r,";\n        }\n      }\n    "))();return function(){return new u}}catch(o){return function(){return Object(a.a)(Object(n.a)({},t,null),e)}}}function f(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return[{name:"New Feature",description:"",prototype:{attributes:Object(s.a)(e)}}]}function p(e,t){return{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:e},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:t,supportsDelete:t,supportsEditing:t,supportsChangeTracking:!1,supportsQuery:!0,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:t,supportsExceedsLimitStatistics:!0},query:u.a,queryRelated:{supportsCount:!0,supportsOrderBy:!0,supportsPagination:!0,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},editing:{supportsGeometryUpdate:t,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1}}}},387:function(e,t,r){"use strict";r.d(t,"a",(function(){return n}));var n={supportsStatistics:!0,supportsPercentileStatistics:!0,supportsSpatialAggregationStatistics:!1,supportedSpatialAggregationStatistics:{envelope:!1,centroid:!1,convexHull:!1},supportsCentroid:!0,supportsCacheHint:!1,supportsDistance:!0,supportsDistinct:!0,supportsExtent:!0,supportsGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQuantization:!0,supportsQuantizationEditMode:!1,supportsQueryGeometry:!0,supportsResultType:!1,supportsSqlExpression:!0,supportsMaxRecordCountFactor:!1,supportsStandardizedQueriesOnly:!0,supportsTopFeaturesQuery:!1,supportsQueryByOthers:!0,supportsHistoricMoment:!1,supportsFormatPBF:!1,supportsDisjointSpatialRelationship:!0,supportsDefaultSpatialReference:!1,supportsCompactGeometry:!1,maxRecordCountFactor:void 0,maxRecordCount:void 0,standardMaxRecordCount:void 0,tileMaxRecordCount:void 0}},388:function(e,t,r){"use strict";r.d(t,"a",(function(){return F}));var n=r(155),a=r(60),i=r(142),s=r(143),u=r(154),o=r.n(u),c=r(159),l=r(147),h=r(156),d=r(190),f=r(146),p=r(162),v=r(374),y=r(329),g=r(158),b=r(212),m=r(165),_=r(311),k=r(366),x=r(153),j=h.a.getLogger("esri.views.layers.2d.features.support.AttributeStore"),O=Object(_.b)(_.a,j),I={sharedArrayBuffer:Object(l.a)("esri-shared-array-buffer"),atomics:Object(l.a)("esri-atomics")};function w(e,t){return function(r){return t(e(r))}}var S=function(){function e(t,r,n,a){Object(i.a)(this,e),this.size=0,this.texelSize=4;var s=a.pixelType,u=a.layout,o=a.textureOnly;this.textureOnly=o||!1,this.pixelType=s,this._ctype=r,this.layout=u,this._resetRange(),this._shared=t,this.size=n,o||(this.data=this._initData(s,n,t,r))}return Object(s.a)(e,[{key:"buffer",get:function(){return Object(f.b)(this.data,(function(e){return e.buffer}))}},{key:"unsetComponentAllTexels",value:function(e,t){for(var r=Object(f.q)(this.data),n=0;n<this.size*this.size;n++)r[n*this.texelSize+e]&=~t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}},{key:"setComponentAllTexels",value:function(e,t){for(var r=Object(f.q)(this.data),n=0;n<this.size*this.size;n++)r[n*this.texelSize+e]|=255&t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}},{key:"setComponent",value:function(e,t,r){var n,i=Object(f.q)(this.data),s=Object(a.a)(r);try{for(s.s();!(n=s.n()).done;){var u=n.value;i[u*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,u),this.dirtyEnd=Math.max(this.dirtyEnd,u)}}catch(o){s.e(o)}finally{s.f()}}},{key:"setComponentTexel",value:function(e,t,r){Object(f.q)(this.data)[r*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)}},{key:"unsetComponentTexel",value:function(e,t,r){Object(f.q)(this.data)[r*this.texelSize+e]&=~t,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)}},{key:"getData",value:function(e,t){var r=Object(b.f)(e);return Object(f.q)(this.data)[r*this.texelSize+t]}},{key:"setData",value:function(e,t,r){var n=Object(b.f)(e),a=1<<t;0!=(this.layout&a)?(this.data[n*this.texelSize+t]=r,this.dirtyStart=Math.min(this.dirtyStart,n),this.dirtyEnd=Math.max(this.dirtyEnd,n)):j.error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}},{key:"lock",value:function(){this.pixelType===x.q.UNSIGNED_BYTE&&this._shared&&I.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,1)}},{key:"unlock",value:function(){this.pixelType===x.q.UNSIGNED_BYTE&&this._shared&&I.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,0)}},{key:"expand",value:function(e){if(this.size=e,!this.textureOnly){var t=this._initData(this.pixelType,e,this._shared,this._ctype),r=Object(f.q)(this.data);t.set(r),this.data=t}}},{key:"toMessage",value:function(){var e=this.dirtyStart,t=this.dirtyEnd,r=this.texelSize;if(e>t)return null;this._resetRange();var n=!(this._shared||"local"===this._ctype),a=this.pixelType,i=this.layout,s=Object(f.q)(this.data);return{start:e,end:t,data:n&&s.slice(e*r,(t+1)*r)||null,pixelType:a,layout:i}}},{key:"_initData",value:function(e,t,r,n){for(var a=r&&"local"!==n?SharedArrayBuffer:ArrayBuffer,i=Object(m.l)(e),s=new i(new a(t*t*4*i.BYTES_PER_ELEMENT)),u=0;u<s.length;u+=4)s[u+1]=255;return s}},{key:"_resetRange",value:function(){this.dirtyStart=2147483647,this.dirtyEnd=0}}]),e}(),F=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){};Object(i.a)(this,e),this._client=t,this.config=r,this._notifyChange=n,this._attributeComputeMap=new Map,this._blocks=new Array,this._filters=new Array(g.y),this._targetType=0,this._abortController=new AbortController,this._hasScaleExpr=!1,this._size=32,this._idsToHighlight=new Set;var a=r.supportsTextureFloat?x.q.FLOAT:x.q.UNSIGNED_BYTE;O("Creating AttributeStore ".concat(I.sharedArrayBuffer?"with":"without"," shared memory")),this._blockDescriptors=[{pixelType:x.q.UNSIGNED_BYTE,layout:1},{pixelType:x.q.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:x.q.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:a,layout:15},{pixelType:a,layout:15},{pixelType:a,layout:15},{pixelType:a,layout:15}],this._blocks=this._blockDescriptors.map((function(){return null}))}return Object(s.a)(e,[{key:"destroy",value:function(){this._abortController.abort()}},{key:"hasScaleExpr",get:function(){return this._hasScaleExpr}},{key:"_signal",get:function(){return this._abortController.signal}},{key:"hasHighlight",get:function(){return this._idsToHighlight.size>0}},{key:"isUpdating",value:function(){return!!this._currUpdate||!!this._nextUpdate}},{key:"update",value:function(e,t){this.config=t;var r=t.schema.processors[0].storage,n=Object(v.a)(this._schema,r);if((e.targets.feature||e.targets.aggregate)&&(e.storage.data=!0),n&&(Object(l.a)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:",n),e.storage.data=!0,this._schema=r,this._attributeComputeMap.clear(),!Object(f.j)(r))){switch(r.target){case"feature":this._targetType=b.c;break;case"aggregate":this._targetType=b.b}if("subtype"===r.type)for(var i in r.mapping){var s=r.mapping[i];if(Object(f.k)(s)&&Object(f.k)(s.vvMapping)){var u,o=Object(a.a)(s.vvMapping);try{for(o.s();!(u=o.n()).done;){var c=u.value;this._bindAttribute(c)}}catch(_){o.e(_)}finally{o.f()}}}else{if(Object(f.k)(r.vvMapping)){var h,d=Object(a.a)(r.vvMapping);try{for(d.s();!(h=d.n()).done;){var p=h.value;this._bindAttribute(p)}}catch(_){d.e(_)}finally{d.f()}}if(Object(f.k)(r.attributeMapping)){var y,g=Object(a.a)(r.attributeMapping);try{for(g.s();!(y=g.n()).done;){var m=y.value;this._bindAttribute(m)}}catch(_){g.e(_)}finally{g.f()}}}}}},{key:"onTileData",value:function(e,t){if(!Object(f.j)(t.addOrUpdate))for(var r=t.addOrUpdate.getCursor();r.next();){var n=r.getDisplayId();this.setAttributeData(n,r)}}},{key:"invalidateResources",value:function(){this._createResourcesPromise=null,this._abortController.abort(),this._abortController=new AbortController}},{key:"setHighlight",value:function(){var e=Object(n.a)(o.a.mark((function e(t,r){var n,i,s,u,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:1,n=this._getBlock(0),i=r.map((function(e){return Object(b.f)(e)})),n.lock(),n.unsetComponentAllTexels(0,1),n.setComponent(0,1,i),n.unlock(),this._idsToHighlight.clear(),s=Object(a.a)(t);try{for(s.s();!(u=s.n()).done;)c=u.value,this._idsToHighlight.add(c)}catch(o){s.e(o)}finally{s.f()}return e.next=6,this.sendUpdates();case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"updateFilters",value:function(){var e=Object(n.a)(o.a.mark((function e(t,r,n){var a,i,s,u,c=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=n.service,i=n.spatialReference,s=r.filters,u=s.map((function(e,t){return c._updateFilter(e,t,a,i)})),e.next=3,Promise.all(u);case 3:if(e.t0=e.sent.some((function(e){return e})),!e.t0){e.next=6;break}t.storage.filters=!0,Object(l.a)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:","Filters changed");case 6:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"setData",value:function(e,t,r,n){var a=Object(b.f)(e);this._ensureSizeForTexel(a),this._getBlock(t).setData(e,r,n)}},{key:"getData",value:function(e,t,r){return this._getBlock(t).getData(e,r)}},{key:"getHighlightFlag",value:function(e){return this._idsToHighlight.has(e)?g.v:0}},{key:"unsetAttributeData",value:function(e){var t=Object(b.f)(e);this._getBlock(0).setData(t,0,0)}},{key:"setAttributeData",value:function(e,t){var r=this,n=Object(b.f)(e);if(this._ensureSizeForTexel(n),this._getBlock(0).setData(n,0,this.getFilterFlags(t)),this._targetType===Object(b.g)(e)){var a=this._attributeComputeMap,i=this.config.supportsTextureFloat?1:2;a.size&&a.forEach((function(e,a){var s=a*i%4,u=Math.floor(a*i/4),o=r._getBlock(u+g.e),c=e(t);if(r.config.supportsTextureFloat)o.setData(n,s,c);else if(c===g.A)o.setData(n,s,255),o.setData(n,s+1,255);else{var l=Object(d.d)(Math.round(c),-32767,32766)+32768,h=255&l,f=(65280&l)>>8;o.setData(n,s,h),o.setData(n,s+1,f)}}))}}},{key:"sendUpdates",value:function(){var e=this;if(Object(l.a)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate"),this._notifyChange(),this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=Object(p.d)(),this._nextUpdate.promise;var t={blocks:this._blocks.map((function(e){return Object(f.k)(e)?e.toMessage():null}))};return this._currUpdate=this._createResources().then((function(){var r=function(){if(e._currUpdate=null,e._nextUpdate){var t=e._nextUpdate;e._nextUpdate=null,e.sendUpdates().then((function(){return t.resolve()}))}else Object(l.a)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::No additional updates queued");e._notifyChange()};Object(l.a)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::client.update");var n=e._client.update(t,e._signal).then(r).catch(r);return e._client.render(e._signal),n})).catch((function(t){if(Object(p.j)(t))return e._createResourcesPromise=null,e._createResources();e._notifyChange(),j.error(new c.a("mapview-attribute-store","Encountered an error during client update",t))})),this._currUpdate}},{key:"_ensureSizeForTexel",value:function(e){for(;e>=this._size*this._size;)if(this._expand())return}},{key:"_bindAttribute",value:function(e){var t;if(null!=e.fieldIndex)e.normalizationField&&j.warn("mapview-arcade","Ignoring normalizationField specified with an arcade expression which is not supported."),t=function(t){return t.getComputedNumericAtIndex(e.fieldIndex)};else{if(!e.field)return;t=e.normalizationField?function(t){var r=t.readAttribute(e.normalizationField);return r?t.readAttribute(e.field)/r:null}:function(t){return t.readAttribute(e.field)}}e.valueRepresentation&&(t=w(t,(function(t){return Object(k.b)(t,e.valueRepresentation)})));this._attributeComputeMap.set(e.binding,w(t,(function(e){return null===e||isNaN(e)||e===1/0?g.A:e})))}},{key:"_createResources",value:function(){var e=this;if(Object(f.k)(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(g.a),this._getBlock(g.d),O("Initializing AttributeStore");var t={shared:I.sharedArrayBuffer&&!("local"===this._client.type),size:this._size,blocks:Object(f.l)(this._blocks,(function(e){return{textureOnly:e.textureOnly,buffer:e.buffer,pixelType:e.pixelType}}))},r=this._client.initialize(t,this._signal).catch((function(t){Object(p.j)(t)?e._createResourcesPromise=null:j.error(new c.a("mapview-attribute-store","Encountered an error during client initialization",t))}));return this._createResourcesPromise=r,r.then((function(){return Object(f.j)(e._createResourcesPromise)?e._createResources():void 0})),r}},{key:"_getBlock",value:function(e){var t=this._blocks[e];if(Object(f.k)(t))return t;O("Initializing AttributeBlock at index ".concat(e));var r=I.sharedArrayBuffer,n=this._client.type,a=new S(r,n,this._size,this._blockDescriptors[e]);return this._blocks[e]=a,this._createResourcesPromise=null,a}},{key:"_expand",value:function(){if(this._size<this.config.maxTextureSize){var e=this._size<<=1;return O("Expanding block size to",e,this._blocks),Object(f.h)(this._blocks,(function(t){return t.expand(e)})),this._createResourcesPromise=null,this._size=e,0}return j.error(new c.a("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}},{key:"_updateFilter",value:function(){var e=Object(n.a)(o.a.mark((function e(t,r,n,a){var i,s,u,c,l;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this._filters[r],s=Object(f.k)(i)&&i.hash,i||t){e.next=3;break}return e.abrupt("return",!1);case 3:if(s!==JSON.stringify(t)){e.next=5;break}return e.abrupt("return",!1);case 5:if(!Object(f.j)(t)){e.next=10;break}if(i){e.next=8;break}return e.abrupt("return",!1);case 8:return u=1<<r+1,c=this._getBlock(0),e.abrupt("return",(this._filters[r]=null,c.setComponentAllTexels(0,u),this.sendUpdates(),!0));case 10:return e.next=12,this._getFilter(r,n);case 12:return l=e.sent,e.next=15,l.update(t,a);case 15:return e.abrupt("return",!0);case 16:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"_getFilter",value:function(){var e=Object(n.a)(o.a.mark((function e(t,n){var a,i,s,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=this._filters[t],!Object(f.k)(a)){e.next=3;break}return e.abrupt("return",a);case 3:return e.next=5,r.e(78).then(r.bind(null,508));case 5:return i=e.sent,s=i.default,u=new s({geometryType:n.geometryType,hasM:!1,hasZ:!1,timeInfo:n.timeInfo,fieldsIndex:new y.a(n.fields)}),e.abrupt("return",(this._filters[t]=u,u));case 9:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"isVisible",value:function(e){return!!(2&this._getBlock(0).getData(e,0))}},{key:"getFilterFlags",value:function(e){for(var t=0,r=Object(b.e)(e.getDisplayId()),n=0;n<this._filters.length;n++){var a=!!(r&1<<n),i=this._filters[n];t|=(!a||Object(f.j)(i)||i.check(e)?1:0)<<n}var s=0;if(this._idsToHighlight.size){var u=e.getObjectId();s=this.getHighlightFlag(u)}return t<<1|s}}]),e}()},399:function(e,t,r){"use strict";r.d(t,"a",(function(){return l}));var n=r(60),a=r(142),i=r(143),s=r(212),u=function(){function e(){Object(a.a)(this,e),this._freeIds=[],this._idCounter=1}return Object(i.a)(e,[{key:"createId",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return Object(s.d)(this._getFreeId(),e)}},{key:"releaseId",value:function(e){this._freeIds.push(e)}},{key:"_getFreeId",value:function(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}]),e}(),o=r(310);function c(e,t,r){if(!(e.length>t))for(;e.length<=t;)e.push(r)}var l=function(){function e(){Object(a.a)(this,e),this._numerics=[],this._strings=[],this._idGenerator=new u,this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[]}return Object(i.a)(e,[{key:"createBitset",value:function(){var e=this._bitsets.length;return this._bitsets.push(o.a.create(this._allocatedSize,s.a)),e+1}},{key:"getBitset",value:function(e){return this._bitsets[e-1]}},{key:"_expand",value:function(){this._allocatedSize<<=1;var e,t=Object(n.a)(this._bitsets);try{for(t.s();!(e=t.n()).done;){e.value.resize(this._allocatedSize)}}catch(r){t.e(r)}finally{t.f()}}},{key:"_ensureNumeric",value:function(e,t){this._numerics[e]||(this._numerics[e]=[]),c(this._numerics[e],t,0)}},{key:"_ensureInstanceId",value:function(e){c(this._instanceIds,e,0)}},{key:"_ensureString",value:function(e,t){this._strings[e]||(this._strings[e]=[]),c(this._strings[e],t,null)}},{key:"createDisplayId",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this._idGenerator.createId();return t>this._allocatedSize&&this._expand(),Object(s.d)(t,e)}},{key:"releaseDisplayId",value:function(e){var t,r=Object(n.a)(this._bitsets);try{for(r.s();!(t=r.n()).done;){t.value.unset(e)}}catch(a){r.e(a)}finally{r.f()}return this._idGenerator.releaseId(e&s.a)}},{key:"getComputedNumeric",value:function(e,t){return this.getComputedNumericAtIndex(e&s.a,0)}},{key:"setComputedNumeric",value:function(e,t,r){return this.setComputedNumericAtIndex(e&s.a,r,0)}},{key:"getComputedString",value:function(e,t){return this.getComputedStringAtIndex(e&s.a,0)}},{key:"setComputedString",value:function(e,t,r){return this.setComputedStringAtIndex(e&s.a,0,r)}},{key:"getComputedNumericAtIndex",value:function(e,t){var r=e&s.a;return this._ensureNumeric(t,r),this._numerics[t][r]}},{key:"setComputedNumericAtIndex",value:function(e,t,r){var n=e&s.a;this._ensureNumeric(t,n),this._numerics[t][n]=r}},{key:"getInstanceId",value:function(e){var t=e&s.a;return this._ensureInstanceId(t),this._instanceIds[t]}},{key:"setInstanceId",value:function(e,t){var r=e&s.a;this._ensureInstanceId(r),this._instanceIds[r]=t}},{key:"getComputedStringAtIndex",value:function(e,t){var r=e&s.a;return this._ensureString(t,r),this._strings[t][r]}},{key:"setComputedStringAtIndex",value:function(e,t,r){var n=e&s.a;this._ensureString(t,n),this._strings[t][n]=r}},{key:"getXMin",value:function(e){return this._bounds[4*(e&s.a)]}},{key:"getYMin",value:function(e){return this._bounds[4*(e&s.a)+1]}},{key:"getXMax",value:function(e){return this._bounds[4*(e&s.a)+2]}},{key:"getYMax",value:function(e){return this._bounds[4*(e&s.a)+3]}},{key:"setBounds",value:function(e,t){var r=t.readHydratedGeometry();if(!r||!r.coords.length)return!1;var n=1/0,a=1/0,i=-1/0,u=-1/0;r.forEachVertex((function(e,t){n=Math.min(n,e),a=Math.min(a,t),i=Math.max(i,e),u=Math.max(u,t)}));var o=e&s.a;return c(this._bounds,4*o+4,0),this._bounds[4*o]=n,this._bounds[4*o+1]=a,this._bounds[4*o+2]=i,this._bounds[4*o+3]=u,!0}}]),e}()},484:function(e,t,r){"use strict";r.d(t,"a",(function(){return g})),r.d(t,"b",(function(){return R})),r.d(t,"c",(function(){return j})),r.d(t,"d",(function(){return O})),r.d(t,"e",(function(){return w})),r.d(t,"f",(function(){return x}));var n=r(155),a=r(154),i=r.n(a),s=r(200),u=r(146),o=r(250),c=r(542),l=r(168),h=r(285),d=r(182),f=(r(344),r(188)),p=r(216),v=r(278),y=new s.a({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"}),g=Object.freeze({}),b=new p.a,m=new p.a,_=new p.a,k={esriGeometryPoint:f.m,esriGeometryPolyline:f.o,esriGeometryPolygon:f.n,esriGeometryMultipoint:f.l};function x(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.hasZ,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:e.hasM;if(Object(u.j)(t))return null;var i=e.hasZ&&n,s=e.hasM&&a;if(r){var o=Object(f.u)(_,t,e.hasZ,e.hasM,"esriGeometryPoint",r,n,a);return Object(f.m)(o,i,s)}return Object(f.m)(t,i,s)}function j(e,t,r,n,a,i){var s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:t,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:r,c=t&&s,l=r&&o,h=Object(u.k)(n)?"coords"in n?n:n.geometry:null;if(Object(u.j)(h))return null;if(a){var d=Object(f.q)(m,h,t,r,e,a,s,o);return i&&(d=Object(f.u)(_,d,c,l,e,i)),k[e](d,c,l)}if(i){var p=Object(f.u)(_,h,t,r,e,i,s,o);return k[e](p,c,l)}return Object(f.x)(b,h,t,r,s,o),k[e](b,c,l)}function O(e,t,r){return I.apply(this,arguments)}function I(){return(I=Object(n.a)(i.a.mark((function e(t,r,n){var a,s,u,o,c,l,h,d;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t.outFields,s=t.orderByFields,u=t.groupByFieldsForStatistics,o=t.outStatistics,a)for(c=0;c<a.length;c++)a[c]=a[c].trim();if(s)for(l=0;l<s.length;l++)s[l]=s[l].trim();if(u)for(h=0;h<u.length;h++)u[h]=u[h].trim();if(o)for(d=0;d<o.length;d++)o[d].onStatisticField&&(o[d].onStatisticField=o[d].onStatisticField.trim());return e.abrupt("return",(t.geometry&&!t.outSR&&(t.outSR=t.geometry.spatialReference),w(t,r,n)));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function w(e,t,r){return S.apply(this,arguments)}function S(){return(S=Object(n.a)(i.a.mark((function e(t,r,n){var a,s,o,d,f,p;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return",null);case 2:if(a=t.where,t.where=a=a&&a.trim(),(!a||/^1 *= *1$/.test(a)||r&&r===a)&&(t.where=null),t.geometry){e.next=5;break}return e.abrupt("return",t);case 5:return e.next=7,F(t);case 7:return s=e.sent,t.distance=0,t.units=null,"esriSpatialRelEnvelopeIntersects"===t.spatialRel&&(o=t.geometry.spatialReference,(s=Object(c.a)(s)).spatialReference=o),t.geometry=s,e.next=12,Object(v.a)(s.spatialReference,n);case 12:return e.next=14,Object(h.a)(Object(l.a)(s));case 14:if(d=e.sent[0],!Object(u.j)(d)){e.next=17;break}throw g;case 17:return f=d.toJSON(),e.next=20,Object(v.b)(f,f.spatialReference,n);case 20:if(p=e.sent){e.next=23;break}throw g;case 23:return e.abrupt("return",(p.spatialReference=n,t.geometry=p,t));case 24:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function F(e){return T.apply(this,arguments)}function T(){return(T=Object(n.a)(i.a.mark((function e(t){var r,n,a,s,u,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.geometry,n=t.distance,a=t.units,null!=n&&!("vertexAttributes"in r)){e.next=3;break}return e.abrupt("return",r);case 3:if(s=r.spatialReference,u=a?y.fromJSON(a):Object(o.e)(s),!s||!Object(d.h)(s)&&!Object(d.p)(s)){e.next=9;break}e.t0=r,e.next=12;break;case 9:return e.next=11,Object(v.a)(s,d.b).then((function(){return Object(v.b)(r,d.b)}));case 11:e.t0=e.sent;case 12:return c=e.t0,e.next=15,A();case 15:return e.t1=e.sent,e.abrupt("return",(0,e.t1)(c.spatialReference,c,n,u));case 17:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function A(){return C.apply(this,arguments)}function C(){return(C=Object(n.a)(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([r.e(6),r.e(16)]).then(r.bind(null,525));case 2:return e.abrupt("return",e.sent.geodesicBuffer);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function R(e){return e&&M in e?JSON.parse(JSON.stringify(e,E)):e}var M="_geVersion",E=function(e,t){return e!==M?t:void 0}},485:function(e,t,r){"use strict";r.d(t,"a",(function(){return C})),r.d(t,"b",(function(){return v})),r.d(t,"c",(function(){return A})),r.d(t,"d",(function(){return T}));var n=r(14),a=r(60),i=r(154),s=r.n(i),u=r(159),o=r(350),c=r(216),l=r(238),h=s.a.mark(y),d=s.a.mark(g),f=s.a.mark(b),p={LineString:"esriGeometryPolyline",MultiLineString:"esriGeometryPolyline",MultiPoint:"esriGeometryMultipoint",Point:"esriGeometryPoint",Polygon:"esriGeometryPolygon",MultiPolygon:"esriGeometryPolygon"};function v(e){return p[e]}function y(e){var t,r,n;return s.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:i.t0=e.type,i.next="Feature"===i.t0?3:"FeatureCollection"===i.t0?6:25;break;case 3:return i.next=5,e;case 5:return i.abrupt("break",25);case 6:t=Object(a.a)(e.features),i.prev=7,t.s();case 9:if((r=t.n()).done){i.next=17;break}if(n=r.value,i.t1=n,!i.t1){i.next=15;break}return i.next=15,n;case 15:i.next=9;break;case 17:i.next=22;break;case 19:i.prev=19,i.t2=i.catch(7),t.e(i.t2);case 22:return i.prev=22,t.f(),i.finish(22);case 25:case"end":return i.stop()}}),h,null,[[7,19,22,25]])}function g(e){var t,r,n,i,u,o,c,l,h;return s.a.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:if(e){s.next=2;break}return s.abrupt("return",null);case 2:s.t0=e.type,s.next="Point"===s.t0?5:"LineString"===s.t0||"MultiPoint"===s.t0?8:"MultiLineString"===s.t0||"Polygon"===s.t0?10:"MultiPolygon"===s.t0?27:58;break;case 5:return s.next=7,e.coordinates;case 7:return s.abrupt("break",58);case 8:return s.delegateYield(e.coordinates,"t1",9);case 9:return s.abrupt("break",58);case 10:t=Object(a.a)(e.coordinates),s.prev=11,t.s();case 13:if((r=t.n()).done){s.next=18;break}return n=r.value,s.delegateYield(n,"t2",16);case 16:s.next=13;break;case 18:s.next=23;break;case 20:s.prev=20,s.t3=s.catch(11),t.e(s.t3);case 23:return s.prev=23,t.f(),s.finish(23);case 26:return s.abrupt("break",58);case 27:i=Object(a.a)(e.coordinates),s.prev=28,i.s();case 30:if((u=i.n()).done){s.next=50;break}o=u.value,c=Object(a.a)(o),s.prev=33,c.s();case 35:if((l=c.n()).done){s.next=40;break}return h=l.value,s.delegateYield(h,"t4",38);case 38:s.next=35;break;case 40:s.next=45;break;case 42:s.prev=42,s.t5=s.catch(33),c.e(s.t5);case 45:return s.prev=45,c.f(),s.finish(45);case 48:s.next=30;break;case 50:s.next=55;break;case 52:s.prev=52,s.t6=s.catch(28),i.e(s.t6);case 55:return s.prev=55,i.f(),s.finish(55);case 58:case"end":return s.stop()}}),d,null,[[11,20,23,26],[28,52,55,58],[33,42,45,48]])}function b(e){var t,r,n,i,u,l,h,d,p,y,g,b,m,_=arguments;return s.a.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:t=_.length>1&&void 0!==_[1]?_[1]:{},r=t.geometryType,n=t.objectIdField,i=Object(a.a)(e),s.prev=3,i.s();case 5:if((u=i.n()).done){s.next=18;break}if(h=u.value,d=h.geometry,p=h.properties,y=h.id,!d||v(d.type)===r){s.next=10;break}return s.abrupt("continue",16);case 10:return b=null!==(l=(g=p||{})[n])&&void 0!==l?l:null,n&&null!=y&&!g[n]&&(g[n]=b=y),m=new o.a(d?x(new c.a,d,t):null,g,null,b),s.next=16,m;case 16:s.next=5;break;case 18:s.next=23;break;case 20:s.prev=20,s.t0=s.catch(3),i.e(s.t0);case 23:return s.prev=23,i.f(),s.finish(23);case 26:case"end":return s.stop()}}),f,null,[[3,20,23,26]])}function m(e){var t,r=Object(a.a)(e);try{for(r.s();!(t=r.n()).done;){if(t.value.length>2)return!0}}catch(n){r.e(n)}finally{r.f()}return!1}function _(e){for(var t=0,r=0;r<e.length;r++){var n=e[r],a=e[(r+1)%e.length];t+=n[0]*a[1]-a[0]*n[1]}return t<=0}function k(e){var t=e[0],r=e[e.length-1];return t[0]===r[0]&&t[1]===r[1]&&t[2]===r[2]||e.push(t),e}function x(e,t,r){switch(t.type){case"LineString":case"MultiPoint":return function(e,t,r){return I(e,t.coordinates,r),e}(e,t,r);case"MultiLineString":return function(e,t,r){var n,i=Object(a.a)(t.coordinates);try{for(i.s();!(n=i.n()).done;){I(e,n.value,r)}}catch(s){i.e(s)}finally{i.f()}return e}(e,t,r);case"MultiPolygon":return function(e,t,r){var n,i=Object(a.a)(t.coordinates);try{for(i.s();!(n=i.n()).done;){var s=n.value;j(e,s[0],r);for(var u=1;u<s.length;u++)O(e,s[u],r)}}catch(o){i.e(o)}finally{i.f()}return e}(e,t,r);case"Point":return function(e,t,r){return S(e,t.coordinates,r),e}(e,t,r);case"Polygon":return function(e,t,r){var n=t.coordinates;j(e,n[0],r);for(var a=1;a<n.length;a++)O(e,n[a],r);return e}(e,t,r)}}function j(e,t,r){var n=k(t);!function(e){return!_(e)}(n)?I(e,n,r):w(e,n,r)}function O(e,t,r){var n=k(t);!function(e){return _(e)}(n)?I(e,n,r):w(e,n,r)}function I(e,t,r){var n,i=Object(a.a)(t);try{for(i.s();!(n=i.n()).done;){S(e,n.value,r)}}catch(s){i.e(s)}finally{i.f()}e.lengths.push(t.length)}function w(e,t,r){for(var n=t.length-1;n>=0;n--)S(e,t[n],r);e.lengths.push(t.length)}function S(e,t,r){var a=Object(n.a)(t,3),i=a[0],s=a[1],u=a[2];e.coords.push(i,s),r.hasZ&&e.coords.push(u||0)}function F(e){switch(typeof e){case"string":return"esriFieldTypeString";case"number":return"esriFieldTypeDouble";default:return"unknown"}}function T(e){if(!e)throw new u.a("geojson-layer:empty","GeoJSON data is empty");if("Feature"!==e.type&&"FeatureCollection"!==e.type)throw new u.a("geojson-layer:unsupported-geojson-object","missing or not supported GeoJSON object type",{data:e});var t=e.crs;if(t){var r="string"==typeof t?t:"name"===t.type?t.properties.name:"EPSG"===t.type?t.properties.code:null,n=new RegExp(".*(CRS84H?|4326)$","i");if(!r||!n.test(r))throw new u.a("geojson-layer:unsupported-crs","unsupported GeoJSON 'crs' member",{crs:t})}}function A(e){var t,r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=[],s=new Set,u=new Set,o=!1,c=null,h=!1,d=n.geometryType,f=void 0===d?null:d,p=!1,b=Object(a.a)(y(e));try{var _=function(){var e=r.value,n=e.geometry,a=e.properties,l=e.id;if((!n||(f||(f=v(n.type)),v(n.type)===f))&&(o||(o=m(g(n))),h||(h=null!=l)&&(t=typeof l,c=Object.keys(a).filter((function(e){return a[e]===l}))),h&&null!=l&&(c.length>1?c=c.filter((function(e){return a[e]===l})):1===c.length&&(c=a[c[0]]===l?c:[])),!p&&a)){var d=!0;for(var y in a)if(!s.has(y)){var b=a[y];if(null!=b){var _=F(b);"unknown"!==_?(u.delete(y),s.add(y),i.push({name:y,alias:y,type:_})):u.add(y)}else d=!1,u.add(y)}p=d}};for(b.s();!(r=b.n()).done;)_()}catch(I){b.e(I)}finally{b.f()}var k=c&&1===c.length&&c[0]||null;if(k){var x,j=Object(a.a)(i);try{for(j.s();!(x=j.n()).done;){var O=x.value;if(O.name===k&&Object(l.p)(O)){O.type="esriFieldTypeOID";break}}}catch(I){j.e(I)}finally{j.f()}}return{fields:i,geometryType:f,hasZ:o,objectIdFieldName:k,objectIdFieldType:t,unknownFields:Array.from(u)}}function C(e,t){return Array.from(b(y(e),t))}},486:function(e,t,r){"use strict";r.d(t,"a",(function(){return u}));var n=r(60),a=r(142),i=r(143),s=r(146),u=function(){function e(t){Object(a.a)(this,e),this.size=0,this._start=0,this.maxSize=t,this._buffer=new Array(t)}return Object(i.a)(e,[{key:"entries",get:function(){return this._buffer}},{key:"enqueue",value:function(e){if(this.size===this.maxSize){var t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return this._buffer[(this._start+this.size++)%this.maxSize]=e,null}},{key:"dequeue",value:function(){if(0===this.size)return null;var e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}},{key:"peek",value:function(){return 0===this.size?null:this._buffer[this._start]}},{key:"find",value:function(e){if(0===this.size)return null;var t,r=Object(n.a)(this._buffer);try{for(r.s();!(t=r.n()).done;){var a=t.value;if(Object(s.k)(a)&&e(a))return a}}catch(i){r.e(i)}finally{r.f()}return null}},{key:"clear",value:function(e){for(var t=this.dequeue();Object(s.k)(t);)e&&e(t),t=this.dequeue()}}]),e}()},499:function(e,t,r){"use strict";r.d(t,"a",(function(){return s}));var n=r(425),a=r(510),i=r(144);function s(){s=function(e,t){return new r(e,void 0,t)};var e=RegExp.prototype,t=new WeakMap;function r(e,n,i){var s=new RegExp(e,n);return t.set(s,i||t.get(e)),Object(a.a)(s,r.prototype)}function u(e,r){var n=t.get(r);return Object.keys(n).reduce((function(t,r){return t[r]=e[n[r]],t}),Object.create(null))}return Object(i.a)(r,RegExp),r.prototype.exec=function(t){var r=e.exec.call(this,t);return r&&(r.groups=u(r,this)),r},r.prototype[Symbol.replace]=function(r,a){if("string"==typeof a){var i=t.get(this);return e[Symbol.replace].call(this,r,a.replace(/\$<([^>]+)>/g,(function(e,t){return"$"+i[t]})))}if("function"==typeof a){var s=this;return e[Symbol.replace].call(this,r,(function(){var e=arguments;return"object"!=Object(n.a)(e[e.length-1])&&(e=[].slice.call(e)).push(u(e,s)),a.apply(this,e)}))}return e[Symbol.replace].call(this,r,a)},s.apply(this,arguments)}},549:function(e,t,r){"use strict";r.d(t,"a",(function(){return z}));var n=r(5),a=r(60),i=r(155),s=r(143),u=r(142),o=r(154),c=r.n(o),l=r(152),h=r(159),d=r(161),f=r(146),p=r(712),v=r(250),y=r(419),g=r(180),b=r(205),m=r(168),_=r(285),k=r(182),x=r(188),j=r(673),O=r(278),I=r(387),w=r(772),S=r(662),F=r(634),T=r(484),A=r(329),C=r(260),R=r(907);var M="feature-store:unsupported-query",E=new p.b(2e6),q=0,z=function(){function e(t){var r=this;Object(u.a)(this,e),this.capabilities={query:I.a},this.geometryType=t.geometryType,this.hasM=t.hasM,this.hasZ=t.hasZ,this.objectIdField=t.objectIdField,this.spatialReference=t.spatialReference,this.definitionExpression=t.definitionExpression,this.featureStore=t.featureStore,this.aggregateAdapter=t.aggregateAdapter,this._changeHandle=this.featureStore.events.on("changed",(function(){return r.clearCache()})),this.timeInfo=t.timeInfo,t.cacheSpatialQueries&&(this._geometryQueryCache=new p.a(q+++"$$",E)),this.fieldsIndex=new A.a(t.fields),t.scheduler&&t.priority&&(this._frameTask=t.scheduler.registerTask(t.priority))}return Object(s.a)(e,[{key:"destroy",value:function(){this._frameTask=Object(f.p)(this._frameTask),this.clearCache(),Object(f.d)(this._geometryQueryCache),this._changeHandle=Object(f.p)(this._changeHandle),Object(f.d)(this.fieldsIndex)}},{key:"featureAdapter",get:function(){return this.featureStore.featureAdapter}},{key:"fullExtent",get:function(){var e=this.featureStore.fullBounds;return Object(f.j)(e)?null:{xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:Object(T.b)(this.spatialReference)}}},{key:"timeExtent",get:function(){return this.timeInfo?(this._timeExtent||(this._timeExtent=Object(F.a)(this.timeInfo,this.featureStore)),this._timeExtent):null}},{key:"clearCache",value:function(){var e;null!==(e=this._geometryQueryCache)&&void 0!==e&&e.clear(),this._allItems=null,this._timeExtent=null}},{key:"executeQuery",value:function(){var e=Object(i.a)(c.a.mark((function e(t,r){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._executeQuery(t,{},r);case 3:return e.abrupt("return",e.sent.createQueryResponse());case 6:if(e.prev=6,e.t0=e.catch(0),e.t0===T.a){e.next=10;break}throw e.t0;case 10:return e.abrupt("return",new w.a([],t,this).createQueryResponse());case 11:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForCount",value:function(){var e=Object(i.a)(c.a.mark((function e(){var t,r,n=arguments;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.length>0&&void 0!==n[0]?n[0]:{},r=n.length>1?n[1]:void 0,e.prev=2,e.next=5,this._executeQuery(t,{returnGeometry:!1,returnCentroid:!1,outSR:null},r);case 5:return e.abrupt("return",e.sent.createQueryResponseForCount());case 8:if(e.prev=8,e.t0=e.catch(2),e.t0===T.a){e.next=12;break}throw e.t0;case 12:return e.abrupt("return",0);case 13:case"end":return e.stop()}}),e,this,[[2,8]])})));return function(){return e.apply(this,arguments)}}()},{key:"executeQueryForExtent",value:function(){var e=Object(i.a)(c.a.mark((function e(t,r){var n,a,i,s,u,o,l,h;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.outSR,e.prev=1,e.next=4,this._executeQuery(t,{returnGeometry:!0,returnCentroid:!1,outSR:null},r);case 4:if(a=e.sent,i=a.size){e.next=8;break}return e.abrupt("return",{count:0,extent:null});case 8:return Object(y.j)(D,y.a),this.featureStore.forEachBounds(a.items,(function(e){return Object(y.e)(D,e)}),N),s={xmin:D[0],ymin:D[1],xmax:D[3],ymax:D[4],spatialReference:Object(T.b)(this.spatialReference)},this.hasZ&&isFinite(D[2])&&isFinite(D[5])&&(s.zmin=D[2],s.zmax=D[5]),(u=Object(O.b)(s,a.spatialReference,n)).spatialReference=Object(T.b)(n||this.spatialReference),u.xmax-u.xmin==0&&(o=Object(v.c)(u.spatialReference),u.xmin-=o,u.xmax+=o),u.ymax-u.ymin==0&&(l=Object(v.c)(u.spatialReference),u.ymin-=l,u.ymax+=l),this.hasZ&&null!=u.zmin&&null!=u.zmax&&u.zmax-u.zmin==0&&(h=Object(v.c)(u.spatialReference),u.zmin-=h,u.zmax+=h),e.abrupt("return",{count:i,extent:u});case 18:if(e.prev=18,e.t0=e.catch(1),e.t0!==T.a){e.next=22;break}return e.abrupt("return",{count:0,extent:null});case 22:throw e.t0;case 23:case"end":return e.stop()}}),e,this,[[1,18]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForIds",value:function(){var e=Object(i.a)(c.a.mark((function e(t,r){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.executeQueryForIdSet(t,r).then((function(e){return Array.from(e)})));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForIdSet",value:function(){var e=Object(i.a)(c.a.mark((function e(t,r){var n,i,s;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._executeQuery(t,{returnGeometry:!0,returnCentroid:!1,outSR:null},r);case 3:return n=e.sent,i=n.items,s=new Set,e.next=8,this._reschedule((function(){var e,t=Object(a.a)(i);try{for(t.s();!(e=t.n()).done;){var r=e.value;s.add(n.featureAdapter.getObjectId(r))}}catch(u){t.e(u)}finally{t.f()}}),r);case 8:return e.abrupt("return",s);case 11:if(e.prev=11,e.t0=e.catch(0),e.t0!==T.a){e.next=15;break}return e.abrupt("return",new Set);case 15:throw e.t0;case 16:case"end":return e.stop()}}),e,this,[[0,11]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForSnapping",value:function(){var e=Object(i.a)(c.a.mark((function e(t,r){var a,i,s,u,o,l,h,d,p,v,y,g,b,x,j=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t.point,i=t.distance,t.types!==w.b.NONE){e.next=3;break}return e.abrupt("return",{candidates:[]});case 3:return e.next=5,this._reschedule((function(){return j._checkQuerySupport(t.query)}),r);case 5:if(s=e.sent,u=!Object(k.d)(a.spatialReference,this.spatialReference),e.t0=u,!e.t0){e.next=11;break}return e.next=11,Object(O.a)(a.spatialReference,this.spatialReference);case 11:if(o="number"==typeof i?i:i.x,l="number"==typeof i?i:i.y,h={xmin:a.x-o,xmax:a.x+o,ymin:a.y-l,ymax:a.y+l,spatialReference:a.spatialReference},d=u?Object(O.b)(h,this.spatialReference):h){e.next=14;break}return e.abrupt("return",{candidates:[]});case 14:return e.next=16,Object(_.a)(Object(m.a)(a),null,{signal:r});case 16:return p=e.sent[0],e.next=19,Object(_.a)(Object(m.a)(d),null,{signal:r});case 19:if(v=e.sent[0],!Object(f.j)(p)&&!Object(f.j)(v)){e.next=22;break}return e.abrupt("return",{candidates:[]});case 22:return y=new w.a(this._searchFeatures(this._getQueryBBoxes(v.toJSON())),s,this),e.next=25,this._reschedule((function(){return j._executeObjectIdsQuery(y)}),r);case 25:return e.next=27,this._reschedule((function(){return j._executeTimeQuery(y)}),r);case 27:return e.next=29,this._reschedule((function(){return j._executeAttributesQuery(y)}),r);case 29:return g=p.toJSON(),b=u?Object(O.b)(g,this.spatialReference):g,x=u?Math.max(d.xmax-d.xmin,d.ymax-d.ymin)/2:i,e.abrupt("return",y.createSnappingResponse(Object(n.a)(Object(n.a)({},t),{},{point:b,distance:x}),a.spatialReference));case 31:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForLatestObservations",value:function(){var e=Object(i.a)(c.a.mark((function e(t,r){var n,a=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.timeInfo&&this.timeInfo.trackIdField){e.next=2;break}throw new h.a(M,"Missing timeInfo or timeInfo.trackIdField",{query:t,timeInfo:this.timeInfo});case 2:return e.prev=2,e.next=5,this._executeQuery(t,{},r);case 5:return n=e.sent,e.next=8,this._reschedule((function(){return a._filterLatest(n)}),r);case 8:return e.abrupt("return",n.createQueryResponse());case 11:if(e.prev=11,e.t0=e.catch(2),e.t0===T.a){e.next=15;break}throw e.t0;case 15:return e.abrupt("return",new w.a([],t,this).createQueryResponse());case 16:case"end":return e.stop()}}),e,this,[[2,11]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForSummaryStatistics",value:function(){var e=Object(i.a)(c.a.mark((function e(){var t,r,n,a,i,s,u=arguments;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=u.length>0&&void 0!==u[0]?u[0]:{},r=u.length>1?u[1]:void 0,n=u.length>2?u[2]:void 0,a=r.field,i=r.normalizationField,s=r.valueExpression,e.next=6,this._getQueryEngineResultForStats(t,{field:a,normalizationField:i,valueExpression:s},n);case 6:return e.abrupt("return",e.sent.createSummaryStatisticsResponse(r));case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"executeQueryForUniqueValues",value:function(){var e=Object(i.a)(c.a.mark((function e(){var t,r,n,a,i,s=arguments;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=s.length>0&&void 0!==s[0]?s[0]:{},r=s.length>1?s[1]:void 0,n=s.length>2?s[2]:void 0,a=r.field,i=r.valueExpression,e.next=6,this._getQueryEngineResultForStats(t,{field:a,valueExpression:i},n);case 6:return e.abrupt("return",e.sent.createUniqueValuesResponse(r));case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"executeQueryForClassBreaks",value:function(){var e=Object(i.a)(c.a.mark((function e(){var t,r,n,a,i,s,u=arguments;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=u.length>0&&void 0!==u[0]?u[0]:{},r=u.length>1?u[1]:void 0,n=u.length>2?u[2]:void 0,a=r.field,i=r.normalizationField,s=r.valueExpression,e.next=6,this._getQueryEngineResultForStats(t,{field:a,normalizationField:i,valueExpression:s},n);case 6:return e.abrupt("return",e.sent.createClassBreaksResponse(r));case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"executeQueryForHistogram",value:function(){var e=Object(i.a)(c.a.mark((function e(){var t,r,n,a,i,s,u=arguments;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=u.length>0&&void 0!==u[0]?u[0]:{},r=u.length>1?u[1]:void 0,n=u.length>2?u[2]:void 0,a=r.field,i=r.normalizationField,s=r.valueExpression,e.next=6,this._getQueryEngineResultForStats(t,{field:a,normalizationField:i,valueExpression:s},n);case 6:return e.abrupt("return",e.sent.createHistogramResponse(r));case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_schedule",value:function(){var e=Object(i.a)(c.a.mark((function e(t,r){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(f.k)(this._frameTask)?this._frameTask.schedule(t,r):t(R.c));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_reschedule",value:function(){var e=Object(i.a)(c.a.mark((function e(t,r){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(f.k)(this._frameTask)?this._frameTask.reschedule(t,r):t(R.c));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_getAll",value:function(e){return Object(f.j)(this._allItems)&&(this._allItems=this.featureStore.toArray()),new w.a(this._allItems,e,this)}},{key:"_executeQuery",value:function(){var e=Object(i.a)(c.a.mark((function e(t,r,a){var i,s,u=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object(d.a)(t),e.next=3,this._schedule((function(){return Object(T.d)(t,u.definitionExpression,u.spatialReference)}),a);case 3:return t=e.sent,e.next=6,this._reschedule((function(){return u._checkQuerySupport(t)}),a);case 6:return t=e.sent,t=Object(n.a)(Object(n.a)({},t),r),e.next=10,this._reschedule((function(){return u._executeSceneFilterQuery(t,a)}),a);case 10:return i=e.sent,e.next=13,this._reschedule((function(){return u._executeGeometryQuery(t,i,a)}),a);case 13:return s=e.sent,e.next=16,this._reschedule((function(){return u._executeAggregateIdsQuery(s)}),a);case 16:return e.next=18,this._reschedule((function(){return u._executeObjectIdsQuery(s)}),a);case 18:return e.next=20,this._reschedule((function(){return u._executeTimeQuery(s)}),a);case 20:return e.next=22,this._reschedule((function(){return u._executeAttributesQuery(s)}),a);case 22:return e.abrupt("return",s);case 23:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_executeSceneFilterQuery",value:function(){var e=Object(i.a)(c.a.mark((function e(t,r){var n,s,u,o,l,h,d,p,v,y,g,b,m,_,x,j,I,F,T=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(f.j)(t.sceneFilter)){e.next=2;break}return e.abrupt("return",null);case 2:if(n=t.outSR,s=t.returnGeometry,u=t.returnCentroid,o=this.featureStore.featureSpatialReference,l=t.sceneFilter.geometry,h=Object(f.j)(o)||Object(k.d)(o,l.spatialReference)?l:Object(O.b)(l,o)){e.next=5;break}return e.abrupt("return",null);case 5:if(d=s||u,p=Object(k.l)(n)&&!Object(k.d)(this.spatialReference,n)&&d?function(){var e=Object(i.a)(c.a.mark((function e(t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",T._project(t,n));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}():function(e){return e},v=this.featureAdapter,y=this._searchFeatures(this._getQueryBBoxes(h)),"disjoint"!==t.sceneFilter.spatialRelationship){e.next=19;break}if(y.length){e.next=9;break}return e.abrupt("return",null);case 9:g=new Set,b=Object(a.a)(y);try{for(b.s();!(m=b.n()).done;)_=m.value,g.add(v.getObjectId(_))}catch(A){b.e(A)}finally{b.f()}return e.next=14,this._reschedule((function(){return T.featureStore.toArray()}),r);case 14:return x=e.sent,e.next=17,this._reschedule(Object(i.a)(c.a.mark((function e(){var n,a,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(S.c)("esriSpatialRelDisjoint",h,T.geometryType,T.hasZ,T.hasM);case 2:return n=e.sent,a=function(e){return!g.has(v.getObjectId(e))||n(v.getGeometry(e))},e.next=6,T._runSpatialFilter(x,a,r);case 6:return i=e.sent,e.abrupt("return",new w.a(i,t,T));case 8:case"end":return e.stop()}}),e)}))),r);case 17:return j=e.sent,e.abrupt("return",p(j));case 19:if(y.length){e.next=21;break}return e.abrupt("return",new w.a([],t,this));case 21:if(!this._canExecuteSinglePass(h,t)){e.next=23;break}return e.abrupt("return",p(new w.a(y,t,this)));case 23:return e.next=25,Object(S.c)("esriSpatialRelContains",h,this.geometryType,this.hasZ,this.hasM);case 25:return I=e.sent,e.next=28,this._runSpatialFilter(y,(function(e){return I(v.getGeometry(e))}),r);case 28:return F=e.sent,e.abrupt("return",p(new w.a(F,t,this)));case 30:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_executeGeometryQuery",value:function(){var e=Object(i.a)(c.a.mark((function e(t,r,n){var s,u,o,h,d,p,v,y,g,b,m,_,x,j,I,F,T,A,C,R,M,E,q,z,N,D=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(f.k)(r)||0!==r.items.length){e.next=2;break}return e.abrupt("return",r);case 2:if(t=Object(f.k)(r)?r.query:t,u=(s=t).geometry,o=s.outSR,h=s.spatialRel,d=s.returnGeometry,p=s.returnCentroid,v=this.featureStore.featureSpatialReference,y=!u||Object(f.j)(v)||Object(k.d)(v,u.spatialReference)?u:Object(O.b)(u,v),g=d||p,b=Object(k.l)(o)&&!Object(k.d)(this.spatialReference,o),m=this._geometryQueryCache&&Object(f.j)(r)?b&&g?JSON.stringify({originalFilterGeometry:u,spatialRelationship:h,outSpatialReference:o}):JSON.stringify({originalFilterGeometry:u,spatialRelationship:h}):null,_=m?this._geometryQueryCache.get(m):null,!Object(f.k)(_)){e.next=6;break}return e.abrupt("return",new w.a(_,t,this));case 6:if(x=function(){var e=Object(i.a)(c.a.mark((function e(t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=b&&g,!e.t0){e.next=4;break}return e.next=4,D._project(t,o);case 4:return m&&D._geometryQueryCache.put(m,t.items,t.items.length+1),e.abrupt("return",t);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),y){e.next=9;break}return e.abrupt("return",x(Object(f.k)(r)?r:this._getAll(t)));case 9:if(j=this.featureAdapter,I=this._searchFeatures(this._getQueryBBoxes(u)),"esriSpatialRelDisjoint"!==h){e.next=29;break}if(I.length){e.next=14;break}return e.abrupt("return",x(Object(f.k)(r)?r:this._getAll(t)));case 14:F=new Set,T=Object(a.a)(I);try{for(T.s();!(A=T.n()).done;)C=A.value,F.add(j.getObjectId(C))}catch(G){T.e(G)}finally{T.f()}if(!Object(f.k)(r)){e.next=21;break}e.t0=r.items,e.next=24;break;case 21:return e.next=23,this._reschedule((function(){return D.featureStore.toArray()}),n);case 23:e.t0=e.sent;case 24:return R=e.t0,e.next=27,this._reschedule(Object(i.a)(c.a.mark((function e(){var r,a,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(S.c)(h,y,D.geometryType,D.hasZ,D.hasM);case 2:return r=e.sent,a=function(e){return!F.has(j.getObjectId(e))||r(j.getGeometry(e))},e.next=6,D._runSpatialFilter(R,a,n);case 6:return i=e.sent,e.abrupt("return",new w.a(i,t,D));case 8:case"end":return e.stop()}}),e)}))),n);case 27:return M=e.sent,e.abrupt("return",x(M));case 29:if(Object(f.k)(r)&&(E=new l.a,I=I.filter((function(e){return Object(l.f)(r.items,e,r.items.length,E)>=0}))),I.length){e.next=33;break}return q=new w.a([],t,this),e.abrupt("return",(m&&this._geometryQueryCache.put(m,q.items,1),q));case 33:if(!this._canExecuteSinglePass(y,t)){e.next=35;break}return e.abrupt("return",x(new w.a(I,t,this)));case 35:return e.next=37,Object(S.c)(h,y,this.geometryType,this.hasZ,this.hasM);case 37:return z=e.sent,e.next=40,this._runSpatialFilter(I,(function(e){return z(j.getGeometry(e))}),n);case 40:return N=e.sent,e.abrupt("return",x(new w.a(N,t,this)));case 42:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_executeAggregateIdsQuery",value:function(e){if(0!==e.items.length&&e.query.aggregateIds&&e.query.aggregateIds.length&&!Object(f.j)(this.aggregateAdapter)){var t,r=new Set,n=Object(a.a)(e.query.aggregateIds);try{for(n.s();!(t=n.n()).done;){var i=t.value;this.aggregateAdapter.getFeatureObjectIds(i).forEach((function(e){return r.add(e)}))}}catch(u){n.e(u)}finally{n.f()}var s=this.featureAdapter.getObjectId;e.items=e.items.filter((function(e){return r.has(s(e))}))}}},{key:"_executeObjectIdsQuery",value:function(e){if(0!==e.items.length&&e.query.objectIds&&e.query.objectIds.length){var t=new Set(e.query.objectIds),r=this.featureAdapter.getObjectId;e.items=e.items.filter((function(e){return t.has(r(e))}))}}},{key:"_executeTimeQuery",value:function(e){if(0!==e.items.length){var t=Object(F.b)(this.timeInfo,e.query.timeExtent,this.featureAdapter);Object(f.j)(t)||(e.items=e.items.filter(t))}}},{key:"_executeAttributesQuery",value:function(e){var t=this;if(0!==e.items.length){var r=Object(j.c)(e.query.where,this.fieldsIndex);if(r){if(!r.isStandardized)throw new TypeError("Where clause is not standardized");e.items=e.items.filter((function(e){return r.testFeature(e,t.featureAdapter)}))}}}},{key:"_runSpatialFilter",value:function(){var e=Object(i.a)(c.a.mark((function e(t,r,n){var a,s,u,o=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}return e.abrupt("return",t);case 2:if(!Object(f.j)(this._frameTask)){e.next=4;break}return e.abrupt("return",t.filter((function(e){return r(e)})));case 4:return a=0,s=new Array,u=function(){var e=Object(i.a)(c.a.mark((function e(i){var l;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(a<t.length)){e.next=9;break}if(l=t[a++],r(l)&&(s.push(l),i.madeProgress()),e.t0=i.done,!e.t0){e.next=7;break}return e.next=7,o._reschedule((function(e){return u(e)}),n);case 7:e.next=0;break;case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),e.abrupt("return",this._reschedule((function(e){return u(e)}),n).then((function(){return s})));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_filterLatest",value:function(e){var t,r=this.timeInfo,n=r.trackIdField,i=r.startTimeField,s=r.endTimeField||i,u=new Map,o=this.featureAdapter.getAttribute,c=Object(a.a)(e.items);try{for(c.s();!(t=c.n()).done;){var l=t.value,h=o(l,n),d=o(l,s),f=u.get(h);(!f||d>o(f,s))&&u.set(h,l)}}catch(p){c.e(p)}finally{c.f()}e.items=Array.from(u.values())}},{key:"_canExecuteSinglePass",value:function(e,t){var r=t.spatialRel;return Object(S.a)(e)&&("esriSpatialRelEnvelopeIntersects"===r||"esriGeometryPoint"===this.geometryType&&("esriSpatialRelIntersects"===r||"esriSpatialRelContains"===r||"esriSpatialRelWithin"===r))}},{key:"_project",value:function(){var e=Object(i.a)(c.a.mark((function e(t,r){var n,a,i=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r&&!Object(k.d)(this.spatialReference,r)){e.next=2;break}return e.abrupt("return",t);case 2:return n=this.featureAdapter,e.next=5,Object(O.c)(t.items.map((function(e){return Object(T.c)(i.geometryType,i.hasZ,i.hasM,n.getGeometry(e))})),this.spatialReference,r);case 5:return a=e.sent,e.abrupt("return",(t.items=a.map((function(e,r){return n.cloneWithGeometry(t.items[r],Object(x.d)(e,i.hasZ,i.hasM))})),t));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_getQueryBBoxes",value:function(e){if(Object(S.a)(e)){if(Object(m.d)(e))return[Object(g.m)(e.xmin,e.ymin,e.xmax,e.ymax)];if(Object(m.g)(e))return e.rings.map((function(e){return Object(g.m)(Math.min(e[0][0],e[2][0]),Math.min(e[0][1],e[2][1]),Math.max(e[0][0],e[2][0]),Math.max(e[0][1],e[2][1]))}))}return[Object(b.a)(Object(g.g)(),e)]}},{key:"_searchFeatures",value:function(e){var t,r=Object(a.a)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;this.featureStore.forEachInBounds(n,(function(e){return G.add(e)}))}}catch(s){r.e(s)}finally{r.f()}var i=Array.from(G.values());return G.clear(),i}},{key:"_checkStatisticsSupport",value:function(){var e=Object(i.a)(c.a.mark((function e(t,r){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t.distance<0||null!=t.geometryPrecision||t.multipatchOption||t.pixelSize||t.relationParam||t.text||t.outStatistics||t.groupByFieldsForStatistics||t.having||t.orderByFields)){e.next=2;break}throw new h.a(M,"Unsupported query options",{query:t});case 2:return e.abrupt("return",(this._checkAttributesQuerySupport(t),Promise.all([this._checkStatisticsParamsSupport(r),Object(S.b)(t,this.geometryType,this.spatialReference),Object(O.a)(this.spatialReference,t.outSR)]).then((function(){return t}))));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_checkStatisticsParamsSupport",value:function(){var e=Object(i.a)(c.a.mark((function e(t){var r,n,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=[],!t.valueExpression){e.next=7;break}return e.next=4,Object(C.e)();case 4:n=e.sent,a=n.arcadeUtils,r=a.extractFieldNames(t.valueExpression);case 7:if(t.field&&r.push(t.field),t.normalizationField&&r.push(t.normalizationField),r.length){e.next=9;break}throw new h.a(M,"params should have at least a field or valueExpression",{params:t});case 9:Object(j.e)(this.fieldsIndex,r,"params contains missing fields");case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_checkQuerySupport",value:function(){var e=Object(i.a)(c.a.mark((function e(t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t.distance<0||null!=t.geometryPrecision||t.multipatchOption||t.pixelSize||t.relationParam||t.text)){e.next=2;break}throw new h.a(M,"Unsupported query options",{query:t});case 2:return e.abrupt("return",(this._checkAttributesQuerySupport(t),this._checkStatisticsQuerySupport(t),Promise.all([Object(S.b)(t,this.geometryType,this.spatialReference),Object(O.a)(this.spatialReference,t.outSR)]).then((function(){return t}))));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_checkAttributesQuerySupport",value:function(e){var t=e.outFields,r=e.orderByFields,n=e.returnDistinctValues,a=e.outStatistics,i=a?a.map((function(e){return e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase()})).filter(Boolean):[];if(r&&r.length>0){var s=" asc",u=" desc",o=r.map((function(e){var t=e.toLowerCase();return t.includes(s)?t.split(s)[0]:t.includes(u)?t.split(u)[0]:e})).filter((function(e){return!i.includes(e)}));Object(j.e)(this.fieldsIndex,o,"orderByFields contains missing fields")}if(t&&t.length>0)Object(j.e)(this.fieldsIndex,t,"outFields contains missing fields");else if(n)throw new h.a(M,"outFields should be specified for returnDistinctValues",{query:e});Object(j.g)(this.fieldsIndex,e.where)}},{key:"_checkStatisticsQuerySupport",value:function(e){var t=e.outStatistics,r=e.groupByFieldsForStatistics,n=e.having,i=r&&r.length,s=t&&t.length;if(n){if(!i||!s)throw new h.a(M,"outStatistics and groupByFieldsForStatistics should be specified with having",{query:e});Object(j.f)(this.fieldsIndex,n,t)}if(s){if(!function(e){return e.every((function(e){return"exceedslimit"!==e.statisticType}))}(t))return;var u=t.map((function(e){return e.onStatisticField})).filter(Boolean);Object(j.e)(this.fieldsIndex,u,"onStatisticFields contains missing fields"),i&&Object(j.e)(this.fieldsIndex,r,"groupByFieldsForStatistics contains missing fields");var o,c=Object(a.a)(t);try{for(c.s();!(o=c.n()).done;){var l=o.value,d=l.onStatisticField,f=l.statisticType;if("percentile_disc"!==f&&"percentile_cont"!==f||!("statisticParameters"in l)){if("count"!==f&&d&&Object(j.d)(d,this.fieldsIndex))throw new h.a(M,"outStatistics contains non-numeric fields",{definition:l,query:e})}else if(!l.statisticParameters)throw new h.a(M,"statisticParamters should be set for percentile type",{definition:l,query:e})}}catch(p){c.e(p)}finally{c.f()}}}},{key:"_getQueryEngineResultForStats",value:function(){var e=Object(i.a)(c.a.mark((function e(t,r,n){var a,i,s=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object(d.a)(t),e.prev=1,e.next=4,this._schedule((function(){return Object(T.d)(t,s.definitionExpression,s.spatialReference)}),n);case 4:return t=e.sent,e.next=7,this._reschedule((function(){return s._checkStatisticsSupport(t,r)}),n);case 7:return t=e.sent,e.next=10,this._reschedule((function(){return s._executeSceneFilterQuery(t,n)}),n);case 10:return a=e.sent,e.next=13,this._reschedule((function(){return s._executeGeometryQuery(t,a,n)}),n);case 13:return i=e.sent,e.next=16,this._reschedule((function(){return s._executeAggregateIdsQuery(i)}),n);case 16:return e.next=18,this._reschedule((function(){return s._executeObjectIdsQuery(i)}),n);case 18:return e.next=20,this._reschedule((function(){return s._executeTimeQuery(i)}),n);case 20:return e.next=22,this._reschedule((function(){return s._executeAttributesQuery(i)}),n);case 22:return e.abrupt("return",i);case 25:if(e.prev=25,e.t0=e.catch(1),e.t0===T.a){e.next=29;break}throw e.t0;case 29:return e.abrupt("return",new w.a([],t,this));case 30:case"end":return e.stop()}}),e,this,[[1,25]])})));return function(t,r,n){return e.apply(this,arguments)}}()}]),e}(),N=Object(y.b)(),D=Object(y.b)(),G=new Set},634:function(e,t,r){"use strict";function n(e,t){if(!e)return null;var r=t.featureAdapter,n=e.startTimeField,a=e.endTimeField,i=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY;if(n&&a)t.forEach((function(e){var t=r.getAttribute(e,n),u=r.getAttribute(e,a);null==t||isNaN(t)||(i=Math.min(i,t)),null==u||isNaN(u)||(s=Math.max(s,u))}));else{var u=n||a;t.forEach((function(e){var t=r.getAttribute(e,u);null==t||isNaN(t)||(i=Math.min(i,t),s=Math.max(s,t))}))}return{start:i,end:s}}function a(e,t,r){if(!t||!e)return null;var n=e.startTimeField,a=e.endTimeField;if(!n&&!a)return null;var i=t.start,s=t.end;return null===i&&null===s?null:void 0===i&&void 0===s?function(){return!1}:n&&a?function(e,t,r,n,a){return null!=n&&null!=a?function(i){var s=e.getAttribute(i,t),u=e.getAttribute(i,r);return(null==s||s<=a)&&(null==u||u>=n)}:null!=n?function(t){var a=e.getAttribute(t,r);return null==a||a>=n}:null!=a?function(r){var n=e.getAttribute(r,t);return null==n||n<=a}:void 0}(r,n,a,i,s):function(e,t,r,n){return null!=r&&null!=n&&r===n?function(n){return e.getAttribute(n,t)===r}:null!=r&&null!=n?function(a){var i=e.getAttribute(a,t);return i>=r&&i<=n}:null!=r?function(n){return e.getAttribute(n,t)>=r}:null!=n?function(r){return e.getAttribute(r,t)<=n}:void 0}(r,n||a,i,s)}r.d(t,"a",(function(){return n})),r.d(t,"b",(function(){return a}))},662:function(e,t,r){"use strict";r.d(t,"a",(function(){return A})),r.d(t,"b",(function(){return F})),r.d(t,"c",(function(){return S}));var n=r(60),a=r(155),i=r(154),s=r.n(i),u=r(159),o=r(491),c=r(268);var l=r(168),h=r(182);function d(e,t){return e?t?4:3:t?3:2}function f(e,t,r,a,i){if(!e)return!1;var s,u=d(t,r),o=e.coords,c=e.lengths,l=!1,h=0,f=Object(n.a)(c);try{for(f.s();!(s=f.n()).done;){var v=s.value;l=p(l,o,u,h,v,a,i),h+=v*u}}catch(y){f.e(y)}finally{f.f()}return l}function p(e,t,r,n,a,i,s){for(var u=e,o=n,c=n,l=n+a*r;c<l;c+=r){(o=c+r)===l&&(o=n);var h=t[c],d=t[c+1],f=t[o],p=t[o+1];(d<s&&p>=s||p<s&&d>=s)&&h+(s-d)/(p-d)*(f-h)<i&&(u=!u)}return u}var v=r(188),y=r(216),g=r(278),b=r(484),m="feature-store:unsupported-query",_={esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"intersects",esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:null},k={esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},x={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},j={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1};function O(e){return!0===k[e]}function I(e){return!0===x[Object(l.c)(e)]}function w(e){return!0===j[e]}function S(e,t,n,a,i){if(Object(l.g)(t)&&"esriGeometryPoint"===n&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e)){var s=Object(v.g)(new y.a,t,!1,!1);return Promise.resolve((function(e){return function(e,t,r,n){return f(e,t,r,n.coords[0],n.coords[1])}(s,!1,!1,e)}))}if(Object(l.g)(t)&&"esriGeometryMultipoint"===n){var u=Object(v.g)(new y.a,t,!1,!1);if("esriSpatialRelContains"===e)return Promise.resolve((function(e){return function(e,t,r,n,a,i){var s=d(a,i),u=n.coords,o=n.lengths;if(!o)return!1;for(var c=0,l=0;c<o.length;c++,l+=s)if(!f(e,t,r,u[l],u[l+1]))return!1;return!0}(u,!1,!1,e,a,i)}))}if(Object(l.d)(t)&&"esriGeometryPoint"===n&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e))return Promise.resolve((function(e){return Object(o.e)(t,Object(b.c)(n,a,i,e))}));if(Object(l.d)(t)&&"esriGeometryMultipoint"===n&&"esriSpatialRelContains"===e)return Promise.resolve((function(e){return Object(o.d)(t,Object(b.c)(n,a,i,e))}));if(Object(l.d)(t)&&"esriSpatialRelIntersects"===e){var h=function(e){return"mesh"===e?c.a:Object(c.b)(e)}(n);return Promise.resolve((function(e){return h(t,Object(b.c)(n,a,i,e))}))}return Promise.all([r.e(6),r.e(16)]).then(r.bind(null,525)).then((function(r){var s=r[_[e]].bind(null,t.spatialReference,t);return function(e){return s(Object(b.c)(n,a,i,e))}}))}function F(e,t,r){return T.apply(this,arguments)}function T(){return(T=Object(a.a)(s.a.mark((function e(t,r,n){var a,i;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t.spatialRel,!(i=t.geometry)){e.next=11;break}if(O(a)){e.next=4;break}throw new u.a(m,"Unsupported query spatial relationship",{query:t});case 4:if(!Object(h.l)(i.spatialReference)||!Object(h.l)(n)){e.next=11;break}if(I(i)){e.next=7;break}throw new u.a(m,"Unsupported query geometry type",{query:t});case 7:if(w(r)){e.next=9;break}throw new u.a(m,"Unsupported layer geometry type",{query:t});case 9:if(!t.outSR){e.next=11;break}return e.abrupt("return",Object(g.a)(t.geometry&&t.geometry.spatialReference,t.outSR));case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function A(e){if(Object(l.d)(e))return!0;if(Object(l.g)(e)){var t,r=Object(n.a)(e.rings);try{for(r.s();!(t=r.n()).done;){var a=t.value;if(5!==a.length)return!1;if(a[0][0]!==a[1][0]||a[0][0]!==a[4][0]||a[2][0]!==a[3][0]||a[0][1]!==a[3][1]||a[0][1]!==a[4][1]||a[1][1]!==a[2][1])return!1}}catch(i){r.e(i)}finally{r.f()}return!0}return!1}},673:function(e,t,r){"use strict";r.d(t,"a",(function(){return m})),r.d(t,"b",(function(){return b})),r.d(t,"c",(function(){return y})),r.d(t,"d",(function(){return _})),r.d(t,"e",(function(){return g})),r.d(t,"f",(function(){return v})),r.d(t,"g",(function(){return p}));var n=r(16),a=r(60),i=r(159),s=r(142),u=r(143),o=r(721),c=r(433),l=new(function(){function e(t,r){Object(s.a)(this,e),this._cache=new o.a(t),this._invalidCache=new o.a(r)}return Object(u.a)(e,[{key:"get",value:function(e,t){var r="".concat(t.uid,":").concat(e),n=this._cache.get(r);if(n)return n;if(void 0!==this._invalidCache.get(r))return null;try{var a=c.WhereClause.create(e,t);return this._cache.put(r,a),a}catch(i){return this._invalidCache.put(r,null),null}}}]),e}())(50,500),h="feature-store:unsupported-query",d=" as ",f=new Set(["esriFieldTypeOID","esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong","esriFieldTypeDate"]);function p(e,t){if(!t)return!0;var r=l.get(t,e);if(!r)throw new i.a(h,"invalid SQL expression",{where:t});if(!r.isStandardized)throw new i.a(h,"where clause is not standard",{where:t});return g(e,r.fieldNames,"where clause contains missing fields"),!0}function v(e,t,r){if(!t)return!0;var n=l.get(t,e);if(!n)throw new i.a(h,"invalid SQL expression",{having:t});if(!n.isAggregate)throw new i.a(h,"having does not contain a valid aggregate function",{having:t});var a=n.fieldNames;if(g(e,a,"having contains missing fields"),!n.getExpressions().every((function(t){var n=t.aggregateType,a=t.field,i=e.has(a)&&e.get(a).name;return r.some((function(t){var r=t.onStatisticField,a=t.statisticType;return(e.has(r)&&e.get(r).name)===i&&a.toLowerCase().trim()===n}))})))throw new i.a(h,"expressions in having should also exist in outStatistics",{having:t});return!0}function y(e,t){return e?l.get(e,t):null}function g(e,t,r){var s,u=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=[],c=Object(a.a)(t);try{for(c.s();!(s=c.n()).done;){var l=s.value;if("*"!==l&&!e.has(l))if(u){var d=b(l);try{var f=y(d,e);if(!f)throw new i.a(h,"invalid SQL expression",{where:d});if(!f.isStandardized)throw new i.a(h,"expression is not standard",{clause:f});g(e,f.fieldNames,"expression contains missing fields")}catch(v){var p=v&&v.details;if(p&&(p.clause||p.where))throw v;p&&p.missingFields?o.push.apply(o,Object(n.a)(p.missingFields)):o.push(l)}}else o.push(l)}}catch(m){c.e(m)}finally{c.f()}if(o.length)throw new i.a(h,r,{missingFields:o})}function b(e){return e.split(d)[0]}function m(e){return e.split(d)[1]}function _(e,t){var r=t.get(e);return!!r&&!f.has(r.type)}},674:function(e,t,r){"use strict";r.d(t,"a",(function(){return y}));var n=r(5),a=r(60),i=r(155),s=r(142),u=r(143),o=r(154),c=r.n(o),l=r(147),h=r(146),d=r(374),f=r(260),p=r(156);var v=r.e(188).then(r.bind(null,1333)),y=function(){function e(t,r){Object(s.a)(this,e),this._canCacheExpressionValue=!1,this._sourceInfo=t,this._storage=r,this._bitsets={computed:r.getBitset(r.createBitset())}}return Object(u.a)(e,[{key:"storage",get:function(){return this._storage}},{key:"invalidate",value:function(){this._bitsets.computed.clear()}},{key:"updateSchema",value:function(){var e=Object(i.a)(c.a.mark((function e(t,r){var n,a,i,s,u,o;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=Object(d.a)(this._schema,r),this._schema=r,r&&!Object(h.j)(n)&&Object(d.b)(n,"attributes")){e.next=3;break}return e.abrupt("return");case 3:Object(l.a)("esri-2d-update-debug")&&console.debug("Applying Update - Store:",n),this._bitsets.computed.clear(),t.targets[r.name]=!0,a=r.attributes,i=[],s=[],e.t0=c.a.keys(a);case 6:if((e.t1=e.t0()).done){e.next=20;break}u=e.t1.value,o=a[u],e.t2=o.type,e.next="field"===e.t2?12:"expression"===e.t2?13:"label-expression"===e.t2?15:"statistic"===e.t2?17:18;break;case 12:return e.abrupt("break",18);case 13:return i.push(this._createArcadeComputedField(o)),e.abrupt("break",18);case 15:return i.push(this._createLabelArcadeComputedField(o)),e.abrupt("break",18);case 17:s.push(o);case 18:e.next=6;break;case 20:return e.next=22,Promise.all(i);case 22:this._computedFields=e.sent,this._canCacheExpressionValue=!this._computedFields.some((function(e){return"expression"===e.type&&e.expression.referencesScale()})),this._statisticFields=s;case 25:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"setComputedAttributes",value:function(e,t,r,n){var i=this._bitsets.computed;if(!this._canCacheExpressionValue||!i.has(r)){i.set(r);var s,u=Object(a.a)(this._computedFields);try{for(u.s();!(s=u.n()).done;){var o=s.value,c=this._evaluateField(t,o,n);switch(o.resultType){case"numeric":e.setComputedNumericAtIndex(r,o.fieldIndex,c);break;case"string":e.setComputedStringAtIndex(r,o.fieldIndex,c)}}}catch(l){u.e(l)}finally{u.f()}}}},{key:"_createArcadeComputedField",value:function(){var e=Object(i.a)(c.a.mark((function e(t){var r,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._sourceInfo.spatialReference,a=this._sourceInfo.fieldsIndex,e.t0=n.a,e.t1=Object(n.a)({},t),e.t2={},e.next=6,Object(f.d)(t.valueExpression,r,a);case 6:return e.t3=e.sent,e.t4={expression:e.t3},e.abrupt("return",(0,e.t0)(e.t1,e.t2,e.t4));case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createLabelArcadeComputedField",value:function(){var e=Object(i.a)(c.a.mark((function e(t){var r,a,i,s,u;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._sourceInfo.spatialReference,a=this._sourceInfo.fieldsIndex,e.next=4,v;case 4:return i=e.sent,s=i.createLabelFunction,e.next=8,s(t.label,a,r);case 8:return u=e.sent,e.abrupt("return",Object(n.a)(Object(n.a)({},t),{},{builder:u}));case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_evaluateField",value:function(e,t,r){switch(t.type){case"label-expression":var a=e.readArcadeFeature();return t.builder.evaluate(a)||"";case"expression":return function(e,t,r){e.referencesGeometry();var a=t.readArcadeFeature();try{return e.evaluate(Object(n.a)(Object(n.a)({},r),{},{$feature:a}))}catch(i){return p.a.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",i),null}}(t.expression,e,{$view:{scale:r}})}}}]),e}()},732:function(e,t,r){"use strict";r.d(t,"a",(function(){return o}));var n=r(142),a=r(143),i=r(144),s=r(145),u=r(298),o=function(e){Object(i.a)(r,e);var t=Object(s.a)(r);function r(e,a){var i;return Object(n.a)(this,r),(i=t.call(this,u.a.createInstance(),e.fullSchema()))._currentIndex=-1,i._reader=e,i._indices=a,i}return Object(a.a)(r,[{key:"hasNext",get:function(){return this._currentIndex+1<this._indices.length}},{key:"getSize",value:function(){return this._indices.length}},{key:"getCursor",value:function(){return this.copy()}},{key:"copy",value:function(){var e=new r(this._reader.copy(),this._indices);return e._currentIndex=this._currentIndex,e}},{key:"next",value:function(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}},{key:"_nextIndex",value:function(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}},{key:"setArcadeSpatialReference",value:function(e){this._reader.setArcadeSpatialReference(e)}},{key:"attachStorage",value:function(e){this._reader.attachStorage(e)}},{key:"geometryType",get:function(){return this._reader.geometryType}},{key:"hasFeatures",get:function(){return this._reader.hasFeatures}},{key:"exceededTransferLimit",get:function(){return this._reader.exceededTransferLimit}},{key:"hasZ",get:function(){return this._reader.hasZ}},{key:"hasM",get:function(){return this._reader.hasM}},{key:"getStorage",value:function(){return this._reader.getStorage()}},{key:"getComputedNumeric",value:function(e){return this._reader.getComputedNumericAtIndex(0)}},{key:"setComputedNumeric",value:function(e,t){return this._reader.setComputedNumericAtIndex(t,0)}},{key:"getComputedString",value:function(e){return this._reader.getComputedStringAtIndex(0)}},{key:"setComputedString",value:function(e,t){return this._reader.setComputedStringAtIndex(0,t)}},{key:"getComputedNumericAtIndex",value:function(e){return this._reader.getComputedNumericAtIndex(e)}},{key:"setComputedNumericAtIndex",value:function(e,t){this._reader.setComputedNumericAtIndex(e,t)}},{key:"getComputedStringAtIndex",value:function(e){return this._reader.getComputedStringAtIndex(e)}},{key:"setComputedStringAtIndex",value:function(e,t){return this._reader.setComputedStringAtIndex(e,t)}},{key:"transform",value:function(e,t,r,n){var a=this.copy();return a._reader=this._reader.transform(e,t,r,n),a}},{key:"readAttribute",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._reader.readAttribute(e,t)}},{key:"readAttributes",value:function(){return this._reader.readAttributes()}},{key:"joinAttributes",value:function(e){return this._reader.joinAttributes(e)}},{key:"readArcadeFeature",value:function(){return this._reader.readArcadeFeature()}},{key:"geometry",value:function(){return this._reader.geometry()}},{key:"field",value:function(e){return this.readAttribute(e,!0)}},{key:"hasField",value:function(e){return this._reader.hasField(e)}},{key:"setField",value:function(e,t){return this._reader.setField(e,t)}},{key:"keys",value:function(){return this._reader.keys()}},{key:"castToText",value:function(){return this._reader.castToText()}},{key:"getQuantizationTransform",value:function(){return this._reader.getQuantizationTransform()}},{key:"getFieldNames",value:function(){return this._reader.getFieldNames()}},{key:"getAttributeHash",value:function(){return this._reader.getAttributeHash()}},{key:"getObjectId",value:function(){return this._reader.getObjectId()}},{key:"getDisplayId",value:function(){return this._reader.getDisplayId()}},{key:"setDisplayId",value:function(e){return this._reader.setDisplayId(e)}},{key:"getGroupId",value:function(){return this._reader.getGroupId()}},{key:"setGroupId",value:function(e){return this._reader.setGroupId(e)}},{key:"getXHydrated",value:function(){return this._reader.getXHydrated()}},{key:"getYHydrated",value:function(){return this._reader.getYHydrated()}},{key:"getX",value:function(){return this._reader.getX()}},{key:"getY",value:function(){return this._reader.getY()}},{key:"setIndex",value:function(e){return this._reader.setIndex(e)}},{key:"getIndex",value:function(){return this._reader.getIndex()}},{key:"readLegacyFeature",value:function(){return this._reader.readLegacyFeature()}},{key:"readOptimizedFeature",value:function(){return this._reader.readOptimizedFeature()}},{key:"readLegacyPointGeometry",value:function(){return this._reader.readLegacyPointGeometry()}},{key:"readLegacyGeometry",value:function(){return this._reader.readLegacyGeometry()}},{key:"readLegacyCentroid",value:function(){return this._reader.readLegacyCentroid()}},{key:"readGeometryArea",value:function(){return this._reader.readGeometryArea()}},{key:"readUnquantizedGeometry",value:function(){return this._reader.readUnquantizedGeometry()}},{key:"readHydratedGeometry",value:function(){return this._reader.readHydratedGeometry()}},{key:"readGeometry",value:function(){return this._reader.readGeometry()}},{key:"readCentroid",value:function(){return this._reader.readCentroid()}},{key:"_readAttribute",value:function(e,t){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}},{key:"_readAttributes",value:function(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}}],[{key:"from",value:function(e,t){return new r(e.copy(),t)}}]),r}(u.a)},772:function(e,t,r){"use strict";r.d(t,"a",(function(){return I})),r.d(t,"b",(function(){return n}));var n,a,i=r(16),s=r(5),u=r(155),o=r(60),c=r(142),l=r(143),h=r(154),d=r.n(h),f=r(146),p=r(349),v=r(542),y=r(270),g=r(182),b=r(673),m=r(581),_=function(){function e(t,r,n){Object(c.a)(this,e),this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=t.returnDistinctValues,this.fieldsIndex=n,this.featureAdapter=r;var a=t.outFields;if(a&&!a.includes("*")){this.outFields=a;var i,s=0,u=Object(o.a)(a);try{for(u.s();!(i=u.n()).done;){var l=i.value,h=Object(b.b)(l),d=this.fieldsIndex.get(h),f=d?null:Object(b.c)(h,n),p=d?d.name:Object(b.a)(l)||"FIELD_EXP_"+s++;this._fieldDataCache.set(l,{alias:p,clause:f})}}catch(v){u.e(v)}finally{u.f()}}}return Object(l.a)(e,[{key:"countDistinctValues",value:function(e){var t=this;return this.returnDistinctValues?(e.forEach((function(e){return t.getAttributes(e)})),this._returnDistinctMap.size):e.length}},{key:"getAttributes",value:function(e){var t=this._processAttributesForOutFields(e);return this._processAttributesForDistinctValues(t)}},{key:"getFieldValue",value:function(e,t,r){var n=r?r.name:t,a=null;return this._fieldDataCache.has(n)?a=this._fieldDataCache.get(n).clause:r||(a=Object(b.c)(t,this.fieldsIndex),this._fieldDataCache.set(n,{alias:n,clause:a})),r?this.featureAdapter.getAttribute(e,n):a.calculateValue(e,this.featureAdapter)}},{key:"getNormalizedValue",value:function(e,t){var r=t.normalizationType,n=t.normalizationTotal,a=this.getFieldValue(e,t.field,t.fieldInfo);if(r&&Number.isFinite(a)){var i=this.getFieldValue(e,t.normalizationField,t.normalizationFieldInfo);a=Object(m.i)(a,r,i,n)}return a}},{key:"getExpressionValue",value:function(e,t,r,n){var a={attributes:this.featureAdapter.getAttributes(e),layer:{fields:this.fieldsIndex.fields}},i=n.createExecContext(a,r);return n.executeFunction(t,i)}},{key:"getExpressionValues",value:function(e,t,r,n){var a=this,i={fields:this.fieldsIndex.fields};return e.map((function(e){var s={attributes:a.featureAdapter.getAttributes(e),layer:i},u=n.createExecContext(s,r);return n.executeFunction(t,u)}))}},{key:"validateItem",value:function(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:Object(b.c)(t,this.fieldsIndex)}),this._fieldDataCache.get(t).clause.testFeature(e,this.featureAdapter)}},{key:"validateItems",value:function(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:Object(b.c)(t,this.fieldsIndex)}),this._fieldDataCache.get(t).clause.testSet(e,this.featureAdapter)}},{key:"_processAttributesForOutFields",value:function(e){var t=this.outFields;if(!t||!t.length)return this.featureAdapter.getAttributes(e);var r,n={},a=Object(o.a)(t);try{for(a.s();!(r=a.n()).done;){var i=r.value,s=this._fieldDataCache.get(i),u=s.alias,c=s.clause;n[u]=c?c.calculateValue(e,this.featureAdapter):this.featureAdapter.getAttribute(e,u)}}catch(l){a.e(l)}finally{a.f()}return n}},{key:"_processAttributesForDistinctValues",value:function(e){if(Object(f.j)(e)||!this.returnDistinctValues)return e;var t=this.outFields,r=[];if(t){var n,a=Object(o.a)(t);try{for(a.s();!(n=a.n()).done;){var i=n.value,s=this._fieldDataCache.get(i).alias;r.push(e[s])}}catch(h){a.e(h)}finally{a.f()}}else for(var u in e)r.push(e[u]);var c="".concat((t||["*"]).join(","),"=").concat(r.join(",")),l=this._returnDistinctMap.get(c)||0;return this._returnDistinctMap.set(c,++l),l>1?null:e}}]),e}(),k=r(278),x=r(484),j=r(238),O=r(260),I=function(){function e(t,r,n){Object(c.a)(this,e),this.items=t,this.query=r,this.geometryType=n.geometryType,this.hasM=n.hasM,this.hasZ=n.hasZ,this.fieldsIndex=n.fieldsIndex,this.objectIdField=n.objectIdField,this.spatialReference=n.spatialReference,this.featureAdapter=n.featureAdapter}return Object(l.a)(e,[{key:"size",get:function(){return this.items.length}},{key:"createQueryResponseForCount",value:function(){var e=new _(this.query,this.featureAdapter,this.fieldsIndex);if(!this.query.outStatistics)return e.countDistinctValues(this.items);var t=this.query,r=t.groupByFieldsForStatistics,n=t.having,a=t.outStatistics;if(!(null===r||void 0===r?void 0:r.length))return 1;var i,s=new Map,u=new Map,c=new Set,l=Object(o.a)(a);try{for(l.s();!(i=l.n()).done;){var h=i.value,d="exceedslimit"!==h.statisticType?h.onStatisticField:void 0;if(!u.has(d)){var f,p=[],v=Object(o.a)(r);try{for(v.s();!(f=v.n()).done;){var y=f.value,g=this._getAttributeValues(e,y,s);p.push(g)}}catch(I){v.e(I)}finally{v.f()}u.set(d,this._calculateUniqueValues(p,e.returnDistinctValues))}var b=u.get(d);for(var m in b){var k=b[m],x=k.data,j=k.items,O=x.join(",");n&&!e.validateItems(j,n)||c.add(O)}}}catch(I){l.e(I)}finally{l.f()}return c.size}},{key:"createQueryResponse",value:function(){var e=Object(u.a)(d.a.mark((function e(){var t;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.query.outStatistics){e.next=11;break}if(!this.query.outStatistics.some((function(e){return"exceedslimit"===e.statisticType}))){e.next=5;break}e.t0=this._createExceedsLimitQueryResponse(this.query),e.next=8;break;case 5:return e.next=7,this._createStatisticsQueryResponse(this.query);case 7:e.t0=e.sent;case 8:t=e.t0,e.next=12;break;case 11:t=this._createFeatureQueryResponse(this.query);case 12:return e.abrupt("return",(this.query.returnQueryGeometry&&(Object(g.l)(this.query.outSR)&&!Object(g.d)(this.query.geometry.spatialReference,this.query.outSR)?t.queryGeometry=Object(x.b)(Object(s.a)({spatialReference:this.query.outSR},Object(k.b)(this.query.geometry,this.query.geometry.spatialReference,this.query.outSR))):t.queryGeometry=Object(x.b)(Object(s.a)({spatialReference:this.query.outSR},this.query.geometry))),t));case 13:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"createSnappingResponse",value:function(e,t){var r,a=this.featureAdapter,i=function(e,t){return e?t?4:3:t?3:2}(this.hasZ,this.hasM),s=e.point,u=s.x,c=s.y,l="number"==typeof e.distance?e.distance:e.distance.x,h="number"==typeof e.distance?e.distance:e.distance.y,d={candidates:[]},p="esriGeometryPolygon"===this.geometryType,v=this._getPointCreator(e.point,this.spatialReference,t),y=Object(o.a)(this.items);try{for(y.s();!(r=y.n()).done;){var g=r.value,b=a.getGeometry(g);if(!Object(f.j)(b)){var m=b.coords,_=b.lengths;if(e.types&n.EDGE)for(var k=0,x=0;x<_.length;x++)for(var j=_[x],O=0;O<j;O++,k+=i){var I=m[k],S=m[k+1];if(O!==j-1){var F=m[k+i],T=m[k+i+1],A=w(u,c,I,S,F,T),C=A.x,R=A.y,M=(u-C)/l,E=(c-R)/h,q=M*M+E*E;q<=1&&d.candidates.push({type:"edge",objectId:a.getObjectId(g),distance:Math.sqrt(q),target:v(C,R),start:v(I,S),end:v(F,T)})}}if(e.types&n.VERTEX)for(var z=p?m.length-i:m.length,N=0;N<z;N+=i){var D=m[N],G=m[N+1],P=(u-D)/l,U=(c-G)/h,L=P*P+U*U;L<=1&&d.candidates.push({type:"vertex",objectId:a.getObjectId(g),distance:Math.sqrt(L),target:v(D,G)})}}}}catch(B){y.e(B)}finally{y.f()}return d.candidates.sort((function(e,t){return e.distance-t.distance})),d}},{key:"_getPointCreator",value:function(e,t,r){var n=Object(f.k)(r)&&!Object(g.d)(t,r)?function(e){return Object(k.b)(e,t,r)}:function(e){return e};return null!=e.z&&null!=e.m?function(t,r){return n({x:t,y:r,z:e.z,m:e.m})}:null!=e.z?function(t,r){return n({x:t,y:r,z:e.z})}:null!=e.m?function(t,r){return n({x:t,y:r,m:e.m})}:function(e,t){return n({x:e,y:t})}}},{key:"createSummaryStatisticsResponse",value:function(){var e=Object(u.a)(d.a.mark((function e(t){var r,n,a,i,s,u,o,c,l,h,f,p,v,y;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.field,n=t.valueExpression,a=t.normalizationField,i=t.normalizationType,s=t.normalizationTotal,u=t.minValue,o=t.maxValue,c=t.scale,l=this.fieldsIndex.isDateField(r),e.next=11,this._getDataValues({field:r,valueExpression:n,normalizationField:a,normalizationType:i,normalizationTotal:s,scale:c});case 11:return h=e.sent,f=Object(m.j)({normalizationType:i,normalizationField:a,minValue:u,maxValue:o}),p=this.fieldsIndex.get(r),v={value:.5,fieldType:null===p||void 0===p?void 0:p.type},y=Object(j.r)(p)?Object(m.e)({values:h,supportsNullCount:f,percentileParams:v}):Object(m.d)({values:h,minValue:u,maxValue:o,useSampleStdDev:!i,supportsNullCount:f,percentileParams:v}),e.abrupt("return",Object(m.k)(y,l));case 17:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"createUniqueValuesResponse",value:function(){var e=Object(u.a)(d.a.mark((function e(t){var r,n,a,i,s,u,o;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.field,n=t.valueExpression,a=t.domain,i=t.returnAllCodedValues,s=t.scale,e.next=7,this._getDataValues({field:r,valueExpression:n,scale:s});case 7:return u=e.sent,o=Object(m.f)(u),e.abrupt("return",Object(m.g)(o,a,i));case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"createClassBreaksResponse",value:function(){var e=Object(u.a)(d.a.mark((function e(t){var r,n,a,i,s,u,o,c,l,h,f,p,v;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.field,n=t.valueExpression,a=t.normalizationField,i=t.normalizationType,s=t.normalizationTotal,u=t.classificationMethod,o=t.standardDeviationInterval,c=t.minValue,l=t.maxValue,h=t.numClasses,f=t.scale,e.next=13,this._getDataValues({field:r,valueExpression:n,normalizationField:a,normalizationType:i,normalizationTotal:s,scale:f});case 13:return p=e.sent,v=Object(m.a)(p,{field:r,normalizationField:a,normalizationType:i,normalizationTotal:s,classificationMethod:u,standardDeviationInterval:o,minValue:c,maxValue:l,numClasses:h}),e.abrupt("return",Object(m.l)(v,u));case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"createHistogramResponse",value:function(){var e=Object(u.a)(d.a.mark((function e(t){var r,n,a,i,s,u,o,c,l,h,f,p;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.field,n=t.valueExpression,a=t.normalizationField,i=t.normalizationType,s=t.normalizationTotal,u=t.classificationMethod,o=t.standardDeviationInterval,c=t.minValue,l=t.maxValue,h=t.numBins,f=t.scale,e.next=13,this._getDataValues({field:r,valueExpression:n,normalizationField:a,normalizationType:i,normalizationTotal:s,scale:f});case 13:return p=e.sent,e.abrupt("return",Object(m.b)(p,{field:r,normalizationField:a,normalizationType:i,normalizationTotal:s,classificationMethod:u,standardDeviationInterval:o,minValue:c,maxValue:l,numBins:h}));case 15:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_sortFeatures",value:function(e,t,r){var n=this;if(e.length>1&&t&&t.length){var a,i=Object(o.a)(t.reverse());try{var s=function(){var t=a.value.split(" "),i=t[0],s=n.fieldsIndex.get(i),u=t[1]&&"desc"===t[1].toLowerCase(),o=Object(m.h)(null===s||void 0===s?void 0:s.type,u);e.sort((function(e,t){var n=r(e,i,s),a=r(t,i,s);return o(n,a)}))};for(i.s();!(a=i.n()).done;)s()}catch(u){i.e(u)}finally{i.f()}}}},{key:"_createFeatureQueryResponse",value:function(e){var t=this,r=this.items,n=this.geometryType,a=this.hasM,s=this.hasZ,u=this.objectIdField,o=this.spatialReference,c=e.outFields,l=e.outSR,h=e.quantizationParameters,d=e.resultRecordCount,f=e.resultOffset,p=e.returnZ,v=e.returnM,g=null!=d&&r.length>(f||0)+d,b=c&&(c.includes("*")?Object(i.a)(this.fieldsIndex.fields):c.map((function(e){return t.fieldsIndex.get(e)})));return{exceededTransferLimit:g,features:this._createFeatures(e,r),fields:b,geometryType:n,hasM:a&&v,hasZ:s&&p,objectIdFieldName:u,spatialReference:Object(x.b)(l||o),transform:h&&Object(y.c)(h)||null}}},{key:"_createFeatures",value:function(e,t){var r=new _(e,this.featureAdapter,this.fieldsIndex),n=this.hasM,a=this.hasZ,s=e.orderByFields,u=e.quantizationParameters,c=e.returnGeometry,l=e.returnCentroid,h=e.maxAllowableOffset,d=e.resultOffset,f=e.resultRecordCount,p=e.returnZ,v=void 0!==p&&p,g=e.returnM,b=a&&v,m=n&&(void 0!==g&&g),k=[],j=0,O=Object(i.a)(t);if(this._sortFeatures(O,s,(function(e,t,n){return r.getFieldValue(e,t,n)})),c||l){var I=Object(y.c)(u);if(c&&!l){var w,S=Object(o.a)(O);try{for(S.s();!(w=S.n()).done;){var F=w.value;k[j++]={attributes:r.getAttributes(F),geometry:Object(x.c)(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(F),h,I,b,m)}}}catch(U){S.e(U)}finally{S.f()}}else if(!c&&l){var T,A=Object(o.a)(O);try{for(A.s();!(T=A.n()).done;){var C=T.value;k[j++]={attributes:r.getAttributes(C),centroid:Object(x.f)(this,this.featureAdapter.getCentroid(C,this),I)}}}catch(U){A.e(U)}finally{A.f()}}else{var R,M=Object(o.a)(O);try{for(M.s();!(R=M.n()).done;){var E=R.value;k[j++]={attributes:r.getAttributes(E),centroid:Object(x.f)(this,this.featureAdapter.getCentroid(E,this),I),geometry:Object(x.c)(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(E),h,I,b,m)}}}catch(U){M.e(U)}finally{M.f()}}}else{var q,z=Object(o.a)(O);try{for(z.s();!(q=z.n()).done;){var N=q.value,D=r.getAttributes(N);D&&(k[j++]={attributes:D})}}catch(U){z.e(U)}finally{z.f()}}var G=d||0;if(null!=f){var P=G+f;k=k.slice(G,Math.min(k.length,P))}return k}},{key:"_createExceedsLimitQueryResponse",value:function(e){var t,r=!1,n=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,s=Object(o.a)(e.outStatistics);try{for(s.s();!(t=s.n()).done;){var u=t.value;if("exceedslimit"===u.statisticType){n=null!=u.maxPointCount?u.maxPointCount:Number.POSITIVE_INFINITY,a=null!=u.maxRecordCount?u.maxRecordCount:Number.POSITIVE_INFINITY,i=null!=u.maxVertexCount?u.maxVertexCount:Number.POSITIVE_INFINITY;break}}}catch(h){s.e(h)}finally{s.f()}if("esriGeometryPoint"===this.geometryType)r=this.items.length>n;else if(this.items.length>a)r=!0;else{var c=this.hasZ?this.hasM?4:3:this.hasM?3:2,l=this.featureAdapter;r=this.items.reduce((function(e,t){var r=l.getGeometry(t);return e+(Object(f.k)(r)&&r.coords.length||0)}),0)/c>i}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(r)}}]}}},{key:"_createStatisticsQueryResponse",value:function(){var e=Object(u.a)(d.a.mark((function e(t){var r,n,a,i,s,u,c,l,h,f,p,v,y,g,b,m,k,x,j,O,I,w,S,F,T,A,C,R,M,E,q,z,N,D,G,P,U,L,B=this;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r={attributes:{}},n=[],a=new Map,i=new Map,s=new Map,u=new Map,c=new _(t,this.featureAdapter,this.fieldsIndex),l=t.outStatistics,h=t.groupByFieldsForStatistics,f=t.having,p=t.orderByFields,v=h&&h.length,g=(y=!!v)&&h[0],b=y&&!this.fieldsIndex.get(g),m=Object(o.a)(l),e.prev=2,m.s();case 4:if((k=m.n()).done){e.next=34;break}if(x=k.value,j=x.outStatisticFieldName,O=x.statisticType,I=x,w="exceedslimit"!==O?x.onStatisticField:void 0,S="percentile_disc"===O||"percentile_cont"===O,F="EnvelopeAggregate"===O||"CentroidAggregate"===O||"ConvexHullAggregate"===O,T=y&&1===v&&(w===g||b)&&"count"===O,!y){e.next=19;break}if(!s.has(w)){A=[],C=Object(o.a)(h);try{for(C.s();!(R=C.n()).done;)M=R.value,E=this._getAttributeValues(c,M,a),A.push(E)}catch(V){C.e(V)}finally{C.f()}s.set(w,this._calculateUniqueValues(A,c.returnDistinctValues))}q=s.get(w),z=d.a.mark((function e(t){var r,n,i,s,o,l,p,v,y,g,b,m,_;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=q[t],n=r.count,i=r.data,s=r.items,o=r.itemPositions,l=i.join(","),f&&!c.validateItems(s,f)){e.next=17;break}if(p=u.get(l)||{attributes:{}},!F){e.next=13;break}return p.aggregateGeometries||(p.aggregateGeometries={}),e.next=7,B._getAggregateGeometry(I,s);case 7:v=e.sent,y=v.aggregateGeometries,g=v.outStatisticFieldName,p.aggregateGeometries[g]=y,e.next=16;break;case 13:b=null,T?b=n:(m=B._getAttributeValues(c,w,a),_=o.map((function(e){return m[e]})),b=S&&"statisticParameters"in I?B._getPercentileValue(I,_):B._getStatisticValue(I,_,null,c.returnDistinctValues)),p.attributes[j]=b;case 16:h.forEach((function(e,t){return p.attributes[B.fieldsIndex.get(e)?e:"EXPR_".concat(t+1)]=i[t]})),u.set(l,p);case 17:case"end":return e.stop()}}),e)})),e.t0=d.a.keys(q);case 12:if((e.t1=e.t0()).done){e.next=17;break}return N=e.t1.value,e.delegateYield(z(N),"t2",15);case 15:e.next=12;break;case 17:e.next=31;break;case 19:if(!F){e.next=29;break}return r.aggregateGeometries||(r.aggregateGeometries={}),e.next=23,this._getAggregateGeometry(I,this.items);case 23:D=e.sent,G=D.aggregateGeometries,P=D.outStatisticFieldName,r.aggregateGeometries[P]=G,e.next=31;break;case 29:U=this._getAttributeValues(c,w,a),r.attributes[j]=S&&"statisticParameters"in I?this._getPercentileValue(I,U):this._getStatisticValue(I,U,i,c.returnDistinctValues);case 31:n.push({name:j,alias:j,type:"esriFieldTypeDouble"});case 32:e.next=4;break;case 34:e.next=39;break;case 36:e.prev=36,e.t3=e.catch(2),m.e(e.t3);case 39:return e.prev=39,m.f(),e.finish(39);case 42:return L=y?Array.from(u.values()):[r],e.abrupt("return",(this._sortFeatures(L,p,(function(e,t){return e.attributes[t]})),{fields:n,features:L}));case 44:case"end":return e.stop()}}),e,this,[[2,36,39,42]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_getAggregateGeometry",value:function(){var e=Object(u.a)(d.a.mark((function e(t,n){var a,i,u,o,c,l,h,f,y,g,b,m,_;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([r.e(6),r.e(16)]).then(r.bind(null,525));case 2:return a=e.sent,i=t.statisticType,u=t.outStatisticFieldName,o=this.featureAdapter,c=this.spatialReference,l=this.geometryType,h=this.hasZ,f=this.hasM,y=n.map((function(e){return Object(x.c)(l,h,f,o.getGeometry(e))})),g=a.convexHull(c,y,!0)[0],b={aggregateGeometries:null,outStatisticFieldName:null},"EnvelopeAggregate"===i?(m=g?Object(v.b)(g):Object(v.a)(a.union(c,y)),b.aggregateGeometries=Object(s.a)(Object(s.a)({},m),{},{spatialReference:c}),b.outStatisticFieldName=u||"extent"):"CentroidAggregate"===i?(_=g?Object(p.b)(g):Object(p.a)(Object(v.a)(a.union(c,y))),b.aggregateGeometries={x:_[0],y:_[1],spatialReference:c},b.outStatisticFieldName=u||"centroid"):"ConvexHullAggregate"===i&&(b.aggregateGeometries=g,b.outStatisticFieldName=u||"convexHull"),e.abrupt("return",b);case 15:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_getStatisticValue",value:function(e,t,r,n){var a,i=e.onStatisticField,s=e.statisticType;return a=null!==r&&void 0!==r&&r.has(i)?r.get(i):Object(j.r)(this.fieldsIndex.get(i))?Object(m.e)({values:t,returnDistinct:n}):Object(m.d)({values:t,minValue:null,maxValue:null,useSampleStdDev:!0}),r&&r.set(i,a),a["var"===s?"variance":s]}},{key:"_getPercentileValue",value:function(e,t){var r=e.onStatisticField,n=e.statisticParameters,a=e.statisticType,i=n.value,s=n.orderBy,u=this.fieldsIndex.get(r);return Object(m.c)(t,{value:i,orderBy:s,fieldType:null===u||void 0===u?void 0:u.type,isDiscrete:"percentile_disc"===a})}},{key:"_getAttributeValues",value:function(e,t,r){if(r.has(t))return r.get(t);var n=this.fieldsIndex.get(t),a=this.items.map((function(r){return e.getFieldValue(r,t,n)}));return r.set(t,a),a}},{key:"_getAttributeNormalizedValues",value:function(e,t){var r=this;return this.items.map((function(n){return e.getNormalizedValue(n,{field:t.field,fieldInfo:r.fieldsIndex.get(t.field),normalizationField:t.normalizationField,normalizationFieldInfo:r.fieldsIndex.get(t.normalizationField),normalizationType:t.normalizationType,normalizationTotal:t.normalizationTotal})}))}},{key:"_getAttributeExpressionValues",value:function(){var e=Object(u.a)(d.a.mark((function e(t,r,n){var a,i,s,u;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(O.e)();case 2:return a=e.sent,i=a.arcadeUtils,s=i.createFunction(r),u=n&&i.getViewInfo(n),e.abrupt("return",t.getExpressionValues(this.items,s,u,i));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_calculateUniqueValues",value:function(e,t){for(var r={},n=this.items,a=n.length,i=0;i<a;i++){var s,u=n[i],c=[],l=Object(o.a)(e);try{for(l.s();!(s=l.n()).done;){var h=s.value;c.push(h[i])}}catch(f){l.e(f)}finally{l.f()}var d=c.join(",");t?null==r[d]&&(r[d]={count:1,data:c,items:[u],itemPositions:[i]}):null==r[d]?r[d]={count:1,data:c,items:[u],itemPositions:[i]}:(r[d].count++,r[d].items.push(u),r[d].itemPositions.push(i))}return r}},{key:"_getDataValues",value:function(){var e=Object(u.a)(d.a.mark((function e(t){var r,n,a,i,s,u,o,c;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new _(this.query,this.featureAdapter,this.fieldsIndex),n=t.valueExpression,a=t.field,i=t.normalizationField,s=t.normalizationType,u=t.normalizationTotal,o=t.scale,c=n?{viewingMode:"map",scale:o,spatialReference:this.query.outSR||this.spatialReference}:null,e.abrupt("return",n?this._getAttributeExpressionValues(r,n,c):this._getAttributeNormalizedValues(r,{field:a,normalizationField:i,normalizationType:s,normalizationTotal:u}));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}();function w(e,t,r,n,a,i){var s=a-r,u=i-n,o=s*s+u*u,c=(e-r)*s+(t-n)*u,l=Math.min(1,Math.max(0,c/o));return{x:r+s*l,y:n+u*l}}(a=n||(n={}))[a.NONE=0]="NONE",a[a.EDGE=1]="EDGE",a[a.VERTEX=2]="VERTEX"},853:function(e,t,r){"use strict";r.d(t,"a",(function(){return m})),r.d(t,"b",(function(){return b}));var n=r(60),a=r(142),i=r(143),s=r(144),u=r(145),o=r(486),c=r(252),l=(r(147),r(146)),h=r(446),d=r(419),f=r(674),p=r(732);function v(e,t){return e<<16|t}function y(e){return(4294901760&e)>>>16}function g(e){return 65535&e}var b={getObjectId:function(e){return e.getObjectId()},getAttributes:function(e){return e.readAttributes()},getAttribute:function(e,t){return e.readAttribute(t)},cloneWithGeometry:function(e,t){return e},getGeometry:function(e){return e.readHydratedGeometry()},getCentroid:function(e,t){return e.readCentroid()}},m=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(e,n,i){var s;return Object(a.a)(this,r),(s=t.call(this,e,n)).featureAdapter=b,s.events=new c.a,s._featureSetsByInstance=new Map,s._objectIdToDisplayId=new Map,s._spatialIndexInvalid=!0,s._indexSearchCache=new o.a(50),s._index=Object(h.a)(9,(function(e){return{minX:s._storage.getXMin(e),minY:s._storage.getYMin(e),maxX:s._storage.getXMax(e),maxY:s._storage.getYMax(e)}})),s.mode=i,s}return Object(i.a)(r,[{key:"storeStatistics",get:function(){var e=0,t=0,r=0;return this.forEach((function(n){var a=n.readGeometry();a&&(t+=a.isPoint?1:a.lengths.reduce((function(e,t){return e+t}),0),r+=a.isPoint?1:a.lengths.length,e+=1)})),{featureCount:e,vertexCount:t,ringCount:r}}},{key:"hasInstance",value:function(e){return this._featureSetsByInstance.has(e)}},{key:"onTileData",value:function(e,t){if(Object(l.j)(t.addOrUpdate))return t;if(t.addOrUpdate.attachStorage(this._storage),"snapshot"===this.mode){for(var r=t.addOrUpdate.getCursor();r.next();){var n=r.getDisplayId();this.setComputedAttributes(this._storage,r,n,e.scale)}return t}this._featureSetsByInstance.set(t.addOrUpdate.instance,t.addOrUpdate);for(var a=t.addOrUpdate.getCursor();a.next();)this._insertFeature(a,e.scale);return this._spatialIndexInvalid=!0,this.events.emit("changed"),t}},{key:"search",value:function(e){var t=this;this._rebuildIndex();var r=e.id,a=this._indexSearchCache.find((function(e){return e.tileId===r}));if(Object(l.k)(a))return a.readers;var i,s=new Map,u=this._searchIndex(e.bounds),o=[],c=Object(n.a)(u);try{for(c.s();!(i=c.n()).done;){var h=i.value,d=this._storage.getInstanceId(h),f=y(d),v=g(d);s.has(f)||s.set(f,[]),s.get(f).push(v)}}catch(b){c.e(b)}finally{c.f()}return s.forEach((function(e,r){var n=t._featureSetsByInstance.get(r);o.push(p.a.from(n,e))})),this._indexSearchCache.enqueue({tileId:r,readers:o}),o}},{key:"insert",value:function(e){for(var t=e.getCursor(),r=this._storage;t.next();){var n,a=v(t.instance,t.getIndex()),i=t.getObjectId(),s=null!==(n=this._objectIdToDisplayId.get(i))&&void 0!==n?n:this._storage.createDisplayId();t.setDisplayId(s),r.setInstanceId(s,a),this._objectIdToDisplayId.set(i,s)}this._featureSetsByInstance.set(e.instance,e),this._spatialIndexInvalid=!0}},{key:"remove",value:function(e){var t=this._objectIdToDisplayId.get(e);if(t){var r=this._storage.getInstanceId(t),n=g(r),a=y(r),i=this._featureSetsByInstance.get(a);this._objectIdToDisplayId.delete(e),this._storage.releaseDisplayId(t),i.removeAtIndex(n),i.isEmpty&&this._featureSetsByInstance.delete(a),this._spatialIndexInvalid=!0}}},{key:"toArray",value:function(){var e=new Array;return this.forEach((function(t){return e.push(t)})),e}},{key:"forEach",value:function(e){var t=this;this._objectIdToDisplayId.forEach((function(r){var n=t._storage.getInstanceId(r),a=t._lookupFeature(n);e(a)}))}},{key:"forEachUnsafe",value:function(e){var t=this;this._objectIdToDisplayId.forEach((function(r){var n=t._storage.getInstanceId(r),a=y(n),i=g(n),s=t._getFeatureSet(a);s.setIndex(i),e(s)}))}},{key:"forEachInBounds",value:function(e,t){var r,a=this._searchIndex(e),i=Object(n.a)(a);try{for(i.s();!(r=i.n()).done;){var s=r.value,u=this.lookupFeatureByDisplayId(s,this._storage);t(Object(l.q)(u))}}catch(o){i.e(o)}finally{i.f()}}},{key:"forEachBounds",value:function(e,t,r){this._rebuildIndex();var a,i=[0,0,0,0],s=Object(n.a)(e);try{for(s.s();!(a=s.n()).done;){var u=a.value;if(u.readGeometry()){var o=u.getDisplayId();i[0]=this._storage.getXMin(o),i[1]=this._storage.getYMin(o),i[2]=this._storage.getXMax(o),i[3]=this._storage.getYMax(o),t(Object(d.h)(r,i))}}}catch(c){s.e(c)}finally{s.f()}}},{key:"sweepFeatures",value:function(e,t,r){var n=this;this._spatialIndexInvalid=!0,this._objectIdToDisplayId.forEach((function(a,i){e.has(a)||(t.releaseDisplayId(a),r&&r.unsetAttributeData(a),n._objectIdToDisplayId.delete(i))})),this.events.emit("changed")}},{key:"sweepFeatureSets",value:function(e){var t=this;this._spatialIndexInvalid=!0,this._featureSetsByInstance.forEach((function(r,n){e.has(n)||t._featureSetsByInstance.delete(n)}))}},{key:"lookupObjectId",value:function(e,t){var r=this.lookupFeatureByDisplayId(e,t);return Object(l.j)(r)?null:r.getObjectId()}},{key:"lookupDisplayId",value:function(e){return this._objectIdToDisplayId.get(e)}},{key:"lookupFeatureByDisplayId",value:function(e,t){var r=t.getInstanceId(e);return this._lookupFeature(r)}},{key:"lookupByDisplayIdUnsafe",value:function(e){var t=this._storage.getInstanceId(e),r=y(t),n=g(t),a=this._getFeatureSet(r);return a?(a.setIndex(n),a):null}},{key:"_insertFeature",value:function(e,t){var r=this._storage,n=e.getObjectId(),a=v(e.instance,e.getIndex());r.getInstanceId(e.getDisplayId());var i=this._objectIdToDisplayId.get(n);i||(i=r.createDisplayId(),this._objectIdToDisplayId.set(n,i),this._spatialIndexInvalid=!0),e.setDisplayId(i),r.setInstanceId(i,a),this.setComputedAttributes(r,e,i,t)}},{key:"_searchIndex",value:function(e){this._rebuildIndex();var t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this._index.search(t)}},{key:"_rebuildIndex",value:function(){var e=this;if(this._spatialIndexInvalid){var t=[];"snapshot"===this.mode?this._featureSetsByInstance.forEach((function(r){for(var n=r.getCursor();n.next();){var a=n.getDisplayId();e._storage.setBounds(a,n)&&t.push(a)}})):this._objectIdToDisplayId.forEach((function(r){var n=e._storage.getInstanceId(r);e._storage.setBounds(r,e._lookupFeature(n))&&t.push(r)})),this._index.clear(),this._index.load(t),this._indexSearchCache.clear(),this._spatialIndexInvalid=!1}}},{key:"_lookupFeature",value:function(e){var t=y(e),r=this._getFeatureSet(t);if(!r)return null;var n=r.getCursor(),a=g(e);return n.setIndex(a),n}},{key:"_getFeatureSet",value:function(e){return this._featureSetsByInstance.get(e)}}]),r}(f.a)},854:function(e,t,r){"use strict";r.d(t,"a",(function(){return O})),r.d(t,"b",(function(){return j})),r.d(t,"c",(function(){return I})),r.d(t,"d",(function(){return S})),r.d(t,"e",(function(){return T})),r.d(t,"f",(function(){return C})),r.d(t,"g",(function(){return M})),r.d(t,"h",(function(){return q})),r.d(t,"i",(function(){return z})),r.d(t,"j",(function(){return D}));var n=r(60),a=r(5),i=r(499),s=r(155),u=r(154),o=r.n(u),c=(r(177),r(186)),l=r(159),h=r(156),d=r(146),f=r(182),p=r(318),v=r(188),y=r(724),g=r(485),b=r(386),m=r(329),_=r(544),k=r(185),x=h.a.getLogger("esri.layers.graphics.sources.ogcfeature"),j="http://www.opengis.net/def/crs/",O="".concat(j,"OGC/1.3/CRS84");function I(e,t){return w.apply(this,arguments)}function w(){return w=Object(s.a)(o.a.mark((function e(t,r){var i,s,u,h,f,p,v,y,k,j,O,I,w,S,F,T,A,C,R,M,E,q=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=q.length>2&&void 0!==q[2]?q[2]:{},s=q.length>3&&void 0!==q[3]?q[3]:5,u=t.links,h=Q(u,"items","application/geo+json")||Q(u,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json"),!Object(d.j)(h)){e.next=5;break}throw new l.a("ogc-feature-layer:missing-items-page","Missing items url");case 5:return e.next=7,Object(c.default)(h.href,{signal:i.signal,query:Object(a.a)(Object(a.a)({limit:s},i.customParameters),{},{token:i.apiKey}),headers:{accept:"application/geo+json"}});case 7:return f=e.sent,p=f.data,e.next=11,Object(g.d)(p);case 11:if(v=Object(g.c)(p,{geometryType:r.geometryType}),y=r.fields||v.fields||[],k=null!=r.hasZ?r.hasZ:v.hasZ,j=v.geometryType,O=r.objectIdField||v.objectIdFieldName||"OBJECTID",I=r.timeInfo,w=y.find((function(e){return e.name===O}))){e.next=20;break}if(v.objectIdFieldType){e.next=17;break}throw new l.a("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");case 17:y.unshift({name:O,alias:O,type:"esriFieldTypeOID",editable:!1,nullable:!1}),e.next=21;break;case 20:w.type="esriFieldTypeOID",w.editable=!1,w.nullable=!1;case 21:O!==v.objectIdFieldName&&(S=y.find((function(e){return e.name===v.objectIdFieldName})))&&(S.type="esriFieldTypeInteger"),y===v.fields&&v.unknownFields.length>0&&x.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:v.unknownFields}}),F=Object(n.a)(y),e.prev=24,F.s();case 26:if((T=F.n()).done){e.next=34;break}if(null==(A=T.value).name&&(A.name=A.alias),null==A.alias&&(A.alias=A.name),"esriFieldTypeOID"!==A.type&&"esriFieldTypeGlobalID"!==A.type&&(A.editable=null==A.editable||!!A.editable,A.nullable=null==A.nullable||!!A.nullable),A.name){e.next=30;break}throw new l.a("ogc-feature-layer:invalid-field-name","field name is missing",{field:A});case 30:if(_.a.jsonValues.includes(A.type)){e.next=32;break}throw new l.a("ogc-feature-layer:invalid-field-type",'invalid type for field "'.concat(A.name,'"'),{field:A});case 32:e.next=26;break;case 34:e.next=39;break;case 36:e.prev=36,e.t0=e.catch(24),F.e(e.t0);case 39:return e.prev=39,F.f(),e.finish(39);case 42:return I&&(C=new m.a(y),I.startTimeField&&((R=C.get(I.startTimeField))?(I.startTimeField=R.name,R.type="esriFieldTypeDate"):I.startTimeField=null),I.endTimeField&&((M=C.get(I.endTimeField))?(I.endTimeField=M.name,M.type="esriFieldTypeDate"):I.endTimeField=null),I.trackIdField&&((E=C.get(I.trackIdField))?I.trackIdField=E.name:(I.trackIdField=null,x.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:I}}))),I.startTimeField||I.endTimeField||(x.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:I}}),I=null)),e.abrupt("return",{drawingInfo:j?Object(b.d)(j):null,geometryType:j,fields:y,hasZ:!!k,objectIdField:O,timeInfo:I});case 44:case"end":return e.stop()}}),e,null,[[24,36,39,42]])}))),w.apply(this,arguments)}function S(e){return F.apply(this,arguments)}function F(){return F=Object(s.a)(o.a.mark((function e(t){var r,n,i,s,u,h,f,p,v=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=v.length>1&&void 0!==v[1]?v[1]:{},n=t.links,i=Q(n,"data","application/json")||Q(n,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json"),!Object(d.j)(i)){e.next=4;break}throw new l.a("ogc-feature-layer:missing-collections-page","Missing collections url");case 4:return s=r.apiKey,u=r.customParameters,h=r.signal,e.next=9,Object(c.default)(i.href,{signal:h,headers:{accept:"application/json"},query:Object(a.a)(Object(a.a)({},u),{},{token:s})});case 9:return f=e.sent,p=f.data,e.abrupt("return",p);case 12:case"end":return e.stop()}}),e)}))),F.apply(this,arguments)}function T(e){return A.apply(this,arguments)}function A(){return A=Object(s.a)(o.a.mark((function e(t){var r,n,i,s,u,h,f,p,v=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=v.length>1&&void 0!==v[1]?v[1]:{},n=t.links,i=Q(n,"conformance","application/json")||Q(n,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json"),!Object(d.j)(i)){e.next=4;break}throw new l.a("ogc-feature-layer:missing-conformance-page","Missing conformance url");case 4:return s=r.apiKey,u=r.customParameters,h=r.signal,e.next=9,Object(c.default)(i.href,{signal:h,headers:{accept:"application/json"},query:Object(a.a)(Object(a.a)({},u),{},{token:s})});case 9:return f=e.sent,p=f.data,e.abrupt("return",p);case 12:case"end":return e.stop()}}),e)}))),A.apply(this,arguments)}function C(e){return R.apply(this,arguments)}function R(){return R=Object(s.a)(o.a.mark((function e(t){var r,n,i,s,u,l,h=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=h.length>1&&void 0!==h[1]?h[1]:{},n=r.apiKey,i=r.customParameters,s=r.signal,e.next=6,Object(c.default)(t,{signal:s,headers:{accept:"application/json"},query:Object(a.a)(Object(a.a)({},i),{},{token:n})});case 6:return u=e.sent,l=u.data,e.abrupt("return",l);case 9:case"end":return e.stop()}}),e)}))),R.apply(this,arguments)}function M(e){return E.apply(this,arguments)}function E(){return E=Object(s.a)(o.a.mark((function e(t){var r,n,i,s,u,l,h,f,p=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=p.length>1&&void 0!==p[1]?p[1]:{},n="application/vnd.oai.openapi+json;version=3.0",i=Q(t.links,"service-desc",n),!Object(d.j)(i)){e.next=4;break}return e.abrupt("return",(x.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null));case 4:return s=r.apiKey,u=r.customParameters,l=r.signal,e.next=9,Object(c.default)(i.href,{signal:l,headers:{accept:n},query:Object(a.a)(Object(a.a)({},u),{},{token:s})});case 9:return h=e.sent,f=h.data,e.abrupt("return",f);case 12:case"end":return e.stop()}}),e)}))),E.apply(this,arguments)}function q(e){var t,r=null===(t=Object(i.a)(/^http:\/\/www\.opengis.net\/def\/crs\/(.*)\/(.*)\/(.*)$/i,{authority:1,version:2,code:3}).exec(e))||void 0===t?void 0:t.groups;if(!r)return null;var n=r.authority,a=r.code;switch(n.toLowerCase()){case"ogc":switch(a.toLowerCase()){case"crs27":return k.a.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return k.a.WGS84.wkid;default:return null}case"esri":case"epsg":var s=Number.parseInt(a,10);return Number.isNaN(s)?null:s;default:return null}}function z(e,t,r){return N.apply(this,arguments)}function N(){return(N=Object(s.a)(o.a.mark((function e(t,r,n){var a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,D(t,r,n);case 2:return a=e.sent,e.abrupt("return",Object(v.j)(a));case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function D(e,t,r){return G.apply(this,arguments)}function G(){return G=Object(s.a)(o.a.mark((function e(t,r,i){var s,u,h,b,m,_,x,j,O,I,w,S,F,T,A,C,R,M,E,q,z,N,D,G,U,Z,Y,H,X,W,J,$,K,ee,te,re,ne,ae,ie,se,ue,oe;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=t.capabilities.query.maxRecordCount,u=t.collection,h=t.layerDefinition,b=t.queryParameters,m=b.apiKey,_=b.customParameters,x=t.spatialReference,j=t.supportedCrs,O=u.links,I=Q(O,"items","application/geo+json")||Q(O,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json"),!Object(d.j)(I)){e.next=3;break}throw new l.a("ogc-feature-layer:missing-items-page","Missing items url");case 3:if(w=r.geometry,S=r.num,F=r.start,T=r.timeExtent,A=r.where,!r.objectIds){e.next=6;break}throw new l.a("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");case 6:return C=k.a.fromJSON(x),R=Object(d.r)(r.outSpatialReference,C),M=R.isWGS84?null:P(R,j),E=V(w,j),q=L(T),z=B(A),N=null!==S&&void 0!==S?S:null!=F&&void 0!==F?10:s,e.next=15,Object(c.default)(I.href,Object(a.a)(Object(a.a)({},i),{},{query:Object(a.a)(Object(a.a)(Object(a.a)({},_),E),{},{crs:M,datetime:q,query:z,limit:N,startindex:F,token:m}),headers:{accept:"application/geo+json"}}));case 15:if(D=e.sent,G=D.data,U=!1,G.links&&(Z=G.links.find((function(e){return"next"===e.rel})),U=!!Z),!U&&Number.isInteger(G.numberMatched)&&Number.isInteger(G.numberReturned)&&(U=G.numberReturned<G.numberMatched),Y=h.fields,H=h.globalIdField,X=h.hasM,W=h.hasZ,J=h.objectIdField,$=h.geometryType,K=Object(g.a)(G,{geometryType:$,hasZ:W,objectIdField:J}),!M&&R.isWebMercator){ee=Object(n.a)(K);try{for(ee.s();!(te=ee.n()).done;)re=te.value,Object(d.k)(re.geometry)&&((ne=Object(v.k)(re.geometry,$,W,!1)).spatialReference=k.a.WGS84,re.geometry=Object(v.d)(Object(p.d)(ne,R)))}catch(o){ee.e(o)}finally{ee.f()}}ae=Object(n.a)(K);try{for(ae.s();!(ie=ae.n()).done;)(se=ie.value).objectId=se.attributes[J]}catch(o){ae.e(o)}finally{ae.f()}return ue=M||!M&&R.isWebMercator?R.toJSON():f.b,oe=new y.a,e.abrupt("return",(oe.exceededTransferLimit=U,oe.features=K,oe.fields=Y,oe.geometryType=$,oe.globalIdFieldName=H,oe.hasM=X,oe.hasZ=W,oe.objectIdFieldName=J,oe.spatialReference=ue,oe));case 26:case"end":return e.stop()}}),e)}))),G.apply(this,arguments)}function P(e,t){var r,n,a,i=e.isWebMercator;if(!e.wkid)return null;var s=i?null!==(r=null!==(n=null!==(a=t[3857])&&void 0!==a?a:t[102100])&&void 0!==n?n:t[102113])&&void 0!==r?r:t[900913]:t[e.wkid];return s?"".concat(j).concat(s):null}function U(e){if(Object(d.j)(e))return"";var t=e.xmin,r=e.ymin,n=e.xmax,a=e.ymax;return"".concat(t,",").concat(r,",").concat(n,",").concat(a)}function L(e){if(Object(d.j)(e))return null;var t=e.start,r=e.end;return"".concat(Object(d.k)(t)?t.toISOString():"..","/").concat(Object(d.k)(r)?r.toISOString():"..")}function B(e){return Object(d.j)(e)||!e||"1=1"===e?null:e}function V(e,t){if(!function(e){return Object(d.k)(e)&&"extent"===e.type}(e))return null;var r=e.spatialReference;if(!r||r.isWGS84)return{bbox:U(e)};var n=P(r,t);return Object(d.k)(n)?{bbox:U(e),"bbox-crs":n}:r.isWebMercator?{bbox:U(Object(p.d)(e,k.a.WGS84))}:null}function Q(e,t,r){return e.find((function(e){return e.rel===t&&e.type===r}))||e.find((function(e){return e.rel===t&&!e.type}))}}}]);